/*!
 * SAP Innovation Management (c) Copyright 2014 SAP AG. All rights reserved.
 */
jQuery.sap.declare("sap.ino.wall.TextEditor");(function(){"use strict";jQuery.sap.require("sap.ino.wall.util.Helper");jQuery.sap.require("sap.ino.wall.ColorPicker");jQuery.sap.require("sap.ino.wall.WallItemBase");jQuery.sap.require("sap.ino.wall.TShirtSize");jQuery.sap.require("sap.ino.thirdparty.nicEdit");sap.ui.core.Control.extend("sap.ino.wall.TextEditor",{metadata:{properties:{"value":{type:"string",group:"Misc",defaultValue:null}},aggregations:{"_textArea":{type:"sap.m.TextArea",multiple:false,visibility:"hidden"},"_buttonColorSelector":{type:"sap.m.Button",multiple:false,visibility:"hidden"},"_colorPicker":{type:"sap.ino.wall.ColorPicker",multiple:false,visibility:"hidden"},"_editorControls":{type:"sap.ui.layout.HorizontalLayout",multiple:false,visibility:"hidden"},},events:{"change":{}}}});sap.ino.wall.TextEditor.M_EVENTS={'change':'change'};sap.ino.wall.TextEditor.prototype.init=function(){this._oRB=sap.ui.getCore().getLibraryResourceBundle("sap.ino.wall");};sap.ino.wall.TextEditor.prototype.onAfterRendering=function(){var l;this._oNicEditor=new nicEditor({buttonList:["bold","italic","underline","left","center","right","ol","ul","forecolor","fontSize","fontFamily"]});this._oNicEditor.addEvent("buttonActivate",jQuery.proxy(this._nicButtonActivate,this));this._oNicEditor.addEvent("buttonDeactivate",jQuery.proxy(this._nicButtonDeactivate,this));this._oNicEditor.addEvent("blur",jQuery.proxy(this._fireChange,this));this._oNicEditor.setPanel(this.getId()+"-nicPanel");this._oNicEditor.addInstance(this.getId()+"-nicContentTA");sap.ui.getCore().byId(this.getId()+"-buttonColorSelector").$().find(".sapMBtnInner").css("background-color",this._sTextColor);l=sap.ino.wall.util.Helper.getColorLuminance(this._sTextColor);if(l<=0.6){this._getButtonColorSelector().addStyleClass("sapInoWallWTextEditorColorSelectorButtonBright").removeStyleClass("sapInoWallWTextEditorColorSelectorButtonNormal");}else{this._getButtonColorSelector().addStyleClass("sapInoWallWTextEditorColorSelectorButtonNormal").removeStyleClass("sapInoWallWTextEditorColorSelectorButtonBright");}this._getColorPicker().getPlacement();};sap.ino.wall.TextEditor.prototype.setValue=function(v){if(v!==this.getValue()){this.setProperty("value",v,true);if(this._isRendered()){this.$().children("textarea").html(jQuery.sap.encodeHTML(this.getProperty("value")));}}return this;};sap.ino.wall.TextEditor.prototype.getFocusDomRef=function(){return this.$().find(".nicEdit-main")[0];};sap.ino.wall.TextEditor.prototype.blur=function(){this.getFocusDomRef().blur();this._getNicEditor().ne.fireEvent("blur");};sap.ino.wall.TextEditor.prototype.setControlDetails=function(n){var e=this._getEditorControls().getContent(),s=n||"S",i=0;if(this._sPreviousSize===s){return;}switch(s){case sap.ino.wall.TShirtSize.XS:case sap.ino.wall.TShirtSize.S:default:for(i=3;i<e.length;i++){e[i].toggleStyleClass("sapInoWallInvisible",true);}break;case sap.ino.wall.TShirtSize.M:for(i=3;i<6;i++){e[i].toggleStyleClass("sapInoWallInvisible",false);}for(i=6;i<e.length;i++){e[i].toggleStyleClass("sapInoWallInvisible",true);}break;case sap.ino.wall.TShirtSize.L:case sap.ino.wall.TShirtSize.XL:for(i=3;i<e.length;i++){e[i].toggleStyleClass("sapInoWallInvisible",false);}break;}this._sPreviousSize=s;};sap.ino.wall.WallItemBase.prototype._isRendered=function(){if(this._bIsInDOM===undefined||this._bIsInDOM===0){this._bIsInDOM=jQuery.sap.byId(this.getId()).length;}return this._bIsInDOM;};sap.ino.wall.TextEditor.prototype._getNicEditor=function(){return nicEditors.findEditor(this.getId()+"-nicContentTA");};sap.ino.wall.TextEditor.prototype._nicButtonActivate=function(i){this._syncButtonState(i.name,true);};sap.ino.wall.TextEditor.prototype._nicButtonDeactivate=function(i){this._syncButtonState(i.name,false);};sap.ino.wall.TextEditor.prototype._syncButtonState=function(n,t){var j;switch(n){case"bold":case"italic":case"underline":case"ol":case"ul":sap.ui.getCore().byId(this.getId()+"-"+n).setPressed(t);break;case"left":if(t){j=sap.ui.getCore().byId(this.getId()+"-justify");j.setSelectedButton(j.getButtons()[0]);}break;case"center":if(t){j=sap.ui.getCore().byId(this.getId()+"-justify");j.setSelectedButton(j.getButtons()[1]);}break;case"right":if(t){j=sap.ui.getCore().byId(this.getId()+"-justify");j.setSelectedButton(j.getButtons()[2]);}break;default:break;}};sap.ino.wall.TextEditor.prototype._fireChange=function(e){var n=this._getNicEditor();if(n){var E=this._cleanEditorContent(n.getContent());if(E!=n.getContent()){n.setContent(E);}if(this.getValue()!==E){this.setProperty("value",E,true);this.fireChange({value:E});}}};sap.ino.wall.TextEditor.prototype._cleanEditorContent=function(e){var s=e.indexOf("<!--StartFragment-->");if(s>=0){var E=e.indexOf("<!--EndFragment-->");e=e.substring(s+20,E>=0?E:undefined);e=jQuery.trim(e);}e=e.substring(0,4000);return e;};sap.ino.wall.TextEditor.prototype._setColor=function(c){var l;this._sTextColor=c;if(this._isRendered()){this._getNicEditor().nicCommand("foreColor",c);sap.ui.getCore().byId(this.getId()+"-buttonColorSelector").$().find(".sapMBtnInner").css("background-color",c);l=sap.ino.wall.util.Helper.getColorLuminance(c);if(l<=0.6){this._getButtonColorSelector().addStyleClass("sapInoWallWTextEditorColorSelectorButtonBright").removeStyleClass("sapInoWallWTextEditorColorSelectorButtonNormal");}else{this._getButtonColorSelector().addStyleClass("sapInoWallWTextEditorColorSelectorButtonNormal").removeStyleClass("sapInoWallWTextEditorColorSelectorButtonBright");}}};sap.ino.wall.TextEditor.prototype._isRendered=function(){if(this._bIsInDOM===undefined||this._bIsInDOM===0){this._bIsInDOM=jQuery.sap.byId(this.getId()).length;}return this._bIsInDOM;};sap.ino.wall.TextEditor.prototype._getEditorControls=function(e){var t=this,c=this.getAggregation("_editorControls");if(!c){c=new sap.ui.layout.HorizontalLayout({allowWrapping:true,content:[new sap.m.ToggleButton(this.getId()+"-bold",{press:function(e){var $=t.$(),s;if(!sap.ino.wall.util.Helper.getTextSelection()){sap.ino.wall.util.Helper.selectAllText($.find(".nicEdit-main")[0]);}else{s=jQuery(sap.ino.wall.util.Helper.getTextSelectionNode()).control(0);if(s&&s!==t){this.setPressed(!this.getPressed());return;}}t._getNicEditor().nicCommand("Bold");setTimeout(function(){if(this.__triggeredKeyEvent){this.focus();}}.bind(this),0);}}).addStyleClass("noflip").addStyleClass("nicEdit").addStyleClass("sapInoWallTextEditorControlButton").addStyleClass("sapInoWallTextEditorControlButtonBold").addEventDelegate({onkeydown:function(e){e.srcControl.__triggeredKeyEvent=true;}.bind(this),onkeyup:function(e){e.srcControl.__triggeredKeyEvent=false;},onsapenter:function(e){e.preventDefault();e.stopPropagation();}}),new sap.m.ToggleButton(this.getId()+"-italic",{press:function(e){var $=t.$(),s;if(!sap.ino.wall.util.Helper.getTextSelection()){sap.ino.wall.util.Helper.selectAllText($.find(".nicEdit-main")[0]);}else{s=jQuery(sap.ino.wall.util.Helper.getTextSelectionNode()).control(0);if(s&&s!==t){this.setPressed(!this.getPressed());return;}}t._getNicEditor().nicCommand("Italic");setTimeout(function(){if(this.__triggeredKeyEvent){this.focus();}}.bind(this),0);}}).addStyleClass("noflip").addStyleClass("nicEdit").addStyleClass("sapInoWallTextEditorControlButton").addStyleClass("sapInoWallTextEditorControlButtonItalic").addEventDelegate({onkeydown:function(e){e.srcControl.__triggeredKeyEvent=true;}.bind(this),onkeyup:function(e){e.srcControl.__triggeredKeyEvent=false;},onsapenter:function(e){e.preventDefault();e.stopPropagation();}}),new sap.m.ToggleButton(this.getId()+"-underline",{press:function(e){var $=t.$(),s;if(!sap.ino.wall.util.Helper.getTextSelection()){sap.ino.wall.util.Helper.selectAllText($.find(".nicEdit-main")[0]);}else{s=jQuery(sap.ino.wall.util.Helper.getTextSelectionNode()).control(0);if(s&&s!==t){this.setPressed(!this.getPressed());return;}}t._getNicEditor().nicCommand("Underline");setTimeout(function(){if(this.__triggeredKeyEvent){this.focus();}}.bind(this),0);}}).addStyleClass("noflip").addStyleClass("nicEdit").addStyleClass("sapInoWallTextEditorControlButton").addStyleClass("sapInoWallTextEditorControlButtonUnderline").addEventDelegate({onkeydown:function(e){e.srcControl.__triggeredKeyEvent=true;}.bind(this),onkeyup:function(e){e.srcControl.__triggeredKeyEvent=false;},onsapenter:function(e){e.preventDefault();e.stopPropagation();}}),this._getButtonColorSelector(),new sap.m.Select(this.getId()+"-face",{width:"130px",items:[new sap.ui.core.Item({key:"",text:this._oRB.getText("WALL_TEXTEDITOR_FAMILY_SELECT")}),new sap.ui.core.Item({key:"arial",text:this._oRB.getText("WALL_TEXTEDITOR_FLD_FONT_ARIAL")}),new sap.ui.core.Item({key:"comic sans ms",text:this._oRB.getText("WALL_TEXTEDITOR_FLD_FONT_COMIC")}),new sap.ui.core.Item({key:"courier new",text:this._oRB.getText("WALL_TEXTEDITOR_FLD_FONT_COURIER")}),new sap.ui.core.Item({key:"geogria",text:this._oRB.getText("WALL_TEXTEDITOR_FLD_FONT_GEORGIA")}),new sap.ui.core.Item({key:"helvetica",text:this._oRB.getText("WALL_TEXTEDITOR_FLD_FONT_HELVETICA")}),new sap.ui.core.Item({key:"impact",text:this._oRB.getText("WALL_TEXTEDITOR_FLD_FONT_IMPACT")}),new sap.ui.core.Item({key:"times new roman",text:this._oRB.getText("WALL_TEXTEDITOR_FLD_FONT_TIMES")}),new sap.ui.core.Item({key:"trebuchet ms",text:this._oRB.getText("WALL_TEXTEDITOR_FLD_FONT_TREBUCHET")}),new sap.ui.core.Item({key:"verdana",text:this._oRB.getText("WALL_TEXTEDITOR_FLD_FONT_VERDANA")})],change:function(e){var i=e.getParameter("selectedItem"),$=t.$(),s;if(!sap.ino.wall.util.Helper.getTextSelection()){sap.ino.wall.util.Helper.selectAllText($.find(".nicEdit-main")[0]);}else{s=jQuery(sap.ino.wall.util.Helper.getTextSelectionNode()).control(0);if(s&&s!==t){return;}}if(i.getKey()!==""){t._getNicEditor().nicCommand("fontname",i.getKey());}setTimeout(function(){if(this.__triggeredKeyEvent){this.focus();}}.bind(this),0);}}).addStyleClass("noflip").addStyleClass("sapInoWallWIBSelect").addStyleClass("nicEdit").addStyleClass("sapInoWallTextEditorControlSelect").addEventDelegate({onkeydown:function(e){e.srcControl.__triggeredKeyEvent=true;}.bind(this),onkeyup:function(e){e.srcControl.__triggeredKeyEvent=false;},onsapenter:function(e){e.preventDefault();e.stopPropagation();}}),new sap.m.Select(this.getId()+"-size",{width:"130px",items:[new sap.ui.core.Item({key:"",text:this._oRB.getText("WALL_TEXTEDITOR_SIZE_SELECT")}),new sap.ui.core.Item({key:"2",text:this._oRB.getText("WALL_ITEMHEADLINE_SIZE_H6")}),new sap.ui.core.Item({key:"3",text:this._oRB.getText("WALL_ITEMHEADLINE_SIZE_H5")}),new sap.ui.core.Item({key:"4",text:this._oRB.getText("WALL_ITEMHEADLINE_SIZE_H4")}),new sap.ui.core.Item({key:"5",text:this._oRB.getText("WALL_ITEMHEADLINE_SIZE_H3")}),new sap.ui.core.Item({key:"6",text:this._oRB.getText("WALL_ITEMHEADLINE_SIZE_H2")}),new sap.ui.core.Item({key:"7",text:this._oRB.getText("WALL_ITEMHEADLINE_SIZE_H1")})],change:function(e){var i=e.getParameter("selectedItem"),$=t.$(),s;if(!sap.ino.wall.util.Helper.getTextSelection()){sap.ino.wall.util.Helper.selectAllText($.find(".nicEdit-main")[0]);}else{s=jQuery(sap.ino.wall.util.Helper.getTextSelectionNode()).control(0);if(s&&s!==t){return;}}if(i.getKey()!==""){t._getNicEditor().nicCommand("fontsize",i.getKey());}setTimeout(function(){if(this.__triggeredKeyEvent){this.focus();}}.bind(this),0);}}).addStyleClass("noflip").addStyleClass("sapInoWallWIBSelect").addStyleClass("nicEdit").addStyleClass("sapInoWallTextEditorControlSelect").addEventDelegate({onkeydown:function(e){e.srcControl.__triggeredKeyEvent=true;}.bind(this),onkeyup:function(e){e.srcControl.__triggeredKeyEvent=false;},onsapenter:function(e){e.preventDefault();e.stopPropagation();}}),new sap.m.SegmentedButton(this.getId()+"-justify",{buttons:[new sap.m.Button(),new sap.m.Button(),new sap.m.Button()],select:function(e){var s=e.getParameter("button"),b=e.getSource().getButtons(),$=t.$(),S;if(!sap.ino.wall.util.Helper.getTextSelection()){sap.ino.wall.util.Helper.selectAllText($.find(".nicEdit-main")[0]);}else{S=jQuery(sap.ino.wall.util.Helper.getTextSelectionNode()).control(0);if(S&&S!==t){return;}}if(s===b[0]){t._getNicEditor().nicCommand("justifyleft");}else if(s===b[1]){t._getNicEditor().nicCommand("justifycenter");}else if(s===b[2]){t._getNicEditor().nicCommand("justifyright");}setTimeout(function(){if(this.__triggeredKeyEvent){s.focus();}}.bind(this),0);}}).addStyleClass("noflip").addStyleClass("nicEdit").addStyleClass("sapInoWallTextEditorControlButton").addStyleClass("sapInoWallTextEditorControlButtonAlignment").addEventDelegate({onkeydown:function(e){e.srcControl.__triggeredKeyEvent=true;}.bind(this),onkeyup:function(e){e.srcControl.__triggeredKeyEvent=false;},onsapenter:function(e){e.preventDefault();e.stopPropagation();}}),new sap.m.ToggleButton(this.getId()+"-ol",{press:function(e){var $=t.$(),s;if(!sap.ino.wall.util.Helper.getTextSelection()){sap.ino.wall.util.Helper.selectAllText($.find(".nicEdit-main")[0]);}else{s=jQuery(sap.ino.wall.util.Helper.getTextSelectionNode()).control(0);if(s&&s!==t){this.setPressed(!this.getPressed());return;}}sap.ui.getCore().byId(t.getId()+"-ul").setPressed(false);t._getNicEditor().nicCommand("insertorderedlist");setTimeout(function(){if(this.__triggeredKeyEvent){this.focus();}}.bind(this),0);}}).addStyleClass("noflip").addStyleClass("nicEdit").addStyleClass("sapInoWallTextEditorControlButton").addStyleClass("sapInoWallTextEditorControlButtonOl").addEventDelegate({onkeydown:function(e){e.srcControl.__triggeredKeyEvent=true;}.bind(this),onkeyup:function(e){e.srcControl.__triggeredKeyEvent=false;},onsapenter:function(e){e.preventDefault();e.stopPropagation();}}),new sap.m.ToggleButton(this.getId()+"-ul",{press:function(e){var $=t.$(),s;if(!sap.ino.wall.util.Helper.getTextSelection()){sap.ino.wall.util.Helper.selectAllText($.find(".nicEdit-main")[0]);}else{s=jQuery(sap.ino.wall.util.Helper.getTextSelectionNode()).control(0);if(s&&s!==t){this.setPressed(!this.getPressed());return;}}sap.ui.getCore().byId(t.getId()+"-ol").setPressed(false);t._getNicEditor().nicCommand("insertunorderedlist");setTimeout(function(){if(this.__triggeredKeyEvent){this.focus();}}.bind(this),0);}}).addStyleClass("noflip").addStyleClass("nicEdit").addStyleClass("sapInoWallTextEditorControlButton").addStyleClass("sapInoWallTextEditorControlButtonUl").addEventDelegate({onkeydown:function(e){e.srcControl.__triggeredKeyEvent=true;}.bind(this),onkeyup:function(e){e.srcControl.__triggeredKeyEvent=false;},onsapenter:function(e){e.preventDefault();e.stopPropagation();}})]}).addStyleClass("noflip");c.addEventDelegate({"onmousedown":function(e){e.preventDefault();return false;}});this.setAggregation("_editorControls",c,true);}return c;};sap.ino.wall.TextEditor.prototype._getColorPicker=function(){var t=this,c=this.getAggregation("_colorPicker");if(!c){c=new sap.ino.wall.ColorPicker(this.getId()+"-colorPicker",{color:t._sTextColor,change:function(e){var $=t.$(),f=jQuery(":focus"),s;if(!sap.ino.wall.util.Helper.getTextSelection()){sap.ino.wall.util.Helper.selectAllText($.find(".nicEdit-main")[0]);}else{s=jQuery(sap.ino.wall.util.Helper.getTextSelectionNode()).control(0);if(s&&s!==t){return;}}t._setColor(e.getParameter("color"));f.focus();}}).addStyleClass("nicEdit");this.setAggregation("_colorPicker",c,true);}return c;};sap.ino.wall.TextEditor.prototype._getButtonColorSelector=function(){var t=this,r,c=this._buttonColorSelector;if(!c){c=new sap.m.Button(this.getId()+"-buttonColorSelector",{tooltip:this._oRB.getText("WALL_ITEMLINE_STATUSMSG_COLOR_SELECT"),press:function(e){var C=t._getColorPicker(),r,$=t.$();if(C.isOpen()){C.close();}else{C.openBy(c,0,0);if(this.__triggeredKeyEvent){C.focus();}}},icon:"sap-icon://palette"}).addStyleClass("noflip").addStyleClass("sapInoWallTextEditorControlButton").addStyleClass("sapInoWallTextEditorColorSelectorButton").addEventDelegate({onkeydown:function(e){e.srcControl.__triggeredKeyEvent=true;},onkeyup:function(e){e.srcControl.__triggeredKeyEvent=false;},onsapenter:function(e){e.preventDefault();e.stopPropagation();}});r=sap.ino.wall.util.Helper.createRandomHexColor();t._setColor(r);this._buttonColorSelector=c;}return c;};})();
