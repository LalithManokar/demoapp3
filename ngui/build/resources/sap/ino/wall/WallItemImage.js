/*!
 * SAP Innovation Management (c) Copyright 2014 SAP AG. All rights reserved.
 */
jQuery.sap.declare("sap.ino.wall.WallItemImage");(function(){"use strict";jQuery.sap.require("sap.ino.wall.WallItemBase");jQuery.sap.require("sap.ino.wall.DropUpload");jQuery.sap.require("sap.ino.wall.LightBox");jQuery.sap.require("sap.ino.commons.models.object.Attachment");jQuery.sap.require("sap.ino.commons.application.Configuration");var C=sap.ino.commons.application.Configuration;sap.ino.wall.WallItemBase.extend("sap.ino.wall.WallItemImage",{metadata:{properties:{"status":{type:"string",group:"Appearance",defaultValue:'Normal'},"preview":{type:"sap.ui.core.URI",group:"Data",defaultValue:null},"image":{type:"sap.ui.core.URI",group:"Data",defaultValue:null},"assignmentId":{type:"int",group:"Identification",defaultValue:-1},"showAsIcon":{type:"boolean",group:"Appearance",defaultValue:false}},aggregations:{"_icon":{type:"sap.ui.core.Icon",multiple:false,visibility:"hidden"},"imagePreview":{type:"sap.m.Image",multiple:false,visibility:"hidden"},"imageLarge":{type:"sap.m.Image",multiple:false,visibility:"hidden"},"_busyIndicator":{type:"sap.m.BusyIndicator",multiple:false,visibility:"hidden"},"_dropUpload":{type:"sap.ino.wall.DropUpload",multiple:false,visibility:"hidden"},"_checkBox":{type:"sap.m.CheckBox",multiple:false,visibility:"hidden"},"_lightBox":{type:"sap.ino.wall.LightBox",multiple:false,visibility:"hidden"}}}});sap.ino.wall.WallItemImage._CAPTION_HEIGHT=20;sap.ino.wall.WallItemImage.prototype.init=function(){sap.ino.wall.WallItemBase.prototype.init.call(this);this.setResizable(true);};sap.ino.wall.WallItemImage.prototype.setImage=function(u){var o=this.getAggregation("imageLarge");this.setProperty("image",u,true);if(o){o.destroy(true);}this.setAggregation("imageLarge",new sap.m.Image({src:u,densityAware:false}),true);if(this._isRendered()){this.$().find("#"+this.getId()+"-imagePreviewWrapper").children("a").attr("href",u);this._renderItemIntoContainer(this.$().find("#"+this.getId()+"-imagePreviewWrapper").children("a")[0],this.getAggregation("imagePreview"),false,true);if(this.getParent()){this.getParent()._notifyItemChanged(this);}}return this;};sap.ino.wall.WallItemImage.prototype.setAssignmentId=function(i){this.setProperty("assignmentId",i,true);if(this.getParent()){this.getParent()._notifyItemChanged(this);}return this;};sap.ino.wall.WallItemImage.prototype.setShowAsIcon=function(v){this.setProperty("showAsIcon",v,true);if(this._isRendered()){jQuery(this._getCheckBox().getDomRef()).prop("'checked",v);var f=this.$().find(".front");var t=f.find(".sapInoWallWITitle");var r=f.find(".sapInoWallWIResizeHandle");if(v){f.removeClass("sapInoWallWII");t.addClass("sapInoWallWIITitleIcon");r.addClass("sapInoWallWIResizeHandleHidden");}else{f.addClass("sapInoWallWII");t.removeClass("sapInoWallWIITitleIcon");r.removeClass("sapInoWallWIResizeHandleHidden");}}if(this.getParent()){this.getParent()._notifyItemChanged(this);}return this;};sap.ino.wall.WallItemImage.prototype.setW=function(v){var p=this.getAggregation("imagePreview");if(p){if(parseInt(v,10)<parseInt(this.$().css("min-width"),10)){v=this.$().css("min-width");}p.setProperty("width",v,true);p.$().width(v);}sap.ino.wall.WallItemBase.prototype.setW.apply(this,[v]);};sap.ino.wall.WallItemImage.prototype.setH=function(v){var p=this.getAggregation("imagePreview"),P=v;if(p){if(!this.getShowAsIcon()){if(parseInt(v,10)>sap.ino.wall.WallItemImage._CAPTION_HEIGHT){P=(parseInt(v,10)-sap.ino.wall.WallItemImage._CAPTION_HEIGHT)+"px";}}if(parseInt(P,10)<parseInt(this.$().css("min-height"),10)){P=this.$().css("min-height");}p.setProperty("height",P,true);p.$().height(P);}sap.ino.wall.WallItemBase.prototype.setH.apply(this,[v]);};sap.ino.wall.WallItemImage.prototype.setPreview=function(u,U){if(isNaN(parseInt(this.getW(),10))||isNaN(parseInt(this.getH(),10))){this.setW("150px",true);this.setH("130px",true);}var t=this,o=this.getAggregation("imagePreview"),n=null,d,i=function(e){var D;if(sap.m.Image.prototype.onload){sap.m.Image.prototype.onload.apply(this,arguments);}t.setStatus("Normal");D=this.$();var $=sap.ui.getCore().byId(t.getId());var p=sap.ui.getCore().byId(t.getId()+"-preview");if($){$.removeStyleClass("sapInoWallWIIImageError");}if(p){p.removeStyleClass("sapInoWallInvisible");}if(D.width()){this.setProperty("width",D.width()+"px",true);}if(D.height()){this.setProperty("height",D.height()+"px",true);}if(U){var f=parseFloat(this.getWidth(),10);var a=parseFloat(this.getHeight(),10);var b=parseFloat(t.getW(),10);var c=parseFloat(t.getH(),10);if(f>b||a>c){var g=f/a;if(g>=1.0){var N=c*g;t.setWH(N+"px",t.getH());}else{var h=b/g;h=h+(t.getTitle()?sap.ino.wall.WallItemImage._CAPTION_HEIGHT:0);t.setWH(t.getW(),h+"px");}}else{var h=parseFloat(this.getHeight(),10);h=h+(t.getTitle()?sap.ino.wall.WallItemImage._CAPTION_HEIGHT:0);t.setWH(this.getWidth(),h+"px");}t._onResize(true);}else{sap.ui.getCore().byId(t.getId()+"-preview").$().width(t.getW()).height(t.getTitle()?parseFloat(t.getH(),10)-sap.ino.wall.WallItemImage._CAPTION_HEIGHT+"px":t.getH());}},I=function(e){var $=sap.ui.getCore().byId(t.getId());var p=sap.ui.getCore().byId(t.getId()+"-preview");t.setStatus("Normal");if($&&!$.hasStyleClass("sapInoWallWIIImageError")){$.addStyleClass("sapInoWallWIIImageError");}if(p&&!p.hasStyleClass("sapInoWallInvisible")){p.addStyleClass("sapInoWallInvisible");p.setSrc("");}},s=(/.xsjs\/([0-9]*)$/.exec(u)||{})[1];if(s){this._iImageStorageId=parseInt(s,10);}this.setProperty("preview",u,true);if(o){o.destroy(true);}n=new sap.m.Image(this.getId()+"-preview",{src:u,densityAware:false,press:function(){var p=this.getParent();if(p instanceof sap.ino.wall.WallItemBase){p=p.getParent();}if(!this._bMoving&&this.getImage()&&!p._hasFollowCursorItems()){if(this.getShowAsIcon()){this.setFlipped(true);}else{this._showLargeImage();}}}.bind(this)}).addEventDelegate({onBeforeRendering:function(e){var a=e.srcControl,$=a.$();$.unbind("load",a.___onloadproxy);$.unbind("error",a.___onloadproxy);},onAfterRendering:jQuery.proxy(function(e){var a=e.srcControl,$=a.$();if(!a.___onloadproxy){a.___onloadproxy=jQuery.proxy(a.onload,a);a.___onerrorproxy=jQuery.proxy(a.onerror,a);}$.bind("load",jQuery.proxy(a.___onloadproxy,a));$.bind("error",jQuery.proxy(a.___onerrorproxy,a));},n)});n.onload=i;n.onerror=I;this.setAggregation("imagePreview",n,true);if(this._isRendered()){if(!U&&!isNaN(parseInt(t.getW(),10))&&!isNaN(parseInt(t.getH(),10))){n.setProperty("width",t.getW(),true);n.setProperty("height",this.getTitle()?parseFloat(this.getH(),10)-sap.ino.wall.WallItemImage._CAPTION_HEIGHT+"px":this.getH(),true);}this.setStatus("Busy");d=this.$().find(".sapInoWallWIIImageWrapper")[0];this._renderItemIntoContainer(d,n,true,false);if(this.getParent()){this.getParent()._notifyItemChanged(this);}}return this;};sap.ino.wall.WallItemImage.prototype._uploadImage=function(e){var t=this,f=e.getParameter("files"),F,s,o,r,S;if(sap.ui.Device.browser.name==="ie"&&sap.ui.Device.browser.version<10&&f===undefined){return;}jQuery.sap.byId(this.getParent().getId()+"-drag").css("display","none");this.$().removeClass("dragCursor");if(f.length!==0){F=f[0];if(!!F.type.match(/image\.*/)){t.setStatus("Busy");t.setFlipped(false);sap.ino.commons.models.object.Attachment.uploadFile(F).done(function(R){var S=R.attachmentId;var a=R.fileName;setTimeout(function(){t.setPreview(C.getAttachmentDownloadURL(S),true);t.setImage(C.getAttachmentDownloadURL(S));if(!t.getTitle()||t.getTitle()===t._oRB.getText("WALL_ITEMIMAGE_NEW_TEXT")){t.setTitle(a);}t._iImageStorageId=S;},500);}).fail(function(R){});}}};sap.ino.wall.WallItemImage.prototype._onResize=function(s,d,D){var f;if(!jQuery.support.hasFlexBoxSupport||sap.ui.Device.browser.safari||sap.ui.Device.browser.internet_explorer&&sap.ui.Device.browser.version===10){f=this.$().find(".back .sapInoWallWIIitleEdit").outerHeight()+10;this.$().find(".back .sapInoWallWIIPreviewEdit").height(this.$().find(".back").height()-f);this.$().find(".back .sapInoWallDropUpload").height(this.$().find(".back .sapInoWallWIIPreviewEdit").height());this.$().find(".back .sapInoWallDropUploadArea").css("height",this.$().find(".back .sapInoWallDropUpload").height()+"px");}this._adjustTShirtSize();};sap.ino.wall.WallItemImage.prototype.setTitle=function(t,s){sap.ino.wall.WallItemBase.prototype.setTitle.apply(this,[t,s]);if(t!==this._oRB.getText("WALL_ITEMIMAGE_NEW_TEXT")){this._getInputTitle().setValue(t);this._getInputTitle().$().children("input").attr("value",t);}};sap.ino.wall.WallItemImage.prototype._getBusyIndicator=function(){var b=this.getAggregation("_busyIndicator");if(!b){b=new sap.m.BusyIndicator(this.getId()+"-busy").addStyleClass("sapInoWallIndicatorBusy");this.setAggregation("_busyIndicator",b,true);}return b;};sap.ino.wall.WallItemImage.prototype._getDropUpload=function(){var c=this.getAggregation("_dropUpload");if(!c){c=new sap.ino.wall.DropUpload({size:"L",change:[this._uploadImage,this]});this.setAggregation("_dropUpload",c,true);}return c;};sap.ino.wall.WallItemImage.prototype._getLightBox=function(){var c=this.getAggregation("_lightBox");if(c){this.removeAggregation("_lightBox");c=null;}c=new sap.ino.wall.LightBox({image:this.getImage(),title:this.getTitle()});this.setAggregation("_lightBox",c,true);return c;};sap.ino.wall.WallItemImage.prototype._getCheckBox=function(){var t=this;var c=this.getAggregation("_checkBox");if(!c){c=new sap.m.CheckBox({text:this._oRB.getText("WALL_ITEMIMAGE_SHOW_AS_ICON"),selected:this.getShowAsIcon(),select:function(e){t.setShowAsIcon(e.getSource().getSelected());}});this.setAggregation("_checkBox",c,true);}return c;};sap.ino.wall.WallItemImage.prototype._getIcon=function(){var c=this.getAggregation("_icon");var t=this;var s=100;var i="sap-icon://picture";if(!c){c=new sap.ui.core.Icon({src:i,size:s+"px",width:"100%",height:"0px",decorative:true});this.setAggregation("_icon",c,true);}return c;};sap.ino.wall.WallItemImage.prototype._showLargeImage=function(){this._getLightBox().open();};sap.ino.wall.WallItemImage.prototype.setStatus=function(s){this.setProperty("status",s,true);if(this._isRendered()){var b=sap.ui.getCore().byId(this.getId()+"-busy");var p=sap.ui.getCore().byId(this.getId()+"-preview");if(this.getStatus()==="Busy"){if(b){b.removeStyleClass("sapInoWallInvisible");}if(p){p.addStyleClass("sapInoWallImageBusy");}}else{if(b){b.addStyleClass("sapInoWallInvisible");}if(p){p.removeStyleClass("sapInoWallImageBusy");}}}};sap.ino.wall.WallItemImage.prototype.onAfterRendering=function(){if(this._isRendered()){var f=this.$().find(".front");var r=f.find(".sapInoWallWIResizeHandle");if(this.getShowAsIcon()){r.addClass("sapInoWallWIResizeHandleHidden");}else{r.removeClass("sapInoWallWIResizeHandleHidden");}}};sap.ino.wall.WallItemImage.prototype.formatToJSON=function(){var j=sap.ino.wall.WallItemBase.prototype.formatToJSON.call(this);if(this.getImage()){j.content.image=this.getImage();j.content.assignmentId=this.getAssignmentId();j.content.preview=this.getPreview();}j.content.showAsIcon=this.getShowAsIcon();return j;};})();
