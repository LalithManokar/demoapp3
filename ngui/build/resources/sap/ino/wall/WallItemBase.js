/*!
 * SAP Innovation Management (c) Copyright 2014 SAP AG. All rights reserved.
 */
jQuery.sap.declare("sap.ino.wall.WallItemBase");(function(){"use strict";jQuery.sap.require("sap.ui.core.Control");jQuery.sap.require("sap.ino.wall.util.Helper");jQuery.sap.require("sap.ino.wall.util.Formatter");jQuery.sap.require("sap.ino.wall.config.Config");jQuery.sap.require("sap.ino.wall.TShirtSize");jQuery.sap.require("sap.ino.wall.WallConfig");jQuery.sap.require("sap.ino.wall.WallMode");sap.ui.core.Control.extend("sap.ino.wall.WallItemBase",{metadata:{properties:{"title":{type:"string",group:"Data",defaultValue:null},"x":{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:null},"y":{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:null},"w":{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:"200px"},"h":{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:"200px"},"depth":{type:"int",group:"Appearance",defaultValue:null},"flipped":{type:"boolean",group:"Behavior",defaultValue:null},"enabled":{type:"boolean",group:"Behavior",defaultValue:true},"selected":{type:"boolean",group:"Behavior",defaultValue:false},"storageId":{type:"int",group:"Identification",defaultValue:-1},"resizable":{type:"boolean",group:"Misc",defaultValue:false}},aggregations:{"_buttonFlip":{type:"sap.m.Button",multiple:false,visibility:"hidden"},"_inputTitle":{type:"sap.m.Input",multiple:false,visibility:"hidden"},"_iconResize":{type:"sap.ui.core.Icon",multiple:false,visibility:"hidden"},"childs":{type:"sap.ino.wall.WallItemBase",multiple:true,singularName:"child",bindable:"bindable"}},events:{"dataChange":{},"positionChange":{}}}});sap.ino.wall.WallItemBase.M_EVENTS={'dataChange':'dataChange','positionChange':'positionChange'};sap.ino.wall.WallItemBase.prototype.init=function(){this._oRB=sap.ui.getCore().getLibraryResourceBundle("sap.ino.wall");this._saveTimer=undefined;};sap.ino.wall.WallItemBase.prototype.exit=function(){this._saveTimer=undefined;this._totalDeltaX=0;this._totalDeltaY=0;this._snapDeltaX=0;this._snapDeltaY=0;};sap.ino.wall.WallItemBase.prototype.onAfterRendering=function(){var a=this.$();if(this._onResize){this._onResize(true);}if(this.getParent()instanceof sap.ino.wall.Wall||this.getParent()instanceof sap.ino.wall.WallItemGroup){this._adjustChildContainerPositioning(this.$("childs"));}if(sap.ui.Device.browser.internet_explorer){if(this.getFlipped()){a.children(".flippable").find(".back").css("backface-visibility","visible");a.children(".flippable").find(".front").css("display","none");}}var f=a.find(".sapInoWallWIFlipBackButtonGroup");if(f&&f.length>0){f.attr("aria-label",this._oRB.getText("CTRL_WALL_ITEMBASE_EXP_FLIPBUTTON"));}else{var F=a.find(".sapInoWallWIFlipBackButton");if(F&&F.length>0){F.attr("aria-label",this._oRB.getText("CTRL_WALL_ITEMBASE_EXP_FLIPBUTTON"));}}};sap.ino.wall.WallItemBase.prototype.setFocusVisible=function(v){if(v||v===undefined){this.addStyleClass("sapInoWallWIBVisibleFocus");}else{this.removeStyleClass("sapInoWallWIBVisibleFocus");}};sap.ino.wall.WallItemBase.prototype.onfocusout=function(e){this.removeStyleClass("sapInoWallWIBVisibleFocus");};sap.ino.wall.WallItemBase.prototype.onkeydown=function(e){var a=this.$();if(sap.ino.wall.WallMode.Write!==this.getWall().getMode()){if(this.getFlipped()){this.setFlipped(false,true);a.focus();}return;}if(!e.ctrlKey&&jQuery(e.target).hasClass("sapInoWallWIB")&&(e.keyCode===jQuery.sap.KeyCodes.ENTER||e.keyCode===jQuery.sap.KeyCodes.F2)){this.setBackFocus(true);e.preventDefault();e.stopPropagation();e.stopImmediatePropagation();}else if((jQuery(e.target).hasClass("sapInoWallWIFlipBackButton")||jQuery(e.target).hasClass("sapInoWallWIFlipBackButtonNormal"))&&e.keyCode===jQuery.sap.KeyCodes.ENTER){this.setFlipped(false,true);a.focus();e.preventDefault();e.stopPropagation();e.stopImmediatePropagation();}else if(e.keyCode===jQuery.sap.KeyCodes.TAB&&this.getProperty("flipped")&&!jQuery(e.target).hasClass("sapInoWallWIB")){var i;var b=a.children(".flippable").children(".back").find('input[type=text], textarea, select[tabindex!="-1"], button, [tabindex="0"], .nicEdit-main, .sapInoWallDropUploadArea');var f=a.find(".sapInoWallWIFlipBackButton");if(f&&f.length>0){b.push(f[0]);}b=jQuery.grep(b,function(c){return jQuery(c).is(":visible");});if(b&&b.length>0){var n=a.children(".flippable").children(".back").find('.nicEdit-main');var t=jQuery(e.target).hasClass("nicEdit-main");if(t&&n&&n.length>0){i=b.indexOf(n[0]);n.control(0).blur();}else{i=b.indexOf(e.target);}if(i!==-1){if(e.shiftKey){i--;if(i===-1){i=b.length-1;}}else{i++;if(i>=b.length){i=0;}}}var F=b[i];if(n&&n.length>0&&F===n[0]){jQuery(F).control(0).focus();}else{jQuery(F).focus();}e.preventDefault();e.stopPropagation();e.stopImmediatePropagation();}}else if(e.keyCode===jQuery.sap.KeyCodes.ESCAPE&&this.getProperty("flipped")&&!jQuery(e.target).hasClass("sapInoWallWIB")){this.setFlipped(false,true);a.focus();e.preventDefault();e.stopPropagation();e.stopImmediatePropagation();}};sap.ino.wall.WallItemBase.prototype.formatToJSON=function(){var w=this.getWall(),c=this.getChilds()||[],r,i=0;r={"id":this.getStorageId(),"parentId":(this.getParent()instanceof sap.ino.wall.WallItemBase?this.getParent().getStorageId():"0"),"wallId":w.getStorageId(),"title":this.getTitle(),"className":this.getMetadata()._sClassName,"position":{"x":this.getX(),"y":this.getY()},"w":this.getW(),"h":this.getH(),"depth":this.getDepth(),"content":{}};if(c.length){r.childs=[];for(;i<c.length;i++){r.childs.push(c[i].formatToJSON());}}return r;};sap.ino.wall.WallItemBase.prototype.setTitle=function(t,s){if(this.getTitle()!==t){this.setProperty("title",t,true);if(this._isRendered()){if(this instanceof sap.ino.wall.WallItemGroup){this.$().children(".flippable").children(".front").find(".sapInoWallWIGTitle").find(".sapInoWallWITitleText").text(t);}else{this.$().children(".flippable").children(".front").find(".sapInoWallWITitleText").text(t);}}if(this.getParent()&&!s){this.getParent()._notifyItemChanged(this);}}return this;};sap.ino.wall.WallItemBase.prototype.setDepth=function(d){if(this.getDepth()!==d){this.setProperty("depth",d,true);this.$().css("z-index",d);if(this.getParent()){this.getParent()._notifyItemChanged(this);}}return this;};sap.ino.wall.WallItemBase.prototype.setEnabled=function(e){if(this.getEnabled()!==e){this.setProperty("enabled",e,true);if(e){this.removeStyleClass("sapInoWallWIBDisabled");}else{this.addStyleClass("sapInoWallWIBDisabled");}}return this;};sap.ino.wall.WallItemBase.prototype.setSelected=function(s){if(this.getSelected()!==s){this.setProperty("selected",s,true);if(s){this.addStyleClass("sapInoWallWIBSelected");}else{this.removeStyleClass("sapInoWallWIBSelected");}}return this;};sap.ino.wall.WallItemBase.prototype.setStorageId=function(v){this.setProperty("storageId",v,true);return this;};sap.ino.wall.WallItemBase.prototype.setX=function(v){if(jQuery.type(v)==="number"){v+="px";}if(this.getX()!==v){this.setProperty("x",v,true);this.$().css("left",v);if(this.getParent()){this.getParent()._notifyItemChanged(this);}}return this;};sap.ino.wall.WallItemBase.prototype.setY=function(v){if(jQuery.type(v)==="number"){v+="px";}if(this.getY()!==v){this.setProperty("y",v,true);this.$().css("top",v);if(this.getParent()){this.getParent()._notifyItemChanged(this);}}return this;};sap.ino.wall.WallItemBase.prototype.setXY=function(x,y){this.setX(x);this.setY(y);return this;};sap.ino.wall.WallItemBase.prototype.setW=function(v){var V=parseInt(v,10);if(jQuery.type(v)==="number"){v+="px";}if(this instanceof sap.ino.wall.WallItemSprite){if(V<=48){v="48px";}}else if(this instanceof sap.ino.wall.WallItemArrow){if(V<=1){v="1px";}}else if(V<sap.ino.wall.WallConfig._ITEM_MIN_SIZE){v=sap.ino.wall.WallConfig._ITEM_MIN_SIZE+"px";}if(this.getW()!==v){this.setProperty("w",v,true);this.$().css("width",v);this.$("front").css("width",v);this.$("back").css("width",v);if(this.getParent()){this.getParent()._notifyItemChanged(this);}}return this;};sap.ino.wall.WallItemBase.prototype.setH=function(v){var V=parseInt(v,10);if(jQuery.type(v)==="number"){v+="px";}if(this instanceof sap.ino.wall.WallItemSprite){if(V<=48){v="48px";}}else if(this instanceof sap.ino.wall.WallItemArrow){if(V<=1){v="1px";}}else if(V<sap.ino.wall.WallConfig._ITEM_MIN_SIZE){v=sap.ino.wall.WallConfig._ITEM_MIN_SIZE+"px";}if(this.getH()!==v){this.setProperty("h",v,true);this.$().css("height",v);this.$("front").css("height",v);this.$("back").css("height",v);if(this.getParent()){this.getParent()._notifyItemChanged(this);}}return this;};sap.ino.wall.WallItemBase.prototype.setWH=function(w,h){this.setW(w);this.setH(h);return this;};sap.ino.wall.WallItemBase.prototype.setFlipped=function(f,v){var t=this,a=this.$(),w=this.getWall();if(!w){return;}if(w.getMode()==="Readonly"){if(this.getFlipped()){f=false;}else{return;}}if(this._bFlipModeSquad){return;}if(sap.ui.Device.browser.firefox){if(f){setTimeout(function(){a.children(".flippable").find(".front").css("display","none");},180);}else{setTimeout(function(){a.children(".flippable").find(".front").css("display","block");},200);this.$().children(".flippable").find("input[type=text], textarea, select").blur();}}else if(sap.ui.Device.browser.internet_explorer){if(sap.ui.Device.browser.version>=10){if(f!==this.getFlipped()&&!this._bFlipModeSquad){this._bFlipModeSquad=true;if(!f){a.children(".flippable").find(".back").css("backface-visibility","visible");}if(f){a.children(".flippable").find(".back").css("backface-visibility","hidden");setTimeout(function(){a.children(".flippable").find(".back").css("backface-visibility","visible");a.children(".flippable").find(".front").css("display","none");},250);}else{setTimeout(function(){a.children(".flippable").find(".back").css("backface-visibility","hidden");a.children(".flippable").find(".front").css("display","block");},250);}setTimeout(function(){t._bFlipModeSquad=false;},600);}this.$().children(".flippable").find("input[type=text], textarea, select").blur();}else{a.children(".flippable").find(".front").css("display",(f?"none":"block"));a.children(".flippable").find(".back").css("display",(!f?"none":"block"));if(this._onResize){this._onResize(true);}}}a.children(".flippable").find(".front").css("visibility","visible");a.children(".flippable").find(".back").css("visibility","visible");setTimeout(function(){a.children(".flippable").find(".front").css("visibility",(f?"hidden":"visible"));a.children(".flippable").find(".back").css("display",(f?"visible":"hidden"));},300);if(f&&!this.getFlipped()){if(!sap.ui.Device.support.touch){setTimeout(function(){a.children(".flippable").children(".back").find('input[type=text], textarea, select[tabindex!="-1"], button, [tabindex="0"], .sapInoWallDropUploadArea').filter(':visible:first').focus();if(t.$().find(".nicEdit-main").control(0)){t.$().find(".nicEdit-main").control(0).focus();}},300);}}else{if(this.$().find(".nicEdit-main").control(0)){this.$().find(".nicEdit-main").control(0).blur();}}if(!f){setTimeout(function(){t.setFocusVisible(v===true);a.focus();},200);}this.setProperty("flipped",f,true);this.$().toggleClass("flipped",f);};sap.ino.wall.WallItemBase.prototype.setBackFocus=function(){var t=this,a=this.$();if(this.getFlipped()){if(!sap.ui.Device.support.touch){a.children(".flippable").children(".back").find('input[type=text], textarea, select[tabindex!="-1"], button, [tabindex="0"], .sapInoWallDropUploadArea').filter(':visible:first').focus();if(t.$().find(".nicEdit-main").control(0)){t.$().find(".nicEdit-main").control(0).focus();}}}else{this.setFlipped(true);}};sap.ino.wall.WallItemBase.prototype.addChildWithoutRendering=function(i){var a=this.$("childs");if(!this.getW()&&!(this instanceof sap.ino.wall.WallItemHeadline)){this.setW(sap.ino.wall.WallConfig._ITEM_MIN_SIZE+"px");}this.addAggregation("childs",i,true);sap.ino.wall.util.Helper.renderItemIntoContainer(a[0],i,false,true);a.removeClass("sapInoWallInvisible");this._adjustChildContainerPositioning(a);return this;};sap.ino.wall.WallItemBase.prototype.removeChildWithoutRendering=function(i){var a=this.$("childs"),c=this.getChilds()||[];this.removeAggregation("childs",i,true);i.$().remove();if(c.length===0){a.addClass("sapInoWallInvisible");}else{this._adjustChildContainerPositioning(a);}return this;};sap.ino.wall.WallItemBase.prototype._adjustChildContainerPositioning=function(a){var l=parseInt(this.getW(),10)-20,w,h,z;if(sap.ui.Device.browser.chrome){l/=sap.ino.wall.WallConfig._ITEM_CHILD_ZOOM;}a.css("left",(isNaN(l)?"0":l)+"px");a.css("top","30px");if(!sap.ino.wall.config.Config.getZoomCapable()){w=parseInt(a.css("width"),10);h=parseInt(a.css("height"),10);z=sap.ino.wall.WallConfig._ITEM_CHILD_ZOOM;a.css("left",parseInt(a.css("left"),10)+(w*z-w)/2.0);a.css("top",parseInt(a.css("top"),10)+(h*z-h)/2.0);}return this;};sap.ino.wall.WallItemBase.prototype.getWall=function(){var p=this,i=0;while(i<3&&p){p=p.getParent();if(p instanceof sap.ino.wall.Wall){return p;}i++;}};sap.ino.wall.WallItemBase.prototype.onselectstart=function(e){if(this._bMoving){e.preventDefault();e.stopPropagation();return false;}else{sap.ui.core.Control.prototype.onselectstart.apply(this,arguments);}};sap.ino.wall.WallItemBase.prototype.ondragstart=function(e){e.data=this.getStorageId();e.preventDefault();e.stopPropagation();};sap.ino.wall.WallItemBase.prototype.ontouchstart=function(e){var w=this.getWall(),c;if(w.getMode()==="Readonly"||w._bSpacePressed){return;}if(w._hasFollowCursorItems()){return;}if(e.isMarked("_sapInoWallInnerItemMove")){return;}if(sap.ui.Device.browser.firefox&&(jQuery(e.target).parent().hasClass("sapMTextArea")||jQuery(e.target).hasClass("sapInoWallScrollable"))&&(e.pageX-jQuery(e.target).offset().left-jQuery(e.target).width()*w.getZoom()/100>-16*w.getZoom()/100||e.pageY-$(e.target).offset().top-$(e.target).height()*w.getZoom()/100>-16*w.getZoom()/100)){e.preventDefault();e.stopPropagation();return;}if(sap.ui.Device.browser.internet_explorer&&(this instanceof sap.ino.wall.WallItemText&&jQuery(e.target).control(0)instanceof sap.m.ScrollContainer||jQuery(e.target).hasClass("sapInoWallScrollable"))&&e.target.clientWidth&&e.offsetX-e.target.clientWidth>0&&e.offsetX-e.target.clientWidth<20*w.getZoom()/100){e.preventDefault();e.stopPropagation();return;}if((jQuery(e.target).filter('input[type=text],textarea,select').length)||e.srcControl instanceof sap.ino.wall.TextEditor){if(this._touchMode!==sap.ino.wall.WallConfig._ITEM_TOUCHMODE_MOVECHILD){this.setDepth(w._getNextDepth());}return;}e.setMarked("_sapInoWallInnerItemMove");var C=false;if(typeof this.onTouchStartItem==="function"){C=this.onTouchStartItem(e);if(C==null||C==undefined){return true;}}if(!C){if(this.getParent()instanceof sap.ino.wall.WallItemBase&&!(this.getParent()instanceof sap.ino.wall.WallItemGroup)){this._touchMode=sap.ino.wall.WallConfig._ITEM_TOUCHMODE_MOVECHILD;}else if(this.getResizable()&&(jQuery(e.target).hasClass("sapInoWallWIResizeHandle")||jQuery(e.target).parent().hasClass("sapInoWallWIResizeHandle"))){this._touchMode=sap.ino.wall.WallConfig._ITEM_TOUCHMODE_RESIZE;this._touchStartItemWidth=parseFloat(this.getW()?this.getW():"160px");this._touchStartItemHeight=parseFloat(this.getH()?this.getH():"160px");this._touchStartItemX=parseFloat(this.getX());this._touchStartItemY=parseFloat(this.getY());}else if(this.getParent()instanceof sap.ino.wall.WallItemGroup){this._touchMode=sap.ino.wall.WallConfig._ITEM_TOUCHMODE_MOVEGROUPITEM;}else{this._touchMode=sap.ino.wall.WallConfig._ITEM_TOUCHMODE_MOVE;}}jQuery(document).disableSelection();if(e.shiftKey&&!e.ctrlKey&&this._touchMode!==sap.ino.wall.WallConfig._ITEM_TOUCHMODE_RESIZE){w._toggleSelection(this);return false;}if(e.ctrlKey&&this._touchMode!==sap.ino.wall.WallConfig._ITEM_TOUCHMODE_RESIZE){w._iItemClonePosition=[sap.ino.wall.util.Helper.getEventX(e),sap.ino.wall.util.Helper.getEventY(e)];c=this._clone();w.placeItem(c,sap.ino.wall.WallConfig._ADD_MODE_CLONE);e.preventDefault();e.stopPropagation();return false;}if(!this._touchEndProxy){this._touchEndProxy=jQuery.proxy(this._ontouchend,this);}if(!this._touchMoveProxy){this._touchMoveProxy=jQuery.proxy(this._ontouchmove,this);}jQuery(document).on("touchend touchcancel mouseup",this._touchEndProxy);jQuery(document).on("touchmove mousemove",this._touchMoveProxy);this._totalDeltaX=0;this._totalDeltaY=0;if(this instanceof sap.ino.wall.WallItemLine){this._snapDeltaX=0;this._snapDeltaY=0;}this._touchStartMousePositionX=sap.ino.wall.util.Helper.getEventX(e);this._touchStartMousePositionY=sap.ino.wall.util.Helper.getEventY(e);if(this._touchMode!==sap.ino.wall.WallConfig._ITEM_TOUCHMODE_MOVECHILD){this.setDepth(w._getNextDepth());}};sap.ino.wall.WallItemBase.prototype._clone=function(){var c=this.clone();c.unbindProperty("title");c.setTitle(this.getTitle());var C=-1;c.setStorageId(C--);c.setSelected(false);r(c);function r(c){jQuery.each(c.getChilds(),function(i,o){o.setStorageId(C--);o.setSelected(false);r(o);});}return c;};sap.ino.wall.WallItemBase.prototype._ontouchmove=function(e){var w=this.getWall(),t,T,d=sap.ino.wall.util.Helper.getEventX(e)-this._touchStartMousePositionX,D=sap.ino.wall.util.Helper.getEventY(e)-this._touchStartMousePositionY,o=this.$().offset(),z,a=null,b,c,f,g,C,h,j,k,l,s,i=0,m;if(!w){jQuery(document).unbind("touchend touchcancel mouseup",this._touchEndProxy);jQuery(document).unbind("touchmove mousemove",this._touchMoveProxy);this._bMoving=false;return;}z=100/w.getZoom();b=w.$("trash");if(sap.ui.Device.browser.chrome){a=w.$("trashAbove");}c=Math.abs(sap.ino.wall.util.Helper.getEventX(e)-b.offset().left-100);f=Math.abs(sap.ino.wall.util.Helper.getEventY(e)-b.offset().top-100);this._touchStartMousePositionX=sap.ino.wall.util.Helper.getEventX(e);this._touchStartMousePositionY=sap.ino.wall.util.Helper.getEventY(e);this._fDeltaX=d;this._fDeltaY=D;this._totalDeltaX+=d;this._totalDeltaY+=D;if((jQuery(e.target).filter('input[type=text],textarea,select').length)||e.srcControl instanceof sap.ino.wall.TextEditor){return;}t=jQuery(e.target).control(0);if(t){T=t.getParent();}if(t instanceof sap.m.Select||t instanceof sap.m.Button||t instanceof sap.m.SegmentedButton||t instanceof sap.ino.wall.DropUpload){return;}else if(T&&T instanceof sap.m.Select||T instanceof sap.m.Button||T instanceof sap.m.SegmentedButton||T instanceof sap.ino.wall.DropUpload){return;}if(e.isMarked("_sapInoWallChildMove")){return;}if(this._touchMode===sap.ino.wall.WallConfig._ITEM_TOUCHMODE_MOVECHILD){if(d||D){this._bMoving=true;w._bMovingItem=true;}e.setMarked("_sapInoWallChildMove",true);if(Math.abs(this._totalDeltaX)>=sap.ino.wall.WallConfig._ITEM_CHILD_UNSNAP_DISTANCE||Math.abs(this._totalDeltaY)>=sap.ino.wall.WallConfig._ITEM_CHILD_UNSNAP_DISTANCE){this.removeStyleClass("sapInoWallWIBUnsnap");this.getParent().removeChildWithoutRendering(this);w._onmousemoveItemUpdate(this,undefined,e);w.placeItem(this,sap.ino.wall.WallConfig._ADD_MODE_DETACHGROUPITEM);jQuery(document).unbind("touchend touchcancel mouseup",this._touchEndProxy);jQuery(document).unbind("touchmove mousemove",this._touchMoveProxy);this._bMoving=false;w._bMovingItem=false;return;}else{this.addStyleClass("sapInoWallWIBUnsnap");}}else if(this._touchMode===sap.ino.wall.WallConfig._ITEM_TOUCHMODE_MOVE||this._touchMode===sap.ino.wall.WallConfig._ITEM_TOUCHMODE_MOVEGROUPITEM){if(this._totalDeltaX>0||this._totalDeltaY>0){this.$().addClass("dragCursor");}if(this instanceof sap.ino.wall.WallItemLine){this._snapDeltaX+=d;this._snapDeltaY+=D;if(this.getOrientation()==="HORIZONTAL"){d=0;if(Math.abs(this._snapDeltaX)>200){this.setOrientation("VERTICAL");this._snapDeltaX=0;this._snapDeltaY=0;}}else if(this.getOrientation()==="VERTICAL"){D=0;if(Math.abs(this._snapDeltaY)>200){this.setOrientation("HORIZONTAL");this._snapDeltaX=0;this._snapDeltaY=0;}}}if(d||D){this._bMoving=true;w._bMovingItem=true;h=parseFloat(this.getX())||0;j=parseFloat(this.getY())||0;this.setXY((h+d*z)+"px",(j+D*z)+"px");if(this._touchMode===sap.ino.wall.WallConfig._ITEM_TOUCHMODE_MOVEGROUPITEM){this.getParent()._recalculateItemDimensions=true;k=parseInt(this.getW(),10)||sap.ino.wall.WallConfig._ITEM_MIN_SIZE;l=parseInt(this.getH(),10)||sap.ino.wall.WallConfig._ITEM_MIN_SIZE;if(h<0||j<0||h+k>(parseInt(this.getParent().getW(),10||sap.ino.wall.WallConfig._ITEM_MIN_SIZE))||j+l>(parseInt(this.getParent().getH(),10)||sap.ino.wall.WallConfig._ITEM_MIN_SIZE)){this.getParent().removeChildWithoutRerendering(this);w._onmousemoveItemUpdate(this,undefined,e);w.placeItem(this,sap.ino.wall.WallConfig._ADD_MODE_DETACHCHILD);jQuery(document).unbind("touchend touchcancel mouseup",this._touchEndProxy);jQuery(document).unbind("touchmove mousemove",this._touchMoveProxy);this._bMoving=false;w._bMovingItem=false;return false;}}s=w._aSelectedItems||[];if(s.length){if(!(this instanceof sap.ino.wall.WallItemLine)&&$.inArray(this,s)>=0){for(;i<s.length;i++){if(s[i].getId()===this.getId()||s[i]instanceof sap.ino.wall.WallItemLine){continue;}h=parseFloat(s[i].getX())||0;j=parseFloat(s[i].getY())||0;s[i].setXY((h+d*z)+"px",(j+D*z)+"px");}}}}b.clearQueue().css("opacity",1);if(sap.ui.Device.browser.chrome){a.css("opacity",1);}b.css("z-index",this.getDepth()-1);if(c<100&&f<100&&(this._totalDeltaX>25||this._totalDeltaY>25)){b.addClass("active");if(sap.ui.Device.browser.chrome){a.addClass("active");}}else{b.removeClass("active");if(sap.ui.Device.browser.chrome){a.removeClass("active");}}}else if(this._touchMode===sap.ino.wall.WallConfig._ITEM_TOUCHMODE_RESIZE){if(e.isMarked("_sapInoWallGroupItemResize")){return;}d=this._totalDeltaX;D=this._totalDeltaY;if(d||D){this._bMoving=true;w._bMovingItem=true;if(e.shiftKey){m=Math.max(this._totalDeltaX,this._totalDeltaY);d=m;D=m;}this.setWH((this._touchStartItemWidth+(e.ctrlKey?d*2.0:d)*z)+"px",(this._touchStartItemHeight+(e.ctrlKey?D*2.0:D)*z)+"px");if(e.ctrlKey){if(parseInt(this.getW(),10)>sap.ino.wall.WallConfig._ITEM_MIN_SIZE){this.setX((this._touchStartItemX-d*z)+"px");}if(parseInt(this.getH(),10)>sap.ino.wall.WallConfig._ITEM_MIN_SIZE){this.setY((this._touchStartItemY-D*z)+"px");}}C=this.getChilds()||[];if(C.length){g=this.$("childs");this._adjustChildContainerPositioning(g);}if(this._onResize){this._onResize(false,d*z,D*z);}if(this.getParent()instanceof sap.ino.wall.WallItemGroup){e.setMarked("_sapInoWallGroupItemResize",true);}}}if(sap.ino.wall.config.Config.getDebugPositioning()){w._calculateAllCollisions(this,sap.ino.wall.WallConfig._COLLISION_ALL,this);}e.preventDefault();e.stopPropagation();};sap.ino.wall.WallItemBase.prototype._ontouchend=function(e){var t=this,w=this.getWall(),a=this.$(),b=null,c,T,d,C=this.getChilds()||[],f=true,s,i=0,D,o,z,l,g,h=[],j,k,m,M,n,G;if(!w){jQuery(document).unbind("touchend touchcancel mouseup",this._touchEndProxy);jQuery(document).unbind("touchmove mousemove",this._touchMoveProxy);this._bMoving=false;return false;}c=w.$("trash");if(sap.ui.Device.browser.chrome){b=w.$("trashAbove");}T=Math.abs(sap.ino.wall.util.Helper.getEventX(e)-c.offset().left-100);d=Math.abs(sap.ino.wall.util.Helper.getEventY(e)-c.offset().top-100);jQuery(document).enableSelection();if(this._touchMode===sap.ino.wall.WallConfig._ITEM_TOUCHMODE_MOVECHILD){jQuery(document).unbind("touchend touchcancel mouseup",this._touchEndProxy);jQuery(document).unbind("touchmove mousemove",this._touchMoveProxy);this._bMoving=false;w._bMovingItem=false;return false;}if(!this._bMoving&&this._touchMode!==sap.ino.wall.WallConfig._ITEM_TOUCHMODE_RESIZE){if(a[0].contains(e.target)){if(this.getParent()instanceof sap.ino.wall.WallItemBase&&!(this.getParent()instanceof sap.ino.wall.WallItemGroup)){f=false;}if(jQuery(e.target).hasClass("sapMScrollCont")||jQuery(e.target).hasClass("sapInoWallScrollable")){D=sap.ino.wall.util.Helper.getEventX(e)-this._touchStartMousePositionX+sap.ino.wall.util.Helper.getEventY(e)-this._touchStartMousePositionY;if(D){f=false;}}f=f&&!(jQuery(e.target).filter('.noflip,input[type=text],textarea,select,.sapMImg,.sapMBtnIcon').length)&&!((jQuery(e.target).control(0))&&jQuery(e.target).control(0).hasStyleClass("noflip"))&&!jQuery(e.target).parent().hasClass("sapMSlt")&&!jQuery(e.target).parent().hasClass("noflip")&&!(jQuery(e.target).attr("class")&&jQuery(e.target).attr("class").trim().indexOf("nicEdit")===0)&&!jQuery(e.target).filter(".sapMInputBasePlaceholder").length&&!e._sapwallDoNotFlip;if(f){if(!w._hasFollowCursorItems()){this.setFlipped(!this.getFlipped());e.preventDefault();e.stopPropagation();}}}}else{w._updateBoundingBox();}this.$().removeClass("dragCursor");if(c.css("opacity")>0){c.css("opacity",1).clearQueue().animate({opacity:"0"},500);}if(sap.ui.Device.browser.chrome){b.css("opacity",0);}if(this._touchMode!==sap.ino.wall.WallConfig._ITEM_TOUCHMODE_RESIZE&&T<100&&d<100&&(this._totalDeltaX>25||this._totalDeltaY>25)&&!this._ignoreTrash){s=w._aSelectedItems||[];if(s.length){if(!(this instanceof sap.ino.wall.WallItemLine)&&$.inArray(this,s)>=0){w.deleteItems(s);w._clearSelection();}}else{w.deleteItems([this]);}w._bMovingItem=false;c.removeClass("active");if(sap.ui.Device.browser.chrome){b.removeClass("active");}}if(this._touchMode!==sap.ino.wall.WallConfig._ITEM_TOUCHMODE_RESIZE&&sap.ino.wall.config.Config.getEnableChildItems()&&this._bMoving&&!(this instanceof sap.ino.wall.WallItemLine)&&!(this instanceof sap.ino.wall.WallItemGroup)){o=w.$("inner").offset();z=100/w.getZoom();l=sap.ino.wall.util.Helper.getEventX(e);g=sap.ino.wall.util.Helper.getEventY(e);if(!sap.ino.wall.config.Config.getZoomCapable()){l=(l+Math.abs(o.left))*z;g=(g+Math.abs(o.top))*z;}else{l=l*z-o.left;g=(g)*z-o.top;}if(!C.length&&this._touchMode===sap.ino.wall.WallConfig._ITEM_TOUCHMODE_MOVEGROUPITEM){G=this.getParent();l-=parseInt(G.getX(),10);g-=parseInt(G.getY(),10);h=w._calculateCollisions(G.getChilds(),[l,g,0,0],sap.ino.wall.WallConfig._COLLISION_INTERSECTIONS,this)[0];}else if(this._touchMode===sap.ino.wall.WallConfig._ITEM_TOUCHMODE_MOVE_START||this._touchMode===sap.ino.wall.WallConfig._ITEM_TOUCHMODE_MOVE_END){h=[];}else if(this._touchMode!==sap.ino.wall.WallConfig._ITEM_TOUCHMODE_MOVEGROUPITEM){h=w._calculateAllCollisions([l,g,0,0],sap.ino.wall.WallConfig._COLLISION_INTERSECTIONS,this)[0];}if(h.length>1){i=0;j=0;k=99999;m=0;M=0;n=null;for(;i<h.length;i++){m=parseInt(h[i].getX(),10)+(h[i].getW()?parseInt(h[i].getW(),10):sap.ino.wall.WallConfig._ITEM_MIN_SIZE)/2;M=parseInt(h[i].getY(),10)+(h[i].getH()?parseInt(h[i].getH(),10):sap.ino.wall.WallConfig._ITEM_MIN_SIZE)/2;j=Math.sqrt(Math.pow(m-l,2)+Math.pow(M-g,2));if(j<k){k=j;n=h[i];}}if(n){h=[n];}}if(h.length>0){if(!C.length||C.length&&h[0]instanceof sap.ino.wall.WallItemGroup){if(h[0]instanceof sap.ino.wall.WallItemGroup||!(this instanceof sap.ino.wall.WallItemArrow)){this.setFlipped(false);h[0].setFlipped(false);w.removeItemWithoutRendering(this);h[0].addChildWithoutRendering(this);h[0].setDepth(w._getNextDepth());if(!(h[0]instanceof sap.ino.wall.WallItemGroup)){sap.m.MessageToast.show(sap.ino.wall.util.Helper.stringFormat(this._oRB.getText("WALL_TOOLTIP_ADD_CHILD"),sap.ino.wall.util.Helper.stripTags(this.getTitle()),sap.ino.wall.util.Helper.stripTags(h[0].getTitle())));}else{sap.m.MessageToast.show(sap.ino.wall.util.Helper.stringFormat(this._oRB.getText("WALL_TOOLTIP_ADD_GROUP"),sap.ino.wall.util.Helper.stripTags(this.getTitle()),sap.ino.wall.util.Helper.stripTags(h[0].getTitle())));h[0]._notifyItemChanged(h[0]);}this._notifyItemChanged(this);}}}}setTimeout(function(){t._bMoving=false;if(w){w._bMovingItem=false;}},0);if(this._touchMode===sap.ino.wall.WallConfig._ITEM_TOUCHMODE_RESIZE){if(this._onResizeEnd){this._onResizeEnd();}}jQuery(document).unbind("touchend touchcancel mouseup",this._touchEndProxy);jQuery(document).unbind("touchmove mousemove",this._touchMoveProxy);};sap.ino.wall.WallItemBase.prototype._isRendered=function(){if(this._bIsInDOM===undefined||this._bIsInDOM===0){this._bIsInDOM=jQuery.sap.byId(this.getId()).length;}return this._bIsInDOM;};sap.ino.wall.WallItemBase.prototype._renderItemIntoContainer=function(d,i,D,I){var r;if(d){r=sap.ui.getCore().createRenderManager();r.renderControl(i);r.flush(d,D,I);r.destroy();}return this;};sap.ino.wall.WallItemBase.prototype._adjustTShirtSize=function(){var w=parseInt(this.getW(),10),h=parseInt(this.getH(),10),s=sap.ino.wall.TShirtSize.S;if(isNaN(w)||isNaN(h)){return;}if(w<100||h<100){s=sap.ino.wall.TShirtSize.XS;this.addStyleClass(s);this.removeStyleClass(sap.ino.wall.TShirtSize.S);this.removeStyleClass(sap.ino.wall.TShirtSize.M);this.removeStyleClass(sap.ino.wall.TShirtSize.L);this.removeStyleClass(sap.ino.wall.TShirtSize.XL);}else if(w<300||h<200){s=sap.ino.wall.TShirtSize.S;this.removeStyleClass(sap.ino.wall.TShirtSize.XS);this.addStyleClass(s);this.removeStyleClass(sap.ino.wall.TShirtSize.M);this.removeStyleClass(sap.ino.wall.TShirtSize.L);this.removeStyleClass(sap.ino.wall.TShirtSize.XL);}else if(w<450||h<400){s=sap.ino.wall.TShirtSize.M;this.removeStyleClass(sap.ino.wall.TShirtSize.XS);this.removeStyleClass(sap.ino.wall.TShirtSize.S);this.addStyleClass(s);this.removeStyleClass(sap.ino.wall.TShirtSize.L);this.removeStyleClass(sap.ino.wall.TShirtSize.XL);}else if(w<600||h<600){s="L";this.removeStyleClass(sap.ino.wall.TShirtSize.XS);this.removeStyleClass(sap.ino.wall.TShirtSize.S);this.removeStyleClass(sap.ino.wall.TShirtSize.M);this.addStyleClass(s);this.removeStyleClass(sap.ino.wall.TShirtSize.XL);}else{s=sap.ino.wall.TShirtSize.XL;this.removeStyleClass(sap.ino.wall.TShirtSize.XS);this.removeStyleClass(sap.ino.wall.TShirtSize.S);this.removeStyleClass(sap.ino.wall.TShirtSize.M);this.removeStyleClass(sap.ino.wall.TShirtSize.L);this.addStyleClass(s);}return s;};sap.ino.wall.WallItemBase.prototype._notifyItemChanged=function(i){if(i.getParent()instanceof sap.ino.wall.WallItemGroup&&this.getWall()){this.getWall()._notifyItemChanged(i);}else if(this.getParent()){this.getParent()._notifyItemChanged(i);}};sap.ino.wall.WallItemBase.prototype._getButtonFlip=function(){var t=this,b=this.getAggregation("_buttonFlip");if(!b){b=new sap.m.Button({icon:sap.ui.core.IconPool.getIconURI("redo"),press:function(e){t.setFlipped(false);if(e){e.preventDefault();}},tooltip:this._oRB.getText("CTRL_WALL_ITEMBASE_EXP_FLIPBUTTON")}).addStyleClass("sapInoWallWIFlipBackButton");this.setAggregation("_buttonFlip",b,true);}return b;};sap.ino.wall.WallItemBase.prototype._getIconResize=function(){var i=this.getAggregation("_iconResize");if(!i){i=new sap.ui.core.Icon({src:"sap-icon://dropdown",size:"15px",width:"12px",height:"15px",decorative:true});this.setAggregation("_iconResize",i,true);}return i;};sap.ino.wall.WallItemBase.prototype._getInputTitle=function(){var t=this,c=this.getAggregation("_inputTitle"),T=sap.ino.wall.util.Formatter.escapeBindingCharacters(this.getTitle()),s=this.getMetadata()._sClassName.split(".").pop().replace("WallItem","").toUpperCase();if(!c){c=new sap.m.Input({value:(T===this._oRB.getText("WALL_ITEM"+s+"_NEW_TEXT")?"":T),maxLength:500,change:function(e){t.setTitle(e.getParameter("newValue"),false,true);}}).addStyleClass("sapInoWallWIBTitle");this.setAggregation("_inputTitle",c,true);}return c;};})();
