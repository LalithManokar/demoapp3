/*!
 * SAP Innovation Management (c) Copyright 2014 SAP AG. All rights reserved.
 */
jQuery.sap.declare("sap.ino.wall.WallItemPerson");(function(){"use strict";jQuery.sap.require("sap.ino.wall.WallItemBase");jQuery.sap.require("sap.ino.wall.util.Formatter");jQuery.sap.require("sap.ino.wall.DropUpload");jQuery.sap.require("sap.ino.commons.models.object.Attachment");jQuery.sap.require("sap.ino.commons.application.Configuration");var C=sap.ino.commons.application.Configuration;sap.ino.wall.WallItemBase.extend("sap.ino.wall.WallItemPerson",{metadata:{properties:{"status":{type:"string",group:"Behavior",defaultValue:'Normal'},"image":{type:"sap.ui.core.URI",group:"Behavior",defaultValue:null},"phone":{type:"string",group:"Misc",defaultValue:null},"email":{type:"string",group:"Misc",defaultValue:null},"originId":{type:"int",group:"Misc",defaultValue:0},"requestImage":{type:"boolean",group:"Misc",defaultValue:false},"assignmentId":{type:"int",group:"Identification",defaultValue:-1}},aggregations:{"_image":{type:"sap.m.Image",multiple:false,visibility:"hidden"},"_inputPhone":{type:"sap.m.Input",multiple:false,visibility:"hidden"},"_inputEmail":{type:"sap.m.Input",multiple:false,visibility:"hidden"},"_linkPhone":{type:"sap.m.Link",multiple:false,visibility:"hidden"},"_linkEmail":{type:"sap.m.Link",multiple:false,visibility:"hidden"},"_busyIndicator":{type:"sap.m.BusyIndicator",multiple:false,visibility:"hidden"},"_dropUpload":{type:"sap.ino.wall.DropUpload",multiple:false,visibility:"hidden"}}}});sap.ino.wall.WallItemPerson._DEFAULT_IMAGE="images/default/person.png";sap.ino.wall.WallItemPerson.prototype.init=function(){sap.ino.wall.WallItemBase.prototype.init.call(this);};sap.ino.wall.WallItemPerson.prototype._getInputEmail=function(){var t=this,c=this.getAggregation("_inputEmail");if(!c){c=new sap.m.Input({value:this.getEmail(),placeholder:this._oRB.getText("WALL_ITEMPERSON_PLACEHOLDER_EMAIL"),change:function(e){t.setEmail(e.getParameter("newValue"),false,true);}}).addStyleClass("sapInoWallWIPEmailIP");this.setAggregation("_inputEmail",c,true);}return c;};sap.ino.wall.WallItemPerson.prototype._getInputTitle=function(){var e=!this.getAggregation("_inputTitle");var t=sap.ino.wall.WallItemBase.prototype._getInputTitle.apply(this,arguments);if(e){t.setShowSuggestion(true);t.attachSuggest(function(E){var v=E.getParameter("suggestValue");var l=new sap.ui.core.ListItem({text:"{data>NAME}",additionalText:"{data>USER_NAME}",key:"{data>ID}"});E.getSource().bindAggregation("suggestionItems",{path:"data>/SearchIdentityWallItemPerson(searchToken='"+jQuery.sap.encodeURL(v)+"')/Results",template:l,parameters:{select:"searchToken,ID,NAME,USER_NAME"}});});t.setFilterFunction(function(v,i){return true;});}return t;};sap.ino.wall.WallItemPerson.prototype._getInputPhone=function(){var t=this,c=this.getAggregation("_inputPhone");if(!c){c=new sap.m.Input({value:this.getPhone(),placeholder:this._oRB.getText("WALL_ITEMPERSON_PLACEHOLDER_PHONE"),change:function(e){t.setPhone(e.getParameter("newValue"));}}).addStyleClass("sapInoWallWIPPhoneIP");this.setAggregation("_inputPhone",c,true);}return c;};sap.ino.wall.WallItemPerson.prototype._getBusyIndicator=function(){var b=this.getAggregation("_busyIndicator");if(!b){b=new sap.m.BusyIndicator(this.getId()+"-busy").addStyleClass("sapInoWallIndicatorBusy");this.setAggregation("_busyIndicator",b,true);}return b;};sap.ino.wall.WallItemPerson.prototype.setImage=function(u,s){var t=this;t.$().find(".sapInoWallWIPImageWrapper").addClass("sapInoWallWIPImageWrapperDefaultImage");var o=this.getAggregation("_image"),n=null,i=function(e){if(sap.m.Image.prototype.onload){sap.m.Image.prototype.onload.apply(this,arguments);}t.$().find(".sapInoWallWIPImageWrapper").removeClass("sapInoWallWIPImageWrapperDefaultImage");t.setStatus("Normal");},I=function(e){if(sap.m.Image.prototype.onerror){sap.m.Image.prototype.onerror.apply(this,arguments);}t.$().find(".sapInoWallWIPImageWrapper").addClass("sapInoWallWIPImageWrapperDefaultImage");t.setStatus("Normal");};this.setProperty("image",u,(o?true:false));if(o){o.destroy();}n=new sap.m.Image({src:u,densityAware:false}).addEventDelegate({onBeforeRendering:function(e){var a=e.srcControl,$=a.$();$.unbind("load",a.___onloadproxy);$.unbind("error",a.___onloadproxy);},onAfterRendering:jQuery.proxy(function(e){var a=e.srcControl,$=a.$();if(!a.___onloadproxy){a.___onloadproxy=jQuery.proxy(a.onload,a);a.___onerrorproxy=jQuery.proxy(a.onerror,a);}$.bind("load",jQuery.proxy(a.___onloadproxy,a));$.bind("error",jQuery.proxy(a.___onerrorproxy,a));},n)});n.onload=i;n.onerror=I;n.attachPress(function(e){if(!t._bMoving&&t.getParent()instanceof sap.ino.wall.Wall){t.setFlipped(true);}});this.setAggregation("_image",n,true);if(this._isRendered()){this._renderItemIntoContainer(this.$().find("#"+this.getId()+"-imageWrapper").children("a")[0],this.getAggregation("_image"),false,true);if(this.getParent()&&!s){this.getParent()._notifyItemChanged(this);}}return this;};sap.ino.wall.WallItemPerson.prototype.setAssignmentId=function(i){this.setProperty("assignmentId",i,true);if(this.getParent()){this.getParent()._notifyItemChanged(this);}return this;};sap.ino.wall.WallItemPerson.prototype.setStatus=function(s){var i,b;this.setProperty("status",s,true);if(this._isRendered()){i=this._getImage();b=this._getBusyIndicator();if(this.getStatus()==="Busy"){b.removeStyleClass("sapInoWallInvisible");i.addStyleClass("sapInoWallImageBusy");}else{b.addStyleClass("sapInoWallInvisible");i.removeStyleClass("sapInoWallImageBusy");}}};sap.ino.wall.WallItemPerson.prototype._requestIdentity=function(v){var t=this;if(!v){return;}this.setRequestImage(false);jQuery.ajax({url:C.getBackendRootURL()+"/"+C.getSystemSetting("sap.ino.config.URL_PATH_OD_APPLICATION")+"/SearchIdentityWallItemPerson(searchToken='"+jQuery.sap.encodeURL(v)+"')/Results?$select=searchToken,ID,NAME,USER_NAME&$format=json",type:"GET"}).success(function(d){var i,I,p,e,n;var s=0;if(d.d&&jQuery.type(d.d.results)==="array"){for(var a=0;a<d.d.results.length;a++){var r=d.d.results[a];if((r.searchToken&&r.NAME&&r.searchToken.toLowerCase()===r.NAME.toLowerCase())||(r.searchToken&&r.EMAIL&&r.searchToken.toLowerCase()===r.EMAIL.toLowerCase())){i=r.ID;I=r.IMAGE_ID;p=r.PHONE?r.PHONE:r.MOBILE;e=r.EMAIL;n=r.NAME;s++;}}if(s===1&&i&&i!==t.getProperty("originId")){t.setProperty("originId",i,true);if(I>0){t.setProperty("image",C.getAttachmentDownloadURL(I),true);}else{t.setProperty("image","",true);}t._fetchPicture();t.setPhone(p);t.setEmail(e);t.setTitle(n);t.rerender();}}}).error(function(j,s,e){});};sap.ino.wall.WallItemPerson.prototype.setTitle=function(t,s,r){sap.ino.wall.WallItemBase.prototype.setTitle.apply(this,arguments);if(this._isRendered()){this.$().find(".sapInoWallWIPMeta").toggleClass("sapInoWallInvisible",!this.getTitle()&&!this.getEmail()&&!this.getPhone());}if(r){this._requestIdentity(t);}};sap.ino.wall.WallItemPerson.prototype.setPhone=function(p,s){var l=this._getLinkPhone();this.setProperty("phone",p,true);l.setText(p);l.toggleStyleClass("sapInoWallInvisible",!p);var i=this._getInputPhone();i.setValue(p);if(this._isRendered()){this.$().find(".sapInoWallWIPMeta").toggleClass("sapInoWallInvisible",!this.getTitle()&&!this.getEmail()&&!this.getPhone());}if(this.getParent()&&!s){this.getParent()._notifyItemChanged(this);}return this;};sap.ino.wall.WallItemPerson.prototype.setEmail=function(e,s,r){var l=this._getLinkEmail();this.setProperty("email",e,true);l.setText(e);l.toggleStyleClass("sapInoWallInvisible",!e);var i=this._getInputEmail();i.setValue(e);if(this._isRendered()){this.$().find(".sapInoWallWIPMeta").toggleClass("sapInoWallInvisible",!this.getTitle()&&!this.getEmail()&&!this.getPhone());}if(e&&e.length>0&&r){this._requestIdentity(e);}if(this.getParent()&&!s){this.getParent()._notifyItemChanged(this);}return this;};sap.ino.wall.WallItemPerson.prototype.setRequestImage=function(r,s){this.setProperty("requestImage",r,true);if(this.getParent()&&!s){this.getParent()._notifyItemChanged(this);}return this;};sap.ino.wall.WallItemPerson.prototype._fetchPicture=function(){var i=this.getProperty("image");this.setImage(i);};sap.ino.wall.WallItemPerson.prototype._uploadImage=function(e){var t=this,f=e.getParameter("files"),F,o,r;if(this.getTitle()===this._oRB.getText("WALL_ITEMPERSON_NEW_TEXT")){this.setTitle("");}if(sap.ui.Device.browser.name==="ie"&&sap.ui.Device.browser.version<10&&f===undefined){return;}jQuery.sap.byId(this.getParent().getId()+"-drag").css("display","none");this.$().removeClass("dragCursor");if(f.length!==0){F=f[0];if(!!F.type.match(/image\.*/)){t.setStatus("Busy");t.setFlipped(false);sap.ino.commons.models.object.Attachment.uploadFile(F).done(function(R){var s=R.attachmentId;setTimeout(function(){t.setImage(C.getAttachmentDownloadURL(s));},500);}).fail(function(R){});}}};sap.ino.wall.WallItemPerson.prototype._getImage=function(){var i=this.getAggregation("_image");if(!i){this.setImage("");this.$().find(".sapInoWallWIPImageWrapper").addClass("sapInoWallWIPImageWrapperDefaultImage");i=this.getAggregation("_image");}return i;};sap.ino.wall.WallItemPerson.prototype._getLinkPhone=function(){var t=this,c=this.getAggregation("_linkPhone");if(!c){c=new sap.m.Link({text:sap.ino.wall.util.Formatter.escapeBindingCharacters(this.getPhone()),press:function(e){sap.m.URLHelper.triggerTel(t.getPhone());}}).addStyleClass("sapInoWallWIPPhoneL").addStyleClass("noflip").toggleStyleClass("sapInoWallInvisible",!this.getPhone());this.setAggregation("_linkPhone",c,true);}return c;};sap.ino.wall.WallItemPerson.prototype._getLinkEmail=function(){var t=this,c=this.getAggregation("_linkEmail");if(!c){c=new sap.m.Link({text:sap.ino.wall.util.Formatter.escapeBindingCharacters(this.getEmail()),press:function(e){sap.m.URLHelper.triggerEmail(t.getEmail());}}).addStyleClass("sapInoWallWIPEmailL").addStyleClass("noflip").toggleStyleClass("sapInoWallInvisible",!this.getEmail());this.setAggregation("_linkEmail",c,true);}return c;};sap.ino.wall.WallItemPerson.prototype._getDropUpload=function(){var c=this.getAggregation("_dropUpload");if(!c){c=new sap.ino.wall.DropUpload({size:"S",change:[this._uploadImage,this]});this.setAggregation("_dropUpload",c,true);}return c;};sap.ino.wall.WallItemPerson.prototype.formatToJSON=function(){var j=sap.ino.wall.WallItemBase.prototype.formatToJSON.call(this);j.content.phone=this.getPhone();j.content.email=this.getEmail();j.content.originId=this.getOriginId();j.content.requestImage=this.getRequestImage();if(this.getImage()){j.content.image=this.getImage();j.content.assignmentId=this.getAssignmentId();}return j;};})();
