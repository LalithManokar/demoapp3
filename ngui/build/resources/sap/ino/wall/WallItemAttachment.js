/*!
 * SAP Innovation Management (c) Copyright 2014 SAP AG. All rights reserved.
 */
jQuery.sap.declare("sap.ino.wall.WallItemAttachment");(function(){"use strict";jQuery.sap.require("sap.ino.wall.WallItemBase");jQuery.sap.require("sap.ino.wall.DropUpload");jQuery.sap.require("sap.ino.commons.models.object.Attachment");jQuery.sap.require("sap.ino.commons.application.Configuration");var C=sap.ino.commons.application.Configuration;var A={DOCUMENT:"DOCUMENT",IMAGE:"IMAGE",VIDEO:"VIDEO",AUDIO:"AUDIO",TEXT:"TEXT",ERROR:"ERROR",DEFAULT:"DOCUMENT"};sap.ino.wall.WallItemBase.extend("sap.ino.wall.WallItemAttachment",{metadata:{properties:{"status":{type:"string",group:"Appearance",defaultValue:'Normal'},"URL":{type:"sap.ui.core.URI",group:"Data",defaultValue:null},"type":{type:"string",group:"Appearance",defaultValue:null},"fileName":{type:"string",group:"Data",defaultValue:null},"assignmentId":{type:"int",group:"Identification",defaultValue:-1}},aggregations:{"_icon":{type:"sap.ui.core.Icon",multiple:false,visibility:"hidden"},"_busyIndicator":{type:"sap.m.BusyIndicator",multiple:false,visibility:"hidden"},"_dropUpload":{type:"sap.ino.wall.DropUpload",multiple:false,visibility:"hidden"}}}});sap.ino.wall.WallItemAttachment.AttachmentType=A;sap.ino.wall.WallItemAttachment.prototype.init=function(){sap.ino.wall.WallItemBase.prototype.init.call(this);this.setResizable(false);};sap.ino.wall.WallItemAttachment.prototype.setURL=function(u){this.setProperty("URL",u,true);this.updateIcon();if(this.getParent()){this.getParent()._notifyItemChanged(this);}return this;};sap.ino.wall.WallItemAttachment.prototype.setAssignmentId=function(i){this.setProperty("assignmentId",i,true);if(this.getParent()){this.getParent()._notifyItemChanged(this);}return this;};sap.ino.wall.WallItemAttachment.prototype._uploadDoc=function(e){var t=this;var f=e.getParameter("files");var F,s,o,r,S;if(sap.ui.Device.browser.name==="ie"&&sap.ui.Device.browser.version<10&&f===undefined){return;}jQuery.sap.byId(this.getParent().getId()+"-drag").css("display","none");this.$().removeClass("dragCursor");if(f.length!==0){F=f[0];t.setStatus("Busy");t.setFlipped(false);sap.ino.commons.models.object.Attachment.uploadFile(F).done(function(R){var S=R.attachmentId;var a=R.fileName;var T=R.mediaType;setTimeout(function(){t.setURL(C.getAttachmentDownloadURL(S));t.setTitle(a);t.setType(T);t.setFileName(a);t.updateIcon();t.setStatus("Normal");t._iStorageId=S;},500);}).fail(function(R){var m=R.messages;t.setType(A.ERROR);t.updateIcon();t.setStatus("Normal");if(m&&m.length>0){sap.m.MessageToast.show(t._oMB.getText(m[0].MESSAGE,m[0].PARAMETERS),{duration:6000});}});}};sap.ino.wall.WallItemAttachment.prototype.setTitle=function(t,s){sap.ino.wall.WallItemBase.prototype.setTitle.apply(this,[t,s]);if(t!==this._oRB.getText("WALL_ITEMATTACHMENT_NEW_TEXT")){this._getInputTitle().setValue(t);this._getInputTitle().$().children("input").attr("value",t);}return this;};sap.ino.wall.WallItemAttachment.prototype.setType=function(t){t=sap.ino.wall.WallItemAttachment.mapType(t);this.setProperty("type",t,true);if(this.getParent()){this.getParent()._notifyItemChanged(this);}this.updateIcon();return this;};sap.ino.wall.WallItemAttachment.mapType=function(t){if(t===A.IMAGE||t.indexOf("image/")===0){t=A.IMAGE;}else if(t===A.VIDEO||t.indexOf("video/")===0){t=A.VIDEO;}else if(t===A.AUDIO||t.indexOf("audio/")===0){t=A.AUDIO;}else if(t===A.TEXT||t.indexOf("text/")===0){t=A.TEXT;}else if(t===A.ERROR){t=A.ERROR;}else if(t===A.DOCUMENT){t=A.DOCUMENT;}else{t=A.DEFAULT;}return t;};sap.ino.wall.WallItemAttachment.prototype.setFileName=function(n){this.setProperty("fileName",n,true);if(this.getParent()){this.getParent()._notifyItemChanged(this);}this.updateIcon();return this;};sap.ino.wall.WallItemAttachment.prototype._getBusyIndicator=function(){var b=this.getAggregation("_busyIndicator");if(!b){b=new sap.m.BusyIndicator(this.getId()+"-busy").addStyleClass("sapInoWallIndicatorBusy");this.setAggregation("_busyIndicator",b,true);}return b;};sap.ino.wall.WallItemAttachment.prototype._getDropUpload=function(){var c=this.getAggregation("_dropUpload");if(!c){c=new sap.ino.wall.DropUpload({size:"L",change:[this._uploadDoc,this],icon:"sap-icon://upload",accept:"*/*"});this.setAggregation("_dropUpload",c,true);}return c;};sap.ino.wall.WallItemAttachment.prototype._onIconPress=function(){if(!this._bMoving&&this.getURL()){var l=document.createElement("a");l.href=this.getURL();l.download=this.getFileName();document.body.appendChild(l);l.click();document.body.removeChild(l);}};sap.ino.wall.WallItemAttachment.prototype.updateIcon=function(){this._getIcon();};sap.ino.wall.WallItemAttachment.prototype._getIcon=function(){var c=this.getAggregation("_icon");var t=this;var s=85;var i;switch(this.getType()){case A.IMAGE:i="sap-icon://attachment-photo";break;case A.VIDEO:i="sap-icon://attachment-video";break;case A.AUDIO:i="sap-icon://attachment-audio";break;case A.TEXT:i="sap-icon://attachment-text-file";break;case A.ERROR:i="sap-icon://alert";break;case A.DOCUMENT:default:i="sap-icon://document";}if(!c){c=new sap.ui.core.Icon({src:i,size:s+"px",width:s+"px",height:(s+10)+"px",decorative:true});c.setTooltip=function(T){this.setAggregation("tooltip",T,true);this.$().attr("title",T);};this.setAggregation("_icon",c,true);}c.detachPress(this._onIconPress,this);c.removeStyleClass("noflip");if(this.getType()!==A.ERROR){if(this.getURL()&&this.getFileName()){c.attachPress(this._onIconPress,this);c.addStyleClass("noflip");c.setTooltip(this._oRB.getText("WALL_ITEMATTACHMENT_STATUSMSG_DOWNLOAD"));}else{c.setTooltip(this._oRB.getText("WALL_ITEMATTACHMENT_STATUSMSG_EMPTY"));}c.removeStyleClass("sapInoWallWIAttError");}else{c.addStyleClass("sapInoWallWIAttError");c.setTooltip(this._oRB.getText("WALL_ITEMATTACHMENT_STATUSMSG_ERROR"));this.setTitle(this._oRB.getText("WALL_ITEMATTACHMENT_CAPTION_ERROR"));}c.setSrc(i);return c;};sap.ino.wall.WallItemAttachment.prototype.setStatus=function(s){this.setProperty("status",s,true);if(this._isRendered()){var b=sap.ui.getCore().byId(this.getId()+"-busy");var i=jQuery("#"+this.getId()+"-iconWrapper>span");if(this.getStatus()==="Busy"){if(b){b.removeStyleClass("sapInoWallInvisible");}if(i){i.addClass("sapInoWallInvisible");}}else{if(b){b.addStyleClass("sapInoWallInvisible");}if(i){i.removeClass("sapInoWallInvisible");}}}};sap.ino.wall.WallItemAttachment.prototype.formatToJSON=function(){var j=sap.ino.wall.WallItemBase.prototype.formatToJSON.call(this);if(this.getURL()){j.content.URL=this.getURL();j.content.assignmentId=this.getAssignmentId();}j.content.type=this.getType()||A.DEFAULT;j.content.fileName=this.getFileName();return j;};})();
