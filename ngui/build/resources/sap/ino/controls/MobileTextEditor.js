/*!
 * SAP Innovation Management (c) Copyright 2014 SAP AG. All rights reserved.
 */
sap.ui.define(["sap/ui/core/Control","sap/m/TextArea","sap/m/Toolbar","sap/m/ToolbarDesign","sap/ui/core/IconPool","sap/m/ToggleButton","sap/m/Dialog","sap/m/InputBase","sap/ui/core/ResizeHandler","sap/base/security/sanitizeHTML"],function(C,T,a,b,I,B,D,c,R,s){"use strict";return C.extend("sap.ino.controls.MobileTextEditor",{metadata:{properties:{dialogTitle:{type:"string",defaultValue:""},editable:{type:"boolean",defaultValue:true},enabled:{type:"boolean",defaultValue:true},height:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},minHeight:{type:"sap.ui.core.CSSSize",defaultValue:"1rem"},maxHeight:{type:"sap.ui.core.CSSSize",defaultValue:""},openInDialog:{type:"boolean",defaultValue:false},showToolbar:{type:"boolean",defaultValue:true},showValueStateMessage:{type:"boolean",defaultValue:true},value:{type:"string",defaultValue:""},valueState:{type:"sap.ui.core.ValueState",defaultValue:sap.ui.core.ValueState.None},valueStateText:{type:"string",defaultValue:null},width:{type:"sap.ui.core.CSSSize",defaultValue:"100%"}},aggregations:{"_editorControls":{type:"sap.m.Toolbar",multiple:false,fitContainer:true,visibility:"hidden"},"_dialog":{type:"sap.m.Dialog",multiple:false,visibility:"hidden"}},events:{change:{}}},init:function(){this._oRB=sap.ui.getCore().getLibraryResourceBundle("sap.ino.controls");this._sResizeRegId=R.register(this,this._onResize);},exit:function(){R.deregister(this._sResizeRegId);},setValue:function(v){this.setProperty("value",v,true);var e=this._getNicEditor();if(!e){jQuery.sap.log.warning("NicEditor not found in method setValue",undefined,"sap.ino.controls.MobileTextEditor");return;}this._getNicEditor().setContent(v||"");},onAfterRendering:function(){this._recalculateHeight();jQuery.sap.require("sap.ino.thirdparty.nicEdit");this._oNicEditor=new nicEditor({buttonList:["bold","italic","underline","ol","ul"]});if(this.getShowToolbar()){this._oNicEditor.addEvent("buttonActivate",jQuery.proxy(this._nicButtonActivate,this));this._oNicEditor.addEvent("buttonDeactivate",jQuery.proxy(this._nicButtonDeactivate,this));}this._oNicEditor.setPanel(this.getId()+"-nicPanel");this._oNicEditor.panelInstance(this.getId()+"-nicContentTA");if(!(this.getEnabled()&&this.getEditable())){this.$().addClass("sapMInputBaseDisabled");this._getNicEditor().disable();}else{if(this.getShowToolbar()){this._oNicEditor.setPanel(this.getId()+"-editorControls");}}},_nicButtonActivate:function(i){this._syncButtonState(i.name,true);},_nicButtonDeactivate:function(i){this._syncButtonState(i.name,false);},_syncButtonState:function(n,t){var o=sap.ui.getCore().byId(this.getId()+"-"+n);o.setPressed(t);},focus:function(){var $=this.$();if(!$){return;}jQuery.sap.focus($.find('.nicEdit-main').first());},onfocusin:function(){this.openValueStateMessage();},onfocusout:function(e){var E=this._getNicEditor();if(!E){return;}var d=E.getContent();this.setProperty("value",d,true);this.closeValueStateMessage();if(this.getEditable()){this.fireChange({value:d});}},ontap:function(e){this._openInDialog();},ontouchmove:function(e){e.setMarked();},_onResize:function(e){e.control._recalculateHeight();},_getNicEditor:function(){return this._oNicEditor&&this._oNicEditor.instanceById(this.getId()+"-nicContentTA");},_recalculateHeight:function(){var i=this._bOpenInDialog;if(i&&(!this.getHeight()||this.getHeight()==="100%")){var p=this.$().parents(".sapMDialog");var h=(p[0].clientHeight-152)/2;if(h>0){this.$().height(h);}}},_openInDialog:function(){if(!this.getOpenInDialog()||this._bOpenInDialog===true){return;}var d=new D({stretch:true,horizontalScrolling:false,verticalScrolling:true,showHeader:true,title:this.getDialogTitle(),beginButton:new B({text:this._oRB.getText("CTRL_MTE_DONE"),press:function(){d.close();}})});var e=new this.constructor({value:this.getValue(),editable:this.getEditable(),enabled:this.getEnabled()}).addStyleClass("sapInoMTEDialog");e._bOpenInDialog=true;this.setAggregation("_dialog",d);d.addContent(e);d.attachAfterOpen(this._onOpenDialog,this);d.attachAfterClose(this._onCloseDialog,this);d.open();},_onCloseDialog:function(e){var d=e.getSource();var v=d.getContent()[0].getValue();this.setAggregation("_dialog",null);d.destroy();this.setValue(v);if(this.getEditable()){this.fireChange({value:v});}},_onOpenDialog:function(e){e.getSource().getContent()[0].focus();},setValueStateText:function(t){this.setProperty("valueStateText",t,true);return this;},setValueState:function(v){this.setProperty("valueState",v,true);var $=this.$();if(!$){return;}var d=$.find(".sapInoMTEContent");d.removeClass("sapMInputBaseErrorInner");d.removeClass("sapMInputBaseSuccessInner");d.removeClass("sapMInputBaseWarningInner");d.removeClass("sapMInputBaseStateInner");var S=this._getStyleClassForValueState();if(S){d.addClass(S);d.addClass("sapMInputBaseStateInner");}return this;},_getStyleClassForValueState:function(){switch(this.getValueState()){case(sap.ui.core.ValueState.Error):return"sapMInputBaseErrorInner";case(sap.ui.core.ValueState.Success):return"sapMInputBaseSuccessInner";case(sap.ui.core.ValueState.Warning):return"sapMInputBaseWarningInner";}},refreshDataState:c.prototype.refreshDataState,propagateMessages:c.prototype.propagateMessages,openValueStateMessage:c.prototype.openValueStateMessage,closeValueStateMessage:c.prototype.closeValueStateMessage,getDomRefForValueStateMessage:c.prototype.getDomRefForValueStateMessage,_getEditorControls:function(e){var t=this;var o=this.getAggregation("_editorControls");if(!o){o=new a({design:b.Solid,content:[new B(this.getId()+"-bold",{press:function(e){t._getNicEditor().nicCommand("Bold");},text:"B"}).addStyleClass("sapInoMTEButton").addStyleClass("sapInoMTEButtonBold"),new B(this.getId()+"-italic",{press:function(e){t._getNicEditor().nicCommand("Italic");},text:"I"}).addStyleClass("sapInoMTEButton").addStyleClass("sapInoMTEButtonItalic"),new B(this.getId()+"-underline",{press:function(e){t._getNicEditor().nicCommand("Underline");},text:"U"}).addStyleClass("sapInoMTEButton").addStyleClass("sapInoMTEButtonUnderline"),new B(this.getId()+"-ol",{press:function(e){t._getNicEditor().nicCommand("insertorderedlist");},icon:I.getIconURI("multi-select")}).addStyleClass("sapInoMTEButton"),new B(this.getId()+"-ul",{press:function(e){t._getNicEditor().nicCommand("insertunorderedlist");},icon:I.getIconURI("menu")}).addStyleClass("sapInoMTEButton")]});this.setAggregation("_editorControls",o,true);}return o;},renderer:function(r,o){r.write("<div ");r.writeControlData(o);r.addClass("sapInoMTE");r.writeClasses();r.write(">");r.write("<div");r.writeAttribute("id",s(o.getId())+"-nicPanel");r.addClass("sapInoMTENicPanel");r.writeClasses();r.write("/>");if(o.getShowToolbar()){r.write("<div");r.writeAttribute("id",s(o.getId())+"-editorControls");r.writeAttribute("role","toolbar");r.writeAttributeEscaped("aria-label",o._oRB.getText("CRTL_MTE_TOOLBAR_LABEL"));r.addClass("sapInoMTEControls");r.writeClasses();r.write(">");r.renderControl(o._getEditorControls());r.write("</div>");}r.write("<div");r.writeAttribute("id",s(o.getId())+"-nicContent");r.addClass("sapInoMTEContent");r.addClass("sapMInputBaseInner");r.addClass("sapMTextAreaInner");if(!(o.getEnabled()&&o.getEditable())){r.addClass("sapMInputBaseDisabledInner");}r.writeClasses();r.addStyle("width",s(o.getWidth()));r.addStyle("height",s(o.getHeight()));if(o.getMinHeight()){r.addStyle("min-height",s(o.getMinHeight()));}if(o.getMaxHeight()){r.addStyle("max-height",s(o.getMaxHeight()));}r.writeStyles();r.write(">");r.write("<textarea");r.writeAttribute("id",s(o.getId())+"-nicContentTA");r.addClass("sapInoMTEContent");r.addClass("sapMInputBaseInner");r.writeClasses();r.writeStyles();r.write(">");r.writeEscaped(o.getValue());r.write("</textarea>");r.write("</div>");r.write("</div>");}});});
