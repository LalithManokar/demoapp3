/*!
 * SAP Innovation Management (c) Copyright 2014 SAP AG. All rights reserved.
 */
sap.ui.define(["sap/ui/core/Control","sap/ino/controls/EvaluationMatrixItem","sap/ui/thirdparty/d3"],function(C,E,a){"use strict";return C.extend("sap.ino.controls.EvaluationMatrix",{metadata:{properties:{width:{type:"float",defaultValue:500},height:{type:"float",defaultValue:500},xMin:{type:"float",defaultValue:0},xMax:{type:"float",defaultValue:50},xLabel:{type:"string"},xLabelUom:{type:"string"},yMin:{type:"float",defaultValue:0},yMax:{type:"float",defaultValue:50},yLabel:{type:"string"},yLabelUom:{type:"string"},r1Min:{type:"float",defaultValue:0},r1Max:{type:"float",defaultValue:null},r2Min:{type:"float",defaultValue:0},r2Max:{type:"float",defaultValue:null},rMin:{type:"float",defaultValue:6},rMax:{type:"float",defaultValue:25},xSegments:{type:"int",defaultValue:2},ySegments:{type:"int",defaultValue:2},mode:{type:"string",defaultValue:"radio"},clickable:{type:"boolean",defaultValue:true},selectedItemName:{type:"string",defaultValue:"item"},legendHeight:{type:"float",defaultValue:0},displayLegend:{type:"boolean",defaultValue:false},innerCircleText:"string",outerCircleText:"string"},aggregations:{"items":{type:"sap.ino.controls.EvaluationMatrixItem",multiple:true,singularName:"item",bindable:true},"evalData":{type:"sap.ino.controls.EvaluationData",multiple:true,singularName:"datum",bindable:true}},events:{"itemSelected":{}}},renderer:function(c,d){c.write("<div");c.writeControlData(d);c.addClass("matrix");c.writeClasses();c.write(">");c.write("</div>");},determineRadiusMax:function(){var I=this.getItems();var i,c;this._r1MaxCalc=null;if(this.getR1Max()){this._r1MaxCalc=this.getR1Max();}else if(I.length>0){for(i=0;i<I.length;i++){c=I[i];if(!this._r1MaxCalc||this._r1MaxCalc<c.getR1Value()){this._r1MaxCalc=c.getR1Value();}}}this._r2MaxCalc=null;if(this.getR2Max()){this._r2MaxCalc=this.getR2Max();}else if(I.length>0){for(i=0;i<I.length;i++){c=I[i];if(!this._r2MaxCalc||this._r2MaxCalc<c.getR2Value()){this._r2MaxCalc=c.getR2Value();}}}},onBeforeRendering:function(){this.prepareMatrix();},prepareMatrix:function(){this.removeAllAggregation("items",true);var d=this.getEvalData();var c;var j;if(d.length===0){return;}for(var i=0;i<d.length;i++){var M=d[i].findValueByAggregationTypeMatrix();if(M){this.setXSegments(M.getXAxisSegmentNo());this.setYSegments(M.getYAxisSegmentNo());var x=d[i].findValueByCriterionCode(M.getXAxisCriterionCode());var y=d[i].findValueByCriterionCode(M.getYAxisCriterionCode());if(y&&x){this.setXLabel(x.getCriterionName());if(x.getUomCode()){this.setXLabelUom(x.getXAxisCriterionCodeLabel());}this.setYLabel(y.getCriterionName());if(y.getUomCode()){this.setYLabelUom(y.getYAxisCriterionCodeLabel());}if(M.getVisParam1CriterionCode()){c=d[i].findValueByCriterionCode(M.getVisParam1CriterionCode());}if(M.getVisParam2CriterionCode()){j=d[i].findValueByCriterionCode(M.getVisParam2CriterionCode());}var l=new sap.ino.controls.EvaluationMatrixItem({name:d[i].getEvaluationId()});if(x.getCriterionValue()){l.setXValue(parseFloat(x.getCriterionValue()));l.setXValueDataType(x.getCriterionDataType());}if(x.getValueMin()){this.setXMin(x.getValueMin());}if(x.getValueMax()){this.setXMax(x.getValueMax());}if(y.getCriterionValue()){l.setYValue(parseFloat(y.getCriterionValue()));l.setYValueDataType(y.getCriterionDataType());}if(y.getValueMin()){this.setYMin(y.getValueMin());}if(y.getValueMax()){this.setYMax(y.getValueMax());}if(c){if(c.getCriterionValue()){l.setR1Value(parseFloat(c.getCriterionValue()));l.setR1ValueDataType(c.getCriterionDataType());}if(c.getValueMin()){this.setR1Min(c.getValueMin());}if(c.getValueMax()){this.setR1Max(c.getValueMax());}}if(j){if(j.getCriterionValue()){l.setR2Value(parseFloat(j.getCriterionValue()));l.setR2ValueDataType(j.getCriterionDataType());}if(j.getValueMin()){this.setR2Min(j.getValueMin());}if(j.getValueMax()){this.setR2Max(j.getValueMax());}}this.addItem(l);}}}},onAfterRendering:function(){var c={top:10,right:10,bottom:30,left:30};if(this.getDisplayLegend()){c.bottom+=this.getLegendHeight();}this.determineRadiusMax();var d=D(this.getItems());var l=this.getWidth()-c.left-c.right;var p=this.getHeight()-c.top-c.bottom;var x=a.scale.linear().domain([this.getXMin(),this.getXMax()]).range([0,l]);var y=a.scale.linear().domain([this.getYMin(),this.getYMax()]).range([p,0]);var G=this.getR1Min()<this.getR2Min()?this.getR1Min():this.getR2Min();var H=this._r1MaxCalc>this._r2MaxCalc?this._r1MaxCalc:this._r2MaxCalc;var r=a.scale.linear().domain([G,H]).range([this.getRMin(),this.getRMax()]);var I=a.select("#"+this.getId());var J=s(I,l,p,c);var K=this.getXMax()-this.getXMin();var X=K/this.getXSegments();var i,j;for(i=1;i<=this.getXSegments();i++){e(J,x(this.getXMin()+i*X),y(this.getYMin()),y(this.getYMax()));}var L=this.getYMax()-this.getYMin();var Y=L/this.getYSegments();for(j=1;j<=this.getYSegments();j++){b(J,x(this.getXMin()),x(this.getXMax()),y(this.getYMin()+j*Y));}f(J,x(this.getXMin()),x(this.getXMax()),y(this.getYMin()),this.getXLabel(),this.getXLabelUom());g(J,y(this.getYMin()),this.getYLabel(),this.getYLabelUom());var M=this.getEvalData();for(i=0;i<M.length;i++){var N=M[i].findValueByAggregationTypeMatrix();if(N){var O=N.getValueOptionListLabelCodes();if(O){for(j=0;j<O.length;j++){var Q=O[j];var P=Q.CODE-1;if(P>=0){var R=P%this.getXSegments();var S=Math.floor(P/this.getXSegments());h(J,x(this.getXMin()+R*X+0.5*X),y(this.getYMin()+(1+S)*Y)+20,Q.TEXT,x(this.getXMin()+X),this.getXSegments());}}}}}var T=k(this,J,x,y,d);m(this,T,x,y,d);o(this,T,r,this.getMode(),this.getClickable());var U=jQuery(this.getDomRef()).find("g[name='circleGroup_"+this.getSelectedItemName()+"']")[0];if(U){t(this,U,this.getMode());}}});function w(c){var d=a.select(this),i=d.node().getComputedTextLength(),j=d.text();while(i>260&&j.length>0){j=j.slice(0,-1);d.text(j+'...');i=d.node().getComputedTextLength();}}function s(c,d,i,j){var l=c.append("svg").attr("width",d+j.left+j.right).attr("focusable","false").attr("height",i+j.top+j.bottom).attr("class","sapUiInoEvaluationMatrixSvgElement").append("g").attr("transform","translate("+j.left+","+j.top+")");return l;}function b(c,x,d,y){var l=c.append("g").attr("class","sapUiInoEvaluationMatrixLine").attr("transform","translate("+x+","+y+")").append("svg:line").attr("x1",0).attr("y1",0).attr("x2",d-x).attr("y2",0);return l;}function e(c,x,y,d){var l=c.append("g").attr("class","sapUiInoEvaluationMatrixLine").attr("transform","translate("+x+","+y+")").append("svg:line").attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",d-y);return l;}function f(c,x,d,y,l,i){var L=i?l+" ["+i+"]":l;var j=c.append("g").attr("class","sapUiInoEvaluationMatrixAxis").attr("transform","translate("+x+","+y+")");j.append("svg:line").attr("x1",0).attr("y1",0).attr("x2",d+1).attr("y2",0);j.append("svg:text").attr("transform","translate("+d+",0)").attr("class","sapUiInoEvaluationMatrixLabel").attr("y","25").attr("x","0").style("text-anchor","end").text(L);return j;}function g(c,y,l,d){var L=d?l+" ["+d+"]":l;var i=c.append("g").attr("class","sapUiInoEvaluationMatrixAxis");i.append("svg:line").attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",y+1);i.append("svg:text").attr("transform","rotate(-90)").attr("class","sapUiInoEvaluationMatrixLabel").attr("x","0").attr("y","-18").style("text-anchor","end").text(L);return i;}function h(c,x,y,l,d,i){var j="sapUiInoEvaluationMatrixQuadrant sapUiInoEvaluationMatrixQuadrantSegments"+i;var p=c.append("g").attr("transform","translate("+x+","+y+")").append("svg:text").attr("class",j).style("text-anchor","middle").text(l);return p;}function k(c,i,x,y,j){var l=i.selectAll("circle").data(j).enter().append("g").attr("name","circleEnter").attr("transform",function(d){return"translate("+x(d.xValue)+","+y(d.yValue)+")";});return l;}function m(c,i,x,y,j){var l=i.append("g").attr("class","sapUiInoEvaluationMatrixHidden").attr("name",function(d){return"coord_"+d.name;});l.append("svg:line").attr("x1",0).attr("y1",0).attr("x2",function(d){var p=-x(d.xValue);return p;}).attr("y2",0).attr("class","sapUiInoEvaluationMatrixValueLine");l.append("svg:line").attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",function(d){var p=y(c.getYMax()-d.yValue+c.getYMin());return p;}).attr("class","sapUiInoEvaluationMatrixValueLine");l.append("svg:text").attr("transform",function(d){var p=-x(d.xValue);return"translate("+(p-17)+", 5)";}).attr("class","sapUiInoEvaluationMatrixCoordinate").text(function(d){return F(d.yValueDataType,d.yValue);});l.append("svg:text").attr("transform",function(d){var p=y(c.getYMax()-d.yValue+c.getYMin());return"translate(0, "+(p+14)+")";}).attr("class","sapUiInoEvaluationMatrixCoordinate").style("text-anchor","middle").text(function(d){return F(d.xValueDataType,d.xValue);});n(c,l,x,y);return l;}function n(c,j,x,y){var l=c.getEvalData();var r,R,p,G;for(var i=0;i<l.length;i++){var M=l[i].findValueByAggregationTypeMatrix();if(M){var H,I;if(M.getVisParam1CriterionCode()){H=l[i].findValueByCriterionCode(M.getVisParam1CriterionCode());if(H){r=H.getCriterionLabel();p=H.getVisParam1CriterionCodeLabel();}}if(M.getVisParam2CriterionCode()){I=l[i].findValueByCriterionCode(M.getVisParam2CriterionCode());if(I){R=I.getCriterionLabel();G=I.getVisParam2CriterionCodeLabel();}}}}if(c.getDisplayLegend()&&r&&R){j.append("svg:circle").attr("cx",function(d){var J=-x(d.xValue);return J+3;}).attr("cy",function(d){var J=y(c.getYMax()-d.yValue+c.getYMin());return J+40;}).attr("r",6).attr("class",function(d){if(d.r1Value<=d.r2Value){return"sapUiInoEvaluationMatrixInnerCircleHighlight";}else{return"sapUiInoEvaluationMatrixOuterCircleHighlight";}});j.append("svg:text").attr("transform",function(d){var J=-x(d.xValue);var K=y(c.getYMax()-d.yValue+c.getYMin());return"translate("+(J+15)+", "+(K+45)+")";}).text(function(d){var L;if(d.r1Value<=d.r2Value){L=r;if(p){L=L+" "+p;}}else{L=R;if(G){L=L+" "+G;}}return L+" ("+c.getInnerCircleText()+")";}).each(w);j.append("svg:circle").attr("cx",function(d){var J=-x(d.xValue);return J+3;}).attr("cy",function(d){var J=y(c.getYMax()-d.yValue+c.getYMin());return J+60;}).attr("r",6).attr("class",function(d){if(d.r1Value>d.r2Value){return"sapUiInoEvaluationMatrixInnerCircleHighlight";}else{return"sapUiInoEvaluationMatrixOuterCircleHighlight";}});j.append("svg:text").attr("transform",function(d){var J=-x(d.xValue);var K=y(c.getYMax()-d.yValue+c.getYMin());return"translate("+(J+15)+", "+(K+65)+")";}).text(function(d){var L;if(d.r1Value>d.r2Value){L=r;if(p){L=L+" "+p;}}else{L=R;if(G){L=L+" "+G;}}return L+" ("+c.getOuterCircleText()+")";}).each(w);}}function o(i,j,r,l,p){var c=j.append("g").attr("name",function(d){return"circleGroup_"+d.name;});c.append("svg:circle").attr("cx",0).attr("cy",0).attr("r",function(d){return r(d.r2Value);}).attr("class","sapUiInoEvaluationMatrixOuterCircle").attr("name","outerCircle").attr("title",function(d){return d.r2Value;});c.append("svg:circle").attr("cx",0).attr("cy",0).attr("r",function(d){return r(d.r1Value);}).attr("class","sapUiInoEvaluationMatrixInnerCircle").attr("name","innerCircle").attr("title",function(d){return d.r1Value;});c.select("circle").each(function(d){if(d.r2Value<d.r1Value){var x=this.parentNode;x.appendChild(x.removeChild(this));}});if(p){c.on("click",function(d){i.setSelectedItemName(q(this),true);i.fireItemSelected({itemName:q(this)});});}c.append("svg:text").attr("transform",function(d){var x=d.r1Value>d.r2Value?d.r1Value:d.r2Value;return"translate("+(r(x)+4)+", 4)";}).attr("class","sapUiInoEvaluationMatrixItemName").text(function(d){return d.name;});}function q(c){var p=c.attributes.name.value.split("_");if(p&&p.length>1){return p[1];}return c.attributes.name.value;}function t(c,d,i){var j=jQuery(d).find("> circle[name*='innerCircle']")[0];z(j,"sapUiInoEvaluationMatrixInnerCircleHighlight");A(j,"sapUiInoEvaluationMatrixInnerCircle");var l=jQuery(d).find("> circle[name*='outerCircle']")[0];z(l,"sapUiInoEvaluationMatrixOuterCircleHighlight");A(l,"sapUiInoEvaluationMatrixOuterCircle");jQuery(d.parentNode.parentNode.parentNode).find("g[name*='circleGroup']").each(function(x,y){if(y!==d){var j=jQuery(y).find("> circle[name*='innerCircle']")[0];z(j,"sapUiInoEvaluationMatrixInnerCircle");A(j,"sapUiInoEvaluationMatrixInnerCircleHighlight");var l=jQuery(y).find("> circle[name*='outerCircle']")[0];z(l,"sapUiInoEvaluationMatrixOuterCircle");A(l,"sapUiInoEvaluationMatrixOuterCircleHighlight");}});var p=d.previousSibling;A(p,"sapUiInoEvaluationMatrixHidden");if(i==="radio"){jQuery(d.parentNode.parentNode.parentNode).find("g[name*='coord']").each(function(x,y){if(y!==p){z(y,"sapUiInoEvaluationMatrixHidden");}});}var r=p.parentNode;r.parentNode.appendChild(r.parentNode.removeChild(r));}function u(c,d,i){if(B(c,d)){A(c,d);if(!B(c,i)){z(c,i);}}else if(B(c,i)){A(c,i);if(!B(c,d)){z(c,d);}}}function v(c,d){var i=c.getAttribute("class");var p=new RegExp("\\b"+d+"\\b");if(p.test(i)){i=i.replace(p,"");}else{i=i.concat(" "+d);}c.setAttribute("class",i);return c;}function z(c,d){var i=c.getAttribute("class");var p=new RegExp("\\b"+d+"\\b");if(!p.test(i)){i=i.concat(" "+d);c.setAttribute("class",i);}return c;}function A(c,d){var i=c.getAttribute("class");var p=new RegExp("\\b"+d+"\\b");if(p.test(i)){i=i.replace(p,"");c.setAttribute("class",i);}return c;}function B(c,d){var i=c.getAttribute("class");var p=new RegExp("\\b"+d+"\\b");return(p.test(i));}function D(c){var d=[];for(var i=0;i<c.length;i++){var l={};for(var j in c[i].mProperties){l[j]=c[i].mProperties[j];}d.push(l);}return d;}function F(d,V){if(isNaN(V)||V===undefined||V===null){return 0;}switch(d){case"INTEGER":V=Math.round(V);break;case"NUMERIC":V=(Math.round(V*100)/100).toLocaleString();break;default:break;}return V;}});
