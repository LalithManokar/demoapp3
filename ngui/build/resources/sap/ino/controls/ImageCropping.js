/*!
 * SAP Innovation Management (c) Copyright 2014 SAP AG. All rights reserved.
 */
sap.ui.define(["sap/ui/core/Control","sap/m/Button","sap/ui/Device","sap/base/security/sanitizeHTML"],function(C,B,D,s){"use strict";return C.extend("sap.ino.controls.ImageCropping",{metadata:{properties:{url:{type:"string"},width:{type:"sap.ui.core.CSSSize",defaultValue:"216px"},height:{type:"sap.ui.core.CSSSize",defaultValue:"121px"},showZoom:{type:"boolean",defaultValue:true},showMove:{type:"boolean",defaultValue:false},showClear:{type:"boolean",defaultValue:false},showCrop:{type:"boolean",defaultValue:false},zoomStep:{type:"int",defaultValue:1},moveStep:{type:"int",defaultValue:1},enabled:{type:"boolean",defaultValue:true}},aggregations:{"_zoomPlusButton":{type:"sap.m.Button",multiple:false,visibility:"hidden"},"_zoomMinusButton":{type:"sap.m.Button",multiple:false,visibility:"hidden"},"_moveUpButton":{type:"sap.m.Button",multiple:false,visibility:"hidden"},"_moveDownButton":{type:"sap.m.Button",multiple:false,visibility:"hidden"},"_moveLeftButton":{type:"sap.m.Button",multiple:false,visibility:"hidden"},"_moveRightButton":{type:"sap.m.Button",multiple:false,visibility:"hidden"},"_clearButton":{type:"sap.m.Button",multiple:false,visibility:"hidden"},"_cropButton":{type:"sap.m.Button",multiple:false,visibility:"hidden"}},events:{clear:{},crop:{},cropImg:{}}},init:function(){this._oRB=sap.ui.getCore().getLibraryResourceBundle("sap.ino.controls");this._bImgLoaded=false;},renderer:function(r,c){r.write("<div");r.writeControlData(c);r.addClass("sapInoImageCrop");r.writeClasses();r.addStyle("width",s(c.getWidth()));r.addStyle("height",s(c.getHeight()));r.writeStyles();r.write(">");if(c.getUrl()){r.write("<div");r.writeAttributeEscaped("tabindex","0");r.writeAttributeEscaped("title",c._oRB.getText("IMAGE_CROP_DETAIL"));r.addClass("sapInoImageCropImageContainer");r.addClass("sapInoImageCropImageContainerHidden");if(!c.getEnabled()){r.addClass("sapInoImageCropImageContainerDisabled");}r.writeClasses();r.write(">");r.write("<img");r.writeAttributeEscaped("src",c.getUrl());r.writeAttributeEscaped("title",c._oRB.getText("IMAGE_CROP_DETAIL"));r.addClass("sapInoImageCropImage");r.writeClasses();r.write("></img>");r.write("</div>");if(c.getEnabled()){if(c.getShowZoom()){r.renderControl(c.getZoomPlusButton());r.renderControl(c.getZoomMinusButton());}if(c.getShowMove()){r.renderControl(c.getMoveUpButton());r.renderControl(c.getMoveDownButton());r.renderControl(c.getMoveLeftButton());r.renderControl(c.getMoveRightButton());}if(c.getShowClear()){r.renderControl(c.getClearButton());}if(c.getShowCrop()){r.renderControl(c.getCropButton());}}}r.write("</div>");},onAfterRendering:function(){var i=this.cropImage();if(i){var t=this;i.onload=function(){t.cropInit();jQuery(t.cropImageContainer()).removeClass("sapInoImageCropImageContainerHidden");t._bImgLoaded=true;};if(this._bImgLoaded){jQuery(this.cropImageContainer()).removeClass("sapInoImageCropImageContainerHidden");}}},setFocus:function(){if(this.cropImage()){jQuery(this.cropImage()).parent().focus();}},getZoomPlusButton:function(){var t=this;var z=this.getAggregation("_zoomPlusButton");if(!z){z=new B({icon:"sap-icon://zoom-in",tooltip:this._oRB.getText("IMAGE_CROP_ZOOM_PLUS"),press:function(e){e.cancelBubble();e.preventDefault();t.cropZoom(t.getZoomStep());t.getFocusDomRef().focus();},enabled:false}).addStyleClass("sapInoImageCropButton").addStyleClass("sapInoImageCropZoomPlus");this.setAggregation("_zoomPlusButton",z);}return z;},getZoomMinusButton:function(){var t=this;var z=this.getAggregation("_zoomMinusButton");if(!z){z=new B({icon:"sap-icon://zoom-out",tooltip:this._oRB.getText("IMAGE_CROP_ZOOM_MINUS"),press:function(e){e.cancelBubble();e.preventDefault();t.cropZoom(-t.getZoomStep());t.getFocusDomRef().focus();},enabled:false}).addStyleClass("sapInoImageCropButton").addStyleClass("sapInoImageCropZoomMinus");this.setAggregation("_zoomMinusButton",z);}return z;},getMoveUpButton:function(){var t=this;var m=this.getAggregation("_moveUpButton");if(!m){m=new B({icon:"sap-icon://slim-arrow-up",tooltip:this._oRB.getText("IMAGE_CROP_MOVE_UP"),press:function(e){e.cancelBubble();e.preventDefault();t.cropMoveBy(0,-t.getMoveStep());t.getFocusDomRef().focus();},enabled:false}).addStyleClass("sapInoImageCropButton").addStyleClass("sapInoImageCropMoveUp");this.setAggregation("_moveUpButton",m);}return m;},getMoveDownButton:function(){var t=this;var m=this.getAggregation("_moveDownButton");if(!m){m=new B({icon:"sap-icon://slim-arrow-down",tooltip:this._oRB.getText("IMAGE_CROP_MOVE_DOWN"),press:function(e){e.cancelBubble();e.preventDefault();t.cropMoveBy(0,t.getMoveStep());t.getFocusDomRef().focus();},enabled:false}).addStyleClass("sapInoImageCropButton").addStyleClass("sapInoImageCropMoveDown");this.setAggregation("_moveDownButton",m);}return m;},getMoveLeftButton:function(){var t=this;var m=this.getAggregation("_moveLeftButton");if(!m){m=new B({icon:"sap-icon://slim-arrow-left",tooltip:this._oRB.getText("IMAGE_CROP_MOVE_LEFT"),press:function(e){e.cancelBubble();e.preventDefault();t.cropMoveBy(-t.getMoveStep(),0);t.getFocusDomRef().focus();},enabled:false}).addStyleClass("sapInoImageCropButton").addStyleClass("sapInoImageCropMoveLeft");this.setAggregation("_moveLeftButton",m);}return m;},getMoveRightButton:function(){var t=this;var m=this.getAggregation("_moveRightButton");if(!m){m=new B({icon:"sap-icon://slim-arrow-right",tooltip:this._oRB.getText("IMAGE_CROP_MOVE_RIGHT"),press:function(e){e.cancelBubble();e.preventDefault();t.cropMoveBy(t.getMoveStep(),0);t.getFocusDomRef().focus();},enabled:false}).addStyleClass("sapInoImageCropButton").addStyleClass("sapInoImageCropMoveRight");this.setAggregation("_moveRightButton",m);}return m;},getClearButton:function(){var t=this;var c=this.getAggregation("_clearButton");if(!c){c=new B({icon:"sap-icon://sys-cancel",tooltip:this._oRB.getText("IMAGE_CROP_CLEAR"),press:function(e){e.cancelBubble();e.preventDefault();t.fireClear();t.getFocusDomRef().focus();},enabled:true}).addStyleClass("sapInoImageCropButton").addStyleClass("sapInoImageCropClear");this.setAggregation("_clearButton",c);}return c;},getCropButton:function(){var t=this;var c=this.getAggregation("_cropButton");if(!c){c=new B({icon:"sap-icon://crop",tooltip:this._oRB.getText("IMAGE_CROP_CROP"),press:function(e){e.cancelBubble();e.preventDefault();t.fireCropImg();t.getFocusDomRef().focus();},enabled:false}).addStyleClass("sapInoImageCropButton").addStyleClass("sapInoImageCropCrop");this.setAggregation("_cropButton",c);}return c;},cropInit:function(S){this.cropInitMove();this.cropInitScrollZoom();if(!S){this.cropInitImage();}this.cropCheckButtons();},cropImageContainer:function(){return jQuery(this.getDomRef()).find(".sapInoImageCropImageContainer")[0];},cropImage:function(){return jQuery(this.getDomRef()).find(".sapInoImageCropImage")[0];},cropInitImage:function(){var i=this.cropImage();var d=jQuery(this.getDomRef());var r=i.naturalWidth/i.naturalHeight;var z=d.width()-i.naturalWidth;var a=d.height()-i.naturalHeight;var b=z>a*r?z:a*r;this.cropZoomBy(b);jQuery(i).css({"left":0,"top":0,"position":"relative"});},cropInitMove:function(){if(!this.getEnabled()){return;}var a=this;var i=this.cropImage();var I=jQuery(i);I.on("mousedown",function(e){e.preventDefault();var p=I.offset().left-e.pageX;var b=I.offset().top-e.pageY;I.on("mousemove",function(e){a.cropMoveAt(p+e.pageX,b+e.pageY);});}).on("mouseup",function(){I.off("mousemove");}).on("mouseout",function(){I.off("mousemove");});I.on("touchstart",function(e){e.preventDefault();if(e.touches&&e.touches.length>0){var t=e.touches[0];var p=I.offset().left-t.pageX;var b=I.offset().top-t.pageY;var d=-1;I.on("touchmove",function(e){if(e.touches&&e.touches.length>0){if(e.touches.length==2){var c=e.touches[0];var f=e.touches[1];var n=Math.sqrt(Math.pow(c.pageX-f.pageX,2)+Math.pow(c.pageY-f.pageY,2));if(d>0){a.cropZoomBy(n-d);}d=n;}else{var t=e.touches[0];a.cropMoveAt(p+t.pageX,b+t.pageY);}}});}}).on("touchend",function(){I.off("touchmove");});},cropInitScrollZoom:function(){if(!this.getEnabled()){return;}var t=this;var i=this.cropImage();var I=jQuery(i);I.parent().bind("wheel mousewheel",function(e){if(e.originalEvent.deltaY>0){t.cropZoom(-1.0);}else{t.cropZoom(1.0);}e.originalEvent.preventDefault();e.originalEvent.stopPropagation();e.originalEvent.stopImmediatePropagation();return false;});},onkeydown:function(e){if(!this.getEnabled()){return;}var S=true;switch(e.keyCode){case jQuery.sap.KeyCodes.ARROW_LEFT:this.cropMoveBy(-1,0);break;case jQuery.sap.KeyCodes.ARROW_UP:this.cropMoveBy(0,-1);break;case jQuery.sap.KeyCodes.ARROW_RIGHT:this.cropMoveBy(1,0);break;case jQuery.sap.KeyCodes.ARROW_DOWN:this.cropMoveBy(0,1);break;case jQuery.sap.KeyCodes.PLUS:case jQuery.sap.KeyCodes.NUMPAD_PLUS:case 171:this.cropZoom(1.0);break;case jQuery.sap.KeyCodes.SLASH:case jQuery.sap.KeyCodes.MINUS:case jQuery.sap.KeyCodes.NUMPAD_MINUS:case 173:this.cropZoom(-1.0);break;default:S=false;break;}if(S){e.preventDefault();e.stopPropagation();e.stopImmediatePropagation();}},cropCheckButtons:function(){if(!this.getEnabled()){return;}var i=jQuery(this.cropImage());var d=jQuery(this.getDomRef());var m=-(i.width()-d.width());var a=-(i.height()-d.height());var l=parseInt(i.css("left"),10);var t=parseInt(i.css("top"),10);if(this.getAggregation("_zoomPlusButton")){this.getAggregation("_zoomPlusButton").setEnabled(true);}if(this.getAggregation("_zoomMinusButton")){this.getAggregation("_zoomMinusButton").setEnabled(i.width()>d.width()&&i.height()>d.height());}if(this.getAggregation("_moveUpButton")){this.getAggregation("_moveUpButton").setEnabled(t>a);}if(this.getAggregation("_moveDownButton")){this.getAggregation("_moveDownButton").setEnabled(t<0);}if(this.getAggregation("_moveLeftButton")){this.getAggregation("_moveLeftButton").setEnabled(l>m);}if(this.getAggregation("_moveRightButton")){this.getAggregation("_moveRightButton").setEnabled(l<0);}if(this.getAggregation("_cropButton")){this.getAggregation("_cropButton").setEnabled(i.width()!==d.width()||i.height()!==d.height());}},cropMoveAt:function(x,y){if(!this.getEnabled()){return;}var i=this.cropImage();var I=jQuery(i);var d=jQuery(this.getDomRef());I.offset({left:x,top:y});var m=-(I.width()-d.width());var a=-(I.height()-d.height());var l=parseInt(I.css("left"),10);var t=parseInt(I.css("top"),10);if(t>0){I.css("top",0);}if(t<a){I.css("top",a);}if(l>0){I.css("left",0);}if(l<m){I.css("left",m);}this.cropCheckButtons();},cropMoveBy:function(d,a){if(!this.getEnabled()){return;}var i=this.cropImage();var p=jQuery(i).offset();this.cropMoveAt(p.left+d,p.top+a);},cropZoom:function(f){if(!this.getEnabled()){return;}this.cropZoomBy(10.0*(f||1.0));},cropZoomBy:function(d){if(!this.getEnabled()){return;}var i=this.cropImage();var I=jQuery(i);var j=jQuery(this.getDomRef());var r=I.width()/I.height();var n=I.width()+d;var a=n/r;if(n<j.width()||a<j.height()){if(n-j.width()<a-j.height()){n=j.width();a=n/r;}else{a=j.height();n=r*a;}}I.width(n);I.height(a);var p=I.offset();this.cropMoveAt(p.left-d/2.0,p.top-d/2.0);this.cropCheckButtons();},crop:function(){var t=this;var I=this.cropImage();if(I){var j=jQuery(I);var d=jQuery(this.getDomRef());if(j.width()!==d.width()||j.height()!==d.height()){var c=document.createElement("canvas");var o=c.getContext("2d");o.mozImageSmoothingEnabled=true;o.webkitImageSmoothingEnabled=true;o.msImageSmoothingEnabled=true;o.imageSmoothingEnabled=true;c.width=d.width();c.height=d.height();o.fillStyle="#FFFFFF";o.fillRect(0,0,c.width,c.height);var a=Math.abs(parseInt(j.css("left"),10));var b=Math.abs(parseInt(j.css("top"),10));var l=a*(I.naturalWidth/j.width());var e=b*(I.naturalHeight/j.height());var w=I.naturalWidth;var h=I.naturalHeight;this.cropDrawImage(o,I,l,e,w-l,h-e,0,0,j.width()-a,j.height()-b);var f=c.toDataURL();var g=atob(f.split(",")[1]);var A=[];for(var i=0;i<g.length;i++){A.push(g.charCodeAt(i));}var F=new Blob([new Uint8Array(A)],{type:"image/png",name:"image.png"});return F;}}return null;},cropCalcVerticalRatio:function(i){if(!D.os.ios){return 1.0;}var n=i.naturalHeight;var c=document.createElement("canvas");c.width=1.0;c.height=n;var o=c.getContext("2d");o.drawImage(i,0,0);var d=o.getImageData(0,0,1,n).data;var S=0;var a=n;var p=n;while(p>S){var A=d[(p-1)*4+3];if(A===0){a=p;}else{S=p;}p=(a+S)>>1;}var r=(p/n);return(r===0)?1.0:r;},cropDrawImage:function(c,i,a,b,d,e,x,y,w,h){var v=1.0;c.drawImage(i,a*v,b*v,d*v,e*v,x,y,w,h);}});});
