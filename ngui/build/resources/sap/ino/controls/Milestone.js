/*!
 * SAP Innovation Management (c) Copyright 2014 SAP AG. All rights reserved.
 */
sap.ui.define(["sap/ui/core/Control","sap/ui/thirdparty/d3"],function(C,c){'use strict';return C.extend("sap.ino.controls.Milestone",{metadata:{properties:{"Id":{type:"int"},"tasks":{type:"array"},"visible":{type:"boolean"},"max-point":{type:'int'}},aggregations:{},events:{}},init:function(){this._oRB=sap.ui.getCore().getLibraryResourceBundle("sap.ino.controls");},controlConfig:{width:'900',height:'300',maxPoints:2,defaultThemeColor:'E50082',defaultFontColor:'666666',fontSizeX:14,fontSizeM:12,fontSizeS:10,defaultBarColor:'5f95c2',defaultBgColor:'f3f3f3',barHeight:20,gap:60,topPadding:5,bottomPadding:15,sidePadding:150,outPadding:200,labelMaxLength:18,milestoneMaxLength:220,milestoneNameMaxFactorLength:30,minWidth:768,normalWidth:800},nowTime:new Date().getTime(),onAfterRendering:function(){this.handleInfinity();this.dataMixin();this.resetting();this.initSVG();this.drawMileStone();},resetting:function(){$.extend(this.controlConfig,{width:this.getParent().$().width()*0.95,height:this.getProperty('tasks')&&this.getProperty('tasks').length*100+10});},initSVG:function(){var t=this.getProperty('tasks');if(this.controlConfig.width<this.controlConfig.minWidth){return c.selectAll(".mile-stone-svg").style({'display':'none'});}this.svg=c.selectAll(".mile-stone-svg").style({'display':'block'}).append("svg").attr("width",this.controlConfig.width).attr("height",this.controlConfig.height).attr("class","svg-content");this.timeScale=c.time.scale().domain([c.min(t,function(d){return d.START_DATE;}),c.max(t,function(d){return d.END_DATE;})]).range([0,this.controlConfig.width-this.controlConfig.outPadding]);},_mileStoneMerge:function(s){this.MILESTONE_NAME='...';this.MILESTONE_DATE=undefined;this.MILESTONE_MERGE=[];this.MILESTONE_COLOR_CODE=s.controlConfig.defaultThemeColor;this.MILESTONE_IS_MERGE=true;this.IS_MILESTONE_DISPLAY=true;},_timeSort:function(a,b){return a.MILESTONE_DATE.getTime()-b.MILESTONE_DATE.getTime();},_isClean:function(t){return t.END_DATE.getFullYear()<9999;},_isInfinity:function(t){return t.END_DATE.getFullYear()===9999;},_isShowTask:function(t){return!!t.IS_TASK_DISPLAY;},_isShowMilestone:function(m){return!!m.IS_MILESTONE_DISPLAY;},handleInfinity:function(){var s=this;var d=this.getProperty('tasks')&&this.getProperty('tasks').sort(function(a,b){return a.SEQUENCE_NO-b.SEQUENCE_NO;});var t=d.filter(this._isShowTask);if(!t&&!t.length){return false;}t.forEach(function(a){a.Milestones=a.Milestones.filter(s._isShowMilestone);});var e=t.filter(this._isClean);var i=t.filter(this._isInfinity);var f=[],g=[];var n=new Date(this.nowTime);if(!i||!i.length){return this.setProperty('tasks',t);}t.forEach(function(v){f=f.concat(v.Milestones);});var m=f.length&&c.max(f,function(v){return v.MILESTONE_DATE;});var h=e&&e.length&&c.max(e,function(v){return v.END_DATE;});i.forEach(function(v){if(!m&&!m){v.END_DATE=new Date(n.getFullYear()+1,n.getMonth(),n.getDate());}if(m&&h){var a=m.getTime()>h.getTime()?m:h;v.END_DATE=new Date(a);}if(m&&!h){v.END_DATE=new Date(m.getTime()*1.01);}if(!m&&h){v.END_DATE=new Date(h.getTime()*1.01);}v.IS_INFINITY=true;});g=e.concat(i);this.setProperty('tasks',g.sort(function(a,b){return a.SEQUENCE_NO-b.SEQUENCE_NO;}));},dataMixin:function(){var s=this.getProperty('tasks');if(!s){return false;}var n=this.nowTime,t,p,a,b;var m=this.controlConfig.maxPoints;var d=this.controlConfig;for(var i=0;i<s.length;i++){t=s[i];t.TASK_INDEX=i;t.LINEGAP=0;t.left=[];t.right=[];this.getTemplateText(t);if(!t.Milestones||!t.Milestones.length){continue;}t.Milestones.sort(this._timeSort);for(var x=0;x<t.Milestones.length;x++){p=t.Milestones[x];a=t.Milestones[x+1];b=t.Milestones[x-1];p.INDEX=i;p.yAxis=0;if(p.MILESTONE_IS_MERGE){t.HAS_MERGE=true;}if(a){p.NEXT=a.MILESTONE_DATE;}else{p.NEXT=t.END_DATE;}if(b){p.PRE=b.MILESTONE_DATE;}else{p.PRE=t.START_DATE;}if(!p.MILESTONE_COLOR_CODE){p.MILESTONE_COLOR_CODE=d.defaultThemeColor;}if(p.MILESTONE_DATE.getTime()<=n){t.left.push(p);}if(p.MILESTONE_DATE.getTime()>n){t.right.push(p);}}if(t.left.length>m&&!t.HAS_MERGE){this._mergeToLeft(t.left);}if(t.right.length>m&&!t.HAS_MERGE){this._mergeToRight(t.right);}t.Milestones=t.left.concat(t.right);}this.setProperty('tasks',s);},getTemplateText:function(t){if(!t){return false;}var s=this;$.extend(t,{TEMPLATE_TEXT:{TASK:s._oRB.getText('MILESTONE_TASK'),START:s._oRB.getText('MILESTONE_START'),END:s._oRB.getText('MILESTONE_END'),INFINITY:s._oRB.getText('MILESTONE_INFINITY')}});},_mergeToLeft:function(a){if(!a){return false;}var l=new this._mileStoneMerge(this);var t=a[0].INDEX;var m=this.controlConfig.maxPoints;var b=this.getProperty('tasks');for(var i=0;i<a.length;i++){if(i<a.length-m){l.MILESTONE_MERGE.push(a[i]);}}l.MILESTONE_DATE=b[t].START_DATE;l.INDEX=t;l.NEXT=b[t].Milestones[a.length-m].NEXT;a[a.length-m].PRE=l.MILESTONE_DATE;a.splice(0,a.length-m,l);},_mergeToRight:function(a){if(!a){return false;}var r=new this._mileStoneMerge(this);var t=a[0].INDEX;var m=this.controlConfig.maxPoints;var b=this.getProperty('tasks');for(var i=0;i<a.length;i++){if(i+1>m){r.MILESTONE_MERGE.push(a[i]);}}r.MILESTONE_DATE=b[t].END_DATE;r.INDEX=t;r.NEXT=b[t].Milestones[a.length-m].NEXT;r.PRE=a[m-1].MILESTONE_DATE;a.splice(m,a.length-m,r);},_getTextWidth:function(t,a){var b=this.controlConfig;var a=a||b.fontSizeM;var s=document.createElement("span");document.body.appendChild(s);var d=c.select(s).append("svg");var e=d.append("text").text(t).attr("style","font-size:"+a+"px");var B=e.node().getBBox();s.parentNode.removeChild(s);return B.width>b.milestoneMaxLength?b.milestoneMaxLength:Math.round(B.width);},drawMileStone:function(){var a=new Array();var t=this.getProperty('tasks');var w=this.controlConfig.width;var h=this.controlConfig.height;var m=this.controlConfig.minWidth;if(w<m){return false;}if(!t||!t.length){return false;}for(var i=0;i<t.length;i++){a.push(t[i].TASK_NAME);}this.categories=a;this.makeGant(t,w,h);},makeGant:function(t,p,a){var b=this.controlConfig;var d=b.barHeight;var g=b.gap;var e=b.topPadding;var s=b.sidePadding;this.drawRects(t,g,e,s,d,p,a);this.vertLabels(g,e);},drawRects:function(t,a,b,e,f,w,h){var s=this.svg;var g=this;var j=this.timeScale;var n=this.nowTime;var l=this.controlConfig;var D=sap.ui.core.format.DateFormat.getDateInstance({style:"medium"});var m=c.max(t,function(d){return d.END_DATE;});var o=c.min(t,function(d){return d.START_DATE;});if(!s||!s.length){return false;}var p=s.append("g").selectAll(".bar").data(t).enter().append("rect");var r=s.append('g').selectAll(".bar").data(t).enter();if(n<m&&n>o){var q=r.append('line').attr('class','now').attr('x1',function(){var d=n<m?n:m;return j(new Date(d))+e;}).attr('y1',b).attr('x2',function(){var d=n<m?n:m;return j(new Date(d))+e;}).attr('y2',function(){return t.length*l.gap+b+15;}).attr('stroke','#'+l.defaultThemeColor);var u=r.append('text').text(function(){var T=D.format(new Date(n));return g._oRB.getText('MILESTONE_TODAY')+': '+T;}).attr('class','now-date').attr('x',function(){var d=n<m?n:m;return j(new Date(d))+e;}).attr('y',function(){return t.length*90+b+15;}).attr("font-size",l.fontSizeX).attr("text-height",f).attr("fill",'#'+l.defaultThemeColor).attr('text-anchor',function(){var i=j(new Date(m))-j(new Date(n));var d=this.textContent.length*l.fontSizeX;if(i-d>0){return'start';}return'end';});}var v=r.append('g').attr('class','points').selectAll(".point").data(function(d){return d.Milestones;}).enter();var x=v.append('rect').attr("x",function(d){return j(d.MILESTONE_DATE)+e+10;}).attr("y",function(d,i){var H=d.INDEX*a+b+f+l.fontSizeM*1.4;var I=true;if(d.INDEX>0){H=g.getLineGapYAxis(d.INDEX,H,t);}return g.setPointYAxis(d,i,H,I)-l.fontSizeM+2;}).attr('width',function(d){if(d.MILESTONE_IS_MERGE){return 12;}var i=g._getTextWidth(d.MILESTONE_NAME,l.fontSizeM);return j(m)-j(d.MILESTONE_DATE)<i?j(m)-j(d.MILESTONE_DATE):i;}).attr('height',function(){return l.fontSizeM;}).attr("fill",'#FFFFFF');var y=v.append('text').attr('class','point-text').text(function(d){if(l.width<l.minWidth){return'...';}if(!d.NEXT){return d.MILESTONE_NAME;}var i=j(m)-j(d.MILESTONE_DATE);var H=g._getTextWidth(d.MILESTONE_NAME,l.fontSizeM)+15;if(i<H){var I=Math.round(g._getTextWidth(d.MILESTONE_NAME,l.fontSizeM)/d.MILESTONE_NAME.length);var J=Math.floor(i/I);if(d.MILESTONE_NAME.length>J+8){var K=J+8;var L=d.MILESTONE_NAME.slice(0,K);return L+'...';}else{var L=d.MILESTONE_NAME;return L;}}if(d.MILESTONE_NAME.length<=l.milestoneNameMaxFactorLength){return d.MILESTONE_NAME;}else{var L=d.MILESTONE_NAME.slice(0,l.milestoneNameMaxFactorLength-1);return L+'...';}}).attr("x",function(d){return j(d.MILESTONE_DATE)+e+10;}).attr("y",function(d,i){var H=d.INDEX*a+b+f+l.fontSizeM*1.4;if(d.INDEX>0){H=g.getLineGapYAxis(d.INDEX,H,t);}d.yAxis=g.setPointYAxis(d,i,H);return d.yAxis;}).attr("font-size",function(d){return d.MILESTONE_IS_MERGE?l.fontSizeX:l.fontSizeM;}).attr("text-anchor","start").attr("text-height",f).attr("fill",function(d){return d.MILESTONE_IS_MERGE?'#'+l.defaultThemeColor:'#'+l.defaultFontColor;});var z=v.append('rect').attr('class','point').attr('rx',2).attr('ry',2).attr('width',10).attr('height',10).attr("x",function(d){return j(d.MILESTONE_DATE)+e;}).attr("y",function(d){return d.yAxis-l.fontSizeM;}).attr("fill",function(d){return'#'+d.MILESTONE_COLOR_CODE;}).attr("stroke","none").attr('transform',function(){return'rotate(45 '+this.getAttribute('x')+' '+this.getAttribute('y')+')';});var A=r.append("rect").attr('class','backgroundBar').attr("rx",10).attr("ry",10).attr("x",l.sidePadding).attr("y",function(d,i){var H=i*a+b;if(i>0){H=g.getLineGapYAxis(i,H,t);}return H;}).attr("width",function(){return j(m);}).attr("height",f).attr("stroke","none").attr("fill",'#'+l.defaultBgColor);var B=r.append("rect").attr('class','bar').attr("rx",10).attr("ry",10).attr("x",function(d){return j(d.START_DATE)+e;}).attr("y",function(d,i){var H=i*a+b;if(i>0){H=g.getLineGapYAxis(i,H,t);}return H;}).attr("width",function(d){return j(d.END_DATE)-j(d.START_DATE);}).attr("height",f).attr("stroke","none").attr("fill",function(d){return'#'+(d.TASK_COLOR_CODE||l.defaultBarColor);});var E=r.append('rect').attr('class','passed').attr("rx",10).attr("ry",10).attr("x",function(d){return j(d.START_DATE)+e;}).attr("y",function(d,i){var H=i*a+b;if(i>0){H=g.getLineGapYAxis(i,H,t);}return H;}).attr("width",function(d){var i=j(d.END_DATE);var H=j(new Date(n));var I=H<i?H:i;var J=I-j(d.START_DATE)>0?I-j(d.START_DATE):0;return J;}).attr("height",f).attr("stroke","none").attr("fill","#ffffff").attr('opacity',0.5);if(n<m&&n>o){var F=r.append('line').attr('class','now').attr('x1',function(){var d=n<m?n:m;return j(new Date(d))+e;}).attr("y1",function(d,i){var H=i*a+b;if(i>0){H=g.getLineGapYAxis(i,H,t);}return H;}).attr('x2',function(){var d=n<m?n:m;return j(new Date(d))+e;}).attr("y2",function(d,i){var H=i*a+b;if(i>0){H=g.getLineGapYAxis(i,H,t);}return H+f;}).attr('stroke','#'+l.defaultThemeColor);}if(n<m&&n>o){q.attr('y2',function(){var G=t.length*a+b+20;for(var k=0;k<t.length;k++){G+=t[k].LINEGAP;}return G;});u.attr('y',function(){var G=t.length*a+b+20;for(var k=0;k<t.length;k++){G+=t[k].LINEGAP;}return G;});}var G=t.length*a+b;for(var k=0;k<t.length;k++){G+=t[k].LINEGAP;}s.attr('height',G+l.bottomPadding);B.on('mouseenter',this.showPopUp).on('mouseleave',this.hidePopUp);E.on('mouseenter',this.showPopUp).on('mouseleave',this.hidePopUp);z.on('click',this.showMileStone);c.select('.mile-stone-screen-cover').on('click',this.hideMileStone);},getLineGapYAxis:function(i,n,t){var a=n;for(var j=i-1;j>=0;j--){a+=t[j].LINEGAP;}return a;},setPointYAxis:function(o,i,n,a){var t=this.getProperty('tasks');var b=this.timeScale;var d=this.controlConfig;var p=b(o.MILESTONE_DATE)-b(o.PRE);var e=n;var f=t[o.INDEX].Milestones[i-1]||undefined;var g=f?f.yAxis:e;o.yAxis=e;if(f&&p<this._getTextWidth(f.MILESTONE_NAME,d.fontSizeM)+15){o.yAxis=g+d.fontSizeM*1.4;if(a){for(var k=i-1;k>=0;k--){if(t[o.INDEX].Milestones[k].yAxis>=o.yAxis){continue;}else{t[o.INDEX].LINEGAP+=d.fontSizeM*1.4;break;}}}}return o.yAxis;},vertLabels:function(t,a){var p=0;var s=this.svg;var b=this.getProperty('tasks');var d=this.categories;var e=this.controlConfig;var f=[];for(var i=0;i<d.length;i++){var l=false;if(d[i].length>e.labelMaxLength){f=d[i].split(" ")||[];for(var k=0;k<f.length;k++){if(f[k+1]){var g=f[k]+" "+f[k+1];if(g.length<e.labelMaxLength){f[k]=f[k]+" "+f[k+1];f.splice(k+1,1);k--;}}}l=true;}var h=i*t+a+15;if(i>0){for(var j=i-1;j>=0;j--){h+=b[j].LINEGAP;}}if(l){var m=this.svg.append("g").append("text").attr('class','milestone-label').attr("font-size",e.fontSizeM).attr("text-anchor","start").attr("text-height",e.fontSizeX).attr('fill','#'+e.defaultFontColor);var L=f.length;if(L>3){f=f.slice(0,3);f[2]+='...';}for(var k=0;k<L;k++){m.append("tspan").text(f[k]).attr("x",20).attr("y",h+k*e.fontSizeX);}}else{var m=this.svg.append("g").append("text").text(d[i]).attr('class','milestone-label').attr("font-size",e.fontSizeM).attr("text-anchor","start").attr("text-height",e.fontSizeX).attr('fill','#'+e.defaultFontColor).attr("x",20).attr("y",h);}}},showPopUp:function(){var d=sap.ui.core.format.DateFormat.getDateInstance({style:"medium"});var a=c.select(this).data()[0];var o=document.getElementsByClassName("mile-stone-tag")[0];if(o.style.display==="block"){return false;}var x=(this.x.animVal.value+this.width.animVal.value/2)+"px";var y=this.y.animVal.value+40+"px";var s,e;switch(a.DATE_TYPE_CODE){case'MONTH':s=a.START_MONTH+'  '+a.START_YEAR;e=a.END_MONTH+'  '+a.END_YEAR;break;case'YEAR':s=a.START_YEAR;e=a.END_YEAR;break;case'DAY':s=d.format(a.START_DATE);e=d.format(a.END_DATE);break;case'QUARTER':s=a.START_QUARTER+'  '+a.START_YEAR;e=a.END_QUARTER+'  '+a.END_YEAR;break;default:break;}if(a.IS_INFINITY){e=a.TEMPLATE_TEXT.INFINITY;}var t="<span class='mile-stone-task'>"+a.TEMPLATE_TEXT.TASK+a.TASK_NAME+"</span>"+"<br/>"+"<span class='mile-stone-task'>"+a.TEMPLATE_TEXT.START+s+"</span>"+"<br/>"+"<span class='mile-stone-task'>"+a.TEMPLATE_TEXT.END+e+"</span>";o.innerHTML=t;o.style.top=y;o.style.left=x;o.style.display="block";c.select('.svg-content').on('click',this.hideMileStone);},hidePopUp:function(){var o=document.getElementsByClassName("mile-stone-tag")[0];if(o.style.display==="none"){return false;}o.style.display="none";},showMileStone:function(){var t,d=c.select(this).data()[0];var D=sap.ui.core.format.DateFormat.getDateInstance({style:"medium"});var o=document.getElementsByClassName("mile-stone")[0];if(o.style.display==="block"){return false;}var x=(this.x.animVal.value+this.width.animVal.value/2)+"px";var y=this.y.animVal.value+40+"px";var m;if(!d.MILESTONE_MERGE||!d.MILESTONE_MERGE.length){switch(d.DATE_TYPE_CODE){case'MONTH':m=d.MILESTONE_MONTH+'  '+d.MILESTONE_YEAR;break;case'YEAR':m=d.MILESTONE_YEAR;break;case'DAY':m=D.format(d.MILESTONE_DATE);break;case'QUARTER':m=d.MILESTONE_QUARTER+'  '+d.MILESTONE_YEAR;break;default:break;}t="<p><span class='tag-point' style='background:#"+d.MILESTONE_COLOR_CODE+"'></span><span style='color:#"+d.MILESTONE_COLOR_CODE+"'>"+m+"</span></p>"+"<p class='mile-stone-date'>"+d.MILESTONE_NAME+"</p>";}if(d.Attachment&&d.Attachment.length){for(var i=0;i<d.Attachment.length;i++){t+='<a class="mile-stone-attachment" target="_blank" rel="'+d.Attachment[i].LABEL+'" href="'+d.Attachment[i].ATTACHMENT_URL+'">'+d.Attachment[i].LABEL+'</a>';}}if(d.MILESTONE_MERGE&&d.MILESTONE_MERGE.length){t='';for(var i=0;i<d.MILESTONE_MERGE.length;i++){switch(d.MILESTONE_MERGE[i].DATE_TYPE_CODE){case'MONTH':m=d.MILESTONE_MERGE[i].MILESTONE_MONTH+'  '+d.MILESTONE_MERGE[i].MILESTONE_YEAR;break;case'YEAR':m=d.MILESTONE_MERGE[i].MILESTONE_YEAR;break;case'DAY':m=D.format(d.MILESTONE_MERGE[i].MILESTONE_DATE);break;case'QUARTER':m=d.MILESTONE_MERGE[i].MILESTONE_QUARTER+'  '+d.MILESTONE_MERGE[i].MILESTONE_YEAR;break;default:break;}t+="<p><span class='tag-point' style='background:#"+d.MILESTONE_MERGE[i].MILESTONE_COLOR_CODE+"'></span><span style='color:#"+d.MILESTONE_MERGE[i].MILESTONE_COLOR_CODE+"'>"+m+"</span></p>"+"<p class='mile-stone-date'>"+d.MILESTONE_MERGE[i].MILESTONE_NAME+"</p>";if(d.MILESTONE_MERGE[i].Attachment&&d.MILESTONE_MERGE[i].Attachment.length){t+='<a class="mile-stone-attachment" target="_blank" rel="'+d.MILESTONE_MERGE[i].Attachment[0].LABEL+'" href="'+d.MILESTONE_MERGE[i].Attachment[0].ATTACHMENT_URL+'">'+d.MILESTONE_MERGE[i].Attachment[0].LABEL+'</a>';}}}o.innerHTML=t;o.style.top=y;o.style.left=x;o.style.display="block";c.select('.mile-stone-screen-cover').style({'display':'block'});},hideMileStone:function(){var o=document.getElementsByClassName("mile-stone")[0];if(o.style.display==="none"){return false;}o.style.display="none";c.select('.mile-stone-screen-cover').style({'display':'none'});},renderer:function(r,o){r.write('<div');r.addClass('mile-stone-container');r.writeClasses();r.write('>');r.write('<div');r.addClass('mile-stone-svg');r.writeClasses();r.write('>');r.write("</div>");r.write('<div');r.addClass('mile-stone-screen-cover');r.writeClasses();r.write('>');r.write("</div>");r.write('<div');r.addClass('mile-stone-tag');r.writeClasses();r.write('>');r.write("</div>");r.write('<div');r.addClass('mile-stone');r.writeClasses();r.write('>');r.write("</div>");r.write("</div>");}});});
