/*!
 * SAP Innovation Management (c) Copyright 2014 SAP AG. All rights reserved.
 */
sap.ui.define(["sap/ui/core/Control","sap/ui/thirdparty/d3"],function(C,a){"use strict";return C.extend("sap.ino.controls.ExpertGraph",{metadata:{properties:{experts:{type:"object",defaultValue:{}}},events:{"mouseOverNode":{},"mouseOutNode":{},"clickNode":{}}},init:function(){this._oRB=sap.ui.getCore().getLibraryResourceBundle("sap.ino.controls");},renderer:function(r,c){r.write("<div ");r.writeControlData(c);r.addClass("sapInoExpertGraphContainer");r.writeClasses();r.write("></div>");},onAfterRendering:function(){var i;var z=a.behavior.zoom().scaleExtent([0.1,10]).on("zoom",Z);var $=a.select("#"+this.getId());var b=$[0][0].scrollWidth;var c=$[0][0].scrollHeight;var s=1;var f=$.append("svg").call(z).attr("transform","translate(0,0)");var r=7;var g=a.layout.force().gravity(0.1).distance(100).charge(-500).size([b,c]);a.behavior.drag().origin(function(d){return d;}).on("dragstart",D).on("drag",k).on("dragend",m);var j=f.append("g");function D(d){a.event.sourceEvent.stopPropagation();a.select(this).classed("dragging",true);g.start();}function k(d){a.select(this).attr("cx",d.x=a.event.x).attr("cy",d.y=a.event.y);}function m(d){a.select(this).classed("dragging",false);}f.on("dblclick.zoom",null);f.on("dblclick",function(){s=1;z.scale(1);z.translate([0,0]);j.transition().duration(500).attr('transform','');g.resume();});function Z(){s=a.event.scale;if(s>1){j.attr("transform","translate("+a.event.translate+")scale("+a.event.scale+")");}else{j.attr("transform","scale("+a.event.scale+")");}g.resume();}function n(d){var G={nodes:[],links:[]};function h(F,H){var I=jQuery.grep(G.links,function(e){return e.source===F&&e.target===H;});if(I.length===0){G.links.push({source:F,target:H});return G.links[G.links.length-1];}return I[0];}function l(F,H){var I=jQuery.grep(G.nodes,function(e){return e.tag_id===F;});if(I.length===0){var N={NAME:H,tag_id:F,group:0};G.nodes.push(N);return G.nodes[G.nodes.length-1];}return I[0];}function w(e){var N=jQuery.grep(G.nodes,function(H){return H.PERSON_ID===e.ID;});if(N.length===0){var F={NAME:e.NAME,PERSON_ID:e.ID,EMAIL:e.EMAIL,PHONE:e.PHONE,MOBILE:e.MOBILE,OFFICE:e.OFFICE,group:1,x:150,y:150,RANK:e.RANK,CORRELATION:e.CORRELATION};G.nodes.push(F);return F;}else{return N[0];}}jQuery.each(d,function(e,F){var H=w(F);jQuery.each(F.CORRELATION,function(I,J){jQuery.each(J.TAGS,function(K,L){var M=l(L.ID,L.NAME);var p=h(H,M);});});});return G;}var o=n(this.getExperts());if(o.nodes.length===0){f.append("text").text(this._oRB.getText("CTRL_EXPERTFINDER_EMPTY_SCREEN")).classed("sapInoExpertGraphEmptyScreenText",true);var x=($[0][0].scrollWidth-f.select("text")[0][0].getBBox().width)/3;var y=($[0][0].scrollHeight-f.select("text")[0][0].getBBox().height)/2;f.select("text").attr("x",x).attr("y",y);}else{g.nodes(o.nodes).links(o.links).start();}var p=j.selectAll(".sapInoExpertLink").data(o.links).enter().append("line").classed("sapInoExpertLink",true);var q=j.selectAll(".sapInoExpertNode").data(o.nodes).enter().append("g").attr("class","sapInoExpertNode").call(g.drag);var t=this;var S=[];var u=[];q.append("circle").attr("r",function(d){if(d.group===0){return 12;}else{if(r+(5/d.RANK)<8){return 8;}else{return r+(5/d.RANK);}}}).style("cursor",function(d){return d.group!==0?"pointer":"auto";}).on("click",function(d,i){if(d.group!==0){if(S.length>0||u.length>0){for(i=0;i<S.length;i++){a.select(S[i]).classed("sapInoExpertGraphSelectedPerson",false).classed("sapInoExpertGraphSelectedTag",false).classed("sapInoExpertGraphSelectText",false).classed("sapInoExpertGraphHighlightLine",false).classed("sapInoExpertGraphSelectedPerson",false);}S=[];for(i=0;i<u.length;i++){a.select(u[i]).classed("sapInoExpertGraphSelectLine",false).classed("sapInoExpertLink",true);}u=[];}var e=[];var h=p.filter(function(l){if(l.source.index===d.index||l.target.index===d.index){e.push(l.source.index);e.push(l.target.index);return true;}else{return false;}});var w=q.filter(function(l){return(e.indexOf(l.index)>=0);});h.each(function(){u.push(this);a.select(this).classed("sapInoExpertLink",false).classed("sapInoExpertGraphHighlightLine",false).classed("sapInoExpertGraphSelectLine",true);});w.each(function(N){S.push(this.childNodes[0]);S.push(this.childNodes[1]);a.select(this.childNodes[1]).classed("sapInoExpertGraphSelectText",true);if(N.group!==1){a.select(this.childNodes[0]).classed("sapInoExpertGraphSelectedTag",true);}else{a.select(this.childNodes[0]).classed("sapInoExpertGraphSelectedPerson",true);}});t.fireClickNode(d);}});q.append("text").attr("dx",14).attr("dy",".35em").attr("x",-0).attr("y",function(d){if(d.group===0){return-12;}else{if(r+(5/d.RANK)<8){return 8;}else{return r+(5/d.RANK);}}}).text(function(d){return d.NAME?d.NAME:"["+t._oRB.getText("CTRL_EXPERTFINDER_GRP_NO_NAME")+"]";}).classed("sapInoExpertGraphText",true);q.each(function(N){if(N.group!==0){a.select(this).classed("sapInoExpertGraphPerson",true);}else{a.select(this).classed("sapInoExpertGraphTag",true);}});var T=[];var v=[];var A=function(N){if(N.group===0){return 12;}else{if(r+(10/N.RANK)<8){return 8;}else{return r+(10/N.RANK);}}};g.on("tick",function(){q.attr("cx",function(d){var w=s>1?b:b/s;d.x=Math.max(A(d),Math.min(w-A(d),d.x));return d.x;}).attr("cy",function(d){var h=s>1?c:c/s;d.y=Math.max(A(d),Math.min(h-A(d),d.y));return d.y;}).on("mouseover",function(d){var e=[];var h=p.filter(function(l){if(l.source.index===d.index||l.target.index===d.index){e.push(l.source.index);e.push(l.target.index);return true;}else{return false;}});var w=q.filter(function(l){return(e.indexOf(l.index)>=0);});h.each(function(){v.push(this);a.select(this).classed("sapInoExpertLink",false).classed("sapInoExpertGraphHiglightLine",true);});w.each(function(){T.push(this.childNodes[0]);T.push(this.childNodes[1]);a.select(this.childNodes[0]).classed("sapInoExpertGraphHiglightCircle",true);a.select(this.childNodes[1]).classed("sapInoExpertGraphHiglightText",true);});t.fireMouseOverNode(d);}).on("mouseout",function(d){for(i=0;i<T.length;i++){a.select(v[i]).classed("sapInoExpertGraphHiglightCircle",false).classed("sapInoExpertGraphHiglightText",false).classed("sapInoExpertGraphHiglightLine",false);}T=[];for(i=0;i<v.length;i++){var e=v[i];var R=jQuery.grep(u,function(h){return h===e;});if(R.length===0){a.select(e).classed("sapInoExpertLink",true);}}v=[];t.fireMouseOutNode(d);});q.attr("transform",function(d){return"translate("+d.x+","+d.y+")";});p.attr("x1",function(d){return d.source.x;}).attr("y1",function(d){return d.source.y;}).attr("x2",function(d){return d.target.x;}).attr("y2",function(d){return d.target.y;});});var B=0;while(g.alpha()>0.03){g.tick();if(B++>500){break;}}function E(){var b=$[0][0].scrollWidth;var c=$[0][0].scrollHeight;f.attr("width",b).attr("height",c);if(g.nodes().length!==0){g.size([b,c]).resume();}else{var x=($[0][0].scrollWidth-f.select("text")[0][0].getBBox().width)/3;var y=($[0][0].scrollHeight-f.select("text")[0][0].getBBox().height)/2;f.select("text").attr("x",x).attr("y",y);}}a.select(window).on('resize',E);}});});
