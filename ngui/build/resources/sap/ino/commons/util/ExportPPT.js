/*!
 * SAP Innovation Management (c) Copyright 2014 SAP AG. All rights reserved.
 */
sap.ui.define(["sap/ino/commons/application/Configuration","sap/ino/commons/models/core/CodeModel","sap/ui/core/format/DateFormat","sap/ino/controls/util/ColorSupport","sap/ino/controls/IdeaStatusType","sap/ui/thirdparty/jszip"],function(C,a,D,b,I,J){"use strict";var R={CAMPAIGN_TEXT:new RegExp("{{CAMPAIGN_TEXT}}","g"),CAMPAIGN_NAME:new RegExp("{{CAMPAIGN_NAME}}","g"),CAMPAIGN_COLOR:new RegExp("{{CAMPAIGN_COLOR}}","g"),CAMPAIGN_TEXT_COLOR:new RegExp("{{CAMPAIGN_TEXT_COLOR}}","g"),IDEA_TITLE:new RegExp("{{IDEA_TITLE}}","g"),IDEA_NAME:new RegExp("{{IDEA_NAME}}","g"),STATUS_TEXT:new RegExp("{{STATUS_TEXT}}","g"),IDEA_STATUS:new RegExp("{{IDEA_STATUS}}","g"),PHASE_TEXT:new RegExp("{{PHASE_TEXT}}","g"),IDEA_PHASE:new RegExp("{{IDEA_PHASE}}","g"),IDEA_SHORT_DESCRIPTION:new RegExp("{{IDEA_SHORT_DESCRIPTION}}","g"),AUTHOR_TEXT:new RegExp("{{AUTHOR_TEXT}}","g"),AUTHOR_NAME:new RegExp("{{AUTHOR_NAME}}","g"),COACH_TEXT:new RegExp("{{COACH_TEXT}}","g"),COACH_NAME:new RegExp("{{COACH_NAME}}","g"),COMMENT_COUNT:new RegExp("{{COMMENT_COUNT}}","g"),EVALUATION_COUNT:new RegExp("{{EVALUATION_COUNT}}","g"),VOTE_COUNT:new RegExp("{{VOTE_COUNT}}","g"),IDEA_LINK:new RegExp("%7b%7bIDEA_LINK%7d%7d","g"),IDEA_TITLE_IMAGE:new RegExp("{{IDEA_TITLE_IMAGE}}","g"),STATUS_CHANGE_REASON_TEXT:new RegExp("{{REASON_TEXT}}","g"),STATUS_CHANGE_REASON:new RegExp("{{CHANGE_REASON}}","g"),XML_TAG:new RegExp("<[^>]*>","g"),XML_FUNCTIONAL_CHAR:new RegExp("&[a-z]*;","g"),AMPERSAND:new RegExp("&","g"),BACKSPACE:new RegExp("nbsp;","g"),LOWER_THAN:new RegExp("<","g"),GREATER_THAN:new RegExp(">","g"),EMPTY_NAMESPACE:new RegExp(" xmlns=\"\"","g")};var F={STATUS_FORMATTER:a.getFormatter("sap.ino.xs.object.status.Status.Root"),PHASE_FORMATTER:a.getFormatter("sap.ino.xs.object.campaign.Phase.Root"),VALUE_OPTION:a.getFormatter("sap.ino.xs.object.basis.ValueOptionList.ValueOptions")};var S={INACTIVE:"E5E5E5",ACTIVE:"048E3E",STOPPED:"9F1313"};var _=new XMLSerializer();return{_getText:function(){if(this.i18n){return this.i18n.getResourceBundle().getText.apply(this.i18n.getResourceBundle(),arguments);}return"";},_getValidXMLString:function(s){return s.replace(R.AMPERSAND,"&amp;").replace(R.LOWER_THAN,"&lt;").replace(R.GREATER_THAN,"&gt;").replace(R.XML_FUNCTIONAL_CHAR," ").replace(R.BACKSPACE,"\r\n").replace(R.XML_TAG,"");},_getTemplate:function(){var d=new jQuery.Deferred();var p=C.getBackendRootURL()+"/"+C.getSystemSetting("sap.ino.config.URL_PATH_XS_PPTX_TEMPLATE_DOWNLOAD")+"?FILE_NAME=IdeaExport";var r=new XMLHttpRequest();r.open("GET",p,true);if(r.responseType){r.responseType="arraybuffer";}if(r.overrideMimeType){r.overrideMimeType("text/plain; charset=x-user-defined");}r.onreadystatechange=function(){if(r.readyState===4){if(r.status===200){d.resolve(r.response);}else{d.reject(r.response);}}};r.send();return d;},_getProcessIndicator:function(o,p){var s="";var c=o.STEPS;var d=o.STEP;var l=Math.round(p.cy/5);var L=p.y+Math.round(p.cy/5)*2;var f=0;if(c>=2){f=Math.round((p.cx-p.cy)/(c-1));}var P=((d<0)?0:d*f);if(d>=c){P=p.cx-p.cy;}var O=100;function e(X,k,m){s+='<p:sp><p:nvSpPr><p:cNvPr id="'+(O++)+'" name="Rectangle '+(O++)+'"/><p:cNvSpPr/><p:nvPr/></p:nvSpPr>'+'<p:spPr><a:xfrm><a:off x="'+X+'" y="'+L+'"/><a:ext cx="'+k+'" cy="'+l+'"/></a:xfrm><a:prstGeom prst="rect"><a:avLst/></a:prstGeom><a:solidFill><a:srgbClr val="'+m+'"/></a:solidFill><a:ln><a:noFill/></a:ln></p:spPr>'+'<p:style><a:lnRef idx="2"><a:schemeClr val="accent1"><a:shade val="50000"/></a:schemeClr></a:lnRef><a:fillRef idx="1"><a:schemeClr val="accent1"/>'+'</a:fillRef><a:effectRef idx="0"><a:schemeClr val="accent1"/></a:effectRef><a:fontRef idx="minor"><a:schemeClr val="lt1"/></a:fontRef></p:style>'+'<p:txBody><a:bodyPr rtlCol="0" anchor="ctr"/><a:lstStyle/><a:p><a:pPr algn="ctr"/><a:endParaRPr lang="en-US" dirty="0"/></a:p></p:txBody></p:sp>';}function g(X,k){s+='<p:sp><p:nvSpPr><p:cNvPr id="'+O++ +'" name="Oval '+O++ +'"/><p:cNvSpPr/><p:nvPr/></p:nvSpPr>'+'<p:spPr><a:xfrm><a:off x="'+X+'" y="'+p.y+'"/><a:ext cx="'+p.cy+'" cy="'+p.cy+'"/></a:xfrm><a:prstGeom prst="ellipse">'+'<a:avLst/></a:prstGeom><a:solidFill><a:srgbClr val="'+k+'"/></a:solidFill><a:ln><a:noFill/></a:ln></p:spPr>'+'<p:style><a:lnRef idx="2"><a:schemeClr val="accent1"><a:shade val="50000"/></a:schemeClr></a:lnRef><a:fillRef idx="1"><a:schemeClr val="accent1"/>'+'</a:fillRef><a:effectRef idx="0"><a:schemeClr val="accent1"/></a:effectRef><a:fontRef idx="minor"><a:schemeClr val="lt1"/></a:fontRef></p:style>'+'<p:txBody><a:bodyPr rtlCol="0" anchor="ctr"/><a:lstStyle/><a:p><a:pPr algn="ctr"/><a:endParaRPr lang="en-US"/></a:p></p:txBody></p:sp>';}var h=S.ACTIVE;if(o.STATUS===I.Discontinued||o.STATUS===I.Merged){h=S.STOPPED;}if(c>1){if(P>0){e(Math.round(p.x+p.cy/2),P,h);}if(p.cx-p.cy-P>0){e(Math.round(p.x+p.cy/2+P),p.cx-p.cy-P,S.INACTIVE);}}for(var i=0;i<c;i++){var x=p.x+i*f;var j=h;if(i>d||o.STATUS===I.Draft){j=S.INACTIVE;}g(x,j);}return s;},_addImageTypesToContentTypes:function(c){var e;if(jQuery(c).find('[Extension="png"]').length===0){e=c.createElement("Default");jQuery(e).attr("Extension","png").attr("ContentType","image/png");c.documentElement.appendChild(e);}if(jQuery(c).find('[Extension="jpeg"]').length===0){e=c.createElement("Default");jQuery(e).attr("Extension","jpeg").attr("ContentType","image/jpeg");c.documentElement.appendChild(e);}if(jQuery(c).find('[Extension="jpg"]').length===0){e=c.createElement("Default");jQuery(e).attr("Extension","jpg").attr("ContentType","application/octet-stream");c.documentElement.appendChild(e);}return"<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>"+_.serializeToString(c.documentElement).replace(R.EMPTY_NAMESPACE,"");},_stringToArrayBuffer:function(s){var A=new ArrayBuffer(s.length);var B=new Uint8Array(A);for(var i=0,c=s.length;i<c;i++){B[i]=s.charCodeAt(i);}return A;},_getImagePlaceholderDimensions:function(s,i){var o=jQuery.parseXML(s);var e=o.getElementsByTagNameNS("*","sp");var p;jQuery.each(e,function(c,f){var g=f.getElementsByTagNameNS("*","t");if(g&&g.length>0&&f.getElementsByTagNameNS("*","t")[0].firstChild.data===i){p=f;return false;}});if(p){var d=p.getElementsByTagNameNS("*","xfrm")[0];var O=d.getElementsByTagNameNS("*","off")[0];var E=d.getElementsByTagNameNS("*","ext")[0];return{name:i,x:parseInt(O.getAttribute("x"),10),y:parseInt(O.getAttribute("y"),10),cx:parseInt(E.getAttribute("cx"),10),cy:parseInt(E.getAttribute("cy"),10)};}},_addImage:function(i,p,f,s,r){var c='<p:pic>'+'<p:nvPicPr>'+'<p:cNvPr id="'+i+'" name="Picture '+i+'"/>'+'<p:cNvPicPr>'+'<a:picLocks noChangeAspect="1"/>'+'</p:cNvPicPr>'+'<p:nvPr/>'+'</p:nvPicPr>'+'<p:blipFill>'+'<a:blip r:embed="rId'+i+'" cstate="print">'+'<a:extLst>'+'<a:ext uri="{28A0092B-C50C-407E-A947-70E740481C1C}">'+'<a14:useLocalDpi xmlns:a14="http://schemas.microsoft.com/office/drawing/2010/main" val="0"/>'+'</a:ext>'+'</a:extLst>'+'</a:blip>'+'<a:stretch>'+'<a:fillRect/>'+'</a:stretch>'+'</p:blipFill>'+'<p:spPr>'+'<a:xfrm>'+'<a:off x="'+p.x+'" y="'+p.y+'"/>'+'<a:ext cx="'+p.cx+'" cy="'+p.cy+'"/>'+'</a:xfrm>'+'<a:prstGeom prst="rect">'+'<a:avLst/>'+'</a:prstGeom>'+'</p:spPr>'+'</p:pic>';s=s.replace(new RegExp("<p:sp>(?:(?!<p:sp>).)*Rectangle(?:(?!<p:sp>).)*"+p.name+".*?<\/p:sp>","g"),c);var o=jQuery.parseXML('<Relationship Id="rId'+i+'" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/image" Target="../media/'+'image'+i+"."+f+'"/>');var d=jQuery.parseXML(r);d.documentElement.appendChild(o.documentElement);return{SlideContent:s,RelsSlideContent:"<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>"+_.serializeToString(d.documentElement).replace(R.EMPTY_NAMESPACE,"")};},_addProcessIndicator:function(i,s){var p=this._getImagePlaceholderDimensions(s,"{{PROCESS_INDICATOR}}");if(!p){return s;}var c=this._getProcessIndicator(i,p);s=s.replace(new RegExp("<p:sp>(?:(?!<p:sp>).)*Rectangle(?:(?!<p:sp>).)*"+p.name+".*?<\/p:sp>","g"),c);return s;},_addTitelImage:function(i,z,c,s,r){if(i.TITLE_IMAGE_ID){var p=this._getImagePlaceholderDimensions(s,"{{IDEA_TITLE_IMAGE}}");if(p){var f=i.TITLE_IMAGE_MEDIA_TYPE.indexOf("/")>-1?i.TITLE_IMAGE_MEDIA_TYPE.split("/")[1]:i.TITLE_IMAGE_MEDIA_TYPE;var d=new jQuery.Deferred();var o=new XMLHttpRequest();o.onreadystatechange=function(){if(o.readyState===4){if(o.status===200){var j=o.response||o.responseText;z.file("ppt/media/image"+c+"."+f,j);d.resolve();}else{d.resolve();}}};var A=C.getBackendRootURL()+"/"+C.getSystemSetting("sap.ino.config.URL_PATH_XS_ATTACHMENT_TITLE_IMAGE_DOWNLOAD")+"/"+i.TITLE_IMAGE_ID;o.open("GET",A,true);o.responseType="arraybuffer";o.send(null);var e=this._addImage(c,p,f,s,r);e.ZIP=z;e.ImageDeferred=d;return e;}}var g;var B=i.NAME.indexOf(" ");if(B>-1){g=i.NAME.substring(0,Math.min(B,8));var h=i.NAME.substring(B+1);B=h.indexOf(" ");if(B>-1){g=g+"\n"+h.substring(0,Math.min(B,8));}else{g=g+"\n"+h.substring(0,8);}}else{g=i.NAME.substring(0,8);}g=this._getValidXMLString(g);return{ZIP:z,SlideContent:s.replace(R.IDEA_TITLE_IMAGE,g.toUpperCase()),RelsSlideContent:r};},_getMaxSlideId:function(r){var m=1;jQuery.each(r,function(i,s){var c=jQuery(s).attr('Id');try{var d=parseInt(c.substring(3),10);m=m<d?d:m;}catch(e){}});return m;},convertToFormatPPTX:function(E){var d=jQuery.Deferred();var t=this._getTemplate();var c=this;t.done(function(T){try{var z=J(T);var s=z.file("ppt/slides/slide1.xml").asText();var f=s.match(/{{\w*}}/g);z.remove("ppt/slides/slide1.xml");var r=z.file("ppt/slides/_rels/slide1.xml.rels").asText();z.remove("ppt/slides/_rels/slide1.xml.rels");var o=jQuery.parseXML(z.file("[Content_Types].xml").asText());var g=o.getElementsByTagName("Types")[0];var h=jQuery(o).find("[PartName='/ppt/slides/slide1.xml']")[0];g.removeChild(h);var p=z.file("ppt/presentation.xml").asText();var P=jQuery.parseXML(z.file("ppt/_rels/presentation.xml.rels").asText());var i=P.getElementsByTagName("Relationships")[0];var j=jQuery(i).find("[Target='slides/slide1.xml']")[0];i.removeChild(j);var k=c._getMaxSlideId(i.childNodes)+1;var l=c._getText("LIST_TIT_FILTER_CAMPAIGN_HEADER");var m=c._getText("LIST_TIT_FILTER_IDEA_HEADER");var n=c._getText("LIST_TIT_FILTER_PHASE_HEADER");var q=c._getText("LIST_TIT_FILTER_STATUS_HEADER");var A=c._getText("LIST_TIT_FILTER_AUTHOR_HEADER");var u=c._getText("LIST_TIT_FILTER_COACH_HEADER");var v=c._getText("IDEA_LIST_FLD_STATUS_CHANGE_REASON");var w=[];var N="";var O=400;jQuery.each(E,function(y,B){var G=s;var H=r;var K=B.SHORT_DESCRIPTION||"";if(K.length===500){K+="...";}K=c._getValidXMLString(K);var L=window.location.protocol+"//"+window.location.host+window.location.pathname+"#/idea/"+B.ID;var M=B.CAMPAIGN_COLOR||"ffffff";var Q=b.calculateMediaTextColor(M.substr(0,2),M.substr(2,2),M.substr(4,2)).slice(1);jQuery.each(f,function(Y,Z){switch(Z){case"{{IDEA_NAME}}":G=G.replace(new RegExp(Z,"g"),c._getValidXMLString(B.NAME));break;default:break;}});G=G.replace(R.CAMPAIGN_TEXT,l);G=G.replace(R.IDEA_TITLE,m);G=G.replace(R.PHASE_TEXT,n);G=G.replace(R.STATUS_TEXT,q);G=G.replace(R.COACH_TEXT,u);G=G.replace(R.AUTHOR_TEXT,A);G=G.replace(R.IDEA_SHORT_DESCRIPTION,K);G=G.replace(R.IDEA_PHASE,F.PHASE_FORMATTER(B.PHASE));G=G.replace(R.IDEA_STATUS,F.STATUS_FORMATTER(B.STATUS));G=G.replace(R.CAMPAIGN_NAME,c._getValidXMLString(B.CAMPAIGN_NAME));G=G.replace(R.COACH_NAME,B.COACH_NAME||"");G=G.replace(R.AUTHOR_NAME,B.SUBMITTER_NAME);G=G.replace(R.CAMPAIGN_COLOR,M.toUpperCase());G=G.replace(R.CAMPAIGN_TEXT_COLOR,Q.toUpperCase());G=G.replace(R.STATUS_CHANGE_REASON_TEXT,v);G=G.replace(R.STATUS_CHANGE_REASON,F.VALUE_OPTION(B.REASON_CODE));H=H.replace(R.IDEA_LINK,L);var U=c._addTitelImage(B,z,O,G,H);z=U.ZIP;G=U.SlideContent;H=U.RelsSlideContent;if(U.ImageDeferred){w.push(U.ImageDeferred);O++;}G=c._addProcessIndicator(B,G);z.file("ppt/slides/slide"+k+".xml",G);z.file("ppt/slides/_rels/slide"+k+".xml.rels",H);var V=h.cloneNode();jQuery(V).attr("PartName","/ppt/slides/slide"+k+".xml");g.appendChild(V);var W=O++;N=N+"<p:sldId id=\""+O++ +"\" r:id=\"rId"+W+"\"/>";var X=j.cloneNode();jQuery(X).attr("Id","rId"+W).attr("Target","slides/slide"+k+".xml");i.appendChild(X);k++;});z.remove("[Content_Types].xml");var x=c._addImageTypesToContentTypes(o);z.file("[Content_Types].xml",x);z.remove("ppt/presentation.xml");p=p.replace(new RegExp("<p:sldId [^>]*(r:)?id[^>]*(r:)?id[^>]*\/>","g"),N);z.file("ppt/presentation.xml",p);z.remove("ppt/_rels/presentation.xml.rels");z.file("ppt/_rels/presentation.xml.rels","<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>"+_.serializeToString(P.documentElement));jQuery.when.apply(jQuery,w).then(function(){d.resolve(z.generate({type:"blob"}));});}catch(e){d.reject(e.toString());}});return d.promise();}};});
