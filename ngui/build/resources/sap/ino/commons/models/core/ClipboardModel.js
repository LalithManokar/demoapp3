/*!
 * SAP Innovation Management (c) Copyright 2014 SAP AG. All rights reserved.
 */
sap.ui.define(["sap/ino/commons/models/aof/ApplicationObjectChange","sap/ino/commons/application/Configuration","sap/ui/model/json/JSONModel"],function(A,C,J){"use strict";var O="object";var E="entry";var a="changed";var I="isEmpty";var b="enabled";var N={Root:"Root"};var c=J.extend("sap.ino.commons.models.core.ClipboardModel",{metadata:{events:{"objectAdded":{},"objectRemoved":{},"objectRevalidated":{},"objectInvalid":{},"clipboardOpen":{}}},constructor:function(n){J.apply(this,[]);this.initialized=false;this.namesRead=false;this.clipboardVisible=false;this.clipboardEnabled=false;this.name=n;var t=this;A.attachChange(A.Action.All,function(e){if(e.actionName===A.Action.Del){t.remove(e.getParameter("object"),e.getParameter("key"));}else{t._validateObject(e);}});},setODataModel:function(o){this._oODataModel=o;},setEnabled:function(e){if(e){this.clipboardEnabled=true;this._initialize();this.setProperty("/"+b,true);}else{this.clipboardEnabled=false;this.setProperty("/"+b,false);}},_changed:function(){this.setProperty("/"+a,new Date());this._isEmpty();},_isEmpty:function(){this.setProperty("/"+I,this.isClipboardEmpty());},_entry:function(o,k,n){return{objectName:o.getMetadata().getName(),key:k,name:n};},_setName:function(o,k){var d=new jQuery.Deferred();if(!o.readSource){return d;}var m=o.getApplicationObjectMetadata();var p=this.getObjectForKey(o,k);var t=this;p.done(function(D){if(D){var e=o.getMetadata().getName();var n=m.nodes[N.Root].nameAttribute;var f=D[n];var r=jQuery.grep(t.getProperty("/"+O)||[],function(g){return g.name==e;});if(r.length!=0){var g=r[0];r=jQuery.grep(g[E]||[],function(h){return h.key==k;});if(r.length!=0){var h=r[0];h.name=f;}}t.checkUpdate(true);d.resolve();}else{t._invalidObject(o,k,d);}});p.fail(function(e){t._invalidObject(o,k,d);});return d.promise();},_invalidObject:function(o,k,d){this.remove(o,k);this.fireEvent("objectInvalid",{applicationObject:o,key:k,entrySet:o.readSource.entitySetName,entityKey:this._getEntityKey(o,k)});d.reject();},prepare:function(){this._initialize();},_initialize:function(){if(!this.initialized){this.initialized=true;this._loadState();}},_validateObject:function(e){this._initialize();var t=this;var o=e.getParameter("object");var k=e.getParameter("key");if(this.isInClipboard(o,k)){t.revalidate(o,k);}},_getEntityKey:function(o,k){return o.readSource.entitySetName+"("+k+")";},clipboardOpened:function(){this._initialize();this.clipboardVisible=true;if(!this.namesRead){this.namesRead=true;this.revalidate();}this._storeState();},clipboardClosed:function(){this._initialize();this.clipboardVisible=false;this._storeState();},toggle:function(o,k,n){this._initialize();if(!this.isInClipboard(o,k)){this.add(o,k,n);return true;}this.remove(o,k);return false;},add:function(o,k,n){this._initialize();if(k<=0){return;}n=n||"";var d=new jQuery.Deferred();var e=o.getMetadata().getName();var f=this._entry(o,k,n);var g="/"+O;var h=this.getProperty(g);if(!h){h=[];this.setProperty(g,h);}var r=jQuery.grep(h||[],function(i){return i.name==e;});var i=null;if(r.length==0){i={name:e,};i[E]=[];h.push(i);}else{i=r[0];}r=jQuery.grep(i[E]||[],function(l){return l.key==k;});var j=null;if(r.length==0){j=f;i[E].push(j);this._setName(o,k).done(d.resolve);}else{j=r[0];j.name=n;d.resolve();}this._storeState();this.checkUpdate(true);this._changed();this.fireEvent("objectAdded",{objectName:e,key:k,entry:f});return d.promise();},remove:function(o,k){this._initialize();var d=undefined;if(o){d=o.getMetadata().getName();var e=this.getProperty("/"+O)||[];var r=jQuery.grep(e,function(f){return f.name==d;});if(r.length!==0){var f=r[0];if(k){r=jQuery.grep(f[E]||[],function(g){return g.key==k;});if(r.length!==0){var g=r[0];f[E].splice(jQuery.inArray(g,f[E]),1);}if(f[E].length===0){e.splice(jQuery.inArray(f,e),1);}}else{e.splice(jQuery.inArray(f,e),1);}}if(e&&e.length===0){this.setData({enabled:this.clipboardEnabled});}}else{this.setData({enabled:this.clipboardEnabled});}this._storeState();this.checkUpdate(true);this._changed();this.fireEvent("objectRemoved",{objectName:d,key:k});},revalidate:function(o,k){this._initialize();var t=this;if(o){var d=o.getMetadata().getName();if(k){this._setName(o,k).done(function(){t.fireEvent("objectRevalidated",{objectName:d,key:k});});}else{var r=jQuery.grep(this.getProperty("/"+O)||[],function(e){return e.name==d;});if(r.length!=0){var e=r[0];jQuery.each(e[E],function(i,f){var k=f.key;t._setName(o,k).done(function(){t.fireEvent("objectRevalidated",{objectName:e.name,key:k});});});}}}else{jQuery.each(this.getProperty("/"+O)||[],function(i,e){o=c.loadObject(e.name);jQuery.each(e[E],function(i,f){var k=f.key;t._setName(o,k).done(function(){t.fireEvent("objectRevalidated",{objectName:e.name,key:k});});});});}},isInClipboard:function(o,k){this._initialize();var r=jQuery.grep(this.getProperty("/"+O)||[],function(d){return d.name==o.getMetadata().getName();});if(r.length!=0){var d=r[0];r=jQuery.grep(d[E]||[],function(e){return e.key==k;});if(r.length!=0){return true;}}return false;},isClipboardEmpty:function(o){if(!o){return(this.getProperty("/"+O)||[]).length<=0;}var r=jQuery.grep(this.getProperty("/"+O)||[],function(d){return d.name==o.getMetadata().getName();});if(r.length!=0){var d=r[0];return(d[E]||[]).length<=0;}return true;},getObjectForKey:function(o,k){var m=o.getApplicationObjectMetadata();return o.readSource(k,o.getObjectName(),m,{onlyRoot:true,model:this._oODataModel});},getObjectKeys:function(o,f){this._initialize();var k=[];if(o){var r=jQuery.grep(this.getProperty("/"+O)||[],function(d){return d.name==o.getMetadata().getName();});if(r.length!=0){var d=r[0];jQuery.each(d[E],function(i,e){k.push(e.key);});}}if(f){var i=k.indexOf(f);if(i>-1){k.splice(i,1);}}return k;},setProperty:function(){this._initialize();J.prototype.setProperty.apply(this,arguments);},getProperty:function(){this._initialize();return J.prototype.getProperty.apply(this,arguments);},_loadState:function(){jQuery.sap.require("jquery.sap.storage");var t=this;var S=jQuery.sap.storage(jQuery.sap.storage.Type.local);var k=this._getStateKey();var d=S.get(k);if(d){try{var D={enabled:this.clipboardEnabled};D[O]=[];var o=JSON.parse(d);if(o.userId==C.getCurrentUser().USER_ID){delete o.userId;jQuery.each(o,function(f,K){var g={name:f};g[E]=[];var h=c.loadObject(f);jQuery.each(K,function(i,k){var j=t._entry(h,k,"");g[E].push(j);});D[O].push(g);});}this.setData(D);this._changed();this._storeState();}catch(e){jQuery.sap.log.debug("JSON string "+d+" from local storage for could not be parsed for key "+k,undefined,"ClipboardModel");}}},_storeState:function(){var S={userId:C.getCurrentUser().USER_ID};jQuery.each(this.getProperty("/"+O)||[],function(i,e){var K=[];jQuery.each(e[E],function(i,f){K.push(f.key);});S[e.name]=K;});var o=jQuery.sap.storage(jQuery.sap.storage.Type.local);var k=this._getStateKey();var d=o.put(k,JSON.stringify(S));if(!d){jQuery.sap.log.debug("State could not be stored in local storage for key "+k,undefined,"ClipboardModel");}},_getStateKey:function(){return this.getMetadata().getName()+"-"+this.name;}});c.loadObject=function(o){jQuery.sap.require(o);return jQuery.sap.getObject(o,0);};var s=null;c.sharedInstance=function(){if(!s){s=new c("__shared_instance__");}return s;};c.getInSharedClipboardFormatter=function(o){return function(k){return c.sharedInstance.isInClipboard(o,k);};};c.getSharedClipboardNotEmptyFormatter=function(o){return function(){return!c.sharedInstance().isClipboardEmpty(o);};};return c;});
