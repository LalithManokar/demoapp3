/*!
 * SAP Innovation Management (c) Copyright 2014 SAP AG. All rights reserved.
 */
sap.ui.define(["sap/ino/commons/models/aof/ApplicationObjectChange","sap/ino/commons/models/aof/PropertyModel","sap/ui/base/ManagedObject","sap/ui/model/odata/v2/ODataListBinding"],function(A,P,M,O){"use strict";var o={};var d={};var a;var b=M.extend("sap.ino.commons.models.core.ModelSynchronizer",{metadata:{}});b=new b({});function u(n,h){if(h&&n){for(var p in n){if(n.hasOwnProperty(p)){h.setProperty("/"+p,n[p]);}}return true;}return false;}function c(S,t){if(S&&t){for(var p in t){if(S.hasOwnProperty(p)&&t.hasOwnProperty(p)){if(t[p]&&typeof t[p]==="object"&&(t[p].hasOwnProperty("__deferred")||t[p].hasOwnProperty("__list")||t[p].hasOwnProperty("__ref"))){continue;}t[p]=S[p];}}return true;}return false;}function g(E,k){var C=new RegExp("^"+E+"\\(.*"+k+"\\)$");var h=new RegExp("^"+E+"\\(.*(')("+k+")\\1\\)$");var i=new RegExp("^"+E+"\\(.*="+k+"\\)$");var j=new RegExp("^"+E+"\\(.*(=')("+k+")\\1\\)$");var D=a.getProperty("/");var l;var m=[];jQuery.each(D,function(K){if(C.test(K)||h.test(K)){m.push(K);}});if(m.length>1){m.forEach(function(K){if(i.test(K)||j.test(K)){l=K;}});}else{l=m&&m[0];}return l;}function r(E,l){var U;if(l&&l.length>0){U=[];l.forEach(function(B){var C=-1;if(B.aLastContexts&&B.aLastContexts.length>0){B.aLastContexts.forEach(function(L,i){if(L.getPath()==="/"+E){C=i;}});}if(C>-1){U.push({"index":C,"bindingContext":B.aLastContexts[C],"bindingToUpdate":B,"isClientOperation":B.bClientOperation,"allKeys":B.aAllKeys});B.bClientOperation=true;B.aAllKeys=B.aKeys.slice();B.aKeys.splice(C,1);B.aLastContexts.splice(C,1);}});}return U;}function e(B){jQuery.each(B,function(E,C){C.forEach(function(t){t.bindingToUpdate.bClientOperation=true;t.bindingToUpdate.aAllKeys=t.bindingToUpdate.aKeys.slice();t.bindingToUpdate.aKeys.splice(t.index,0,E);t.bindingToUpdate.aLastContexts.splice(t.index,0,t.bindingContext);});});}function f(B){jQuery.each(B,function(E,C){C.forEach(function(t){t.bindingToUpdate.bClientOperation=t.isClientOperation;t.bindingToUpdate.aAllKeys=t.allKeys;});});}function s(E,k,D){var B={};var C={};var l=false;jQuery.each(E,function(i,h){function j(p){function q(N){if(N&&N.length>3){return N.substring(0,N.length-4);}return N;}if(p instanceof O){var v=p&&p.oEntityType&&p.oEntityType.name;v=q(v)+"Type"===v?q(v):undefined;return v===h||p.getPath()==="/"+h;}return false;}var m=g(h,k);var t=a.getProperty("/"+m);if(t){c(D,t);C[m]=true;var L=a.aBindings.filter(j);l=L.length>0;if(l){var n=r(m,L);if(n){B[m]=n;}}}});a.checkUpdate(true,false,C);if(l){e(B);a.checkUpdate(true,false,C);f(B);}}b.putApplicationObject=function(h,i){var j=i.getApplicationObject().getMetadata().getName();if(!o[j]){o[j]={};}if(!o[j][h]){o[j][h]=[];}var I=o[j][h];if(jQuery.inArray(i,I)===-1){I.push(i);}};b.removeApplicationObject=function(h,i){var j=i.getApplicationObject().getMetadata().getName();var I=o&&o[j]&&o[j][h];if(I){o[j][h]=jQuery.grep(I,function(k,l){return i!==k;});}};b.getApplicationObject=function(h,i){return o&&o[h]&&o[h][i];};b.addAOInstanceDependency=function(h,D,S){if(h&&D&&S){var i=d[h];if(!i){d[h]={};i=d[h];}i[D]={"dependentModel":D,"syncFunction":S};return true;}return false;};b.setODataModel=function(n){a=n;};b.getODataModel=function(){return a;};b._getApplicationObjectByName=function(i){jQuery.sap.require(i);return jQuery.sap.getObject(i,0);};b.syncEntity=function(E){var D=new jQuery.Deferred();var h=g(E.entitySetName,E.entitySetKey);if(h){a.read("/"+h,{success:function(i){s([E.entitySetName],E.entitySetKey,i);D.resolve({success:true});},error:function(R){if(R.response.statusCode!==404){jQuery.sap.log.error("Error when retrieving "+E.entitySetKey,undefined,"sap.ino.commons.models.core.ModelSynchronizer");}D.reject({success:true});}});}else{D.reject({success:true});}return D.promise();};b.update=function(I,h,j,k,D,C){if(I){j=j||I.getApplicationObject();k=k||I.getKey();D=D||I.getData();}var E=j&&j.invalidation&&j.invalidation.entitySets;var l;if(D){if(E){s(E,k,D);}l=k&&j&&b.getApplicationObject(j.getMetadata().getName(),k);if(l&&l.length>1){jQuery.each(l,function(i,v){if(v!==I){u(D,v);}});if(I&&I.getPropertyModel()){I.getPropertyModel().getDataInitializedPromise().done(function(){jQuery.each(l,function(i,v){if(v!==I&&v.getPropertyModel()){v.getPropertyModel().sync(k,true);}});});}}}else{if(!I&&k&&h!=="del"){var m=j.getMetadata().getName();var S=b._getApplicationObjectByName(m);var n=S.readData(k,{model:a,onlyRoot:true});if(n){n.done(function(i){if(E){s(E,k,i);}var v=b.getApplicationObject(m,k);if(v){jQuery.each(v,function(w,x){u(i,x);});}});}P.invalidateCachedProperties(j.getObjectName(),k);}}var p=h&&j.actionImpacts&&j.actionImpacts[h];var q=[];if(p){p.forEach(function(i){if(i.objectName!==undefined){q.push(i);}});}if(q&&q.length>0){jQuery.each(q,function(i,v){var w=v.objectName;var x=C&&v.objectKey&&C[v.objectKey];if(x&&!Array.isArray(x)){x=[x];}if(x&&w){var y=b._getApplicationObjectByName(w);var z=y.getMetadata().getName();var B={model:a,projection:v.impactedAttributes};jQuery.each(x,function(F,G){var H=y.readSource(G,z,{},B);H.done(function(T){var J=y&&y.invalidation&&y.invalidation.entitySets;s(J,G,T);l=b.getApplicationObject(w,G);if(l){jQuery.each(l,function(K,L){u(T,L);});}});});}});}if(p){p.forEach(function(i){if(i.entitySetName!==undefined){b.syncEntity(i);}});}var t=I&&d&&d[I];if(t){jQuery.each(t,function(i,v){if(v&&v.dependentModel&&v.syncFunction){v.syncFunction(I,v.dependentModel);}});}if(h==="del"&&l){l.forEach(function(i){b.removeApplicationObject(I.getKey(),i);i._isDeleted=true;});delete o[j.getMetadata().getName()][k];}};A.attachChange(A.Action.All,function(E){var i=E.getParameter("instance");var h=E.getParameter("actionName");var j=E.getParameter("object");var k=E.getParameter("key");var D=E.getParameter("dataUpdate");var C=E.getParameter("changeRequest");b.update(i,h,j,k,D,C);});return b;});
