/*!
 * SAP Innovation Management (c) Copyright 2014 SAP AG. All rights reserved.
 */
sap.ui.define(["sap/ino/commons/models/aof/MetaModel","sap/ui/base/ManagedObject","sap/ui/model/Sorter","sap/ui/core/format/DateFormat"],function(M,a,S,D){"use strict";var R={};var N={Root:"Root"};var d=D.getDateInstance({pattern:"yyyy-MM-dd"});R.getDefaultODataSource=function(e,s,o){var f=function(K,O,m,A){o=o||A.model;var j=A.groupSetting;var r={};K=typeof(K)==="string"?"'"+K+"'":K;if(jQuery.isPlainObject(K)){var n=jQuery.map(K,function(V,L){return L+"='"+V+"'";});K=n.join(",");}var B="/"+e+"("+K+")";var P=null;var q=jQuery.extend({},m.nodes);s=f.settings(A);if(s&&s.includeNodes){jQuery.each(s.includeNodes,function(i,L){if(!q[L.name]){q[L.name]=L;}});}var t=h(q);if(t.length>0){P=["$expand="+t.join(",")];}if(s&&s.projection&&s.projection.length>0){var u="$select=";jQuery.each(s.projection,function(i,L){if(s.projection.length-1===i){u+=L;}else{u+=L+",";}});if(!P){P=[];}P.push(u);}var w=true;if(s&&s.async!==undefined){w=s.async;}var U=s&&s.useBuffer;var x=[];var y=new jQuery.Deferred();if(!U){o.read(B,{urlParameters:P,success:function(L){jQuery.extend(r,g(c(L),t));y.resolve(L);},error:function(L){o.fireRequestFailed((L&&L.response)?L.response:{statusCode:400});y.reject(L);}});}else{o.createBindingContext("/"+B,null,P,function(L){if(L&&L.getObject()){var Q=L.getObject();jQuery.extend(r,g(c(Q),t));y.resolve(Q);}else{y.reject();}});}x.push(y);function z(E){var L=B+"/"+E;var y=new jQuery.Deferred();var F=m.nodes[E];var Q=F&&[new S(F.primaryKey)];if(!U){o.read(L,{async:true,groupId:j&&j[E],sorters:Q,success:function(T){r[E]=c(T);y.resolve(T);},error:function(T){if(T.statusCode==404){r[E]=[];y.resolve([]);}else{y.reject(T);}}});}else{o.createBindingContext("/"+L,null,null,function(T){if(T&&T.getObject()){var V=T.getObject();r[E]=c(V);y.resolve(V);}else{y.resolve([]);}});}return y;}var C=s&&s.onlyRoot;if(!C){for(var E in q){var F=q[E];if(F.name==N.Root||F.parentNode!=N.Root){continue;}if(s&&s.excludeNodes&&s.excludeNodes.indexOf(E)>=0){continue;}var G=false;for(var i=0;i<t.length;i++){var H=t[i];if(H.indexOf(E)===0){G=true;break;}}if(s&&s.deepChildPaths){if(s.deepChildPaths[E]){G=true;}}if(G){continue;}x.push(z(E));}}var I=new jQuery.Deferred();var J=jQuery.when.apply(jQuery,x);J.done(function(){var L=m.isConcurrencyControlEnabled?l(r,m.nodes[N.Root]):undefined;v(r,m,"Root",b);I.resolve(r,L);});J.fail(function(L){I.reject(L);});return I.promise();};function g(m,n){for(var i=0;i<n.length;i++){var q=n[i];var r=q.split("/");var t=m;for(var j=0;j<r.length;j++){var u=r[j];if(t[u]===undefined){break;}if(t[u]==null){t[u]=[];break;}t=t[u];}}return m;}function h(n){var i=[];var j;for(j in n){var m=n[j];if(m.name==N.Root){continue;}if(s&&s.excludeNodes&&s.excludeNodes.indexOf(j)>=0){continue;}if(s&&s.deepChildPaths&&s.deepChildPaths[j]){continue;}var C=k(m,n);if(C&&C.indexOf("/")!=-1){i.push(C);}}if(s&&s.deepChildPaths){for(j in s.deepChildPaths){if(s&&s.excludeNodes&&s.excludeNodes.indexOf(j)>=0){continue;}var q=s.deepChildPaths[j];if(q.indexOf("/")!==-1){i.push(q);}}}i=i.filter(function(r,t,u){return u.indexOf(r)===t;});i.sort();return i;}function k(n,i){var P=n.name;while(n.parentNode&&n.parentNode!=N.Root){n=i[n.parentNode];P=n.name+"/"+P;}return P;}function l(i,n){var t={};jQuery.each(n.attributes,function(A,j){if(j.concurrencyControl){var V=i[A];if(V instanceof Date){V=V.toISOString();}t[A]=V;}});return JSON.stringify(t);}(function(s){f.settings=function(A){if(A){return m(s,A);}return s;};function m(s,A){s=s||{};A=A||{};return{deepChildPaths:jQuery.extend(s.deepChildPaths||{},A.deepChildPaths||{}),excludeNodes:(s.excludeNodes||[]).concat(A.excludeNodes||[]),includeNodes:(s.includeNodes||[]).concat(A.includeNodes||[]),projection:(s.projection||[]).concat(A.projection||[]),async:A.async!==undefined?A.async:s.async,onlyRoot:A.onlyRoot!==undefined?A.onlyRoot:s.onlyRoot,useBuffer:A.useBuffer!==undefined?A.useBuffer:s.useBuffer};}}(s));f.entitySetName=e;return f;};R.getDefaultAOFSource=function(s){return function(k,o,m,A){var e=new jQuery.Deferred();var E=jQuery.extend({},s,A);var u=M.getEndpoint(o);var f=jQuery.ajax({url:u+"/"+k,type:"GET",dataType:"json",async:E.async!==undefined?E.async:true,cache:E.cache,contentType:"application/json",headers:E.headers||undefined});f.done(function(r,g,j){var C=j.getResponseHeader("ETag");v(r,m,"Root",p);e.resolve(r,C);});f.fail(function(r){e.reject(r);});return e.promise();};};function p(n,o,s){if(n&&o&&s&&jQuery.isPlainObject(n)){var e=o.nodes&&o.nodes[s]&&o.nodes[s].attributes;if(e){jQuery.each(e,function(i,A){if(A.dataType){if(A.dataType==="TIMESTAMP"){n[i]=new Date(n[i]);}}});}}}function b(n,o,s){if(n&&o&&s&&jQuery.isPlainObject(n)){var e=o.nodes&&o.nodes[s]&&o.nodes[s].attributes;if(e){jQuery.each(e,function(i,A){if(A.dataType&&A.dataType==="DOUBLE"){if(n[i]!==null){n[i]=parseFloat(n[i]);}}if(A.dataType==="DATE"){n[i]=d.format(n[i]);}});}}}function v(n,o,s,P){if(n&&o&&s&&P){P(n,o,s);for(var e in n){var C=n[e];if(C&&n.hasOwnProperty(e)&&jQuery.isArray(C)&&C.length>0){jQuery.each(C,function(i,f){if(jQuery.isPlainObject(f)){v(f,o,e,P);}});}}}}function c(o){if(!o){return{};}o=jQuery.extend(true,{},o);var C;if(o.results){C=[];jQuery.each(o.results,function(i,r){C.push(c(r));});}else{if(o.__metadata){delete o.__metadata;}jQuery.each(o,function(P,e){if(e&&e.constructor==Object){if(e.__deferred){delete o[P];}else{o[P]=c(e);}}if(e&&jQuery.isArray(e)){jQuery.each(e,function(i,f){c(f);});}});C=o;}return C;}R.cleanData=c;R.setMetaModel=function(m){M=m;};return R;});
