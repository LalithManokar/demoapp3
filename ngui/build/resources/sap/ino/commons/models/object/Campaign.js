/*!
 * SAP Innovation Management (c) Copyright 2014 SAP AG. All rights reserved.
 */
sap.ui.define(["sap/ino/commons/models/aof/ApplicationObject","sap/ino/commons/models/aof/PropertyModel","sap/ino/commons/models/core/ReadSource","sap/ino/commons/models/core/Extensibility","sap/ino/commons/application/Configuration","sap/ui/core/message/Message","sap/ui/core/MessageType","sap/ui/core/format/DateFormat","sap/ino/commons/models/core/CodeModel"],function(A,P,R,E,C,M,c,D,d){"use strict";var S={Draft:"sap.ino.config.CAMP_DRAFT",Published:"sap.ino.config.CAMP_PUBLISHED"};var f=A.extend("sap.ino.commons.models.object.Campaign",{objectName:"sap.ino.xs.object.campaign.Campaign",readSource:R.getDefaultODataSource("CampaignFull"),invalidation:{entitySets:["CampaignFull","CampaignSmall","CampaignSmallIdeaAssign","CampaignCount","CampaignSearch","CampaignSearchParams","CampaignEntityCount","MyCampaignFollow"]},determinations:{onCreate:function(o,a){var t=D.setBeginOfDay(new Date());var O=new Date();O.setFullYear(O.getFullYear()+1);sap.ui.ino.models.util.Date.setEndOfDay(O);var v=d.getCodes("sap.ino.xs.object.campaign.VoteType.Root");var V;if(v&&v.length>0){V=v[0].CODE;}var i={VALID_FROM:t,VALID_TO:O,SUBMIT_FROM:t,SUBMIT_TO:O,IS_BLACK_BOX:0,STATUS_CODE:S.Draft,COLOR_CODE:"FFFFFF",VOTE_TYPE_CODE:V,LanguageTexts:[],Managers:[],Experts:[],Coaches:[],Participants:[],LanguagePages:[],Attachments:[]};_(i,a);E.initExtensionNode(i,"Extension",a);return i;},onRead:function(o,e){_(o,e);o.LanguagePages.sort(function(a,b){return a.PAGE_NO-b.PAGE_NO;});o.Phases.sort(function(a,b){return a.SEQUENCE_NO-b.SEQUENCE_NO;});E.initExtensionNode(o,"Extension",e);return o;},onPersist:function(o,a){P.invalidateCachedProperties("sap.ino.xs.object.iam.Group");},onNormalizeData:function(o){jQuery.each(o.LanguagePages||[],function(i,p){p.PAGE_NO=i;});jQuery.each(o.Phases||[],function(i,p){p.SEQUENCE_NO=i;});return o;},onMergeConcurrentChanges:function(m,u){jQuery.each(u.LanguageTexts||[],function(I,t){if(t.ID<0){var l=t.LANG;var a=t.ID;var b=jQuery.grep(m.LanguageTexts||[],function(t,I){return t.LANG===l&&t.ID!==a;});if(b.length===1){t.ID=b[0].ID;jQuery.extend(b[0],t);for(var i=0;m.LanguageTexts;i++){if(m.LanguageTexts[i].ID===a){m.LanguageTexts.splice(i,1);return;}}}}});return m;}},actions:{publish:{enabledCheck:function(o,e){if(e===undefined){return o.getProperty("/property/actions/create/enabled");}else{var u=o.getProperty("/property/actions/update/enabled");var s=o.getProperty("/property/actions/submit/enabled");return u&&s&&e;}},execute:function(k,o,p,a,s){var b=(o.getProperty("/STATUS_CODE")==S.Draft);var e=new jQuery.Deferred();var m=o.modify(s);m.fail(e.reject);if(b){m.done(function(){var g=o.submit(s);g.fail(e.reject);g.done(e.resolve);});}else{m.done(e.resolve);}return e.promise();}},save:{enabledCheck:function(o){if(o.getProperty("/ID")<0){return o.getProperty("/property/actions/create/enabled");}else{var u=o.getProperty("/property/actions/update/enabled");var b=(o.getProperty("/STATUS_CODE")==S.Draft);return u&&b;}},execute:function(k,o,p,a,s){return o.modify(s);}}},setProperty:function(p,v){if(p==="/SUBMIT_TO"||p==="/VALID_TO"){sap.ui.ino.models.util.Date.setEndOfDay(v);}return A.prototype.setProperty.apply(this,arguments);},setCampaignImage:function(o){this._setImage(o,"CAMPAIGN_DETAIL_IMG","/CAMPAIGN_IMAGE_ASSIGN_ID","/CAMPAIGN_IMAGE_ID");},setCampaignBackgroundImage:function(o){this._setImage(o,"BACKGROUND_IMG","/CAMPAIGN_BACKGROUND_IMAGE_ASSIGN_ID","/CAMPAIGN_BACKGROUND_IMAGE_ID");},setCampaignMobileSmallBackgroundImage:function(o){this._setImage(o,"SMALL_BACKGROUND_IMG","/CAMPAIGN_SMALL_BACKGROUND_IMAGE_ASSIGN_ID","/CAMPAIGN_SMALL_BACKGROUND_IMAGE_ID");},setCampaignListImage:function(o){this._setImage(o,"CAMPAIGN_LIST_IMG","/CAMPAIGN_LIST_IMAGE_ASSIGN_ID","/CAMPAIGN_LIST_IMAGE_ID");},_setImage:function(o,r,a,s){var p="/Attachments";o.ROLE_TYPE_CODE=r;var b=this.getProperty(p);b=b?b:[];var i=0;var e=0;jQuery.each(b,function(k,g){if(g.ATTACHMENT_ID==o.ATTACHMENT_ID){i=g.ID;jQuery.each(b,function(k,g){if(g.ROLE_TYPE_CODE===r){g.ROLE_TYPE_CODE="ATTACHMENT";e=g.ATTACHMENT_ID;}});g.ROLE_TYPE_CODE=o.ROLE_TYPE_CODE;return false;}return true;});if(i===0){i=this.getNextHandle();o.ID=i;jQuery.each(b,function(k,g){if(g.ROLE_TYPE_CODE===r){g.ROLE_TYPE_CODE="ATTACHMENT";e=g.ATTACHMENT_ID;}});b.push(o);}else{b=jQuery.grep(b,function(g,I){if(g.ATTACHMENT_ID!==e){return true;}return false;});}this.setProperty(a,i);this.setProperty(s,o.ATTACHMENT_ID);this.setProperty(p,b);},clearCampaignImage:function(a){this._clearImage(a,"/CAMPAIGN_IMAGE_ASSIGN_ID","/CAMPAIGN_IMAGE_ID");},clearCampaignBackgroundImage:function(a){this._clearImage(a,"/CAMPAIGN_BACKGROUND_IMAGE_ASSIGN_ID","/CAMPAIGN_BACKGROUND_IMAGE_ID");},clearCampaignMobileSmallBackgroundImage:function(a){this._clearImage(a,"/CAMPAIGN_SMALL_BACKGROUND_IMAGE_ASSIGN_ID","/CAMPAIGN_SMALL_BACKGROUND_IMAGE_ID");},clearCampaignListImage:function(a){this._clearImage(a,"/CAMPAIGN_LIST_IMAGE_ASSIGN_ID","/CAMPAIGN_LIST_IMAGE_ID");},_clearImage:function(a,s,b){this.setProperty(s,null);this.setProperty(b,null);var p="/Attachments";var e=this.getProperty(p);e=jQuery.grep(e,function(o,i){if(o.ID!==a){return true;}return false;});this.setProperty(p,e);},addAttachment:function(n){n.ROLE_TYPE_CODE="ATTACHMENT";this.addChild(n,"Attachments");},removeAttachment:function(i){var a=jQuery.grep(this.getProperty("/Attachments"),function(o){return o.ID===i;});var o=a&&a[0];if(o){if(o.ROLE_TYPE_CODE==="CAMPAIGN_DETAIL_IMG"){this.setProperty("/CAMPAIGN_IMAGE_ASSIGN_ID",null);this.setProperty("/CAMPAIGN_IMAGE_ID",null);}else if(o.ROLE_TYPE_CODE==="BACKGROUND_IMG"){this.setProperty("/CAMPAIGN_BACKGROUND_IMAGE_ASSIGN_ID",null);this.setProperty("/CAMPAIGN_BACKGROUND_IMAGE_ID",null);}else if(o.ROLE_TYPE_CODE==="SMALL_BACKGROUND_IMG"){this.setProperty("/CAMPAIGN_SMALL_BACKGROUND_IMAGE_ASSIGN_ID",null);this.setProperty("/CAMPAIGN_SMALL_BACKGROUND_IMAGE_ID",null);}else if(o.ROLE_TYPE_CODE==="CAMPAIGN_LIST_IMG"){this.setProperty("/CAMPAIGN_LIST_IMAGE_ASSIGN_ID",null);this.setProperty("/CAMPAIGN_LIST_IMAGE_ID",null);}this.removeChild(o);}},addTag:function(n){var m;var t=this.getProperty("/Tags");if(!n.NAME||jQuery.trim(n.NAME).length===0){m=new sap.ui.ino.application.Message({key:"MSG_INVALID_EMPTY_TAG",level:sap.ui.core.MessageType.Error,group:"TAG"});return m;}n.NAME=jQuery.trim(n.NAME);if(!n.TAG_ID&&n.NAME){n.TAG_ID=this.getNextHandle();}var a=jQuery.grep(t,function(T){return T.TAG_ID===n.TAG_ID;});if(a.length===0){this.addChild(n,"Tags");}},validateHTML:function(I){var m=[];jQuery.each(this.getData().LanguagePages,function(i,l){if(I&&l.ID!=I){return;}var a=d.getCodes("sap.ino.xs.object.basis.Language.Root",function(L){return L.ISO_CODE==l.LANG;});var o={"TYPE":"E","MESSAGE":"MSG_CAMPAIGN_INVALID_HTML","REF_ID":l.ID,"REF_NODE":"LanguagePages","REF_FIELD":"HTML_CONTENT","PARAMETERS":[l.TITLE,"{code>sap.ino.xs.object.basis.Language.Root:"+a[0].CODE+"}"]};try{var r=new jQuery(l.HTML_CONTENT);if(!r||r.length===0){m.push(o);}}catch(e){m.push(o);}});return m;},determinePageCreate:function(l){return{ID:this.getNextHandle(),PAGE_NO:0,HTML_CONTENT:"<p></p>",TITLE:"",IS_VISIBLE:1,LANG:l};},determinePhaseCreate:function(){var p=this.getProperty("/Phases");var s=0;for(var i=0;i<p.length;++i){s=p[i].SEQUENCE_NO>=s?p[i].SEQUENCE_NO+1:s;}var a=d.getCodes("sap.ino.xs.object.campaign.Phase.Root");var b="";var e=true;for(var j=0;j<a.length;++j){b=a[j].CODE;e=true;for(var k=0;k<p.length;++k){if(b===p[k].PHASE_CODE){e=false;break;}}if(e){break;}}var g=d.getCodes("sap.ino.xs.object.status.Model.Root");var h=(g&&g.length>0)?g[0].CODE:"";return{PHASE_CODE:b,STATUS_MODEL_CODE:h,EVALUATION_MODEL_CODE:"",VOTING_ACTIVE:1,SHOW_IDEA_IN_COMMUNITY:1,IDEA_CONTENT_EDITABLE:1,SEQUENCE_NO:s,AUTO_EVAL_PUB_CODE:""};},setData:function(o){A.prototype.setData.apply(this,arguments);var e=sap.ui.getCore().getEventBus();e.publish("sap.ui.ino.models.object.Campaign","language_update",{});}});function _(o,a){var e=o.LanguageTexts;var b=d.getCodes("sap.ino.xs.object.basis.Language.Root",function(l){var F=jQuery.grep(e,function(L){return L.LANG==l.ISO_CODE;});return F.length===0;});var i=jQuery.map(b,function(l){return{LANG:l.ISO_CODE,ID:a.getNextHandle(),NAME:"",SHORT_NAME:"",DESCRIPTION:"",IDEA_DESCRIPTION_TEMPLATE:""};});o.LanguageTexts=o.LanguageTexts.concat(i);return o;}f.Status=S;return f;});
