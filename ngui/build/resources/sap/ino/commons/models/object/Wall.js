/*!
 * SAP Innovation Management (c) Copyright 2014 SAP AG. All rights reserved.
 */
sap.ui.define(["sap/ino/commons/models/aof/ApplicationObject","sap/ino/commons/models/core/ReadSource","sap/ino/commons/models/util/WallMapper","sap/ino/commons/models/util/UUID","sap/ino/commons/application/Configuration","sap/ino/commons/models/aof/ApplicationObjectChange"],function(A,R,W,U,C,c){"use strict";var d={Readonly:"Readonly",Write:"Write"};var o="sap.ino.xs.object.wall.Wall";var e;e=A.extend("sap.ino.commons.models.object.Wall",{objectName:o,readSource:R.getDefaultAOFSource({cache:false}),invalidation:{entitySets:["Wall","MyWalls","WallSearch"]},actionImpacts:{"create":[{"objectName":"sap.ino.commons.models.object.Idea","objectKey":"IDEA_ID"}]},determinations:{onRead:f,onNormalizeData:n},constructor:function(){A.apply(this,arguments);this._wallSessionUUID=U.generate();},process:function(a){return e.processRequest(this,a);},getSyncDate:function(){return new Date(this.getLastReadDate().getTime()-2500);},readDeltaData:function(){var p=this.readData({cache:false,headers:{"wall-last-read":this.getSyncDate().toUTCString(),"wall-session-uuid":this._wallSessionUUID}});this._lastReadDate=new Date();return p;},pollDeltaData:function(){var p=jQuery.ajax({url:this.getEndpointURL().replace("/wall.xsjs","/wall_poll.xsjs")+"/"+this.getKey(),type:"GET",dataType:"json",contentType:"application/json",cache:false,headers:{"wall-last-read":this.getSyncDate().toUTCString(),"wall-session-uuid":this._wallSessionUUID}});this._lastReadDate=new Date();return p;},save:function(S){var t=this;var p=this.modify(S);p.done(function(){var D=t.getData();n(D,t);g(D,t);t.setProperty("/WALL_EDITABLE",D.WALL_EDITABLE);t.setProperty("/WALL_ADMINISTRABLE",D.WALL_ADMINISTRABLE);t.setProperty("/CHANGED_AT",(new Date()).toJSON());});return p;},saveItems:function(I,S,b){var t=this;var J=this._stringifyItems(I,true,b);var p=this.process({type:"POST",cache:false,url:this.getEndpointURL(),data:J,async:!S,contentType:"application/json; charset=UTF-8"});p.done(function(r){t.setProperty("/CHANGED_AT",(new Date()).toJSON());var a={object:t.getApplicationObject(),key:t.getProperty("/ID"),dataUpdate:{CHANGED_AT:t.getProperty("/CHANGED_AT")},};c.fireChange(a);});return p;},deleteItems:function(I){var t=this;var a=I.join();var p=this.process({type:"DELETE",cache:false,url:this.getEndpointURL(),headers:{"wall-wallItemIds":a}});p.done(function(r){var b={object:t.getApplicationObject(),key:t.getProperty("/ID"),dataUpdate:{CHANGED_AT:t.getProperty("/CHANGED_AT")}};c.fireChange(b);});return p;},addPermission:function(N){var p=this.getProperty("/Permissions");var m=jQuery.grep(p,function(P){return P.ID===N.ID||P.IDENTITY_ID===N.IDENTITY_ID;});if(m.length===0){N.ID=this.getNextHandle();this.oData.Permissions.push(N);this.oData.Permissions.sort(e.fnSortByName);this.checkUpdate(true);return true;}return false;},notifyPermissionUpdated:function(p){var P=jQuery.grep(this.getProperty("/Permissions")||[],function(a){return a.ID===p;});return P.length>0;},removePermission:function(p){var t=this;var P=jQuery.grep(this.getProperty("/Permissions")||[],function(a){return a.ID===p;});jQuery.each(P,function(a,b){t.removeChild(b);});return P.length!==0;},setBackgroundAttachmentImage:i,clearBackgroundAttachmentImage:j,deltaUpdate:h,_stringifyItems:function(w,I,S){var t=this;var v;if(S){v=w;}else{v=this._mapWallItemsWallToIno(w);}if(I){if(jQuery.type(v)!=="array"){v=[v];}var a={ID:this.getKey(),Items:v};return JSON.stringify(a);}else{return JSON.stringify(v);}},_mapWallItemsWallToIno:function(w){var t=this;if(jQuery.type(w)=="array"){var a=[];w.forEach(function(I){a.push(t._mapWallItemsWallToIno(I));});return a;}else{return W.mapItemToIno(w);}}});function f(D,w){jQuery.each(D.Items||[],function(I,a){if(a.CHANGED_AT>D.CHANGED_AT){D.CHANGED_AT=a.CHANGED_AT;}});s(D,w);g(D,w);return D;}function s(D,w){D.Permissions=[].concat(D.Readers).concat(D.Writers).concat(D.Admins);D.Permissions.sort(e.fnSortByName);}function g(D,w){D.WALL_EDITABLE=!D.IS_LOCKED&&D.IS_EDITABLE===1;D.WALL_ADMINISTRABLE=!D.IS_LOCKED&&D.IS_ADMINISTRABLE===1;}function h(D,a){if(!D){return undefined;}if(D.ACTION_CODE!="DELETED"){var w=W.mapWallFromIno(D,true);if(D.ITEM_SCOPE){delete w.strongestAuth;}a(w);delete D.ID;delete D.ITEM_SCOPE;delete D.ACTION_CODE;D=jQuery.extend(this.getData(),D);s(D,this);g(D,this);this.setData(D);this.setAfterInitChanges();return true;}return false;}function i(a){var b=this.getProperty("/BackgroundImage")||[];if(b.length===0){b=[{ID:this.getNextHandle()}];}b[0].ATTACHMENT_ID=a;this.setProperty("/BackgroundImage",b);this.setProperty("/BACKGROUND_IMAGE_URL","");this.setProperty("/BACKGROUND_COLOR","");this.setProperty("/BACKGROUND_IMAGE_ZOOM",100);this.setProperty("/BACKGROUND_IMAGE_REPEAT",0);this.setProperty("/BACKGROUND_IMAGE_POSITION_X",0);this.setProperty("/BACKGROUND_IMAGE_POSITION_Y",0);}function j(E){this.setProperty("/BackgroundImage",[]);if(!E){this.setProperty("/BACKGROUND_IMAGE_URL","");}this.setProperty("/BACKGROUND_IMAGE_ZOOM",null);this.setProperty("/BACKGROUND_IMAGE_REPEAT",null);this.setProperty("/BACKGROUND_IMAGE_POSITION_X",null);this.setProperty("/BACKGROUND_IMAGE_POSITION_Y",null);}function n(D,w){var b=w.getBeforeData();D.Readers=[];D.Writers=[];D.Admins=[];jQuery.each(D.Permissions||[],function(a,p){var B=jQuery.grep(b.Permissions,function(k){return k.IDENTITY_ID===p.IDENTITY_ID;});var I=p.ID;if(B.length>0&&B[0].ROLE_CODE!==p.ROLE_CODE){I=w.getNextHandle();}switch(p.ROLE_CODE){case"WALL_READER":D.Readers.push({ID:I,IDENTITY_ID:p.IDENTITY_ID});break;case"WALL_WRITER":D.Writers.push({ID:I,IDENTITY_ID:p.IDENTITY_ID});break;case"WALL_ADMIN":D.Admins.push({ID:I,IDENTITY_ID:p.IDENTITY_ID});break;default:break;}});return D;}e.readItems=function(w,a){return jQuery.ajax({url:e.getBackendUrl(),headers:{"wall-action":"readItems","wall-wallIds":w.toString()},accepts:"application/json",async:a!==false,cache:false});};e.readWalls=function(w,a){return jQuery.ajax({url:e.getBackendUrl(),headers:{"wall-action":"readWalls","wall-wallIds":w.toString()},accepts:"application/json",async:a!==false,cache:false});};e.getBackendUrl=function(){return C.getBackendRootURL()+C.getApplicationObject(o);};e.fnSortByName=function(a,b){var N=a&&a.IDENTITY_NAME&&a.IDENTITY_NAME.toLowerCase();var k=b&&b.IDENTITY_NAME&&b.IDENTITY_NAME.toLowerCase();return((N<k)?-1:((N>k)?1:0));};e.processRequest=function(w,a){var p=[a];if(!a.headers||!a.headers["wall-session-uuid"]){if(!a.headers){a.headers={};}a.headers["wall-session-uuid"]=w._wallSessionUUID||U.generate();}var P;if(!w._lastProcessPromise){P=A.prototype.process.apply(w,p);}else{var D=jQuery.Deferred();w._lastProcessPromise.hasSuccessor=true;w._lastProcessPromise.always(function(){A.prototype.process.apply(w,p).always(function(r,S,b){D.resolve(r,S,b);}).fail(function(r){D.reject(r);});});P=D.promise();}w._lastProcessPromise=P;P.always(function(){if(w._lastProcessPromise&&!w._lastProcessPromise.hasSuccessor){w._lastProcessPromise=null;}});return P;};return e;});
