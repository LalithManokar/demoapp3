/*!
 * SAP Innovation Management (c) Copyright 2014 SAP AG. All rights reserved.
 */
sap.ui.define(["sap/ino/commons/models/aof/ApplicationObject","sap/ino/commons/models/core/ReadSource","sap/ino/commons/application/Configuration","sap/ui/unified/FileUploaderParameter","sap/ino/thirdparty/jimp.min"],function(A,R,C,F){"use strict";var a=A.extend("sap.ino.commons.models.object.Attachment",{objectName:"sap.ino.xs.object.attachment.Attachment",readSource:R.getDefaultODataSource("Attachment")});function b(u,o,s,t,S,e,c){var d=new FormData();if(Array.isArray(o)){o.map(function(f){if(s!==null&&s!==undefined){d.append("upload",f,s);}else{d.append("upload",f,s);}});}else{if(s!==null&&s!==undefined){d.append("upload",o,s);}else{d.append("upload",o);}}var h={};h.label=c;return jQuery.ajax({url:u,type:t,headers:h,success:function(r){var f=a.parseUploadResponse(r);if(jQuery.type(S)==="function"){S(f);}},error:function(r){if(jQuery.type(e)==="function"){e(r);}},data:d,cache:false,contentType:false,processData:false});}a.prepareFileUploader=function(f,c){f.removeAllHeaderParameters();var o=new F({name:"x-csrf-token",value:C.getXSRFToken()});f.addHeaderParameter(o);var d=new F({name:"unicode_filename",value:a.stringToUnicode(c[0].name)});f.addHeaderParameter(d);};a.uploadFile=function(f,s,i,c){var d=new jQuery.Deferred();var e=f.name||f.type.replace(/\//g,".");var u=i?'/'+i:'';var U=a.getEndpointURL()+u;var t=i?'PUT':'POST';var g=s&&!i?true:false;if(c){this.compressFile(f,s,g).then(function(D){b(U,D,e,t,function(r){d.resolve(r);},function(){d.reject();});}).catch(function(){d.reject();});}else{b(U,f,e,t,function(r){d.resolve(r);},function(){d.reject();});}return d.promise();};a.uploadFileIncludeFileLabel=function(f,s,S,i,c){var d=new jQuery.Deferred();var e=f.name||f.type.replace(/\//g,".");var u=i?'/'+i:'';var U=a.getEndpointURL()+u;var t=i?'PUT':'POST';var g=S&&!i?true:false;if(c){this.compressFile(f,S,g).then(function(D){b(U,D,e,t,function(r){d.resolve(r);},function(){d.reject();},s);}).catch(function(){d.reject();});}else{b(U,f,e,t,function(r){d.resolve(r);},function(){d.reject();},s);}return d.promise();};function _(B,q){return new Promise(function(r){if(!q){r(B);}else{try{if(B.type.startsWith('image')&&Jimp){var c=new FileReader();c.onload=function(){var f=c.result;Jimp.read(f).then(function(i){var d=i;d=d.quality(q);d.getBufferAsync(B.type).then(function(g){var n=new Blob([g],{type:B.type});n.name=B.name;if(n.size>B.size){r(B);}else{r(n);}});});};c.readAsArrayBuffer(B);}else{r(B);}}catch(e){r(B);}}});}a.compressFile=function(f,s,u){var p=[];if(u&&s){p.push(_(s));}p.push(_(f,20));p.push(_(f,80));return Promise.all(p);};a.parseUploadResponse=function(r){var c=r.match(new RegExp("^<html.*<body>.*((?:[0-9]*...))\]:(.*)</body></html>"));if(c&&c.length===3&&!isNaN(parseInt(c[1],10))){var s=parseInt(c[1],10);try{var o=JSON.parse(c[2]);var d=JSON.parse(c[2]);return{success:s<300,attachmentId:d.GENERATED_IDS&&d.GENERATED_IDS[-1]||null,fileName:d.FILE_NAME,mediaType:d.MEDIA_TYPE,messages:d.MESSAGES};}catch(e){return null;}}else{return null;}};a.stringToUnicode=function(s){return s.replace(/[\s\S]/g,function(e){return"\\u"+("0000"+e.charCodeAt().toString(16)).slice(-4);});};a.unicodeToString=function(s){return s.replace(/\\u[\dABCDEFabcdef][\dABCDEFabcdef][\dABCDEFabcdef][\dABCDEFabcdef]/g,function(m){return String.fromCharCode(parseInt(m.replace(/\\u/g,""),16));});};return a;});
