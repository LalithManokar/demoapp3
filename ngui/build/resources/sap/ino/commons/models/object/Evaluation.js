/*!
 * SAP Innovation Management (c) Copyright 2014 SAP AG. All rights reserved.
 */
sap.ui.define(["sap/ino/commons/models/aof/ApplicationObject","sap/ino/commons/models/core/CodeModel","sap/ino/commons/application/Configuration","sap/ui/model/type/Float","sap/ui/model/type/Integer","sap/ui/core/message/Message","sap/ui/core/MessageType","sap/ui/model/ParseException","sap/ino/commons/models/core/ReadSource"],function(ApplicationObject,CodeModel,Configuration,Float,Integer,Message,MessageType,ParseException,ReadSource){"use strict";var Status={Draft:"sap.ino.config.EVAL_DRAFT"};var Evaluation=ApplicationObject.extend("sap.ino.commons.models.object.Evaluation",{objectName:"sap.ino.xs.object.evaluation.Evaluation",readSource:ReadSource.getDefaultODataSource("IdeaEvaluation",{excludeNodes:["Owner"]}),invalidation:{entitySets:["IdeaEvaluation","IdeaMyEvaluation","IdeaPublishedEvaluation","EvaluationRequestItems"]},actionImpacts:{"del":[{"objectName":"sap.ino.commons.models.object.Idea","objectKey":"IDEA_ID","impactedAttributes":["EVALUATION_COUNT"]}],"create":[{"objectName":"sap.ino.commons.models.object.Idea","objectKey":"IDEA_ID","impactedAttributes":["EVALUATION_COUNT"]}],"modifyAndSubmit":[{"objectName":"sap.ino.commons.models.object.Idea","objectKey":"IDEA_ID","impactedAttributes":["EVALUATION_COUNT"]},{"objectName":"sap.ino.commons.models.object.EvaluationRequestItem","objectKey":"EVAL_REQ_ITEM_ID","impactedAttributes":["STATUS_CODE"]}],"executeStatusTransition":[{"objectName":"sap.ino.commons.models.object.Idea","objectKey":"IDEA_ID","impactedAttributes":["EVALUATION_COUNT"]}]},determinations:{onCreate:function(d,o){var i=d.IDEA_ID;var D=jQuery.Deferred();var t=D.promise();if(i>0){var m=o.getReadSourceModel();var c=[];var T=new jQuery.Deferred();m.read("/IdeaFull("+i+")/EvaluationTemplate",{success:function(e){T.resolve({"oEvaluation":e});},error:function(e){T.reject(e);}});c.push(T);var C=new jQuery.Deferred();m.read("/IdeaFull("+i+")/EvaluationTemplate/CriterionValues",{success:function(e){C.resolve({"oEvaluationCriterionValues":e});},error:function(e){C.reject(e);}});c.push(C);jQuery.when.apply(jQuery,c).done(function(){var e,E;jQuery.each(arguments,function(a,b){if(b.hasOwnProperty("oEvaluation")){e=b.oEvaluation;}else if(b.hasOwnProperty("oEvaluationCriterionValues")){E=b.oEvaluationCriterionValues;}});e.CriterionValues=E.results;e=ReadSource.cleanData(e);h(e);D.resolve(e);});}else{h(d);D.resolve(d);}var h=function(e){var s=new Date();if(e){e.EVALUATOR_NAME=Configuration.getCurrentUser()&&Configuration.getCurrentUser().NAME;e.CREATED_AT=s;e.CHANGED_AT=s;if(e.CriterionValues){jQuery.each(e.CriterionValues,function(I,v){if(!v.NUM_VALUE&&v.NUM_VALUE_MIN!==null){v.NUM_VALUE=v.NUM_VALUE_MIN;}if(v.NUM_VALUE===null){v.NUM_VALUE=0;}v.NUM_VALUE=parseFloat(v.NUM_VALUE);if(v.AGGREGATION_TYPE==="MATRIX"){v.NUM_VALUE=1;}v.ID=o.getNextHandle();});}else{e.CriterionValues=[];}}var f=e.CriterionValues;if(d&&d.aggregationData){if(f){for(var g in d.aggregationData){var j=_getCriterionByCode(f,g);if(j&&(j.DATATYPE_CODE==="INTEGER"||j.DATATYPE_CODE==="NUMERIC")){j.NUM_VALUE=d.aggregationData[g];}else if(j&&j.DATATYPE_CODE==="BOOLEAN"){j.BOOL_VALUE=d.aggregationData[g];}}}}if(d&&d.totalData){if(f){for(var g in d.totalData){var j=_getCriterionByCode(f,g);if(j&&(j.DATATYPE_CODE==="INTEGER"||j.DATATYPE_CODE==="NUMERIC")){j.NUM_VALUE=d.totalData[g].value;}else if(j&&j.DATATYPE_CODE==="BOOLEAN"){j.BOOL_VALUE=d.totalData[g].value;}else if(j&&j.DATATYPE_CODE==="TEXT"){j.TEXT_VALUE=d.totalData[g].value;}j.MSG=d.totalData[g].msg;j.MSG_TOOLTIP=d.totalData[g].msg_tooltip;j.COMMENT=d.totalData[g].comment;}}}e.CriterionValues.sort(function(a,b){return a.SEQUENCE_NO-b.SEQUENCE_NO;});if(f){_updateCompleteCalculations(f);}_buildCriteriaHierarchy(e);};if(d.averEval){jQuery.each(d.EvalAttachments,function(a,e){e.ID=o.getNextHandle();});}return t;},onRead:function(d,o){if(d&&d.CriterionValues){d.CriterionValues.sort(function(a,b){return a.SEQUENCE_NO-b.SEQUENCE_NO;});_buildCriteriaHierarchy(d);}},onPersist:function(k,c,i,a,r,o){},onNormalizeData:function(e){var c=e.CriterionValues;if(c){jQuery.each(e.CriterionValues,function(i,v){v.NUM_VALUE=parseFloat(v.NUM_VALUE);if(v.DATATYPE_CODE==="TEXT"){v.NUM_VALUE=null;}});}return e;}},actions:{modifyAndSubmit:{enabledCheck:function(o,e){var s=o.getProperty("/STATUS_CODE");return s===Status.Draft;},execute:function(k,o,p,a){var d=new jQuery.Deferred();var m=o.modify();m.fail(d.reject);m.done(function(){var s=o.submit();s.fail(d.reject);s.done(d.resolve);});return d.promise();}},del:{enabledCheck:function(i,e){if(e===undefined){return false;}}},executeStatusTransition:{initParameter:function(p,s){p.STATUS_ACTION_CODE=s;}}},setProperty:setProperty,updateDeltaCalculation:updateDeltaCalculation,addBinding:addBinding,addAttachment:_addAttachment,removeAttachment:_removeAttachment});Evaluation.Status=Status;var aNumValuePaths=["NUM_VALUE","criterion/NUM_VALUE"];function addBinding(b){ApplicationObject.prototype.addBinding.apply(this,arguments);var p=b&&b.sPath;var c=b.getContext();if(p&&aNumValuePaths&&aNumValuePaths.indexOf(p)>-1&&c){var o;if(p==="NUM_VALUE"){o=c.getObject();}else if(p==="criterion/NUM_VALUE"){o=c.getObject().criterion;}if(o){switch(o.DATATYPE_CODE){case"INTEGER":b.setType(new Integer(),b.sInternalType);break;case"NUMERIC":b.setType(new Float(),b.sInternalType);break;}}}}function setProperty(sPath,vValue,oContext){var MIN_INT=Number.MIN_SAFE_INTEGER||-9007199254740991;var MAX_INT=Number.MAX_SAFE_INTEGER||9007199254740991;var bSuccess=false;var oObject=oContext&&oContext.getObject();if(!oContext&&sPath.indexOf("/")===0){oObject=this.getData();sPath=sPath.substr(1);}if(sPath.indexOf("NUM_VALUE")>-1&&(vValue>MAX_INT||vValue<MIN_INT)){var oMsg=sap.ui.getCore().getModel(sap.ui.ino.application.ApplicationBase.MODEL_MSG);throw new ParseException(oMsg.getResourceBundle().getText("MSG_NUMERIC_INTERVAL",[vValue,MIN_INT,MAX_INT]));}if(oObject&&sPath){if(oObject&&sPath&&oObject.hasOwnProperty(sPath)){if(oObject.VALUE_OPTION_LIST_CODE){if(sPath==="COMMENT"){oObject[sPath]=vValue;}if(oObject.DATATYPE_CODE==="INTEGER"&&sPath.indexOf("NUM_VALUE")>-1){oObject[sPath]=vValue;}else if(oObject.DATATYPE_CODE==="NUMERIC"&&sPath.indexOf("NUM_VALUE")>-1){oObject[sPath]=vValue;}else if(oObject.DATATYPE_CODE==="TEXT"&&sPath.indexOf("TEXT_VALUE")>-1){oObject[sPath]=vValue;}else if(oObject.DATATYPE_CODE==="BOOLEAN"&&sPath.indexOf("BOOL_VALUE")>-1){oObject[sPath]=vValue;}}else{oObject[sPath]=vValue;}}else if(sPath.indexOf("criterion")>-1){var sPropertyName=sPath.replace("criterion/","");var oCriterion=oObject.criterion;if(oCriterion.hasOwnProperty(sPropertyName)){if(oCriterion.VALUE_OPTION_LIST_CODE){if(sPropertyName==="COMMENT"){oCriterion[sPropertyName]=vValue;bSuccess=true;}if(oCriterion.DATATYPE_CODE==="INTEGER"&&sPath.indexOf("NUM_VALUE")>-1){oCriterion[sPropertyName]=vValue;bSuccess=true;}else if(oCriterion.DATATYPE_CODE==="NUMERIC"&&sPath.indexOf("NUM_VALUE")>-1){oCriterion[sPropertyName]=vValue;bSuccess=true;}else if(oCriterion.DATATYPE_CODE==="TEXT"&&sPath.indexOf("TEXT_VALUE")>-1){oCriterion[sPropertyName]=vValue;bSuccess=true;}else if(oCriterion.DATATYPE_CODE==="BOOLEAN"&&sPath.indexOf("BOOL_VALUE")>-1){oCriterion[sPropertyName]=vValue;bSuccess=true;}}else{oCriterion[sPropertyName]=vValue;bSuccess=true;}}}}var aCriterionValue=this.getData().CriterionValues;if(arguments.length>=3){if(oContext&&(sPath.indexOf("NUM_VALUE")>-1||sPath.indexOf("BOOL_VALUE")>-1)){this.updateDeltaCalculation(aCriterionValue,oContext,sPath);}}else if(arguments.length===2){if(sPath==="/CriterionValues"){_updateCompleteCalculations(aCriterionValue);}}var oData=oContext&&oContext.getModel()&&oContext.getModel().getData();if(oData){var aRootCriteria=oContext.getModel().getData().CriterionValues;var aOverallResult=jQuery.grep(aRootCriteria,function(c,I){return c.IS_OVERALL_RESULT;});var aCriterionValues=oData.CriterionValues;var sCriterionValues=_getNumCriterion(aCriterionValues);var aCalcFormula=oData.MODEL_CALC_FORMULA;var aEnableFormula=oData.MODEL_ENABLE_FORMULA;if(aEnableFormula){for(var i=0;i<sCriterionValues.length;i++){var sCriterionValue=sCriterionValues[i];if(sCriterionValue.DATATYPE_CODE==="NUMERIC"||sCriterionValue.DATATYPE_CODE==="INTEGER"){var sCriterionCode=sCriterionValue.CRITERION_CODE.split('.');sCriterionCode=sCriterionCode.slice(sCriterionCode.length-1).toString();var sCriterionNumValue=sCriterionValue.NUM_VALUE||0;sCriterionNumValue=(!sCriterionValue.AGGREGATION_TYPE&&sCriterionValue.WEIGHT!==null&&sCriterionValue.WEIGHT!==undefined)?sCriterionNumValue*sCriterionValue.WEIGHT*0.01:sCriterionNumValue;aCalcFormula=aCalcFormula.replace(new RegExp("\\$"+sCriterionCode+"(?=[\\/+\\-*\\s,)(]|$)",'g'),sCriterionNumValue);}else{aCalcFormula=aCalcFormula.replace(new RegExp("\\$"+sCriterionCode+"(?=[\\/+\\-*\\s,)(]|$)",'g'),0);}}oData.OV_RES_NUM_VALUE=eval(aCalcFormula);oData.OV_RES_DATATYPE_CODE="NUMERIC";}else if(aOverallResult&&aOverallResult[0]){switch(oData.OV_RES_DATATYPE_CODE){case"INTEGER":oData.OV_RES_NUM_VALUE=aOverallResult[0].NUM_VALUE;break;case"NUMERIC":oData.OV_RES_NUM_VALUE=aOverallResult[0].NUM_VALUE;break;case"BOOLEAN":oData.OV_RES_BOOL_VALUE=aOverallResult[0].BOOL_VALUE;break;case"TEXT":oData.OV_RES_TEXT_VALUE=aOverallResult[0].TEXT_VALUE;break;}}}this.checkUpdate(false,false);return bSuccess;}function updateDeltaCalculation(c,C,a){var p=C.getPath();if(p.indexOf("/CriterionValues/")===0||p.indexOf("/criteriaHierarchy/")===0){var b=false;if(_calcParentAggregation(c,a,this.getProperty("PARENT_CRITERION_CODE",C))){b=true;}if(_calcMatrixAggregation(c)){b=true;}if(b){this.getData().CriterionValues=c;}}}function _updateCompleteCalculations(c){for(var i=0;i<c.length;i++){var C=c[i];if(!C.PARENT_CRITERION_CODE){var d=C.DATATYPE_CODE;if(d==="INTEGER"||d==="NUMERIC"){_calcParentAggregation(c,"NUM_VALUE",C.CODE);}else if(d==="BOOLEAN"){_calcParentAggregation(c,"BOOL_VALUE",C.CODE);}}}_calcMatrixAggregation(c);}function _calcMatrixAggregation(c){var m=_getCriterionByAggregationTypeMatrix(c);if(m.length<=0){return;}for(var i=0;i<m.length;i++){var M=m[i];if(!M.X_AXIS_SEGMENT_NO||!M.X_AXIS_SEGMENT_NO){return;}var d=M.DATATYPE_CODE;if(d!=="INTEGER"&&d!=="NUMERIC"){return;}var x=_getCriterionByCode(c,M.X_AXIS_CRITERION_CODE);var y=_getCriterionByCode(c,M.Y_AXIS_CRITERION_CODE);if(!x||!y){return;}if(x.NUM_VALUE_MIN===null||x.NUM_VALUE_MAX===null||y.NUM_VALUE_MIN===null||y.NUM_VALUE_MAX===null){return;}if(x.NUM_VALUE<x.NUM_VALUE_MIN||x.NUM_VALUE>x.NUM_VALUE_MAX){return;}if(y.NUM_VALUE<y.NUM_VALUE_MIN||y.NUM_VALUE>y.NUM_VALUE_MAX){return;}var a=Math.floor((x.NUM_VALUE-x.NUM_VALUE_MIN)/((x.NUM_VALUE_MAX-x.NUM_VALUE_MIN)/M.X_AXIS_SEGMENT_NO))+1;a=a>M.X_AXIS_SEGMENT_NO?M.X_AXIS_SEGMENT_NO:a;var b=Math.floor((y.NUM_VALUE-y.NUM_VALUE_MIN)/((y.NUM_VALUE_MAX-y.NUM_VALUE_MIN)/M.Y_AXIS_SEGMENT_NO))+1;b=b>M.Y_AXIS_SEGMENT_NO?M.Y_AXIS_SEGMENT_NO:b;M.NUM_VALUE=a+(b-1)*M.X_AXIS_SEGMENT_NO;}return true;}function _calcParentAggregation(c,a,p){if(a!=="NUM_VALUE"&&a!=="BOOL_VALUE"){return;}var C=false;if(p){var P=_getCriterionByCode(c,p);if(!P){return;}var b=_getCriterionsByParentCode(c,p);var d=P.DATATYPE_CODE;var A=P.AGGREGATION_TYPE;if(d==="INTEGER"||d==="NUMERIC"){if(A==="SUM"||A==="AVG"){C=_aggregate(b,P,a);}else if(A==="FORMULA"){C=_getFormulaValue(c,P,a);}}else if(d==="BOOLEAN"){if(A==="AND"||A==="OR"){var e=true;var o=false;jQuery.each(b,function(i,f){if(f.DATATYPE_CODE===d){e=e&&f[a]&&f[a]===1;if(f[a]){o=o||f[a]===1;}}});if(A==="AND"){P[a]=e?1:0;}else if(A==="OR"){P[a]=o?1:0;}C=true;}if(A==="AVG"){C=_aggregate(b,P,a);}}if(P.PARENT_CRITERION_CODE){if(_calcParentAggregation(c,a,P.PARENT_CRITERION_CODE)){return true;}}}return C;}function _aggregate(c,p,a){var d=p.DATATYPE_CODE;var A=p.AGGREGATION_TYPE;if((d==="BOOL_VALUE"||a==="BOOL_VALUE")&&d!==a){return;}var s=0;var f=0;jQuery.each(c,function(i,C){if(((C.DATATYPE_CODE==="INTEGER"||C.DATATYPE_CODE==="NUMERIC")&&a==="NUM_VALUE")||(C.DATATYPE_CODE==="BOOLEAN"&&a==="BOOL_VALUE")){if(C[a]){if(C.WEIGHT===undefined||C.WEIGHT===null){s+=C[a];}else{s+=C[a]*C.WEIGHT*0.01;}}f++;}});if(A==="SUM"){if(d==="BOOLEAN"){p[a]=Math.max(s,1);}else if(d==="INTEGER"){if(p.WEIGHT===undefined||p.WEIGHT===null){p[a]=Math.round(s);}else{p[a]=Math.round(s*p.WEIGHT*0.01);}}else{if(p.WEIGHT===undefined||p.WEIGHT===null){p[a]=s;}else{p[a]=s*p.WEIGHT*0.01;}}}else if(A==="AVG"){p[a]=s/f;if(d==="BOOLEAN"){p[a]=Math.round(p[a]);}else if(d==="INTEGER"){p[a]=(p.WEIGHT===undefined||p.WEIGHT===null)?Math.round(p[a]):Math.round(p[a]*p.WEIGHT*0.01);}else{p[a]=(p.WEIGHT===undefined||p.WEIGHT===null)?p[a]:p[a]*p.WEIGHT*0.01;}}return true;}function _getFormulaValue(a,p,A){var d=p.DATATYPE_CODE;if((d==="BOOL_VALUE"||A==="BOOL_VALUE")&&d!==A){return false;}function g(c){if(!c){return"";}if(c.lastIndexOf(".")>-1){return c.substr(c.lastIndexOf(".")+1);}return c;}var v=a,f=p.FORMULA,r=f.match(/\$([^+\-*\/\s\)\(,]+)/gm),n=void 0;for(var i=0;i<v.length;i++){for(var j=0;j<r.length;j++){if(r[j]==="$"+g(v[i].CODE)){n=v[i][A];if(!v[i].AGGREGATION_TYPE&&(v[i].DATATYPE_CODE==="NUMERIC"||v[i].DATATYPE_CODE==="INTEGER")){var w=v[i].WEIGHT;if(!w){w=100;}n*=(Number(w)||100)/100;}f=f.replace(r[j],n);}}}try{var P=p.WEIGHT;if(!P){P=100;}var R=Math.round(Number(window.eval(f))*Number(P))/100;if(d==="INTEGER"){R=Math.round(R);}p[A]=R;}catch(e){p[A]=0;}return true;}function _getCriterionByCode(c,C){return jQuery.map(c,function(o){if(o.CODE===C){return o;}})[0];}function _getCriterionsByParentCode(c,p){return jQuery.map(c,function(C){if(C.PARENT_CRITERION_CODE===p){return C;}});}function _getRootCriteria(c){return jQuery.map(c,function(C){if(C.PARENT_CRITERION_CODE===null||C.PARENT_CRITERION_CODE===""){return C;}});}function _getNumCriterion(c){return jQuery.map(c,function(C){if(C.DATATYPE_CODE==="NUMERIC"||C.DATATYPE_CODE==="INTEGER"){return C;}});}function _getCriterionByAggregationTypeMatrix(c,C){return jQuery.map(c,function(o){if(o.AGGREGATION_TYPE==="MATRIX"){return o;}});}function _calculateOVResult(oDefaultData){var oOverallResultCriterion=oDefaultData&&oDefaultData.criteriaHierarchy&&oDefaultData.criteriaHierarchy.overallResultCriterion;var aCriterionValues=oDefaultData.CriterionValues;var sCriterionValues=_getNumCriterion(aCriterionValues);var aCalcFormula=oDefaultData.MODEL_CALC_FORMULA;var aEnableFormula=oDefaultData.MODEL_ENABLE_FORMULA;if(aEnableFormula){for(var i=0;i<sCriterionValues.length;i++){var sCriterionValue=sCriterionValues[i];if(sCriterionValue.DATATYPE_CODE==="NUMERIC"||sCriterionValue.DATATYPE_CODE==="INTEGER"){var sCriterionCode=sCriterionValue.CRITERION_CODE.split('.');sCriterionCode=sCriterionCode.slice(sCriterionCode.length-1).toString();var sCriterionNumValue=sCriterionValue.NUM_VALUE||0;if(isNaN(sCriterionNumValue)){sCriterionNumValue=0;}sCriterionNumValue=(!sCriterionValue.AGGREGATION_TYPE&&sCriterionValue.WEIGHT!==null&&sCriterionValue.WEIGHT!==undefined)?sCriterionNumValue*sCriterionValue.WEIGHT*0.01:sCriterionNumValue;aCalcFormula=aCalcFormula.replace(new RegExp("\\$"+sCriterionCode+"(?=[\\/+\\-*\\s,)(]|$)",'g'),sCriterionNumValue);}else{aCalcFormula=aCalcFormula.replace(new RegExp("\\$"+sCriterionCode+"(?=[\\/+\\-*\\s,)(]|$)",'g'),0);}}oDefaultData.OV_RES_NUM_VALUE=eval(aCalcFormula);oDefaultData.OV_RES_DATATYPE_CODE="NUMERIC";}else if(oOverallResultCriterion){oDefaultData.OV_RES_NUM_VALUE=oOverallResultCriterion.NUM_VALUE;oDefaultData.OV_RES_BOOL_VALUE=oOverallResultCriterion.BOOL_VALUE;oDefaultData.OV_RES_DATATYPE_CODE=oOverallResultCriterion.DATATYPE_CODE;oDefaultData.OV_RES_VALUE_OPTION_LIST_CODE=oOverallResultCriterion.VALUE_OPTION_LIST_CODE;oDefaultData.OV_RES_UOM_CODE=oOverallResultCriterion.UOM_CODE;}}function _buildCriteriaHierarchy(d){var h={};var c=d.CriterionValues;var r=_getRootCriteria(c);var o=jQuery.grep(r,function(C,i){return C.IS_OVERALL_RESULT;});h.overallResultCriterion=o[0];var a=jQuery.grep(r,function(C,i){return C.IS_OVERALL_RESULT===0;});h.aggregatingCriteria=[];if(o&&o.length>0&&o[0].AGGREGATION_TYPE!=="MATRIX"){h.aggregatingCriteria.push({criterion:h.overallResultCriterion,children:_getCriterionsByParentCode(c,h.overallResultCriterion.CRITERION_CODE)});}if(a&&a.length>0){jQuery.each(a,function(i,C){h.aggregatingCriteria.push({criterion:C,children:_getCriterionsByParentCode(c,C.CRITERION_CODE)});});}jQuery.each(c,function(i,C){if(C.VALUE_OPTION_LIST_CODE){var s="sap.ino.xs.object.basis.ValueOptionList.Root_"+C.VALUE_OPTION_LIST_CODE;C.valueOptionList=CodeModel.getCodes(s,function(b){return b.ACTIVE===1;});}if(C.NUM_VALUE){C.NUM_VALUE=Math.round(C.NUM_VALUE*100)/100;}});d.criteriaHierarchy=h;if(d.OV_RES_DATATYPE_CODE||d.MODEL_ENABLE_FORMULA){_calculateOVResult(d);}}function _addAttachment(n){n.ROLE_TYPE_CODE="ATTACHMENT";this.addChild(n,"EvalAttachments");}function _removeAttachment(i){var a=jQuery.grep(this.getProperty("/EvalAttachments")||[],function(A){return A.ID===i;});var f=a&&a[0];if(f){this.removeChild(f);}}Evaluation.createAverageEvaluation=function(i,e,s,E,c){var a={};var A={};var o={};var f=function(j,V){var k=a[j.CRITERION_CODE];if(!k){k=0;}k+=parseFloat(j[V])||0;a[j.CRITERION_CODE]=k;var l=A[j.CRITERION_CODE];if(!l){l=0;}l++;A[j.CRITERION_CODE]=l;var m=o[j.CRITERION_CODE];if(!m){m=j.DATATYPE_CODE;o[j.CRITERION_CODE]=m;}};jQuery.each(e,function(I,j){jQuery.each(j,function(k,l){if(l.DATATYPE_CODE==="INTEGER"||l.DATATYPE_CODE==="NUMERIC"){f(l,"NUM_VALUE");}else if(l.DATATYPE_CODE==="BOOLEAN"){f(l,"BOOL_VALUE");}});});for(var C in a){var v=a[C];var b=A[C];var d=o[C];v=v/b;if(d==="INTEGER"||d==="BOOLEAN"){v=Math.round(v);}else if(d==="NUMERIC"){v=Math.round(v*100)/100;}a[C]=v;}var g=[];jQuery.each(E,function(j,k){g=g.concat(k);});var h=new Evaluation({IDEA_ID:i,aggregationData:a,averEval:true,COMMENT:c,EvalAttachments:g},s);return h;};Evaluation.createTotalEvaluation=function(i,e,s,E,c,n,f){var t={};var a={};var A=function(j,v){t[j.CRITERION_CODE]=t[j.CRITERION_CODE]||{comment:""};var k=t[j.CRITERION_CODE].value;if(!k){k=0;}k+=parseFloat(j[v])||0;t[j.CRITERION_CODE].value=k;t[j.CRITERION_CODE].maxVal=parseFloat(j.NUM_VALUE_MAX)||0;t[j.CRITERION_CODE].minVal=parseFloat(j.NUM_VALUE_MIN)||-9007199254740991;var l=a[j.CRITERION_CODE];if(!l){l=j.DATATYPE_CODE;a[j.CRITERION_CODE]=l;}};jQuery.each(e,function(I,j){jQuery.each(j,function(k,l){t[l.CRITERION_CODE]=t[l.CRITERION_CODE]||{comment:""};if(l.DATATYPE_CODE==="INTEGER"||l.DATATYPE_CODE==="NUMERIC"){A(l,"NUM_VALUE");}else if(l.DATATYPE_CODE==="BOOLEAN"){if(t[l.CRITERION_CODE].value===undefined||t[l.CRITERION_CODE].value===null){t[l.CRITERION_CODE].value=l.BOOL_VALUE;}}else if(l.DATATYPE_CODE==="TEXT"){if(!t[l.CRITERION_CODE].value||t[l.CRITERION_CODE].value.trim().length===0){t[l.CRITERION_CODE].value=l.TEXT_VALUE;}}t[l.CRITERION_CODE].comment+=" "+(l.COMMENT||"");});});for(var C in t){var d=a[C];if(t[C].hasOwnProperty("maxVal")){var b=t[C].maxVal;if(b&&t[C].value>b){var m=f([t[C].value,b],1);t[C].msg=m.msg;t[C].msg_tooltip=m.msg_tooltip;t[C].value=b;}}if(t[C].hasOwnProperty("minVal")){var g=t[C].minVal;if(g&&t[C].value<g){var M=f([t[C].value,g],2);t[C].msg=M.msg;t[C].msg_tooltip=M.msg_tooltip;t[C].value=g;}}if(d==="INTEGER"){t[C].value=Math.round(t[C].value);}else if(d==="NUMERIC"){t[C].value=Math.round(t[C].value*100)/100;}}var h=[];jQuery.each(E,function(j,k){h=h.concat(k);});var o=new Evaluation({IDEA_ID:i,totalData:t,averEval:true,EvalAttachments:h,COMMENT:c},s);return o;};return Evaluation;});
