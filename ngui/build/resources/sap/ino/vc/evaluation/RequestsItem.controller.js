sap.ui.define(["sap/ino/vc/commons/BaseObjectModifyController","sap/ino/commons/models/object/EvaluationRequestItem","sap/ino/commons/models/object/EvaluationRequestComment","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ino/vc/commons/TopLevelPageFacet","sap/ino/commons/models/aof/PropertyModel","sap/ui/model/Filter","sap/m/Token","sap/ui/model/FilterOperator","sap/ui/model/Sorter","sap/ui/core/MessageType","sap/ui/core/message/Message","sap/m/MessageBox","sap/ino/commons/application/Configuration","sap/ino/vc/evaluation/EvaluationFormatter"],function(B,E,a,M,J,T,P,F,b,c,S,d,e,f,C,g){"use strict";return B.extend("sap.ino.vc.evaluation.RequestsItem",jQuery.extend({},T,{routes:["evaluationrequest-item"],onInit:function(){B.prototype.onInit.apply(this,arguments);},onRouteMatched:function(){B.prototype.onRouteMatched.apply(this,arguments);var o=this;o.setHelp("EVALUATIONREQUESTS_ITEM");var r=this.getObjectModel();r.getDataInitializedPromise().done(function(D){if(r.oData.Clarifications.length>0){o.setViewProperty("/CLARIFICATION_DISPLAY",false);}o.bindDefaultODataModel.call(o,D.ID);r.setProperty("/InitRefObjectId",D.EVAL_REQ_ID);o._commentMixinInitCommentModel();});o.setViewProperty("/USER_IMAGE_ID",o.getOwnerComponent().getCurrentUserImageId());},createObjectModel:function(o){return new E(o,{actions:["update","del","executeStatusTransition","sendClarification","forward"],continuousUse:true,readSource:{model:this.getDefaultODataModel()}});},_commentMixinInitCommentModel:function(){this.byId("commentViewList").getController().commentMixinInit({commentInputId:"commentInputField",commentListId:"commentList",successMessageKey:"MSG_CREATE_SUCCESS_COMMENT",editDialogViewName:"sap.ino.vc.comment.EditCommentDialog"});},getODataEntitySet:function(){return"EvaluationRequestItem";},onOpenCreator:function(o){var s=o.getSource();var i=s.getBindingContext("object").getProperty("FROM_IDENTITY_ID");if(!this.oIdentityCardView){this.oIdentityCardView=sap.ui.xmlview({viewName:"sap.ino.vc.iam.IdentityCard"});this.getView().addDependent(this.oIdentityCardView);}this.oIdentityCardView.getController().open(s,i);},onRequestItemPress:function(){this.navigateTo("evaluationrequest-item",{id:this.getObjectModel().getKey()});},onIdeaPressed:function(){var i=this.getObjectModel().getProperty("/IDEA_ID");this.navigateTo("idea-display",{id:i},true);},onAccept:function(){this.onExecuteStatusTransition("sap.ino.config.EVAL_REQ_ACCEPT");},onReject:function(){this.onExecuteStatusTransition("sap.ino.config.EVAL_REQ_REJECT");},onForward:function(){var r=this.createRequestForwardDialog();var t=this;r.open();t.addForwardExpertInputHandling(this.byId("inputForwardExpert"),{suggestion:{key:"ID",text:"NAME",additionalText:"USER_NAME",path:"data>/SearchIdentity(searchToken='$suggestValue')/Results",filters:[new F({path:"ID",operator:c.NE,value1:C.getCurrentUser().USER_ID})],sorter:new S("NAME")},token:{key:"IDENTITY_ID",text:"NAME"}});},addForwardExpertInputHandling:function(o,s){if(!o){return;}var t=this;var h=t._createSuggestHandler(s.suggestion);o.attachSuggest(h,t);},onForwardClose:function(){this._oRequestForwardDialog.close();this.byId("inputForwardExpert").removeAllTokens();this.byId("txtAreaForwardReasonDes").setValue("");},onSubmitForward:function(){var t=this;var o=t.byId("inputForwardExpert").getTokens();var s=t.byId("inputForwardExpert").getValue();if(o.length>0&&!s){t.resetClientMessages();var i=parseInt(o[0].mProperties.key,10);var h=t.executeObjectAction("forward",{parameters:{EXPERT_ID:i,COMMENT_FORWARD:t.byId("txtAreaForwardReasonDes").getValue().trim()},messages:{success:"EVALUATIONREQUESTS_MSG_FORWARD_SUCCESS",error:"EVALUATIONREQUESTS_MSG_FORWARD_FAILURE"}});h.fail(function(r){if(r.MESSAGES.length>0){f.error(r.MESSAGES[0].MESSAGE_TEXT,{actions:[f.Action.OK],onClose:function(D){}});}});h.done(function(){t._oRequestForwardDialog.close();t.byId("inputForwardExpert").removeAllTokens();t.byId("txtAreaForwardReasonDes").setValue("");t.navigateTo("idea-display",{id:t.getObjectModel().oData.IDEA_ID},true);});h.always(function(){t._oRequestForwardDialog.setBusy(false);});}else{t.setClientMessage(new e({code:"EVALUATIONREQUESTS_MSG_FORWARD_NO_EXPERT",type:d.Error}),t.byId("inputForwardExpert"));}},onSubmitClarification:function(){var t=this;var s=t.byId("txtAreaClarificationReasonDes").getValue().trim();if(s){t.resetClientMessages();var o=t.executeObjectAction("sendClarification",{parameters:{TO_IDENTITY:t.getObjectModel().getProperty("/OWNER_ID"),CONTENT:s},messages:{success:"EVALUATIONREQUESTS_MSG_CLARIFICATION_SUCCESS",error:"EVALUATIONREQUESTS_MSG_CLARIFICATION_FAILURE"}});o.done(function(){t.byId("txtAreaClarificationReasonDes").setValue("");t._oRequestClarificationDialog.close();t.setViewProperty("/CLARIFICATION_DISPLAY",false);});o.always(function(){t._oRequestClarificationDialog.setBusy(false);});}else{t.setClientMessage(new e({code:"EVALUATIONREQUESTS_MSG_CLARIFICATION_NO_RESON",type:d.Error}),this.byId("txtAreaClarificationReasonDes"));t.byId("txtAreaClarificationReasonDes").setValue("");}},onCreateClarification:function(){var o=this.createClarificationDialog();o.open();},onClarificationClose:function(){this.byId("txtAreaClarificationReasonDes").setValue("");this._oRequestClarificationDialog.close();},onCreateEvaluation:function(){this.navigateTo("evaluation-create",{query:{ideaId:this.getObjectModel().getProperty("/IDEA_ID"),EvalReqItemId:this.getObjectModel().getKey()}});},onExecuteStatusTransition:function(s){var h=this;var m=h.getObjectModel();var A=m.executeStatusTransition({STATUS_ACTION_CODE:s});if(A){A.done(function(){M.show(h.getText("OBJECT_MSG_STATUS_CHANGE_SUCCESS"));});A.fail(function(o){if(o.MESSAGES&&o.MESSAGES.length>0){M.show(h.getText(o.MESSAGES[0].MESSAGE_TEXT));}});}},createRequestForwardDialog:function(){if(!this._oRequestForwardDialog){this._oRequestForwardDialog=this.createFragment("sap.ino.vc.evaluation.fragments.RequestForward",this.getView().getId());this.getView().addDependent(this._oRequestForwardDialog);}return this._oRequestForwardDialog;},createClarificationDialog:function(){if(!this._oRequestClarificationDialog){this._oRequestClarificationDialog=this.createFragment("sap.ino.vc.evaluation.fragments.RequestCreateClarification",this.getView().getId());this.getView().addDependent(this._oRequestClarificationDialog);}return this._oRequestClarificationDialog;},onEvaluationRequestOwnerPressed:function(o){o.preventDefault();var s=o.getSource();if(s){var i=s.getBindingContext("object")&&s.getBindingContext("object").getProperty("OWNER_ID");if(i!==undefined&&!this.oIdentityCardView){this.oIdentityCardView=sap.ui.xmlview({viewName:"sap.ino.vc.iam.IdentityCard"});this.getView().addDependent(this.oIdentityCardView);}if(this.oIdentityCardView&&this.oIdentityCardView.getController()){this.oIdentityCardView.getController().open(s,i);}}},createEvaluationFormatter:function(i,s){if(s==='sap.ino.config.EVAL_REQ_EXPIRED'||s==='sap.ino.config.EVAL_REQ_REJECTED'||s==='sap.ino.config.EVAL_REQ_COMPLETED'){return false;}return g.createEvaluationDynamicFormatter(i);}}));});
