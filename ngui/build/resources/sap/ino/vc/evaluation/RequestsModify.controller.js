sap.ui.define(["sap/ino/vc/commons/BaseObjectModifyController","sap/ui/model/json/JSONModel","sap/ino/commons/models/object/EvaluationRequest","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/Sorter","sap/ui/core/MessageType","sap/ui/core/message/Message","sap/ino/vc/commons/TopLevelPageFacet","sap/ino/vc/evaluation/mixins/ExpertFinderMixin","sap/ino/vc/idea/mixins/AddExpertFromClipboardMixin","sap/ino/vc/evaluation/EvaluationFormatter","sap/ino/commons/util/DateUtil"],function(B,J,E,F,a,S,M,b,T,c,A,d,D){"use strict";var r={create:"evaluationrequest-create",edit:"evaluationrequest-edit"};return B.extend("sap.ino.vc.evaluation.RequestsModify",jQuery.extend({},T,c,A,{view:{CLIPBOARD_ITEM_SELECT_COUNTER:0,IS_EVALUATION_REQUEST:false},routes:[r.create,r.edit],_INPUT_EXPERTS_SETTING:{childNodeName:"Experts",childNodeNameSingular:"Expert",suggestion:{key:"ID",text:"NAME",additionalText:"USER_NAME",path:"data>/SearchIdentity(searchToken='$suggestValue')/Results",sorter:new S("NAME")},token:{key:"IDENTITY_ID",text:"NAME"}},onInit:function(){B.prototype.onInit.apply(this,arguments);this.addMultiInputHandling(this.byId("inputExperts"),this._INPUT_EXPERTS_SETTING);this.byId("inputExperts").attachTokenUpdate(this._tokenUpdate,this);this.getView().setModel(new J(this.view),"view");this.setViewProperty("/IS_EVALUATION_REQUEST",true);},_initExpertsFilters:function(){this._findFilters(this.getObjectModel().getProperty("/Experts"),function(e){return e.IDENTITY_ID;});},_tokenUpdate:function(e){if(!e.getSource().getAggregation("tokenizer")){return;}var t=e.getSource().getAggregation("tokenizer").getAggregation("tokens");this._findFilters(t,function(o){return o.getProperty("key");});},_findFilters:function(k,g){this._INPUT_EXPERTS_SETTING.suggestion.filters=undefined;if(!k||k.length<=0){return;}var f=[];jQuery.each(k,function(i,K){f.push(new sap.ui.model.Filter({path:"ID",operator:"NE",value1:g(K)}));});this._INPUT_EXPERTS_SETTING.suggestion.filters=new sap.ui.model.Filter({filters:f,and:true});},createObjectModel:function(o,R,e){var C=this;var k=o;var s={nodes:["Root"],continuousUse:true,concurrencyEnabled:true,readSource:{model:this.getDefaultODataModel()}};var f=new E(k,s);if(!k){var q=e["?query"]||{};var n=parseInt(q.idea,10);try{C.getView().setBusy(true);jQuery.when(f.getReadSourceModel().read("/IdeaMedium("+n+")",{success:function(i){f.setProperty("/RESP_VALUE_CODE",i.RESP_VALUE_CODE);f.setProperty("/IDEA_NAME",i.NAME);f.setProperty("/IDEA_ID",i.ID);f.setProperty("/IDEA_PHASE_CODE",i.PHASE);f.setProperty("/CAMPAIGN_SUBMIT_TO",i.CAMPAIGN_SUBMIT_TO);}})).done(function(){C.getView().setBusy(false);});jQuery.when(f.getReadSourceModel().read("/IdeaFull("+n+")/Experts",{success:function(i){f.setProperty("/IdeaExpertsForDialog",i.results);}})).done(function(){C.getView().setBusy(false);});jQuery.when(f.getReadSourceModel().read("/IdeaFull("+n+")/RespExperts",{success:function(i){f.setProperty("/RespExpertsForDialog",i.results);}})).done(function(){C.getView().setBusy(false);});jQuery.when(f.getReadSourceModel().read("/IdeaFull("+n+")/CampaignExperts",{success:function(i){f.setProperty("/CampExpertsForDialog",i.results);}})).done(function(){C.getView().setBusy(false);});}catch(g){jQuery.sap.log.error("Failed parsing creation arguments",g,"evaluationrequest-create");}}return f;},onRouteMatched:function(){var C=this;B.prototype.onRouteMatched.apply(this,arguments);C.setHelp("EVALUATIONREQUESTS_MODIFY");C.getObjectModel().getDataInitializedPromise().done(function(){C._initExpertsFilters();});},onSubmit:function(){var C=this;C.resetClientMessages();if(!C.validateContent()){return;}var o=C.getObjectModel().oData;var e=sap.ino.commons.models.object.EvaluationRequest.checkBeforeUpdate(o);e.done(function(R){if(R&&R.RESULT){C.onConfirmDialog(R.RESULT);}else{C.onModify();}});},onModify:function(){var C=this;var o=C.getObjectModel();var e=C.getObjectModel().oData;e.ACCEPT_DATE=D.convertToUtcString(e.ACCEPT_DATE);e.COMPLETE_DATE=D.convertToUtcString(e.COMPLETE_DATE);var m=this.executeObjectAction("modify",{messages:{error:"MSG_EVAL_REQ_INVALID_ERROR"}});m.done(function(){C.navigateTo("idea-display",{id:o.getProperty("/IDEA_ID"),query:{section:"sectionEvaluations"}},true);});m.fail(function(){e.ACCEPT_DATE=D.convertToLocalDate(e.ACCEPT_DATE);e.COMPLETE_DATE=D.convertToLocalDate(e.COMPLETE_DATE);});},onIdeaPressed:function(){var i=this.getObjectModel().getProperty("/IDEA_ID");this.navigateTo("idea-display",{id:i},true);},onDelete:function(e){var C=this;C.resetClientMessages();var o=e.getSource();var f=this.executeObjectAction("del",{messages:{confirm:"MSG_DEL_CONFIRM",success:"MSG_DEL_SUCCESS"}});f.done(function(R){if(R&&R.confirmationCancelled===true){if(o&&jQuery.type(o.focus)==="function"){o.focus();}return;}C.navigateBack();});},onConfirmDialog:function(R){var _={"EXPERT_AMOUNT_WARNING":"MSG_EVAL_REQ_MAX_EXPERT_WARNING","DUPLICATED_EXPERT_WARNING":"MSG_EVAL_REQ_DUPLICATED_EXPERT_WARNING","EXISTED_EVALUATION_WARNING":"MSG_EVAL_REQ_EXISTED_EVALUATION_WARNING"};var C=this;var v=new sap.m.VBox();if(!R||R.length<=0){C.onModify();return;}jQuery.each(R,function(i,f){var o=f instanceof Object;var s=f;if(o){s=f.MSG_CODE;}var t=C.getText(_[s]);var g=new sap.m.Text({text:t});if(!o){g.addStyleClass("sapUiSmallMarginBottom");}v.addItem(g);var h='';if(o&&f.DuplExperts){jQuery.each(f.DuplExperts,function(j,k){h+="<li>"+k+"</li>";});v.addItem(new sap.ui.core.HTML({content:"<ul class='sapUiTinyMarginTop sapUiSmallMarginBottom'>"+h+"</ul>",sanitizeContent:true}));}});var e=new sap.m.Dialog({title:C.getText('IDEA_OBJECT_TIT_CONFIRM_EVALUATION_REQUEST'),type:'Message',content:[v],beginButton:new sap.m.Button({text:C.getText('BTN_OK'),press:function(){var f=C.getObjectModel().getProperty("/Experts");jQuery.each(R,function(i,g){jQuery.each(g.DuplExperts,function(h,s){for(var j=f.length-1;j>=0;j--){if(f[j].NAME===s){f.splice(j,1);}}});});C._initExpertsFilters();C.getObjectModel().setProperty("/Experts",f);C.onModify();e.close();}}),endButton:new sap.m.Button({text:C.getText("BTN_CANCEL"),press:function(){e.close();}}),afterClose:function(){e.destroy();}});e.open();},validateContent:function(){var C=this;var m=C.getObjectModel();var e=m.getProperty("/Experts");if(!e||e.length<=0){var o=new b({code:"MSG_EVAL_REQ_EXPERTS_MANDATORY_ERROR",type:M.Error});C.setClientMessage(o,C.byId("inputExperts"));return false;}if(!m.getProperty("/ACCEPT_DATE")){C.setClientMessage(new b({code:"MSG_EVAL_REQ_ACCEPTANCE_MANDATORY_ERROR",type:M.Error}),C.byId("dpAcceptDate"));return false;}if(!m.getProperty("/COMPLETE_DATE")){C.setClientMessage(new b({code:"MSG_EVAL_REQ_COMPLETION_MANDATORY_ERROR",type:M.Error}),C.byId("dpCompletetDate"));return false;}if(!m.getProperty("/DESCRIPTION")){C.setClientMessage(new b({code:"MSG_EVAL_REQ_DESCRIPTION_MANDATORY_ERROR",type:M.Error}),C.byId("txtAreaDesc"));return false;}return true;},toSubmitDate:function(t,e){return t+" "+d.toDate(e);}}));});
