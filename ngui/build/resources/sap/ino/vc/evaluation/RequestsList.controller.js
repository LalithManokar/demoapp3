sap.ui.define(["sap/ui/Device","sap/ui/model/Sorter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox","sap/ino/commons/application/Configuration","sap/ino/commons/formatters/ObjectListFormatter","sap/ino/commons/models/aof/ApplicationObjectChange","sap/ino/controls/OrientationType","sap/ino/vc/commons/TopLevelPageFacet","sap/ino/vc/commons/BaseVariantListController","sap/ino/vc/evaluation/mixins/MassActionMixin"],function(D,S,F,a,M,C,O,A,b,T,B,c){"use strict";var r={EVALREQ:"evalreqlist",EVALREQ_VARIANT:"evalreqlistvariant"};var v={EVAL_REQ_ALL:"all",EVAL_REQ_FOR_ME:"forme",EVAL_REQ_FOR_ME_OVERDUE:"formeoverdue",EVAL_REQ_MY:"my",EVAL_REQ_MY_OVERDUE:"myoverdue"};var f={NONE:undefined,EVAL_REQ_FOR_ME:"forMe",EVAL_REQ_FOR_ME_OVERDUE:"forMeOverdue",EVAL_REQ_MY:"byMe",EVAL_REQ_MY_OVERDUE:"byMeOverdue"};var l={NAME:"EVAL_REQ_LIST_MIT_NAME",Variants:{DEFAULT_VARIANT:v.EVAL_REQ_ALL,TITLE:"EVAL_REQ_LIST_MIT_ALL",Values:[{TEXT:"EVAL_REQ_LIST_MIT_ALL",ACTION:v.EVAL_REQ_ALL,FILTER:f.NONE,MANAGE:false},{TEXT:"EVAL_REQ_LIST_MIT_FOR_ME",ACTION:v.EVAL_REQ_FOR_ME,HIERARCHY_LEVEL:"1",FILTER:f.EVAL_REQ_FOR_ME,MANAGE:false},{TEXT:"EVAL_REQ_LIST_MIT_FOR_ME_OVERDUE",ACTION:v.EVAL_REQ_FOR_ME_OVERDUE,HIERARCHY_LEVEL:"1",FILTER:f.EVAL_REQ_FOR_ME_OVERDUE,MANAGE:false},{TEXT:"EVAL_REQ_LIST_MIT_MY",ACTION:v.EVAL_REQ_MY,HIERARCHY_LEVEL:"1",FILTER:f.EVAL_REQ_MY,MANAGE:true},{TEXT:"EVAL_REQ_LIST_MIT_MY_OVERDUE",ACTION:v.EVAL_REQ_MY_OVERDUE,HIERARCHY_LEVEL:"1",FILTER:f.EVAL_REQ_MY_OVERDUE,MANAGE:true}]}};var L=B.extend("sap.ino.vc.evaluation.RequestsList",jQuery.extend({},T,c,{formatter:jQuery.extend({},O),list:l,routes:["evalreqlist","evalreqlistvariant"],view:{"List":{"VARIANT":v.EVAL_REQ_ALL,"MANAGE":false,"TAGS":[],"IS_TAGS_SELECTION":false,"TAGCLOUD":true,"TAGCLOUD_EXPABLE":true,"TAGCLOUD_EXP":false,"TAGCLOUD_BAR_VISIBLE":false},"ORIENTATION":b.PORTRAIT},onInit:function(){B.prototype.onInit.apply(this,arguments);this.oViewModel=this.getModel("view");this.oViewModel.setData(this.view,true);this.initApplicationObjectChangeListeners();},onRouteMatched:function(e){this.setGlobalFilter([]);this.setHelp("EVALREQ_LIST");this.show(e);this._bInnerViewNavigation=true;},onCampaignDialogItemsSelect:function(e){var s=e.getParameter("selectedItem").data("ID")+"";var o=this.byId("panelFilterFragment--campaignFilterList");o.getBinding("suggestionItems").filter([]);var d=o.getSuggestionItems();for(var i=0;i<d.length;i++){if(d[i].getProperty("key")===s){o.setSelectionItem(d[i]);break;}}if(s!==this.getViewProperty("/List/CAMPAIGN")){this.setViewProperty("/List/CAMPAIGN",s);this.setFilter(new F("CAMPAIGN_ID",a.EQ,s));this._filter();}},onCampaignDialogSearch:function(e){var o=e.getParameter("itemsBinding");var V=jQuery.sap.encodeURL(e.getParameter("value"));o.filter(new F("SHORT_NAME",a.Contains,V));o.sort(new S("SHORT_NAME"));},onCampaignSuggestion:function(e){var V=this.getModel("view");var o=e.getSource().getBinding("suggestionItems");var E=jQuery.extend({},e,true);var s=E.getParameter("suggestValue");this.resetClientMessages();this.byId("panelFilterFragment--campaignFilterList").setFilterSuggests(false);V.setProperty("/campaignSuggestion",this._aCampaignSuggestion);o.filter(new F("SHORT_NAME",a.Contains,s));o.sort(new S("SHORT_NAME"));},onFilterReset:function(){this.setViewProperty("/List/IDEA_TITLE","");this.setViewProperty("/List/CAMPAIGN_TITLE","");this.setViewProperty("/List/EXPERT_NAME","");this.setViewProperty("/List/STATUS_TEXT","");this.setViewProperty("/List/CAMPAIGN",undefined);this.setViewProperty("/List/ACCEPT_DATE",undefined);this.setViewProperty("/List/COMPLETE_DATE",undefined);var t=this.getList();var o=t.getColumns();for(var i=0;i<o.length;i++){t.filter(o[i],null);}this.byId("panelFilterFragment--campaignFilterList").setValue(undefined);this.setFilter([]);if(!D.system.desktop){return;}},onFilterCampaignChange:function(e){var s=e.getParameter("selectedItem")?Number(e.getParameter("selectedItem").getProperty("key")):undefined;if(s!==this.getViewProperty("/List/CAMPAIGN")){this.setViewProperty("/List/CAMPAIGN",s);this.setFilter(new F("CAMPAIGN_ID",a.EQ,s));this._filter();}},onClearCampaignFilter:function(e){var V=e.getParameter("value");if(V.trim()===""){this.setViewProperty("/List/CAMPAIGN",undefined);this.setFilter([]);this._filter();}},onHandleCampaignFilterHelp:function(){var V=this.getModel("view");if(!this._oCampaignlistDialog){this._oCampaignlistDialog=this.createCampaignListDialog();}V.setProperty("/campaignSuggestion",this._aCampaignSuggestion);this._oCampaignlistDialog.open();},onOrientationChange:function(){},onTableFilter:function(e){e.preventDefault();var o=e.getParameter("column");var V=e.getParameter("value");var i=o.getId().substr(o.getId().lastIndexOf("-")+1);switch(i){case"colIdeaTitle":this.setViewProperty("/List/IDEA_TITLE",V);break;case"colExpert":this.setViewProperty("/List/EXPERT_NAME",V);break;case"colCampaign":this.setViewProperty("/List/CAMPAIGN_TITLE",V);break;case"colStatus":this.setViewProperty("/List/STATUS_TEXT",V);break;case"colAcceptDate":this.setViewProperty("/List/ACCEPT_DATE",V);break;case"colCompleteDate":this.setViewProperty("/List/COMPLETE_DATE",V);break;default:break;}o.setFiltered(Boolean(V));this._filter();},onTableSelectionChange:function(e){var t=this.getList();var s=t.getSelectedIndices();var d=jQuery.grep(s,function(i){var j=t.getContextByIndex(i).getProperty("STATUS_CODE");return j==="sap.ino.config.EVAL_REQ_REQUESTED"||j==="sap.ino.config.EVAL_REQ_IN_CLARIFICATION";});var g=jQuery.grep(s,function(i){var j=t.getContextByIndex(i).getProperty("STATUS_CODE");return j!=="sap.ino.config.EVAL_REQ_REJECTED"&&j!=="sap.ino.config.EVAL_REQ_COMPLETED"&&j!=="sap.ino.config.EVAL_REQ_EXPIRED";});var h=jQuery.grep(s,function(i){var j=t.getContextByIndex(i).getProperty("STATUS_CODE");return j!=="sap.ino.config.EVAL_REQ_REJECTED"&&j!=="sap.ino.config.EVAL_REQ_COMPLETED"&&j!=="sap.ino.config.EVAL_REQ_EXPIRED"&&j!=="sap.ino.config.EVAL_REQ_ACCEPTED";});if(this.getViewProperty("/List/IS_EVAL_REQ_LIST_BY_ME")){if(this.byId("sapInoMassDeleteBtn")){this.byId("sapInoMassDeleteBtn").setEnabled(s.length>0);}}if(this.byId("sapInoAcceptBtn")&&this.byId("sapInoRejectBtn")&&this.byId("sapInoFowardBtn")&&this.byId("sapInoCreateBtn")){this.byId("sapInoAcceptBtn").setEnabled(s.length>0&&d.length===s.length);this.byId("sapInoRejectBtn").setEnabled(s.length>0&&d.length===s.length);this.byId("sapInoFowardBtn").setEnabled(s.length>0&&h.length===s.length);this.byId("sapInoCreateBtn").setEnabled(s.length>0&&g.length===s.length);}},onTableColumnMenuOpen:function(e){var m=e.getParameter("menu");var i=e.getParameters().id;i=i.substr(i.lastIndexOf("-")+1);if(i==="colAcceptDate"||i==="colCompleteDate"){m.onAfterRendering=function(){var I=$(m.getItems()[2].getDomRef());I.find("label").html(this.getText("EVAL_REQ_LIST_FLD_WITHIN_NEXT"));I.find("input").addClass("sapUiTinyMarginBeginEnd").attr("style","width:5em").attr("type","number").attr("min","1").after("<label class='sapUiMnuTfItemLbl'>"+this.getText("EVAL_REQ_LIST_FLD_DAYS")+"</label>");};}},onTableBtnPress:function(e){var s=e.getSource();var E=s.getBindingContext("data").getProperty("ID");this.navigateTo("evaluationrequest-item",{id:E});},_filter:function(){var t=this;var d=[];if(this.getViewProperty("/List/CAMPAIGN")){d.push(new F("CAMPAIGN_ID",a.EQ,this.getViewProperty("/List/CAMPAIGN")));}if(this.getViewProperty("/List/CAMPAIGN_TITLE")){d.push(new F({path:"CAMPAIGN_TITLE",test:function(V){var s=t.getViewProperty("/List/CAMPAIGN_TITLE");if(V&&V.toLowerCase().indexOf(s.trim().toLowerCase())>=0){return true;}return false;}}));}if(this.getViewProperty("/List/IDEA_TITLE")){d.push(new F({path:"IDEA_TITLE",test:function(V){var s=t.getViewProperty("/List/IDEA_TITLE");if(V&&V.toLowerCase().indexOf(s.trim().toLowerCase())>=0){return true;}return false;}}));}if(this.getViewProperty("/List/EXPERT_NAME")){d.push(new F({path:"EXPERT_NAME",test:function(V){var s=t.getViewProperty("/List/EXPERT_NAME");if(V&&V.toLowerCase().indexOf(s.trim().toLowerCase())>=0){return true;}return false;}}));}if(this.getViewProperty("/List/STATUS_TEXT")){d.push(new F({path:"STATUS_TEXT",test:function(V){var s=t.getViewProperty("/List/STATUS_TEXT");if(V&&V.toLowerCase().indexOf(s.trim().toLowerCase())>=0){return true;}return false;}}));}if(this.getViewProperty("/List/ACCEPT_DATE")){d.push(new F({path:"ACCEPT_DATE",test:function(V){var o=new Date();var s=t.getViewProperty("/List/ACCEPT_DATE");if(!V||isNaN(s)){return false;}s=parseInt(s,10);if(o.setDate(o.getDate()+s)<V){return false;}return true;}}));}if(this.getViewProperty("/List/COMPLETE_DATE")){d.push(new F({path:"COMPLETE_DATE",test:function(V){var o=new Date();var s=t.getViewProperty("/List/COMPLETE_DATE");if(!V||isNaN(s)){return false;}s=parseInt(s,10);if(o.setDate(o.getDate()+s)<V){return false;}return true;}}));}this.getList().getBinding("rows").filter(d.length?new F(d,true):null,"Application");},_check4ManagingList:function(){var d=C.hasCurrentUserPrivilege("sap.ino.ui::backoffice.access");if(d){var V=this.getViewProperty("/List/VARIANT");var e=this.getListProperty("/Variants/Values");var g=jQuery.grep(e,function(o){return o.ACTION===V;});g=(g&&g.length>0)?g[0]:{};return g.MANAGE||g.CAMPAIGN_MANAGE||false;}return false;},bindList:function(){var t=this;this.saveState();this.resetActionState();var p="";var i=false;var o=this.getBindingParameter();function d(){var e=arguments[0].getParameter("data").results;var n=[];var V=t.getModel("view");jQuery.each(e,function(I,g){if(jQuery.grep(n,function(N){return N.ID===g.CAMPAIGN_ID;}).length===0||n.length===0){n.push({ID:g.CAMPAIGN_ID,SHORT_NAME:g.CAMPAIGN_TITLE});}});V.setProperty("/campaignSuggestion",n);t._aCampaignSuggestion=n;t._filter();}p+="SearchEvaluationRequestParams";p+="(filterName='"+(o.VariantFilter||"")+"'"+")/Results";this.setPath("data>/"+p);if((!D.system.desktop&&D.orientation.landscape)||(D.system.desktop&&this.getViewProperty("/ORIENTATION")===b.LANDSCAPE)){i=true;}this.getList().bindRows({parameters:{operationMode:"Client"},sorter:new S("COMPLETE_DATE",false),path:this.getPath(),events:{dataRequested:function(){jQuery.each(t.getBusyControls(),function(I,e){if(jQuery.type(e.setBusy)==="function"){e.setBusy(true);}});},dataReceived:function(){jQuery.each(t.getBusyControls(),function(I,e){if(jQuery.type(e.setBusy)==="function"){e.setBusy(false);}});if(jQuery.type(d)==="function"){d.apply(this,arguments);}}}});},createCampaignListDialog:function(){if(!this._campaignDialog){this._campaignDialog=this.createFragment("sap.ino.vc.idea.fragments.CampaignSuggestionSelectList",this.getView().getId());this.getView().addDependent(this._campaignDialog);}return this._campaignDialog;},getBindingParameter:function(){var V,s;V=this.getViewProperty("/List/VARIANT");s=this.getCurrentVariant().FILTER;var d=this.getViewProperty("/List/SEARCH");var t=this.getViewProperty("/List/TAGS");var e=this.getViewProperty("/List/CAMPAIGN");var g=jQuery.map(t,function(o){return o.ID;});return{Variant:V,VariantFilter:s,SearchTerm:d,TagIds:g,CampaignId:e};},getList:function(){return this.byId("tablelist--evaluationrequestlist");},getVariantVisibility:function(V){var d,e;d=this.getModel("list").getProperty("/Variants/Values");for(var i=0;i<d.length;i+=1){var o=d[i];if(o.ACTION===V){e=o.VISIBLE;}}return e;},initApplicationObjectChangeListeners:function(){var t=this;var d=["create","del","modifyAndSubmit","executeStatusTransition","forward"];var e=function(E){var s=E.getParameter("actionName");if(s&&d.indexOf(s)>-1&&E.getParameter("object").getMetadata().getName()==="sap.ino.commons.models.object.EvaluationRequestItem"){t.bindList();}};A.attachChange(A.Action.Create,e);A.attachChange(A.Action.Del,e);A.attachChange(A.Action.Action,e);},show:function(e,o){var q;var V;if(e&&e.getParameter){var d=e.getParameter("arguments");q=d["?query"];V=d.variant;}else{V=o.variant;q=o;}var t=this;var s=this.getListProperty("/Variants/DEFAULT_VARIANT");this.setViewProperty("/isre",V||s);V=this.getViewProperty("/isre");var g=this.getVariant(V);this.setViewProperty("/List/VARIANT",g.ACTION);var h=this.getList()&&this.getList().isBound("rows");var R=this.hasStateChanged(this.getCurrentRoute(),V,q,D.orientation.portrait);R=R||this._bListChanged;this._bListChanged=false;if(!h||R){this.setVariantVisibility();this.setParameters(q,g);var i=this.getViewProperty("/ORIENTATION");this.onOrientationChange(D.system.desktop?i:D.orientation);var j=this.getVariantVisibility(V);if(j===false||typeof(j)==="undefined"){M.show(t.getText("NOT_AUTHORIZED_MESSAGE"),M.Icon.INFORMATION,t.getText("NOT_AUTHORIZED_DIALOG_TITLE"),[M.Action.OK],function(){t.navigateTo("home");});return;}this.bindList();}},setParameters:function(q,V){q=q||{};var s=V.ACTION;this.setViewProperty("/List/HAS_BACKOFFICE",C.hasCurrentUserPrivilege("sap.ino.ui::backoffice.access"));this.setViewProperty("/List/TAGCLOUD",false);this.setViewProperty("/List/MANAGE",true);this.setViewProperty("/List/IS_EVAL_REQ_LIST",true);this.setViewProperty("/List/IS_EVAL_REQ_LIST_FOR_ME",false);this.setViewProperty("/List/IS_EVAL_REQ_LIST_BY_ME",false);this.setViewProperty("/List/IS_EVAL_REQ_LIST_ALL",false);this.setViewProperty("/DISABLE_ORIENTATION",true);if([v.EVAL_REQ_FOR_ME,v.EVAL_REQ_FOR_ME_OVERDUE].indexOf(s)>=0){this.setViewProperty("/List/IS_EVAL_REQ_LIST_FOR_ME",true);this.setViewProperty("/List/IS_EVAL_REQ_LIST_BY_ME",false);this.setViewProperty("/List/IS_EVAL_REQ_LIST_ALL",false);this.setViewProperty("/List/SELECTION_MODE","Single");}else if([v.EVAL_REQ_MY,v.EVAL_REQ_MY_OVERDUE].indexOf(s)>=0){this.setViewProperty("/List/IS_EVAL_REQ_LIST_BY_ME",true);this.setViewProperty("/List/IS_EVAL_REQ_LIST_FOR_ME",false);this.setViewProperty("/List/IS_EVAL_REQ_LIST_ALL",false);this.setViewProperty("/List/SELECTION_MODE","MultiToggle");}else{this.setViewProperty("/List/IS_EVAL_REQ_LIST_BY_ME",false);this.setViewProperty("/List/IS_EVAL_REQ_LIST_FOR_ME",false);this.setViewProperty("/List/IS_EVAL_REQ_LIST_ALL",true);this.setViewProperty("/List/SELECTION_MODE","Single");}this.setViewProperty("/List/MANAGE",!this.getViewProperty("/List/IS_EVAL_REQ_LIST_ALL")&&!V.MANAGE||(V.MANAGE&&C.hasCurrentUserPrivilege("sap.ino.ui::backoffice.access")));},setVariantVisibility:function(){var V=this.getModel("list").getProperty("/Variants/Values");for(var i=0;i<V.length;i+=1){var o=V[i];var I=o.MANAGE||false;var d=o.EXPERT||false;var e=o.CAMPAIGN_MANAGE||false;var g=C.getSystemSetting("sap.ino.config.EVAL_REQ_ACTIVE")==="1"&&(!I&&!d&&!e)||(d&&C.hasCurrentUserPrivilege("sap.ino.ui::expert"))||(e&&C.hasCurrentUserPrivilege("sap.ino.ui::campaign_manager"))||(I&&C.hasCurrentUserPrivilege("sap.ino.ui::backoffice.access"));this.getModel("list").setProperty("/Variants/Values/"+i+"/VISIBLE",g);}}}));L.list=l;L.routes=r;return L;});
