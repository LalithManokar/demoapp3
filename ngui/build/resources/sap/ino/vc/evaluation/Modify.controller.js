sap.ui.define(["sap/ino/vc/commons/BaseObjectModifyController","sap/ino/commons/models/object/Evaluation","sap/ino/vc/evaluation/EvaluationFacet","sap/ino/commons/models/types/IntBooleanType","sap/ino/commons/models/types/IntNullableBooleanType","sap/ui/model/json/JSONModel","sap/ino/commons/models/object/Attachment","sap/ino/vc/attachment/AttachmentMixin","sap/ino/commons/application/Configuration","sap/m/MessageToast","sap/ino/vc/commons/TopLevelPageFacet"],function(B,E,a,I,b,J,A,c,C,M,T){"use strict";var r={create:"evaluation-create",edit:"evaluation-edit"};var d=A.getEndpointURL();return B.extend("sap.ino.vc.evaluation.Modify",jQuery.extend({},T,a,c,{routes:[r.create,r.edit],intBoolean:new I(),integerType:new b(),onInit:function(){B.prototype.onInit.apply(this,arguments);if(!this.getModel("local")){this.setModel(new J({ATTACHMENT_UPLOAD_URL:d}),"local");}if(!this.getModel("view")){this.setModel(new J({"IDEA_NAVIGATION_SECTION":"ideaSectionEvaluations"}),"view");}var v=this.getModel("view");if(!v.getProperty("/IDEA_NAVIGATION_SECTION")){v.setProperty("/IDEA_NAVIGATION_SECTION","ideaSectionEvaluations");}v.setProperty("/EDIT_MODE",true);this.aBusyControls=[this.byId("evaluationLayout")];this.initMatrixControl();this.scrollDockElement("evaluationModify","evaluationMatrix");this._sResizeEvalList=this.attachListControlResized(this.byId("criteriaList"));},onExit:function(){B.prototype.onExit.apply(this,arguments);this.detachListControlResized(this._sResizeEvalList);},onRouteMatched:function(e){var t=this;var o=e.getParameter("arguments");var f=this.getObjectModel();var R=e.getParameter("name");this.setObjectExists(true);var s={actions:["del","modify","modifyAndSubmit","submit"],nodes:["Root"],continuousUse:true,readSource:{model:this.getDefaultODataModel()}};function g(f){t.setObjectModel(f);f.getDataInitializedPromise().done(function(){t.setHelp("EVALUATION_MODIFY");});f.getDataInitializedPromise().fail(function(){t.setObjectExists(false);});t.bindMatrix();}if(R===r.create){var q=o["?query"]||{};if(jQuery.isNumeric(q.ideaId)){if(q.evalIds){var h=q.evalIds.split(",");var D=this.getModel("data");var i=[];jQuery.each(h,function(l,k){var m=new jQuery.Deferred();D.read("/IdeaEvaluation("+k+")/CriterionValues",{success:function(p){m.resolve({"CriterionValues":p.results});},error:function(p){m.reject(p);}});i.push(m);if(q.includeAttachs*1){var n=new jQuery.Deferred();D.read("/IdeaEvaluation("+k+")/EvalAttachments",{success:function(p){n.resolve({"EvalAttachments":p.results});},error:function(p){n.reject(p);}});i.push(n);}});jQuery.when.apply(jQuery,i).done(function(){var l=[],m=[],n={};jQuery.each(arguments,function(u,v){if(v.hasOwnProperty("CriterionValues")&&v.CriterionValues){l.push(v.CriterionValues);}else if(v.hasOwnProperty("EvalAttachments")&&v.EvalAttachments){jQuery.each(v.EvalAttachments,function(N,w){if(!n.hasOwnProperty(w.ATTACHMENT_ID)){n[w.ATTACHMENT_ID]=true;m.push(w);}});}});var p=Number(q.evalAction);if(p===1){f=E.createAverageEvaluation(parseInt(q.ideaId,10),l,s,m,t.getText("IDEA_OBJECT_DEFAULT_AVE_EVALUATION_COMMENT"));}else if(p===2){f=E.createTotalEvaluation(parseInt(q.ideaId,10),l,s,m,t.getText("IDEA_OBJECT_DEFAULT_TOTAL_EVALUATION_COMMENT"),h[0],function(u,v){return v===1?{msg:t.getText("MSG_EVALUATION_MAX_WARNING_TXT",u),msg_tooltip:t.getText("MSG_EVALUATION_MAX_WARNING_INFO",u)}:{msg:t.getText("MSG_EVALUATION_MAX_WARNING_TXT",u),msg_tooltip:t.getText("MSG_EVALUATION_MIN_WARNING_INFO",u)};});}g(f);});}else{var j={IDEA_ID:parseInt(q.ideaId,10)};if(parseInt(q.EvalReqItemId,10)>0){j.EVAL_REQ_ITEM_ID=parseInt(q.EvalReqItemId,10);}f=new E(j,s);g(f);}}}else{if(jQuery.isNumeric(o.id)){var k=parseInt(o.id,10);if(!f||(f.getKey()!==k)){f=new E(k,s);}this.bindDefaultODataModel(k);g(f);}}},onAfterRendering:function(){this._attachmentMixinInit({attachmentId:"EvalAttachments",updateObject:function(o){},uploadSuccess:function(o,R){o.addAttachment({"CREATED_BY_NAME":C.getCurrentUser().NAME,"ATTACHMENT_ID":R.attachmentId,"FILE_NAME":R.fileName,"MEDIA_TYPE":R.mediaType,"CREATED_AT":new Date()});}});},onSave:function(){var o=this;var i=o.getObjectModel().isNew();var m=o.executeObjectAction("modify");m.done(function(){var e=o.getObjectModel();if(i){o.navigateTo("evaluation-edit",{id:e.getKey()},true);}});}}));});
