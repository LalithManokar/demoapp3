sap.ui.define(["sap/ino/commons/models/aof/ApplicationObjectChange","sap/ino/vc/commons/BaseController","sap/ino/vc/evaluation/EvaluationFacet","sap/ino/vc/evaluation/EvaluationFormatter","sap/m/GroupHeaderListItem","sap/ino/commons/application/Configuration"],function(A,B,E,a,G,C){"use strict";var f={};jQuery.extend(f,a);f.formatGroupHeader=function(g){return new G({title:f.ideaPhase(g.ideaPhaseCode),upperCase:false});};return B.extend("sap.ino.vc.idea.Evaluations",{formatter:f,grouper:function(c){return{key:c.getProperty("GROUP_ORDER"),ideaPhaseCode:c.getProperty("IDEA_PHASE_CODE")};},onInit:function(){var e=["evaluationList","myEvaluationList","pubEvaluationList"];var t=this;B.prototype.onInit.apply(this,arguments);this._initHandleEvaluationAOChange();this._initHandleEvaluationRequestAOChange();e.forEach(function(s){var o=t.byId(s);if(o){if(!t._aResizeEvalList){t._aResizeEvalList=[];}t._aResizeEvalList.push(t.attachListControlResized(o));}});this._oRouter=this.getOwnerComponent().getRouter();this._oRouter.attachRouteMatched(this._resetSelList,this);},onExit:function(){var t=this;B.prototype.onExit.apply(this,arguments);t._aResizeEvalList.forEach(function(r){t.detachListControlResized(r);});this._oRouter.detachRouteMatched(this._resetSelList,this);},onItemPress:function(e){var c=e.getSource()&&e.getSource().getBindingContext("data");if(c){this.navigateTo("evaluation-display",{id:c.getProperty("ID")});}},onItemRequestPressManager:function(e){var c=e.getSource()&&e.getSource().getBindingContext("data");if(c){this.navigateTo("evaluationrequest-display",{id:c.getProperty("ID")});}},onItemRequestPressExpert:function(e){var c=e.getSource()&&e.getSource().getBindingContext("data");if(c){this.navigateTo("evaluationrequest-item",{id:c.getProperty("ID")});}},onSelectionChange:function(e){if(!this._oSelectionMap){this._oSelectionMap={};}var s=e.getParameter("selected");var S=e.getSource();var d=S.getBindingContext("data").getObject();var o=this.getModel("objectContext");if(s){this._oSelectionMap[d.ID]=d.MODEL_CODE;}else{delete this._oSelectionMap[d.ID];}var O=this.getModel("object");o.setProperty("/EvaluationSelection",this._oSelectionMap);var v=true;jQuery.each(this._oSelectionMap,function(i,c){if(c!==O.getProperty("/CURR_PHASE_EVALUATION_MODEL")){v=false;}});var b=v&&Object.keys(this._oSelectionMap).length>=2;o.setProperty("/CreateAverageEvaluationEnabled",b);o.setProperty("/CreateTotalEvaluationEnabled",b);},_initHandleEvaluationAOChange:function(){var t=this;var b=function(e){var s=e&&e.getParameter("actionName");if(s&&["create","del","submit","modifyAndSubmit","executeStatusTransition"].indexOf(s)>-1){t.rebindList(t.getView().byId("myEvaluationList"));var S=e&&e.getParameter("instance")&&e.getParameter("instance").getProperty("/STATUS_CODE");if(S!=="sap.ino.config.EVAL_DRAFT"){t.rebindList(t.getView().byId("pubEvaluationList"));t.rebindList(t.getView().byId("evalationRequestExpert"));}var c=e.getParameter("changeRequest");if((s&&["create","del","submit","modifyAndSubmit"].indexOf(s)>-1)||c&&c.STATUS_ACTION_CODE==="sap.ino.config.EVAL_REWORK"){t.rebindList(t.getView().byId("evaluationList"));t.rebindList(t.getView().byId("evalationRequestExpert"));}}};A.attachChange(A.Action.Create,b);A.attachChange(A.Action.Del,b);A.attachChange(A.Action.Action,b);},_initHandleEvaluationRequestAOChange:function(e){var t=this;var b=function(e){var s=e&&e.getParameter("actionName");var c=e.getParameter("changeRequest");if(e.getParameter("object").getMetadata().getName()==="sap.ino.commons.models.object.EvaluationRequest"&&t&&t.getView().byId("evalationRequestManager")){if(s&&["create","del","submit","modifyAndSubmit","bulkDeleteEvalReqs"].indexOf(s)>-1){if((s&&["del","submit","modifyAndSubmit","create"].indexOf(s)>-1)||c){t.rebindList(t.getView().byId("evalationRequestManager"));}}}else if(e.getParameter("object").getMetadata().getName()==="sap.ino.commons.models.object.EvaluationRequestItem"&&t&&t.getView().byId("evalationRequestExpert")){if(s&&["create","del","submit","modifyAndSubmit","forward","executeStatusTransition"].indexOf(s)>-1){if((s&&["del","submit","modifyAndSubmit","create"].indexOf(s)>-1)||c){t.rebindList(t.getView().byId("evalationRequestExpert"));}}}};A.attachChange(A.Action.Create,b);A.attachChange(A.Action.Del,b);A.attachChange(A.Action.Action,b);},onEvaluatorPressed:function(e){e.preventDefault();var s=e.getSource();if(s){var i=s.getBindingContext("data")&&s.getBindingContext("data").getProperty("EVALUATOR_ID");if(i!==undefined&&!this.oIdentityCardView){this.oIdentityCardView=sap.ui.xmlview({viewName:"sap.ino.vc.iam.IdentityCard"});this.getView().addDependent(this.oIdentityCardView);}if(this.oIdentityCardView&&this.oIdentityCardView.getController()){this.oIdentityCardView.getController().open(s,i);}}},onEvaluationRequestOwnerPressed:function(e){e.preventDefault();var s=e.getSource();if(s){var i=s.getBindingContext("data")&&s.getBindingContext("data").getProperty("OWNER_ID");if(i!==undefined&&!this.oIdentityCardView){this.oIdentityCardView=sap.ui.xmlview({viewName:"sap.ino.vc.iam.IdentityCard"});this.getView().addDependent(this.oIdentityCardView);}if(this.oIdentityCardView&&this.oIdentityCardView.getController()){this.oIdentityCardView.getController().open(s,i);}}},rebindList:function(l){if(l){var b=l.getBindingInfo("items");l.bindItems(b);}},_resetSelList:function(){var o=this.getModel("objectContext");var b=Object.keys(o.getProperty("/EvaluationSelection")||{});if(b.length<=0&&this.getCurrentRoute()==="idea-display"){this._oSelectionMap={};this.rebindList(this.getView().byId("evaluationList"));this.rebindList(this.getView().byId("myEvaluationList"));this.rebindList(this.getView().byId("pubEvaluationList"));}}});});
