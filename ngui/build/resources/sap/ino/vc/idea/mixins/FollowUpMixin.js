sap.ui.define(["sap/ino/vc/idea/mixins/BaseActionMixin","sap/ino/vc/commons/BaseController","sap/ui/core/format/DateFormat","sap/ino/commons/models/object/FollowUp","sap/ino/vc/idea/mixins/FollowUpFormatter","sap/ino/commons/formatters/BaseFormatter","sap/ino/commons/models/types/FollowUpRelativeDateType","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/ino/commons/application/Configuration","sap/m/MessageBox","sap/ui/core/Locale"],function(B,a,D,F,b,c,d,J,M,C,e,L){"use strict";var _;var g=function(t){if(!_){if(t.getOwnerComponent){_=D.getDateInstance({pattern:"YYYY-MM-dd"},new L(t.getOwnerComponent().getModel("user").getProperty("/data/LOCALE")));}else{return D.getDateInstance({pattern:"YYYY-MM-dd"});}}return _;};var f=jQuery.extend({},B);f.followUpRelativeDateType=new d();f.followUpMixinFormatter=b;f.getFollowUpMixinFollowUpDialog=function(){if(!this._oFollowUpMixinFollowUpDialog){this._oFollowUpMixinFollowUpDialog=this.createFragment("sap.ino.vc.idea.fragments.FollowUp",this.getView().getId());this.getView().addDependent(this._oFollowUpMixinFollowUpDialog);this._oFollowUpMixinFollowUpDialog.setInitialFocus(this.createId("relativeDate"));}return this._oFollowUpMixinFollowUpDialog;};f.onFollowUpMixinFollowUp=function(E){var i,I,h,j;if(this.isActionContextSingleIdeaDisplay()){this.resetClientMessages();i=this.getObjectModel();I=i.getProperty("/ID");h=i.getProperty("/FOLLOW_UP_ID");j=i.getProperty("/FOLLOW_UP_DATE");}else{i=E.getSource().getBindingContext("data");I=i.getProperty("ID");h=i.getProperty("FOLLOW_UP_ID");j=i.getProperty("FOLLOW_UP_DATE");}var o=this.getFollowUpMixinFollowUpDialog();o.data("context","single");o.setModel(new J({"ID":I,"FOLLOW_UP_ID":h,"FOLLOW_UP_DATE":j,"FOLLOW_UP_RELATIVE_DATES":F.relativeDates}),"followUp");o.open();};f.onMassFollowUp=function(E){if(this.getViewProperty("/List/SELECT_ALL")){var o=this.getBindingParameter();var i=this._check4ManagingList();var s=this.getList().getBinding('items').sFilterParams;var t=this.getViewProperty("/List/TAGS");var h={};var j=[];t.forEach(function(l,m){if(!h[l.ROOTGROUPID]){h[l.ROOTGROUPID]=[];h[l.ROOTGROUPID].push(l.ID);j.push(l.ROOTGROUPID);}else{h[l.ROOTGROUPID].push(l.ID);}});var p={searchToken:o.SearchTerm||"",tagsToken:h[j[0]]?h[j[0]].join(","):"",tagsToken1:h[j[1]]?h[j[1]].join(","):"",tagsToken2:h[j[2]]?h[j[2]].join(","):"",tagsToken3:h[j[3]]?h[j[3]].join(","):"",tagsToken4:h[j[4]]?h[j[4]].join(","):"",filterName:o.VariantFilter||"",filterBackoffice:i?"1":"0",filterString:s||""};if(this.setQueryObjectIdeaformFilters){this.setQueryObjectIdeaformFilters(p);}if(this.getCampaignFormQuery){p.ideaFormId=this.getCampaignFormQuery()||"";}if(this.getSearchType){p.searchType=this.getSearchType();}if(this.setQueryObjectCompanyViewFilters){this.setQueryObjectCompanyViewFilters(p);}var k=this;var S=E.getSource();S.setEnabled(false);jQuery.ajax({url:C.getBackendRootURL()+"/sap/ino/xs/rest/common/select_all_ideas.xsjs",data:p,success:function(r){S.setEnabled(true);if(r.Ideas.length===0){e.show(k.getText("NO_IDEAS_AND_RELOAD_PAGE"),{icon:e.Icon.INFORMATION,actions:[sap.m.MessageBox.Action.OK],onClose:function(){k.bindList();}});return;}k._oSelectionMap={};jQuery.each(r.Ideas,function(I,l){if(!k._oDeselectionMap[l.ID]){l.property=k._createPropertyData(l);if(l.FOLLOW_UP_DATE){l.FOLLOW_UP_DATE=new Date(l.FOLLOW_UP_DATE);}k._oSelectionMap[l.ID]=l;}});k.onFollowUpMixinMassFollowUp();},error:function(r){M.show(k.getText(r.responseJSON.messageKey));}});}else{this.onFollowUpMixinMassFollowUp();}};f.onFollowUpMixinMassFollowUp=function(){var i=jQuery.map(this._oSelectionMap,function(I){return I.ID;});var h=jQuery.map(this._oSelectionMap,function(I){return I.FOLLOW_UP_DATE;}).reduce(function(p,v){if(p){return p;}else{return v;}},null);var o=this.getFollowUpMixinFollowUpDialog();o.data("context","mass");o.setModel(new J({"IDS":i,"ID":null,"FOLLOW_UP_ID":-1,"FOLLOW_UP_DATE":h,"FOLLOW_UP_RELATIVE_DATES":F.relativeDates}),"followUp");o.open();};f.onFollowUpMixinFollowUpDialogOK=function(E){var t=this;var o=this.getFollowUpMixinFollowUpDialog();o.setBusy(true);var h=o.getModel("followUp");var s=h.getProperty("/FOLLOW_UP_DATE")&&g(this).format(h.getProperty("/FOLLOW_UP_DATE"));if(o.data("context")==="mass"){var O={parameters:{ideaIds:h.getProperty("/IDS"),date:s},messages:{success:function(){o.close();return t.getText("OBJECT_MSG_FOLLOW_UP_SAVE_SUCCESS");},error:function(){return t.getText("OBJECT_MSG_FOLLOW_UP_SAVE_FAILED");}}};var m=a.prototype.executeObjectAction.call(this,F,"massModify",O);m.always(function(){o.setBusy(false);});}else{if(s){var i=F.modify(h.getProperty("/FOLLOW_UP_ID")||-1,{DATE:s,OBJECT_ID:h.getProperty("/ID"),OBJECT_TYPE_CODE:"IDEA"});i.done(function(){o.close();M.show(t.getText("OBJECT_MSG_FOLLOW_UP_SAVE_SUCCESS"));});i.fail(function(){M.show(t.getText("OBJECT_MSG_FOLLOW_UP_SAVE_FAILED"));});i.always(function(){o.setBusy(false);});}else{if(h.getProperty("/FOLLOW_UP_ID")){var j=F.del(h.getProperty("/FOLLOW_UP_ID"),{OBJECT_ID:h.getProperty("/ID")});j.done(function(){o.setModel(undefined,"followUp");o.close();M.show(t.getText("OBJECT_MSG_FOLLOW_UP_DEL_SUCCESS"));});j.fail(function(){M.show(t.getText("OBJECT_MSG_FOLLOW_UP_DEL_FAILED"));});j.always(function(){o.setBusy(false);});}else{o.setBusy(false);}}}};f.onFollowUpMixinFollowUpDialogDelete=function(E){var t=this;var o=this.getFollowUpMixinFollowUpDialog();o.setBusy(true);var h=o.getModel("followUp");var s=h&&h.getProperty("/FOLLOW_UP_ID");if(o.data("context")==="mass"){var O={parameters:{ideaIds:h.getProperty("/IDS"),date:null},messages:{success:function(){o.close();return t.getText("OBJECT_MSG_FOLLOW_UP_SAVE_SUCCESS");},error:function(){return t.getText("OBJECT_MSG_FOLLOW_UP_SAVE_FAILED");}}};var m=a.prototype.executeObjectAction.call(this,F,"massModify",O);m.always(function(){o.setBusy(false);});}else{if(s){var i=F.del(s,{OBJECT_ID:h.getProperty("/ID")});i.done(function(){o.close();M.show(t.getText("OBJECT_MSG_FOLLOW_UP_DEL_SUCCESS"));});i.fail(function(){M.show(t.getText("OBJECT_MSG_FOLLOW_UP_DEL_FAILED"));});i.always(function(){o.setBusy(false);});}else{o.setBusy(false);o.close();}}};f.onFollowUpMixinFollowUpDialogCancel=function(){var o=this.getFollowUpMixinFollowUpDialog();if(this.isActionContextSingleIdeaDisplay()){this.resetInputTypeValidations(o);}o.close();};f.onFollowUpMixinFollowUpAfterClose=function(E){var o=E.getSource();o.destroy();this._oFollowUpMixinFollowUpDialog=undefined;};return f;});
