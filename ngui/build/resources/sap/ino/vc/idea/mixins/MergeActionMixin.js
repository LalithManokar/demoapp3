sap.ui.define(["sap/ino/vc/idea/mixins/BaseActionMixin","sap/ino/vc/commons/BaseController","sap/ui/model/json/JSONModel","sap/ino/commons/models/core/ClipboardModel","sap/ino/commons/models/core/ModelSynchronizer","sap/ino/commons/models/aof/PropertyModel",'sap/ino/commons/models/object/Idea',"sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/Sorter","sap/m/CheckBox","sap/m/MessageToast","sap/ino/commons/application/Configuration","sap/m/MessageBox","sap/ino/commons/models/object/MergeConfig","sap/ino/controls/IdeaStatusType"],function(B,a,J,C,M,P,I,F,b,S,c,d,e,f,g,h){"use strict";var j=jQuery.extend({},B);j.onIdeaMerge=function(E){var D,i,n,k,o,m;var s=E.getSource();if(this.isActionContextSingleIdeaDisplay()){i=this.getObjectModel().getProperty("/ID");n=this.getObjectModel().getProperty("/NAME");}else{i=s.getBindingContext("data").getProperty("ID");n=s.getBindingContext("data").getProperty("NAME");}m=new J({pageview:"merge01",sourceId:i,sourceName:n,leadingIdeaId:i,allIdeas:[],selectedIdeas:[],selectedIdeaObjects:[]});o=this._getClipboardModel();if(o){var l=o.getObjectKeys(I).filter(function(T){return T!==i;});k=l.map(function(T){return new F("ID",b.EQ,T);});m.setProperty("/selectedIdeas",l);m.setProperty("/allIdeas",l.slice(0));}var p=l;p.push(i);var q={idea_id:p.join(",")};var t=this;var r;var u=jQuery.ajax({url:e.getBackendRootURL()+"/sap/ino/xs/rest/common/check_merge_anonymous_idea.xsjs",data:q,success:function(w){r=w;},type:"GET",contentType:"application/json; charset=UTF-8",async:false});if(r===0){d.show(t.getText("IDEA_MERGE_MSG_ANONYMOUS_IDEA_CANNOT_BE_MERGED"));return;}if(k.length===0){d.show(t.getText("MSG_IDEA_MERGE_NO_IDEA_IN_CLIPBOARD"));return;}var v=new P("sap.ino.xs.object.idea.Idea",i,{actions:["mergeIdeas"]},false,function(w){var x=w.getSource().getData();if(x&&x.actions&&x.actions.mergeIdeas){var y=x.actions.mergeIdeas;if(y.enabled){t.setModel(m,"merge");D=t._getIdeaMergeDialog();t._prepareListItemForIdeaMerge(k);D.open();}else{d.show(y.messages&&y.messages.length>0&&y.messages[0].MESSAGE_TEXT||this.getText("IDEA_MERGE_MSG_IDEA_CANNOT_BE_MERGED"));}}});};j._getIdeaMergeDialog=function(){if(!this._oMergeDialog){this._oMergeDialog=this.createFragment("sap.ino.vc.idea.fragments.IdeaMergeDialog",this.getView().getId());this.getView().addDependent(this._oMergeDialog);this._sResizeMergeDialog=this.attachListControlResized(this.byId("ideaSelection"));}return this._oMergeDialog;};j._prepareListItemForIdeaMerge=function(i){var A,o,s;if(!this._oIdeaMergeListItemTemplate){this._oIdeaMergeListItemTemplate=this.getFragment("sap.ino.vc.idea.fragments.FlatListItemForMerge");A=sap.ui.core.Fragment.byId(this.getView().getId(),"flatListIdeaActions");A.removeItem(A.getItems()[0]);o=new c({selected:{parts:[{path:"data>ID"},{path:"merge>/selectedIdeas"}],formatter:this.formatIsInSelectedIdeas},select:this.onIdeaMergeIdeaSelect});A.addItem(o);}s=this.byId("ideaSelection");s.bindItems({path:"data>/IdeaMedium",filters:i,sorter:new S("NAME"),template:this._oIdeaMergeListItemTemplate});};j.onIdeaMergeIdeaSelect=function(E){var s,i,k,l;s=E.getSource();i=E.getParameter("selected");k=s.getBindingContext("data").getProperty("ID");l=this.getModel("merge").getProperty("/selectedIdeas").slice(0);if(i){if(l.indexOf(k)===-1){l.push(k);}}else{if(l.indexOf(k)>-1){l.splice(l.indexOf(k),1);}}this.getModel("merge").setProperty("/selectedIdeas",l);};j.onSelectAllMergeIdeas=function(E){var A=this.getModel("merge").getProperty("/allIdeas").slice(0);this.getModel("merge").setProperty("/selectedIdeas",A);};j.onChangeLeadingMergeIdea=function(E){var l=E.getParameter("selectedItem");var L=l.getKey();var m=this.getModel("merge");var i=m.getProperty("/selectedIdeaObjects").map(function(o){return{ID:o.ID,NAME:o.NAME};});m.setProperty("/leadingIdeaId",L);this._simulateMergeTransition(L,i);};j._disposeIdeaMergeDialog=function(){var D=this._getIdeaMergeDialog();this.detachListControlResized(this._sResizeMergeDialog);D.close();D.destroy();this._oMergeDialog=null;};j.onIdeaMergeCancel=function(E){this._disposeIdeaMergeDialog();};j.onIdeaMergeNextStep=function(E){var m=this.getModel("merge");var s=m.getProperty("/selectedIdeas");var o=this.byId("ideaSelection");var i=m.getProperty("/sourceId");var l=m.getProperty("/leadingIdeaId");var k=[];jQuery.each(o.getItems(),function(n,p){var q=p.getBindingContext("data").getProperty("ID");var r=p.getBindingContext("data").getProperty("NAME");if(s.indexOf(q)>-1){k.push({ID:q,NAME:r});}});k.push({ID:i,NAME:m.getProperty("/sourceName")});this._simulateMergeTransition(l,k);};j._simulateMergeTransition=function(l,k){var t=this;var m=this.getModel("merge");var n=function(q,K,v){for(var i=0;i<q.length;i+=1){var r=q[i];if(r[K]===v){return r;}}return null;};var o=function(i){var N;var D=i.getSource().getData();if(D&&D.actions&&D.actions.mergeIdeas){var T=D.actions.mergeIdeas;jQuery.each(T.customProperties.outcome,function(q,r){var s=n(k,"ID",r.ID)||{};s.outcome=r;});if(T.messages&&T.messages.length!==0){jQuery.each(T.messages,function(q,r){var s=n(k,"ID",r.REF_ID)||{};s.messages=r;});}}m.setProperty("/selectedIdeaObjects",k);m.setProperty("/pageview","merge02");N=t.byId("ideaMergeNavCon");N.to(t.byId("merge02"));};var p=new P("sap.ino.xs.object.idea.Idea",l,{actions:[{"mergeIdeas":k.map(function(i){return i.ID;}).filter(function(i){return i!==l;})}]},false,o);};j.onIdeaMergePrevStep=function(E){var n=this.byId("ideaMergeNavCon");this.getModel("merge").setProperty("/pageview","merge01");n.backToPage(this.byId("merge01"));};j.onMergeIdeasExecute=function(E){var l=this.getModel("merge").getProperty("/leadingIdeaId");var m=this.getModel("merge").getProperty("/selectedIdeaObjects");var i=m.filter(function(o){return o.ID!==l&&o.outcome&&o.outcome.OUTCOME!=="IDEA_MERGE_NOT_MERGABLE";}).map(function(o){return o.ID;});var A;this.isActionContextSingleIdeaDisplay();A=I.mergeIdeas(l,i);var t=this;A.done(function(){i.map(function(k){M.update(null,"mergeIdeas",I,k);});t._disposeIdeaMergeDialog();d.show(t.getText("MSG_IDEA_MERGE_SUCCESS"));});A.fail(function(r){var k=r.MESSAGES;jQuery.each(k,function(n,o){var T;if(o.MESSAGE_TEXT){T=o.MESSAGE_TEXT;}else{T=t.getText(o.MESSAGE,o.REF_ID);}d.show(T);});});};j.formatIdeaMergeActionEnabled=function(s){return!this.formatter.isFinal(s)&&this._getClipboardModel().getProperty("/enabled");};j.formatIdeaMergeResult=function(o,m){return m&&m.MESSAGE_TEXT||this.getText(o);};j.formatIdeaMergeResultErroneous=function(m){return!!m;};j.formatIsInSelectedIdeas=function(i,s){return s.indexOf(i)!==-1;};j.formatIdeaMergeNextStepEnabled=function(s){return s&&s.length>0||false;};j.formatMergeActionEnabled=function(i){var v=0;if(i){jQuery.each(i,function(k,o){if(o.outcome&&o.outcome.OUTCOME!=="IDEA_MERGE_NOT_MERGABLE"){v+=1;}});}return v>=2;};j.handleMassMerge=function(E){if(this.getViewProperty("/List/SELECT_ALL")){var o=this.getBindingParameter();var i=this._check4ManagingList();var s=this.getList().getBinding('items').sFilterParams;var t=this.getViewProperty("/List/TAGS");var k={};var l=[];t.forEach(function(q){if(!k[q.ROOTGROUPID]){k[q.ROOTGROUPID]=[];k[q.ROOTGROUPID].push(q.ID);l.push(q.ROOTGROUPID);}else{k[q.ROOTGROUPID].push(q.ID);}});var p={searchToken:o.SearchTerm||"",tagsToken:k[l[0]]?k[l[0]].join(","):"",tagsToken1:k[l[1]]?k[l[1]].join(","):"",tagsToken2:k[l[2]]?k[l[2]].join(","):"",tagsToken3:k[l[3]]?k[l[3]].join(","):"",tagsToken4:k[l[4]]?k[l[4]].join(","):"",filterName:o.VariantFilter||"",filterBackoffice:i?"1":"0",filterString:s||""};if(this.setQueryObjectIdeaformFilters){this.setQueryObjectIdeaformFilters(p);}if(this.getCampaignFormQuery){p.ideaFormId=this.getCampaignFormQuery()||"";}if(this.getSearchType){p.searchType=this.getSearchType();}if(this.setQueryObjectCompanyViewFilters){this.setQueryObjectCompanyViewFilters(p);}var m=this;var n=E.getSource();n.setEnabled(false);jQuery.ajax({url:e.getBackendRootURL()+"/sap/ino/xs/rest/common/select_all_ideas.xsjs",data:p,success:function(r){n.setEnabled(true);if(r.Ideas.length===0){f.show(m.getText("NO_IDEAS_AND_RELOAD_PAGE"),{icon:f.Icon.INFORMATION,actions:[sap.m.MessageBox.Action.OK],onClose:function(){m.bindList();}});return;}m._oSelectionMap={};jQuery.each(r.Ideas,function(q,D){if(!m._oDeselectionMap[D.ID]){D.property=m._createPropertyData(D);m._oSelectionMap[D.ID]=D;}});m._onMassMerge();},error:function(r){d.show(m.getText(r.responseJSON.messageKey));}});}else{this._onMassMerge();}};j._onMassMerge=function(){var D,i,m,k,s,l,n;var o=this._getClipboardModel();if(o){k=o.getObjectKeys(I).filter(function(t){return t!==i;});}if(this.isActionContextSingleIdeaDisplay()){s=[this.getObjectModel().getProperty("/ID")];}else{s=Object.keys(this._oSelectionMap).map(function(p){return parseInt(p,10);});}k=k||[];n=s.concat(k);l=n.map(function(t){return new F("ID",b.EQ,t);});m=new J({pageview:"massMerge01",leadingIdeaId:-1,selectedIdeas:n,leadingIdeaList:[],mergeResultList:[],mergeable:false,mergeRuleEnable:!!(e.getSystemSetting("sap.ino.config.ENABLE_IDEA_MERGE_RULE")*1),voteMergeEnable:true});D=this._getIdeaMassMergeDialog();D.setModel(m,"merge");this._prepareListItemForMassIdeaMerge(l);var N=this.byId("massIdeaMergeNavCon");N.to(this.byId("massMerge01"));D.open();};j._getIdeaMassMergeDialog=function(){if(!this._oMassMergeDialog){this._oMassMergeDialog=this.createFragment("sap.ino.vc.idea.fragments.IdeaMassMergeDialog",this.getView().getId());this._oMassMergeDialog.setEscapeHandler(this.handleEscapePress,this);this.getView().addDependent(this._oMassMergeDialog);}return this._oMassMergeDialog;};j._prepareListItemForMassIdeaMerge=function(i){var A,s,o,l=[{ID:-1,NAME:""}];var m=this._getIdeaMassMergeDialog().getModel("merge");if(!this._oIdeaMassMergeListItemTemplate){this._oIdeaMassMergeListItemTemplate=this.getFragment("sap.ino.vc.idea.fragments.FlatListItemForMerge");A=sap.ui.core.Fragment.byId(this.getView().getId(),"mergeListIdeaActions");A.removeItem(A.getItems()[0]);var _=this.formatCheckboxTooltip.bind(this);o=new c({selected:{parts:["data>ID","merge>/leadingIdeaId","merge>/selectedIdeas"],formatter:this.formatSelectedState},tooltip:{parts:["data>ID","merge>/leadingIdeaId","merge>/selectedIdeas"],formatter:_},enabled:{parts:["data>ID","merge>/leadingIdeaId","data>STATUS"],formatter:this.formatIsLeadingIdea},select:this.onIdeaMergeIdeaSelect});A.addItem(o);}var k=new F({filters:i,and:false});var n=new F("STATUS",b.NE,h.Merged);s=this.byId("ideaToMerge");s.bindItems({path:"data>/IdeaMedium",sorter:new S("NAME"),filters:new F({filters:[k,n],and:true}),template:this._oIdeaMassMergeListItemTemplate});s.getBinding("items").attachDataReceived(function(){jQuery.each(s.getItems(),function(p,q){var r=q.getBindingContext("data").getProperty("ID");var t=q.getBindingContext("data").getProperty("NAME");var v=q.getBindingContext("data").getProperty("VOTE_TYPE_TYPE_CODE");l.push({ID:r,NAME:t,VOTE_TYPE_TYPE_CODE:v});});m.setProperty("/leadingIdeaList",l);},this);};j.handleChangeLeadingMergeIdea=function(){var m=this._getIdeaMassMergeDialog().getModel("merge");var l=parseInt(m.getData().leadingIdeaId,10);var A=m.getProperty("/leadingIdeaList");m.setProperty("/selectedIdeas",A.filter(function(i){return i.ID!==l&&i.ID!==-1;}).map(function(i){return i.ID;}));};j.handleMassIdeaMergePrevStep=function(){var D=this._getIdeaMassMergeDialog();var m=D.getModel("merge");var i=parseInt(/massMerge0(\d)/.exec(m.getProperty("/pageview"))[1],10);var n;if(i===3&&!m.getProperty("/mergeRuleEnable")){n="massMerge01";}else{n="massMerge0"+(i-1);}m.setProperty("/pageview",n);var N=this.byId("massIdeaMergeNavCon");N.to(this.byId(n));};j.handleMassIdeaMergeNextStep=function(){var D=this._getIdeaMassMergeDialog();var m=D.getModel("merge");if(m.getProperty("/mergeRuleEnable")){this.handleMassIdeaMergeToRuleStep();}else{this.handleMassIdeaMergeToConfirmStep();}};j.handleMassIdeaMergeToRuleStep=function(){var t=this;var n=this.byId("massIdeaMergeNavCon");n.to(this.byId("massMerge02"));var D=this._getIdeaMassMergeDialog();var m=D.getModel("merge");m.setProperty("/pageview","massMerge02");m.setProperty("/mergeable",false);D.setBusy(true);var o=g.getMergeConfig();o.done(function(i){if(i.RESULT.length===0){i.RESULT=[{MERGE_TYPE:t.getText('IDEA_MASS_MERGE_RULE_TABLE_LABEL_AUTHOR'),ADD:false,IGNORE:false,PROMPT:true,OBJECT_TYPE_CODE:'AUTHOR'},{MERGE_TYPE:t.getText('IDEA_MASS_MERGE_RULE_TABLE_LABEL_EXPERTS'),ADD:false,IGNORE:false,PROMPT:true,OBJECT_TYPE_CODE:'EXPERT'},{MERGE_TYPE:t.getText('IDEA_MASS_MERGE_RULE_TABLE_LABEL_VOTES'),ADD:false,IGNORE:false,PROMPT:true,OBJECT_TYPE_CODE:'VOTE'},{MERGE_TYPE:t.getText('IDEA_MASS_MERGE_RULE_TABLE_LABEL_COMMENTS'),ADD:false,IGNORE:false,PROMPT:true,OBJECT_TYPE_CODE:'COMMENT'}];}else{i.RESULT.forEach(function(R){switch(R.OBJECT_TYPE_CODE){case"AUTHOR":R.MERGE_TYPE=t.getText('IDEA_MASS_MERGE_RULE_TABLE_LABEL_AUTHOR');break;case"EXPERT":R.MERGE_TYPE=t.getText('IDEA_MASS_MERGE_RULE_TABLE_LABEL_EXPERTS');break;case"VOTE":R.MERGE_TYPE=t.getText('IDEA_MASS_MERGE_RULE_TABLE_LABEL_VOTES');break;case"COMMENT":R.MERGE_TYPE=t.getText('IDEA_MASS_MERGE_RULE_TABLE_LABEL_COMMENTS');break;}R.ADD=!!R.ADD;R.IGNORE=!!R.IGNORE;R.PROMPT=!!R.PROMPT;});}var r=new J(i.RESULT);D.setModel(r,"rule");r.attachPropertyChange(t._handleRuleChange,t);r.firePropertyChange();D.setBusy(false);});};j.handleMassIdeaMergeToConfirmStep=function(){var D=this._getIdeaMassMergeDialog();var m=D.getModel("merge");var l=parseInt(m.getProperty("/leadingIdeaId"),10);var t=[l].concat(m.getProperty("/selectedIdeas"));var L=m.getProperty("/leadingIdeaList");var i=this;m.setProperty("/mergeResultList",t.map(function(k){var o=L.filter(function(p){return p.ID===k;})[0];return{ideaType:o.ID===l?i.getText("IDEA_MASS_MERGE_CONFIRM_TABLE_COL_LEADING_TYPE"):i.getText("IDEA_MASS_MERGE_CONFIRM_TABLE_COL_SOURCE_TYPE"),ideaName:o.NAME,ideaID:o.ID,result:o.ID===l?i.getText("IDEA_MASS_MERGE_CONFIRM_TABLE_COL_RESULT_CONTINUE"):i.getText("IDEA_MASS_MERGE_CONFIRM_TABLE_COL_RESULT_STOP"),isLeading:o.ID===l};}));var n=this.byId("massIdeaMergeNavCon");n.to(this.byId("massMerge03"));m.setProperty("/pageview","massMerge03");};j.handleMassIdeaMergeCancel=function(){this._getIdeaMassMergeDialog().close();};j.handleEscapePress=function(p){p.reject();};j.formatIsLeadingIdea=function(i,l){return i!==parseInt(l,10);};j.formatSelectedState=function(i,l,s){return i!==parseInt(l,10)&&s.indexOf(i)!==-1;};j.formatCheckboxTooltip=function(i,l,s){if(!j.formatIsLeadingIdea(i,l)){return"";}var k=j.formatSelectedState(i,l,s);return k?this.getText("IDEA_MASS_MERGE_SOURCE_IDEA_DESELECTED"):this.getText("IDEA_MASS_MERGE_SOURCE_IDEA_SELECTED");};j.formatMergeEnable=function(m,i,l,s){if(!m){return parseInt(l,10)!==-1&&s.length>0;}else{return i;}};j.formatVoteMergeAbleMsgDisplay=function(p,s,l,A){if(p!=='massMerge03'){return false;}if(s.length>1){return true;}var m=[s[0],parseInt(l,10)];var i=A.filter(function(o){if(m.indexOf(o.ID)>-1){return true;}return false;});return i[0].VOTE_TYPE_TYPE_CODE!==i[1].VOTE_TYPE_TYPE_CODE;};j._computeVoteRule=function(s,m){var n=m.selectedIdeas.filter(function(i){return i.VOTE_TYPE_TYPE_CODE!=="LIKE";});var v;if(n.length>0){v=s.filter(function(r){return r.OBJECT_TYPE_CODE==="VOTE";})[0];v.ADD=false;v.IGNORE=true;v.PROMPT=false;}};j._handleRuleChange=function(E){var r=E.getSource().getData();var n=r.filter(function(R){if(!R.ADD&&!R.IGNORE){return true;}else{return false;}});if(n.length===0){this._getIdeaMassMergeDialog().getModel('merge').setProperty('/mergeable',true);}};j.handleMassMergeExecute=function(){var D=this._getIdeaMassMergeDialog();D.setBusy(true);var m=D.getModel("merge");var l=parseInt(m.getProperty("/leadingIdeaId"),10);var i=m.getProperty("/selectedIdeas");var k=m.getProperty("/mergeRuleEnable")?D.getModel("rule").getData():[];var A=I.mergeIdeas(l,{SOURCE_IDEAS:i,MERGE_RULE:k});var t=this;A.done(function(){D.setBusy(false);D.close();i.forEach(function(n){M.update(null,"mergeIdeas",I,n);});if(typeof t.bindList==="function"){t.bindList();}d.show(t.getText("MSG_IDEA_MERGE_SUCCESS"));});A.fail(function(r){var n=r.MESSAGES;jQuery.each(n,function(o,p){var T;if(p.MESSAGE_TEXT){T=p.MESSAGE_TEXT;}else{T=t.getText(p.MESSAGE,p.REF_ID);}d.show(T);});});};return j;});
