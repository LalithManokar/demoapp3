sap.ui.define(["sap/ino/vc/idea/mixins/BaseActionMixin","sap/ui/model/json/JSONModel","sap/ino/commons/models/object/Idea","sap/ino/commons/models/aof/PropertyModel","sap/ino/commons/models/types/IntBooleanType","sap/ui/core/message/Message","sap/ui/core/MessageType","sap/m/MessageToast","sap/ino/controls/IFrame","sap/ino/commons/application/Configuration","sap/ui/core/ListItem","sap/ino/commons/formatters/ObjectFormatter","sap/m/MessageBox"],function(B,J,I,P,a,M,b,c,d,C,L,O,e){"use strict";var f=jQuery.extend({},B);f.ChangeStatusMixinData={aIdeaIds:[],iIdeaId:null,oPropertyModel:undefined};f.reasonCodeExist=function(r){return(r&&r!==''?true:false);};f.formatter=O;f.onChangeStatus=function(E){var D=this.getChangeStatusDialog();D.data("context","single");var i=this.getObjectModel();this.ChangeStatusMixinData.iIdeaId=i.getProperty("/ID");this.ChangeStatusMixinData.bIdeaPhaseNeedReward=i.getProperty("/IDEA_PHASE_NEED_REWARD");this.ChangeStatusMixinData.bHasIncompletedEvalReq=i.getProperty("/IDEA_HAS_INCOMPLETED_EVAL_REQ");this.ChangeStatusMixinData.bRewardDismissed=i.getProperty("/REWARD_DISMISSED");this.ChangeStatusMixinData.oPropertyModel=i.getPropertyModel();var s=this.ChangeStatusMixinData.oPropertyModel.getProperty("/actions/executeStatusTransition/customProperties/statusTransitions/0/STATUS_ACTION_CODE");this.bindStatusModel(s);this.initLinkButton();D.open();};f.onChangeStatusInList=function(E){this.saveCurrentFocusBeforeActionDialogOpen();var s=E.getSource();var D=this.getChangeStatusDialog();D.data("context","single");this.ChangeStatusMixinData.iIdeaId=s.getBindingContext("data").getProperty("ID");this.ChangeStatusMixinData.iCampaignId=s.getBindingContext("data").getProperty("CAMPAIGN_ID");this.ChangeStatusMixinData.sPhase=s.getBindingContext("data").getProperty("PHASE");this.ChangeStatusMixinData.bIdeaPhaseNeedReward=s.getBindingContext("data").getProperty("IDEA_PHASE_NEED_REWARD");this.ChangeStatusMixinData.bHasIncompletedEvalReq=s.getBindingContext("data").getProperty("IDEA_HAS_INCOMPLETED_EVAL_REQ");this.ChangeStatusMixinData.bRewardDismissed=s.getBindingContext("data").getProperty("REWARD_DISMISSED");var S={actions:["executeStatusTransition"]};this.ChangeStatusMixinData.oPropertyModel=new P("sap.ino.xs.object.idea.Idea",this.ChangeStatusMixinData.iIdeaId,S,false,function(){var i=this.ChangeStatusMixinData.oPropertyModel.getProperty("/actions/executeStatusTransition/customProperties/statusTransitions/0/STATUS_ACTION_CODE");this.bindStatusModel(i);D.open();}.bind(this,arguments));};f.onMassChangeStatus=function(E){if(this.getViewProperty("/List/SELECT_ALL")){var o=this.getBindingParameter();var i=this._check4ManagingList();var F=this.getList().getBinding('items').sFilterParams;var t=this.getViewProperty("/List/TAGS");var g={};var h=[];t.forEach(function(l,m){if(!g[l.ROOTGROUPID]){g[l.ROOTGROUPID]=[];g[l.ROOTGROUPID].push(l.ID);h.push(l.ROOTGROUPID);}else{g[l.ROOTGROUPID].push(l.ID);}});var p={searchToken:o.SearchTerm||"",tagsToken:g[h[0]]?g[h[0]].join(","):"",tagsToken1:g[h[1]]?g[h[1]].join(","):"",tagsToken2:g[h[2]]?g[h[2]].join(","):"",tagsToken3:g[h[3]]?g[h[3]].join(","):"",tagsToken4:g[h[4]]?g[h[4]].join(","):"",filterName:o.VariantFilter||"",filterBackoffice:i?"1":"0",filterString:F||""};if(this.setQueryObjectIdeaformFilters){this.setQueryObjectIdeaformFilters(p);}if(this.getCampaignFormQuery){p.ideaFormId=this.getCampaignFormQuery()||"";}if(this.getSearchType){p.searchType=this.getSearchType();}if(this.setQueryObjectCompanyViewFilters){this.setQueryObjectCompanyViewFilters(p);}var j=this;var k=jQuery.extend({},E);var s=E.getSource();s.setEnabled(false);jQuery.ajax({url:C.getBackendRootURL()+"/sap/ino/xs/rest/common/select_all_ideas.xsjs",data:p,success:function(r){s.setEnabled(true);if(r.Ideas.length===0){e.show(j.getText("NO_IDEAS_AND_RELOAD_PAGE"),{icon:e.Icon.INFORMATION,actions:[sap.m.MessageBox.Action.OK],onClose:function(){j.bindList();}});return;}j._oSelectionMap={};jQuery.each(r.Ideas,function(l,D){if(!j._oDeselectionMap[D.ID]){D.property=j._createPropertyData(D);j._oSelectionMap[D.ID]=D;}});j._onMassChangeStatus(k);},error:function(r){c.show(j.getText(r.responseJSON.messageKey));}});}else{this._onMassChangeStatus(E);}};f._onMassChangeStatus=function(E){var D=this.getChangeStatusDialog();D.data("context","mass");this.ChangeStatusMixinData.aIdeaIds=jQuery.map(this._oSelectionMap,function(i){return i.ID;});this.ChangeStatusMixinData.iIdeaId=this.ChangeStatusMixinData.aIdeaIds[0];var s={actions:["executeStatusTransition"]};this.ChangeStatusMixinData.oPropertyModel=new P("sap.ino.xs.object.idea.Idea",this.ChangeStatusMixinData.iIdeaId,s,false,function(){var i=this.ChangeStatusMixinData.oPropertyModel.getProperty("/actions/executeStatusTransition/customProperties/statusTransitions/0/STATUS_ACTION_CODE");this.bindStatusModel(i);D.open();}.bind(this,arguments));};f.bindStatusModel=function(s){var S=I.executeStatusTransitionModel(this.ChangeStatusMixinData.oPropertyModel,s);var D=this.getChangeStatusDialog();D.setModel(this.ChangeStatusMixinData.oPropertyModel,"property");D.setModel(S,"status");return S;};f.isIdeaPhaseNeedReward=function(){var D=this.getChangeStatusDialog();var s=D.getModel("status");if(this.ChangeStatusMixinData.bIdeaPhaseNeedReward&&s.getProperty("/REWARD_ACTIVE")&&!this.ChangeStatusMixinData.bRewardDismissed){return true;}return false;};f.isIdeaHasEvalReq=function(){if(this.ChangeStatusMixinData.bHasIncompletedEvalReq&&C.getSystemSetting("sap.ino.config.EVAL_REQ_ACTIVE")){return true;}return false;};f.getChangeStatusDialog=function(){if(!this._oChangeStatusDialog){this._oChangeStatusDialog=this.createFragment("sap.ino.vc.idea.fragments.ChangeStatus");this.getView().addDependent(this._oChangeStatusDialog);}return this._oChangeStatusDialog;};f.onChangeStatusSuggestUser=function(E){var v=E.getParameter("suggestValue");var t=new L({text:"{data>NAME}",additionalText:"{data>USER_NAME}",key:"{data>ID}"});E.getSource().bindAggregation("suggestionItems",{path:"data>/SearchIdentity(searchToken='"+jQuery.sap.encodeURL(v)+"')/Results",template:t,parameters:{select:"searchToken,ID,NAME,USER_NAME"}});};f.onStatusActionChanged=function(E){var s=E.getSource().getSelectedKey();this.resetClientMessages();this.clearClientMessages();this.initLinkButton();this.bindStatusModel(s);};f.onChangeStatusDialogOK=function(E){var D=this.getChangeStatusDialog();var s=D.getModel("status");var g=s.getData('data');var t=this;var A;function h(){D.setBusy(true);if(D.data("context")==="mass"){if(!t.hasAnyClientErrorMessages()){A=I.massExecuteStatusTransition(jQuery.extend({},s.getData(),{keys:t.ChangeStatusMixinData.aIdeaIds}));}}else{if(t.isActionContextSingleIdeaDisplay()){var l=t.getObjectModel();if(!t.hasAnyClientErrorMessages()){A=l.executeStatusTransition(s.getData(),true);}}else{if(!t.hasAnyClientErrorMessages()){A=I.executeStatusTransition(t.ChangeStatusMixinData.iIdeaId,s.getData());}}}if(A){A.fail(function(o){if(o.MESSAGES&&o.MESSAGES.length>0){c.show(t.getText(o.MESSAGES[0].MESSAGE_TEXT));}});A.done(function(){t.restoreFocusAfterActionDialogClose();if(typeof t.bindList==="function"){t.bindList();}D.close();c.show(t.getText("OBJECT_MSG_STATUS_CHANGE_SUCCESS"));t._oChangeStatusDialog.destroy();t._oChangeStatusDialog=undefined;});A.always(function(){D.setBusy(false);});}else{D.setBusy(false);}}var i=this.isIdeaPhaseNeedReward();var j=this.isIdeaHasEvalReq();var k;if(i&&j){k=this.getText("OBJECT_MSG_STATUS_CHANGE_DOUBLE_CONFIRMATION");}else if(i){k=this.getText("OBJECT_MSG_STATUS_CHANGE_CONFIRMATION");}else if(j){k=this.getText("OBJECT_MSG_STATUS_CHANGE_EVAL_CONFIRMATION");}if((i||j)&&g.STATUS_ACTION_CODE==="sap.ino.config.START_NEXT_PHASE"){e.confirm(k,{title:this.getText("IDEA_OBJECT_TIT_STATUS_CHANGE_CONFIRMATION"),icon:e.Icon.NONE,onClose:function(r){if(r==="OK"){h();}else{t.onChangeStatusDialogCancel();}}});}else{h();}};f.onChangeStatusDialogCancel=function(E){var D=this.getChangeStatusDialog();if(this.resetInputTypeValidations){this.resetInputTypeValidations(D);}this.restoreFocusAfterActionDialogClose();this._oChangeStatusDialog.close();this._oChangeStatusDialog.destroy();this._oChangeStatusDialog=undefined;};f.onAfterChangeStatusDialogClose=function(E){};f.onShowMailPreview=function(E){var D=this.getChangeStatusDialog();var s=D.getModel("status");var t={CAMPAIGN_ID:this.ChangeStatusMixinData.iCampaignId,PHASE:this.ChangeStatusMixinData.sPhase,STATUS_ACTION_CODE:s.getProperty("/STATUS_ACTION_CODE"),NEXT_STATUS_CODE:s.getProperty("/NEXT_STATUS_CODE")};var o=this.getObjectModel&&this.getObjectModel();if(o){t.CAMPAIGN_ID=o.getProperty("/CAMPAIGN_ID");t.PHASE=o.getProperty("/PHASE");t.STATUS_CODE=o.getProperty("/STATUS_CODE");}var T=new J(C.getTextMoudleURL(t));T.attachRequestCompleted(null,function(){var g=s.getProperty("/RESPONSE");var u=this.getModel("user").getData().data.LOCALE;var p={CONTENT:jQuery.sap.encodeHTML(g||""),IDEA:this.ChangeStatusMixinData.iIdeaId,DECIDER:s.getProperty("/DECIDER_ID"),ACTOR:C.getCurrentUser().USER_ID,LOCALE:u,ACTION:s.getProperty("/STATUS_ACTION_CODE"),PHASE:s.getProperty("/NEXT_PHASE_CODE"),STATUS:s.getProperty("/NEXT_STATUS_CODE"),TEXT_CODE:!T.getData()[0]?"null":T.getData()[0].TEXT_MODULE_CODE,REASON:jQuery.sap.encodeHTML(s.getProperty("/REASON")||""),REASON_CODE:s.getProperty("/REASON_CODE"),LINK_LABEL:s.getProperty("/LINK_LABEL"),LINK_URL:s.getProperty("/LINK_URL")};var m=new J(C.getMailPreviewURL(p));if(!this._oMailPreviewDialog){this._oMailPreviewDialog=this.createFragment("sap.ino.vc.idea.fragments.MailPreviewDialog");this.getView().addDependent(this._oMailPreviewDialog);}m.attachRequestCompleted(this.onMailTextLoaded,this);},this);};f.onMailTextLoaded=function(E){var h=new d({content:E.getSource().getData().TEXT});this._oMailPreviewDialog.addContent(h);this._oMailPreviewDialog.open();};f.onMailViewClose=function(){if(this._oMailPreviewDialog){this._oMailPreviewDialog.close();this._oMailPreviewDialog.removeAllContent();}};f.onChangeStatusSuggestionUserSelected=function(E){var D=this.getChangeStatusDialog();var s=D.getModel("status");this.resetClientMessages();var i=E.getParameters().selectedItem;if(i){var g=parseInt(i.getProperty("key"),10);s.setProperty("/DECIDER_ID",g);}else{var u=C.getCurrentUser();s.setProperty("/DECIDER_ID",u.USER_ID);}};f.onAddLinkDialogCancel=function(){this.resetClientMessages();this._oLinkDialog.close();this._oLinkDialog.destroy();this._oLinkDialog=undefined;};f.onAddLink=function(){var D=this.getLinkDialog();D.setModel(new J({URL:"",LABEL:""}),"link");D.bindElement({path:"link>/"});this.resetClientMessages();D.open();};f.onAddLinkDialogOK=function(){var D=this.getLinkDialog();var m=D.getModel("link");var u=m.getProperty("/URL");var l=m.getProperty("/LABEL");this.resetClientMessages();var o=this.addLink(u,l);if(o){this.setClientMessage(o,this.byId("URLInput"));}else{this._oLinkDialog.close();this._oLinkDialog.destroy();this._oLinkDialog=undefined;}};f.addLink=function(u,l){var m;var s=this.getChangeStatusDialog().getModel("status");u=u.trim();if(!u||u===""){m=new M({code:"IDEA_OBJECT_MSG_LINK_URL_NOT_ALLOWED",type:b.Error});return m;}if(u&&u.indexOf("http://")!==0&&u.indexOf("https://")!==0&&u.indexOf("mailto:")!==0){u="http://"+u;}if(!u||u===""||!jQuery.sap.validateUrl(u)){m=new M({code:"IDEA_OBJECT_MSG_LINK_URL_NOT_ALLOWED",type:b.Error});return m;}if(!l||l===""){l=null;}s.setProperty("/LINK_LABEL",l);s.setProperty("/LINK_URL",u);this.getLinkButton().setVisible(false);};f.getLinkDialog=function(){if(!this._oLinkDialog){this._oLinkDialog=this.createFragment("sap.ino.vc.idea.fragments.Link",this.getView().getId());this.getView().addDependent(this._oLinkDialog);this._oLinkDialog.setInitialFocus(this.createId("URLInput"));}return this._oLinkDialog;};f.onEditLink=function(){var D=this.getLinkDialog();var s=this.getChangeStatusDialog().getModel("status");var u=s.getProperty("/LINK_URL");var l=s.getProperty("/LINK_LABEL");D.setModel(new J({URL:u,LABEL:l}),"link");D.bindElement({path:"link>/"});D.open();};f.onDeleteLink=function(){var s=this.getChangeStatusDialog().getModel("status");s.setProperty("/LINK_LABEL","");s.setProperty("/LINK_URL","");this.getLinkButton().setVisible(true);};f.getLinkButton=function(){return this.byId("addLink");};f.initLinkButton=function(){this.byId("addLink").setVisible(true);};f.clearClientMessages=function(){var m=new sap.ui.getCore().getMessageManager();var g=m.getMessageModel().getData();var t=[];jQuery.each(g,function(i,o){if(o.target.indexOf("responseRequireTextArea")>-1||o.target.indexOf("responseRequireTextAreaDecision")>-1){t.push(o);}});m.removeMessages(t);};f.onChangeStatusMakerChange=function(E){var s=E.getSource();var v=s.getValue();var t=this,g;var S=this.getChangeStatusDialog().getModel("status");var D=typeof this._getChangeDecisionDialog==="function"?this._getChangeDecisionDialog().getModel("decision"):undefined;var h=s.getAggregation("suggestionItems");if(h){for(var i=0;i<h.length;i++){if(v===h[i].getText()){g=parseInt(h[i].getProperty("key"),10);}else if(v===h[i].getAdditionalText()){g=parseInt(h[i].getProperty("key"),10);}if(g){if(S){S.setProperty("/DECIDER_ID",g);}if(D){D.setProperty("/DECIDER_ID",g);}break;}}}if(!g){t.resetClientMessages();t.setClientMessage(new M({code:"IDEA_OBJECT_MSG_DECISION_MAKER_VALUE_WRONG_INPUT",type:b.Error}),s);}else{t.resetClientMessages();}};return f;});
