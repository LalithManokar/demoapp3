sap.ui.define(["sap/ino/commons/models/object/Vote","sap/ino/commons/models/object/IdeaFollow","sap/m/MessageToast","sap/ino/commons/models/core/CodeModel","sap/ui/model/json/JSONModel"],function(V,I,M,C,J){"use strict";var v={COM:"Company",COST:"Cost Center",ORG:"Organization",OFF:"Office"};var o={TYPE_STAR:"STAR",TYPE_LIKE:"LIKE",TYPE_LIKE_DISLIKE:"LIKE_DISLIKE"};var a=function(){throw"Mixin may not be instantiated directly";};a.onUserVote=function(e){var d=this.getVoteMixinDialog();var i=e.getParameter('objectId');var p=this.getPropertyUrl(i);var s=this.getModel('data').getProperty(p+'/VOTE_COMMENT_TYPE');var b=this.getModel('data').getProperty(p+'/VOTE_REASON_CODE');var P=this.getModel('data').getProperty(p+'/PUBLIC_VOTE');var c;this.dialogParameters=e.getParameters();this.dialogSource=e.getSource();this.resetClientMessages();var m=new sap.ui.getCore().getMessageManager();m.removeAllMessages();var f=e.getParameter('voteId');if(!f){this.oIdeaVoteModel=new J();}if(!s||s===null||s===''){return this.onSubmit();}if(!this.dialogSource.getProperty('value')){return this.onSubmit();}if(s==='LIST'&&b){var g="sap.ino.xs.object.basis.ValueOptionList.ValueOptions";c=C.getCodes(g,function(j){return j.LIST_CODE===b&&j.ACTIVE===1;});}var h={VOTE_COMMENT_TYPE:s,VOTE_REASON_CODE:b,VOTE_COMMENT_LIST:c,PUBLIC_VOTE:P,VOTE_COMMENT:"",VOTE_REASON:c&&c[0].CODE||""};this.oVoteModel=new J();this.oVoteModel.setData(h);d.setModel(this.oVoteModel,"vote");d.open();};a.getPropertyUrl=function(i){var p=['IdeaMediumCommunity','MyIdeaMediumCommunity','IdeaMediumBackofficeSearch','IdeaFull'];return this.CheckProperty(p,i);};a.CheckProperty=function(l,b){var k=l,p;if(!k||!b){return false;}for(var i=0;i<k.length;i++){p=this.getEntityKey(k[i],b);if(p){return'/'+p;}}};a.getEntityKey=function(e,k){var c=new RegExp("^"+e+"\\(.*"+k+"\\)$");var b=new RegExp("^"+e+"\\(.*(')("+k+")\\1\\)$");var d=new RegExp("^"+e+"\\(.*="+k+"\\)$");var f=new RegExp("^"+e+"\\(.*(=')("+k+")\\1\\)$");var D=this.getModel('data').getProperty("/");var E;var g=[];jQuery.each(D,function(K){if(c.test(K)||b.test(K)){g.push(K);}});if(g.length>1){g.forEach(function(K){if(d.test(K)||f.test(K)){E=K;}});}else{E=g&&g[0];}return E;};a.onSubmit=function(e){var s=this;var b;var c=this.dialogSource;var d=this._oVoteMixinDialog.getModel('vote')?this._oVoteMixinDialog.getModel('vote').getProperty('/VOTE_REASON'):'';var f=this._oVoteMixinDialog.getModel('vote')?this._oVoteMixinDialog.getModel('vote').getProperty('/VOTE_COMMENT'):'';var i=this.dialogParameters.objectId;var S=this.dialogParameters.value;var g=this.dialogParameters.voteId;var r=this.routes&&this.routes.length?this.routes[0]:undefined;if(!this.hasAnyClientErrorMessages()){b=V.vote(i,S,g,d,f);if(c.setEnabled){c.setEnabled(false);}}var p=this.getPropertyUrl(this.dialogParameters.objectId);var h=this.getModel('data').getProperty(p+'/VOTED_BY_GROUP');var F=this.getModel('data').getProperty(p+'/FOLLOW');var A=this.getModel('data').getProperty(p+'/AUTO_FOLLOW');var j=this.getModel('data').getProperty(p+'/VOTE_TYPE_TYPE_CODE');var k=true;var l=b.mode;if(b){if(l==="DEL_VOTE"){b.vote.done(function(){var L="voteView--voteList";var m=sap.ui.getCore().byId(L);if(m){var B=m.getBindingInfo("items");m.bindItems(B);}if(!h){M.show(s.getText("VOTE_MSG_REMOVE_VOTE_SUCCESS"));}else{M.show(s.getText("VOTE_MSG_REMOVE_VOTE_BY_GROUP_SUCCESS",[v[h]]));var G=sap.ui.getCore().byId("voteView--groupVoteList");if(G){var n=G.getBindingInfo("items");G.bindItems(n);}}var q={ID:null,SCORE:0};if(s.oIdeaVoteModel){s.oIdeaVoteModel.setProperty("/"+i,q);}if(c.setEnabled){c.setEnabled(true);}if(s.isGlobalSearch){s.getSearchResult(s.getViewProperty("/SEARCH_QUERY"));}});}else if(l==="MODIFY_VOTE"){b.vote.done(function(e){var L="voteView--voteList";var m=sap.ui.getCore().byId(L);if(m){var B=m.getBindingInfo("items");m.bindItems(B);}if(!h){M.show(s.getText("VOTE_MSG_VOTE_SUCCESS"));}else{M.show(s.getText("VOTE_MSG_VOTE_BY_GROUP_SUCCESS",[v[h]]));var G=sap.ui.getCore().byId("voteView--groupVoteList");if(G){var n=G.getBindingInfo("items");G.bindItems(n);}}var q={ID:e.GENERATED_IDS[-1]||g,SCORE:S};if(s.oIdeaVoteModel){s.oIdeaVoteModel.setProperty("/"+i,q);}if(c.setEnabled){c.setEnabled(true);}if(j==="STAR"){var t=s.getModel('data').getProperty(p+'/MAX_STAR_NO');k=S&&t&&S>=(t-1)?true:false;}else if(j==="LIKE_DISLIKE"){k=S>0?true:false;}if(!F&&A&&k){s.onVotedFollow();}if(s.isGlobalSearch){s.getSearchResult(s.getViewProperty("/SEARCH_QUERY"));}});}b.vote.fail(function(m){if(c.setEnabled){c.setEnabled(true);}M.show(m.MESSAGES.length===1?m.MESSAGES[0].MESSAGE_TEXT:s.getText("VOTE_MSG_VOTING_NOT_POSSIBLE"));});this.getVoteMixinDialog().setModel("","vote");return this.getVoteMixinDialog().close();}};a.onVotedFollow=function(){var t=this;var i=this.dialogParameters.objectId;var f=I.follow(i,"IDEA",0);f.done();};a.globalSearchAllVoteCount=function(b,c){var d=this.getModel("data");var e=this.dialogParameters;var s=d.oData.Ideas.data;var i=e.objectId;var f,g;jQuery.each(s,function(j,k){if(k.ID===i){f=k;g=j;return false;}});if(f){switch(f.VOTE_TYPE_TYPE_CODE){case o.TYPE_LIKE:if(b==="MODIFY_VOTE"){f.VOTE_COUNT+=1;}else{f.VOTE_COUNT-=1;}f.USER_SCORE=e.value;f.SCORE=f.VOTE_COUNT;f.VOTE_ID=c.ID;break;case o.TYPE_LIKE_DISLIKE:if(b==="MODIFY_VOTE"){f.NEG_VOTES=e.value===-1?f.NEG_VOTES+1:f.NEG_VOTES;f.POS_VOTES=e.value===1?f.POS_VOTES+1:f.POS_VOTES;f.POS_VOTES=e.value===-1&&e.oldValue===1?f.POS_VOTES-1:f.POS_VOTES;f.NEG_VOTES=e.value===1&&e.oldValue===-1?f.NEG_VOTES-1:f.NEG_VOTES;}else{f.POS_VOTES=e.oldValue===1?f.POS_VOTES-1:f.POS_VOTES;f.NEG_VOTES=e.oldValue===-1?f.NEG_VOTES-1:f.NEG_VOTES;}f.USER_SCORE=e.value;f.VOTE_ID=c.ID;break;case o.TYPE_STAR:var S=f.SCORE*f.VOTE_COUNT;var h=f.USER_SCORE;if(b==="MODIFY_VOTE"){f.VOTE_COUNT=f.USER_SCORE?f.VOTE_COUNT:f.VOTE_COUNT+1;}else{f.VOTE_COUNT=f.VOTE_COUNT-1;}f.USER_SCORE=e.value;f.SCORE=f.VOTE_COUNT?(S+f.USER_SCORE-h)/f.VOTE_COUNT:0;f.VOTE_ID=c.ID;break;default:break;}d.setProperty("/Ideas/data/"+g,f);}};a.onCloseDialog=function(e){this.dialogSource.setValue(this.dialogParameters.oldValue);this.getVoteMixinDialog().setModel("","vote");return this.getVoteMixinDialog().close();};a.getVoteMixinDialog=function(){if(!this._oVoteMixinDialog){this._oVoteMixinDialog=this.createFragment('sap.ino.vc.idea.fragments.VoteMixin');this.getView().addDependent(this._oVoteMixinDialog);}return this._oVoteMixinDialog;};a.transitionTitle=function(b){var t,c;var p=this.dialogParameters;if(b){t=C.getText("sap.ino.xs.object.basis.ValueOptionList.Root",b);}else{t=this.getText('IDEA_VOTE_DEFAULT_TITLE');}switch(p.type){case'LIKE':c='IDEA_VOTE_LIKE';break;case'LIKE_DISLIKE':c=p.value===1?'IDEA_VOTE_LIKE':'IDEA_VOTE_DISLIKE';break;case'STAR':c='IDEA_VOTE_STAR';break;default:c='IDEA_VOTE_LIKE';break;}return this.getText(c,[t]);};a.onIdeaCommentPress=function(E){var i;if(E.getParameter("ideaId")){i=E.getParameter("ideaId");}else{try{if(E.getSource().getProperty("objectId")){i=E.getSource().getProperty("objectId");}}catch(e){i=E.getSource().getBindingContext("data").getProperty("ID");}}if(i){this.navigateTo("idea-display",{id:i,query:{section:"sectionComments"}});}};return a;});
