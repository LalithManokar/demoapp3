sap.ui.define(["sap/ino/commons/models/object/Idea","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ino/commons/models/core/CodeModel","sap/ino/commons/formatters/ObjectFormatter","sap/ui/core/message/Message","sap/ui/core/MessageType","sap/ino/controls/IFrame","sap/ino/commons/application/Configuration","sap/ui/core/ListItem"],function(I,M,J,C,O,a,b,c,d,L){"use strict";var e=function(){throw"Mixin may not be instantiated directly";};e.onOpenChangeDecision=function(E){var D=this._getChangeDecisionDialog();var o=this.getObjectModel();this.resetClientMessages();var f=o.getProperty("/Decisions");var s=E.getSource();var g=s.getCustomData()[0].getValue();var S,h;for(var i=0;i<f.length;i++){if(g===f[i].ID){S=f[i];h=i;}}if(S){var j=jQuery.extend({},S);var k=new J(j);D.setModel(k,"decision");if(S.DECISION_REASON_LIST_CODE){var l="sap.ino.xs.object.basis.ValueOptionList.ValueOptions";var r=C.getCodes(l,function(m){return m.LIST_CODE===S.DECISION_REASON_LIST_CODE&&m.ACTIVE===1;});}}k.setProperty("/reasonList",r);k.setProperty("/INDEX",h);k.setProperty("/SEND_RESPONSE",1);k.setProperty("/IS_DECISION_RELEVANT",true);D.open();};e._getChangeDecisionDialog=function(){var D=this._oChangeDecisionDialog;if(!D){D=this.createFragment("sap.ino.vc.idea.fragments.ChangeDecision",this.getView().getId());this.getView().addDependent(D);this._oChangeDecisionDialog=D;}return D;};e.onChangeDecisionDialogCancel=function(){var D=this._getChangeDecisionDialog();D.close();this.resetClientMessages();var o=D.getModel("decision");o.setData(null);this._oChangeDecisionDialog.destroy();this._oChangeDecisionDialog=undefined;};e.onChangeDecisionSuggestionUserSelected=function(E){var D=this._getChangeDecisionDialog();var o=D.getModel("decision");this.resetClientMessages();var i=E.getParameters().selectedItem;if(i){var f=parseInt(i.getProperty("key"),10);o.setProperty("/DECIDER_ID",f);}else{var u=d.getCurrentUser();o.setProperty("/DECIDER_ID",u.USER_ID);}};e.onChangeDecisionSuggestUser=function(E){var v=E.getParameter("suggestValue");var t=new L({text:"{data>NAME}",additionalText:"{data>USER_NAME}",key:"{data>ID}"});E.getSource().bindAggregation("suggestionItems",{path:"data>/SearchIdentity(searchToken='"+jQuery.sap.encodeURL(v)+"')/Results",template:t,parameters:{select:"searchToken,ID,NAME,USER_NAME"}});};e.onChangeDecisionDialogOK=function(){var D=this._getChangeDecisionDialog();var f=D.getModel("decision");var i=this.getObjectModel();var A;var t=this;if(f.getProperty("/SEND_RESPONSE")===0){f.setProperty("/RESPONSE","");}D.setBusy(true);if(!t.hasAnyClientErrorMessages()){A=I.changeDecision(i.getProperty("/ID"),f.getData());}if(A){A.fail(function(o){if(o.MESSAGES&&o.MESSAGES.length>0){M.show(t.getText(o.MESSAGES[0].MESSAGE_TEXT));}D.setBusy(false);});A.done(function(){var o=t.getModel("data");o.read("/IdeaDecision("+f.getProperty("/ID")+")",{success:function(r){D.setBusy(false);D.close();M.show(t.getText("OBJECT_MSG_DECISION_CHANGE_SUCCESS"));delete r.__metadata;i.setProperty("/Decisions/"+f.getProperty("/INDEX"),r);i.setProperty("/Decisions/"+f.getProperty("/INDEX")+"/DECISION_DATE",f.getProperty("/DECISION_DATE"));t._oChangeDecisionDialog.destroy();t._oChangeDecisionDialog=undefined;}});});}else{D.setBusy(false);}};e.onAddLinkChangeDecisionDialogCancel=function(){this.resetClientMessages();this._oLinkDialog.close();this._oLinkDialog.destroy();this._oLinkDialog=undefined;};e.onAddLinkChangeDecision=function(){var D=this.getLinkChangeDecisionDialog();D.setModel(new J({URL:"",LABEL:""}),"link");D.bindElement({path:"link>/"});this.resetClientMessages();D.open();};e.onAddLinkChangeDecisionDialogOK=function(){var D=this.getLinkChangeDecisionDialog();var m=D.getModel("link");var u=m.getProperty("/URL");var l=m.getProperty("/LABEL");this.resetClientMessages();var o=this.addLinkChangeDecision(u,l);if(o){this.setClientMessage(o,this.byId("URLChangeDecisionInput"));}else{this._oLinkDialog.close();this._oLinkDialog.destroy();this._oLinkDialog=undefined;}};e.addLinkChangeDecision=function(u,l){var m;var D=this._getChangeDecisionDialog().getModel("decision");u=u.trim();if(!u||u===""){m=new a({code:"IDEA_OBJECT_MSG_LINK_URL_NOT_ALLOWED",type:b.Error});return m;}if(u&&u.indexOf("http://")!==0&&u.indexOf("https://")!==0&&u.indexOf("mailto:")!==0){u="http://"+u;}if(!u||u===""||!jQuery.sap.validateUrl(u)){m=new a({code:"IDEA_OBJECT_MSG_LINK_URL_NOT_ALLOWED",type:b.Error});return m;}if(!l||l===""){l=null;}D.setProperty("/LINK_LABEL",l);D.setProperty("/LINK_URL",u);this.getLinkButtonChangeDecision().setVisible(false);};e.getLinkChangeDecisionDialog=function(){if(!this._oLinkDialog){this._oLinkDialog=this.createFragment("sap.ino.vc.idea.fragments.ChangeDecisionLink",this.getView().getId());this.getView().addDependent(this._oLinkDialog);this._oLinkDialog.setInitialFocus(this.createId("URLChangeDecisionInput"));}return this._oLinkDialog;};e.onEditLinkChangeDecision=function(){var D=this.getLinkChangeDecisionDialog();var o=this._getChangeDecisionDialog().getModel("decision");var u=o.getProperty("/LINK_URL");var l=o.getProperty("/LINK_LABEL");D.setModel(new J({URL:u,LABEL:l}),"link");D.bindElement({path:"link>/"});D.open();};e.onDeleteLinkChangeDecision=function(){var D=this._getChangeDecisionDialog().getModel("decision");D.setProperty("/LINK_LABEL","");D.setProperty("/LINK_URL","");this.getLinkButtonChangeDecision().setVisible(true);};e.getLinkButtonChangeDecision=function(){return this.byId("addLinkChangeDecision");};e.initLinkButtonChangeDecision=function(){this.byId("addLinkChangeDecision").setVisible(true);};e.onShowChangeDecisionMailPreview=function(E){var D=this._getChangeDecisionDialog();var o=D.getModel("decision");var t=o.getProperty("/RESPONSE");var u=navigator.language||navigator.userLanguage;var p={CONTENT:jQuery.sap.encodeHTML(t||""),IDEA:o.getProperty("/IDEA_ID"),ACTOR:o.getProperty("/DECIDER_ID"),LOCALE:u.split("-")[0],ACTION:o.getProperty("/STATUS_ACTION_CODE"),PHASE:o.getProperty("/PHASE_CODE"),STATUS:o.getProperty("/STATUS_CODE"),TEXT_CODE:o.getProperty("/TEXT_MODULE_CODE"),REASON:jQuery.sap.encodeHTML(o.getProperty("/REASON")||""),REASON_CODE:o.getProperty("/REASON_CODE"),LINK_LABEL:o.getProperty("/LINK_LABEL"),LINK_URL:o.getProperty("/LINK_URL")};var m=new J(d.getMailPreviewURL(p));if(!this._oChangeDecisionMailPreviewDialog){this._oChangeDecisionMailPreviewDialog=this.createFragment("sap.ino.vc.idea.fragments.ChangeDecisionMailPreviewDialog");this.getView().addDependent(this._oChangeDecisionMailPreviewDialog);}m.attachRequestCompleted(this.onMailTextLoad,this);};e.onMailTextLoad=function(E){var h=new c({content:E.getSource().getData().TEXT});this._oChangeDecisionMailPreviewDialog.addContent(h);this._oChangeDecisionMailPreviewDialog.open();};e.onChangeDecisionMailViewClose=function(){if(this._oChangeDecisionMailPreviewDialog){this._oChangeDecisionMailPreviewDialog.close();this._oChangeDecisionMailPreviewDialog.removeAllContent();}};e.onChangeDecisionMakerChange=function(E){var s=E.getSource();var v=s.getValue();var t=this,f;var S=typeof this.getChangeStatusDialog==="function"?this.getChangeStatusDialog().getModel("status"):undefined;var D=this._getChangeDecisionDialog().getModel("decision");var g=s.getAggregation("suggestionItems");if(g){for(var i=0;i<g.length;i++){if(v===g[i].getText()){f=parseInt(g[i].getProperty("key"),10);}else if(v===g[i].getAdditionalText()){f=parseInt(g[i].getProperty("key"),10);}if(f){if(S){S.setProperty("/DECIDER_ID",f);}if(D){D.setProperty("/DECIDER_ID",f);}break;}}}if(!f){t.resetClientMessages();t.setClientMessage(new a({code:"IDEA_OBJECT_MSG_DECISION_MAKER_VALUE_WRONG_INPUT",type:b.Error}),s);}else{t.resetClientMessages();}};return e;});
