sap.ui.define(["sap/ino/vc/idea/mixins/BaseActionMixin","sap/ino/vc/commons/BaseObjectController","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox","sap/ino/commons/application/Configuration","sap/ino/commons/models/object/Idea"],function(B,a,J,M,F,b,c,C){"use strict";var d=jQuery.extend({},B);var f=function(r){if(this._oChangeAuthorConfirmDialog&&this._oChangeAuthorConfirmDialog.isOpen()){this._oChangeAuthorConfirmDialog.close();}var t=this;a.prototype.executeObjectAction.call(this,"changeAuthorStatic",{messages:{success:function(){if(typeof t.getObjectModel==="function"){t.setBusy(true);t.getObjectModel().sync();t.getObjectModel().getDataInitializedPromise().always(function(){t.setBusy(false);});}else if(typeof t.bindList==="function"){t.bindList();}M.show(t.getText("OBJECT_MSG_AUTHOR_CHANGE_SUCCESS"),{autoClose:false});},error:function(R){if(R.MESSAGES&&R.MESSAGES.length>0){M.show(t.getText(R.MESSAGES[0].MESSAGE_TEXT,R.MESSAGES[0].PARAMETERS),{autoClose:false});}}},staticparameters:r,objectModelExt:jQuery.sap.getObject("sap.ino.commons.models.object.Idea",0)});};var g=function(){if(typeof this.getObjectModel==="function"){return[this.getObjectModel().getProperty("/ID")];}else{return Object.keys(this._oSelectionMap);}};var G=function(){var i;if(typeof this.getObjectModel==="function"){i=this.getObjectModel().getData();return{"ID":i.CREATED_BY_ID,"NAME":i.CREATED_BY_NAME};}else{i=this._oSelectionMap[Object.keys(this._oSelectionMap)[0]];return{"ID":i.SUBMITTER_ID,"NAME":i.SUBMITTER_NAME};}};var e=function(){if(typeof this.getObjectModel==="function"){return[this.getObjectModel().getProperty("/CAMPAIGN_ID")];}else{var h=[];Object.keys(this._oSelectionMap).forEach(function(k){if(h.indexOf(this._oSelectionMap[k].CAMPAIGN_ID)>-1){return;}h.push(this._oSelectionMap[k].CAMPAIGN_ID);}.bind(this));return h;}};d.onChangeAuthorSearch=function(E){this.bindAuthors(E.getSource(),E.getParameter("value"));};d.onChangeAuthor=function(){var D=this.getChangeAuthorDialog();this.bindAuthors(D);D.open();};d.onMassChangeAuthor=function(E){if(this.getViewProperty("/List/SELECT_ALL")){var o=this.getBindingParameter();var i=this._check4ManagingList();var s=this.getList().getBinding('items').sFilterParams;var t=this.getViewProperty("/List/TAGS");var h={};var j=[];t.forEach(function(l,m){if(!h[l.ROOTGROUPID]){h[l.ROOTGROUPID]=[];h[l.ROOTGROUPID].push(l.ID);j.push(l.ROOTGROUPID);}else{h[l.ROOTGROUPID].push(l.ID);}});var p={searchToken:o.SearchTerm||"",tagsToken:h[j[0]]?h[j[0]].join(","):"",tagsToken1:h[j[1]]?h[j[1]].join(","):"",tagsToken2:h[j[2]]?h[j[2]].join(","):"",tagsToken3:h[j[3]]?h[j[3]].join(","):"",tagsToken4:h[j[4]]?h[j[4]].join(","):"",filterName:o.VariantFilter||"",filterBackoffice:i?"1":"0",filterString:s||""};if(this.setQueryObjectIdeaformFilters){this.setQueryObjectIdeaformFilters(p);}if(this.getCampaignFormQuery){p.ideaFormId=this.getCampaignFormQuery()||"";}if(this.getSearchType){p.searchType=this.getSearchType();}if(this.setQueryObjectCompanyViewFilters){this.setQueryObjectCompanyViewFilters(p);}var k=this;var S=E.getSource();S.setEnabled(false);jQuery.ajax({url:C.getBackendRootURL()+"/sap/ino/xs/rest/common/select_all_ideas.xsjs",data:p,success:function(r){S.setEnabled(true);if(r.Ideas.length===0){c.show(k.getText("NO_IDEAS_AND_RELOAD_PAGE"),{icon:c.Icon.INFORMATION,actions:[sap.m.MessageBox.Action.OK],onClose:function(){k.bindList();}});return;}k._oSelectionMap={};jQuery.each(r.Ideas,function(I,D){if(!k._oDeselectionMap[D.ID]){D.property=k._createPropertyData(D);k._oSelectionMap[D.ID]=D;}});k._massChangeAuthor();},error:function(r){M.show(k.getText(r.responseJSON.messageKey));}});}else{this._massChangeAuthor();}};d._massChangeAuthor=function(){var D=this.getMassChangeAuthorDialog();this.bindAuthors(D);D.open();};d.onChangeAuthorConfirm=function(){var o=this._oChangeAuthorConfirmDialog.getModel("confirm").getData();var O=G.call(this);var i=g.call(this);var r={"ORIGIN_AUTHOR_ID":O.ID,"AUTHOR_ID":o.newAuthorID,"Reward":o.changeReward||false,"Selfevaluation":o.changeEval||false,"keys":i};f.call(this,r);};d.onChangeRewardAndEvluYes=function(){var o=this._oChangeAuthorConfirmDialog.getModel("confirm").getData();var O=G.call(this);var i=g.call(this);var r={"ORIGIN_AUTHOR_ID":O.ID,"AUTHOR_ID":o.newAuthorID,"Reward":o.REWARDCOUNT>0,"Selfevaluation":o.SELFEVALUATIONCOUNT>0,"keys":i};f.call(this,r);};d.onChangeRewardAndEvaluNO=function(){var o=this._oChangeAuthorConfirmDialog.getModel("confirm").getData();var O=G.call(this);var i=g.call(this);var r={"ORIGIN_AUTHOR_ID":O.ID,"AUTHOR_ID":o.newAuthorID,"Reward":false,"Selfevaluation":false,"keys":i};f.call(this,r);};d.getChangeAuthorDialog=function(){if(!this._oChangeAuthorDialog){var _=function(s){s._oList.setMode("SingleSelectLeft");s._oList.mEventRegistry.selectionChange=[];s._oDialog.setEndButton(s._getCancelButton());};this._oChangeAuthorDialog=this.createFragment("sap.ino.vc.idea.fragments.ChangeAuthor");this._oChangeAuthorDialog.attachConfirm(this.onChangeAuthorDialogOK,this);this.getView().addDependent(this._oChangeAuthorDialog);_(this._oChangeAuthorDialog);}return this._oChangeAuthorDialog;};d.getMassChangeAuthorDialog=function(){if(!this._oChangeAuthorDialog){var _=function(s){s._oList.setMode("SingleSelectLeft");s._oList.mEventRegistry.selectionChange=[];s._oDialog.setEndButton(s._getCancelButton());};this._oChangeAuthorDialog=this.createFragment("sap.ino.vc.idea.fragments.ChangeAuthor");this._oChangeAuthorDialog.attachConfirm(this.onMassChangeAuthorDialogOK,this);this._oChangeAuthorDialog.data("context","mass");this.getView().addDependent(this._oChangeAuthorDialog);_(this._oChangeAuthorDialog);}return this._oChangeAuthorDialog;};d.getChangeAuthorConfirmDialog=function(){if(!this._oChangeAuthorConfirmDialog){this._oChangeAuthorConfirmDialog=this.createFragment("sap.ino.vc.idea.fragments.ChangeAuthorConfirm");this.getView().addDependent(this._oChangeAuthorConfirmDialog);}return this._oChangeAuthorConfirmDialog;};d.onChangeAuthorDialogOK=function(E){var i=this.getObjectModel().getProperty("/ID");var s=E.getParameter("selectedItem");if(!s){return;}var o=s.getBindingContext("data").getObject();var t=this;this.getView().setBusy(true);this.getModel("data").read('/IdeaFull('+i+')/RewardSelfevaluationCount',{async:true,success:function(D){D.SELFEVALUATIONCOUNT=parseInt(D.SELFEVALUATIONCOUNT,10);D.REWARDCOUNT=parseInt(D.REWARDCOUNT,10);if(D.SELFEVALUATIONCOUNT>0||D.REWARDCOUNT>0){t.getView().setBusy(false);var h=t.getChangeAuthorConfirmDialog();h.setModel(new J({REWARDCOUNT:D.REWARDCOUNT,SELFEVALUATIONCOUNT:D.SELFEVALUATIONCOUNT,oldAuthor:t.getObjectModel().getProperty("/CREATED_BY_NAME"),newAuthor:o.NAME,newAuthorID:o.ID}),"confirm");h.open();}else{var I=t.getObjectModel();var r={"ORIGIN_AUTHOR_ID":I.getProperty("/CREATED_BY_ID"),"AUTHOR_ID":o.ID,"Reward":false,"Selfevaluation":false,"keys":[I.getProperty("/ID")]};f.call(t,r);}}});};d.onMassChangeAuthorDialogOK=function(E){var s=E.getParameter("selectedItem");if(!s){return;}var o=s.getBindingContext("data").getObject();var O=G.call(this);var t=this;var h=Object.keys(this._oSelectionMap).map(function(i){return new F({path:"ID",operator:b.EQ,value1:i});});var _=function(D){var r=0,S=0;D.some(function(i){if(i.REWARDCOUNT>0){r=1;}if(i.SELFEVALUATIONCOUNT>0){S=1;}if(r===1&&S===1){return true;}else{return false;}});return{"REWARDCOUNT":r,"SELFEVALUATIONCOUNT":S};};this.getView().setBusy(true);this.getModel("data").read('/IdeaRewardSelfevaluationCount',{async:true,filters:h,success:function(D){var p=_(D.results);if(p.SELFEVALUATIONCOUNT>0||p.REWARDCOUNT>0){t.getView().setBusy(false);var i=t.getChangeAuthorConfirmDialog();i.data("context","mass");i.setModel(new J({REWARDCOUNT:p.REWARDCOUNT,SELFEVALUATIONCOUNT:p.SELFEVALUATIONCOUNT,oldAuthor:O.NAME,newAuthor:o.NAME,newAuthorID:o.ID}),"confirm");i.open();}else{var r={"ORIGIN_AUTHOR_ID":O.ID,"AUTHOR_ID":o.ID,"Reward":false,"Selfevaluation":false,"keys":Object.keys(t._oSelectionMap)};f.call(t,r);}}});};d.bindAuthors=function(D,s){var h=e.call(this).join(",");s=s?jQuery.sap.encodeURL(s):"*";if(!/.*[\u4e00-\u9fa5]+.*$/.test(s)&&s.length<3){D.removeAllItems();return;}var o={path:"data>/SearchCampaignParticipantsParams(searchToken='"+s+"',campaignIdsToken='"+h+"')/Results",template:D.getBindingInfo("items").template};var O;if(D.data("context")==="mass"){O=G.call(this).ID;}else{O=this.getObjectModel().getProperty("/CREATED_BY_ID");}o.filters=[new F({path:"ID",operator:b.NE,value1:O})];D.bindAggregation("items",o);};d.handleAuthorSelect=function(E){var o=this.getChangeAuthorDialog().getModel("changedAuthor");var s=E.getParameter("selectedItem");o.setProperty("/ID",s.getKey());o.setProperty("/NAME",s.getText());};return d;});
