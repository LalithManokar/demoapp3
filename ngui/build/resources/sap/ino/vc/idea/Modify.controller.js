sap.ui.define(["sap/ino/vc/commons/BaseObjectModifyController","sap/ino/commons/models/object/Idea","sap/ino/commons/models/object/Attachment","sap/ino/commons/application/WebAnalytics","sap/m/Token","sap/m/MessageToast","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/Sorter","sap/ui/core/ListItem","sap/ui/core/HTML","sap/ino/commons/application/Configuration","sap/ino/controls/MobileTextEditor","sap/ino/vc/commons/TopLevelPageFacet","sap/ui/model/json/JSONModel","sap/ui/core/MessageType","sap/ui/core/message/Message","sap/ui/core/ResizeHandler","sap/ui/Device","sap/m/MessageBox","sap/m/Label","sap/m/CheckBox","sap/m/Input","sap/m/ComboBox","sap/ino/commons/models/core/CodeModel","sap/ui/model/type/String","sap/ino/commons/models/types/IntegerType","sap/ino/commons/models/types/FloatType","sap/ui/model/odata/type/Date","sap/ino/commons/models/types/IntegerNullableType","sap/ino/commons/models/types/FloatNullableType","sap/ino/commons/models/types/IntNullableBooleanType","sap/ino/vc/commons/mixins/SimilarIdeasMixin","sap/ino/vc/commons/mixins/RichTextInitMixin"],function(B,I,A,W,T,M,F,a,S,L,H,C,b,d,J,f,g,R,D,h,k,l,m,n,o,p,q,r,s,t,u,v,w,x){"use strict";var y={BOOLEAN:"BOOL_VALUE",TEXT:"TEXT_VALUE",INTEGER:"NUM_VALUE",NUMERIC:"NUM_VALUE",RICHTEXT:"RICH_TEXT_VALUE",DATE:"DATE_VALUE"};return B.extend("sap.ino.vc.idea.Modify",jQuery.extend({},d,w,x,{routes:["idea-edit","idea-create"],preCheck:true,onInit:function(){B.prototype.onInit.apply(this,arguments);this._dViewShown=jQuery.Deferred();this.setViewProperty("/EDIT",true);this.setViewProperty("/ATTACHMENT_UPLOAD_URL",A.getEndpointURL());this.addMultiInputHandling(this.byId("Contributors"),{childNodeName:"Contributors",childNodeNameSingular:"Contributor",suggestion:{key:"ID",text:"NAME",additionalText:"USER_NAME",path:"data>/SearchIdentity(searchToken='$suggestValue')/Results",filters:[new F({path:"TYPE_CODE",operator:a.EQ,value1:"USER"})],sorter:new S("NAME")},token:{key:"IDENTITY_ID",text:"NAME",editable:"{=!${object>/CONTRIBUTION_READ_ONLY}}"}});this.addMultiInputHandling(this.byId("Tags"),{childNodeName:"Tags",childNodeNameSingular:"Tag",suggestion:{key:"NAME",text:"NAME",path:"data>/SearchTagsParams(searchToken='$suggestValue')/Results",filter:[],sorter:[]},token:{key:"NAME",text:"NAME"}});},onRouteMatched:function(e){var c=this.byId("campaignComboBox");c.setValue(undefined);var i=e.getParameters().name;var j=this;B.prototype.onRouteMatched.apply(this,arguments);var z=this.getObjectModel();z.getDataInitializedPromise().done(function(K){j.bindCampaignList(K,z.isNew());j.bindAnonymousList(K,z.isNew());z.setProperty("/OLD_RESP_NAME",z.getProperty("/RESP_VALUE_NAME"));j._oldCampaignId=z.getProperty("/CAMPAIGN_ID");j._oldCampaignForm=z.getProperty("/CAMPAIGN_FORM_CODE");var N=j.byId("ideaFormAddFields");if(i==="idea-edit"){j.setRespListProperty.call(j,z,z.oData.RESP_NAME);if(N.getItems()[0]){N.removeAllItems();}if(z.oData.CAMPAIGN_ID){j.getModel("data").read("/CampaignSmall("+z.oData.CAMPAIGN_ID+")/FormFields",{urlParameters:{"$orderby":"SEQUENCE_NO"},success:function(O){var P=O.results;var Q=z.oData.FieldsValue;if(P&&Q&&Q.length>0&&P.length>0&&P[0].FORM_CODE===Q[0].FORM_CODE){var U=j.cacluateNewFieldsAdded(P,Q);z.setProperty("/NEW_ADDED_FIELDS",U);}j.addFormFields.call(j,z.oData.FieldsValue,N,z);},error:function(O){M.show(O.message);}});}j.syncAuthorToContributionShare();}else{j.setRespListProperty.call(j,z,z.oData.RESP_VALUE_CODE);if(N.getItems()[0]){N.removeAllItems();}if(z.oData.CAMPAIGN_ID){j.getModel("data").read("/CampaignSmall("+z.oData.CAMPAIGN_ID+")/FormFields",{urlParameters:{"$orderby":"SEQUENCE_NO"},success:function(O){var P=O.results;j.addFormFields.call(j,P,N,z);},error:function(O){M.show(O.message);}});}}});jQuery.when(z.getPropertyModelInitializedPromise(),this._dViewShown).done(function(P){j.initRTE(P);j.initIdeaDetails();if(j.getObjectModel().isNew()&&!j.getObjectExists()){j.setObjectExists(true);}if(!j.getObjectModel().getPropertyModel().getProperty("/actions/modify/enabled")&&!j.getObjectModel().getPropertyModel().getProperty("/actions/del/enabled")){j.setObjectExists(false);}});var E=C.getSystemSetting("sap.ino.config.DISABLE_IDEA_IMAGE");var G=C.getSystemSetting("sap.ino.config.DISABLE_IDEA_IMAGE_HIDE_PHASE_BAR");this.setViewProperty('/ENABLE_IDEA_IMAGE',!(E*1)&&!(G*1));this.setHelp("IDEA_MODIFY");this.showSection("sectionDetails");this.byId("RespList").onAfterRendering=function(){sap.m.Input.prototype.onAfterRendering.apply(this);j.byId("NAME").focus();};},cacluateNewFieldsAdded:function(c,e){var N=[];var j=function(E,G){return E.filter(function(V){return V.CODE===G;});};for(var i=0;i<c.length;i++){var z=j(e,c[i].CODE);if(z.length===0&&c[i].IS_ACTIVE){N.push(c[i]);}}return N;},onDelete:function(e){var c=this;var i=e.getSource();var O=c.getObjectModel();var j=C.getSystemSettingsModel().getProperty("/sap.ino.config.PPM_INTEGRATION_ACTIVE");var z=O.getProperty("/INTEGRATION_OBJECT_EXIST");var E=O.getPropertyModel().getProperty("/actions/del/customProperties/hasReward");var G=O.getPropertyModel().getProperty("/actions/del/enabled");var K=O.getPropertyModel().getProperty("/actions/del/customProperties/isMergeedWithVote");if(E){M.show(this.getText("MSG_IDEA_HAVE_REWARD_CANNOT_DELETE"));}else if(!G){M.show(this.getText("OBJECT_MSG_DELETE_FAILED"));}else if(K){M.show(this.getText("MSG_IDEA_MERGED_WITH_VOTE_CANNOT_DELETE"));}else{var N=O.getProperty("/EVALUATION_COUNT");var P=O.getPropertyModel().getProperty("/actions/del/customProperties/isManager");if(!N||(N&&P)){var Q="MSG_DEL_CONFIRM";if(j==="1"||z){Q="MSG_IDEA_CAMP_MANAGER_DEL_CONFIRM_HAVE_PPM_INTEGRATION";}var U=c.executeObjectAction("del",{messages:{confirm:Q,success:"MSG_DEL_SUCCESS"}});U.done(function(V){if(V&&V.confirmationCancelled===true){if(i&&jQuery.type(i.focus)==="function"){i.focus();}return;}c.navigateTo("idealist");});}else{M.show(this.getText("MSG_IDEA_DEL_FAILED_SUBMITTER_HAVE_EVALUATION"));}}},onCampaignSelectionChange:function(){var c=this;var i=this.getObjectModel();var e=this.byId("ideaFormAddFields");this.resetClientMessages();if(e.getItems()[0]){e.removeAllItems();if(i._isNew){i.oData.FieldsValue=[];}}i.setProperty("/RESP_VALUE_CODE","");i.setProperty("/RESP_VALUE_NAME","");i.setProperty("/RESP_VALUE_DESCRIPTION","");var j=this.byId("campaignComboBox");var z=j.getSelectedKey();if(z>0&&j){var E=j.getItemByKey(z).getProperty("text");j.setValue(E);}if(!i._isNew){this.onFormChanged.call(this,i,z,e,j);}else{if(z){this.getModel("data").read("/CampaignSmall("+z+")/FormFields",{urlParameters:{"$orderby":"SEQUENCE_NO"},success:function(K){var N=K.results;c.addFormFields.call(c,N,e,i);},error:function(K){M.show(K.message);}});}}var G=this.getModel("data");G.attachRequestCompleted(G,c.syncAuthorToContributionShareBinding,c);this.bindSimilarIdeas();this.bindAnonymousList(G,i.isNew(),z);},addFormFields:function(c,e,i,j){var z=this;if(z.aCheckBoxes){z.aCheckBoxes=[];}if(z.aComboBoxes){z.aComboBoxes=[];}var G=function(Q){var U;switch(Q.DATATYPE_CODE){case"BOOLEAN":U=!Q.VALUE_OPTION_LIST_CODE?new v(null):new sap.ino.commons.models.types.IntegerType();break;case"INTEGER":if(Q.MANDATORY){U=new q(null,{minimum:(Q.NUM_VALUE_MIN||undefined),maximum:(Q.NUM_VALUE_MAX||undefined)});}else{U=new t(null,{minimum:(Q.NUM_VALUE_MIN||undefined),maximum:(Q.NUM_VALUE_MAX||undefined)});}break;case"NUMERIC":if(Q.MANDATORY){U=new r({groupingEnabled:false},{minimum:(Q.NUM_VALUE_MIN||undefined),maximum:(Q.NUM_VALUE_MAX||undefined)});}else{U=new u({groupingEnabled:false},{minimum:(Q.NUM_VALUE_MIN||undefined),maximum:(Q.NUM_VALUE_MAX||undefined)});}break;case"TEXT":U=new p(null,{minLength:(Q.MANDATORY?1:undefined)});break;case"RICHTEXT":U=new p(null,{minLength:(Q.MANDATORY?1:undefined)});break;case"DATE":U=new s(null,{nullable:(Q.MANDATORY?false:true)});break;default:break;}return U;};var E=function(Q){var V=Q.getParameters().value;var U=Q.getSource();var X=U.getItemByText(V);if(X===null){var Y=new g({code:"IDEA_FORM_MSG_DROPDOWN_LIST",type:f.Error});this.oIdeaFormMessage=Y;z.setClientMessage(Y,this);}else{z.resetClientMessages();}};var K=function(Q){var U=Q.getSource();var V=U.getValue();var X=U.getItemByText(V);if(V&&!X){z.setClientMessage(new g({code:"IDEA_FORM_MSG_DROPDOWN_LIST",type:f.Error}),this);}else{z.resetClientMessages();}};var N=function(Q){if(!this.getSelected()){this.setValueState('Error');z.setClientMessage(new g({code:"IDEA_OBJECT_MSG_CHECK_BOX_UNTICK",type:f.Error}),this);}else{z.resetClientMessages(Q.getParameter('id'));this.setValueState('None');}};var O=i.getPropertyModel().getProperty("/nodes/Root/attributes/CAMPAIGN_ID/changeable");var P=i.getProperty("/NEW_ADDED_FIELDS");if(P&&P.length>0){c=c.concat(P);c.sort(function(Q,U){if(Q.SEQUENCE_NO<U.SEQUENCE_NO){return-1;}else{return 1;}});i.setProperty("/FieldsValue/",c);}jQuery.each(c,function(Q,U){if(!U.IS_ACTIVE){return true;}if(i._isNew||j===h.Action.OK||!U.ID){var V=jQuery.extend({ID:i.getNextHandle(),FIELD_CODE:U.CODE},U);i.setProperty("/FieldsValue/"+Q,V);}if(U.IS_DISPLAY_ONLY){var X=new H({sanitizeContent:true,preferDOM:false,content:{model:"object",path:"/FieldsValue/"+Q+"/DISPLAY_TEXT",formatter:z.formatter.wrapHTML}});e.addItem(X);return true;}var Y;if(U.UOM_CODE){Y=U.DEFAULT_TEXT+"("+o.getText("sap.ino.xs.object.basis.Unit.Root",U.UOM_CODE)+")";}else{Y=U.DEFAULT_TEXT;}var Z=false;if(U.MANDATORY===1){Z=true;}var _;_=y[U.DATATYPE_CODE];if(U.VALUE_OPTION_LIST_CODE){var a1=new k({text:Y,tooltip:U.DEFAULT_LONG_TEXT,required:Z});if(U.IS_HIDDEN_SETTING&&U.IS_HIDDEN_SETTING===1){a1.setTooltip(z.getText("IDEA_EDIT_FORM_HIDDEN_TOOLTIP"));}else if(U.IS_HIDDEN_SETTING===undefined&&U.IS_HIDDEN===1){a1.setTooltip(z.getText("IDEA_EDIT_FORM_HIDDEN_TOOLTIP"));}a1.addStyleClass("sapInoIdeaFormLabelStyle");e.addItem(a1);var b1="sap.ino.xs.object.basis.ValueOptionList.Root_"+U.VALUE_OPTION_LIST_CODE;if(V){V.valueOptionList=o.getCodes(b1,function(n1){return n1.ACTIVE===1;});}else{U.valueOptionList=o.getCodes(b1,function(n1){return n1.ACTIVE===1;});}var c1="object>/FieldsValue/"+Q+"/"+_;var d1={path:c1,type:G(U)};var e1=new n({enabled:O,tooltip:U.DEFAULT_LONG_TEXT,selectedKey:d1,width:"100%",change:U.MANDATORY?E:K});e1.addItem();var f1="{object>"+_+"}";var g1=new L({key:f1,text:"{object>DEFAULT_TEXT}"});var h1="object>/FieldsValue/"+Q+"/valueOptionList";e1.bindItems({path:h1,template:g1,sorter:new S("SEQUENCE_NO")});if(!z.aComboBoxes){z.aComboBoxes=[];}z.aComboBoxes.push(e1);e.addItem(e1);}else{if(U.DATATYPE_CODE==="BOOLEAN"){if(!z.aCheckBoxes){z.aCheckBoxes=[];}var i1=new l({text:U.DEFAULT_TEXT,enabled:O,tooltip:U.DEFAULT_LONG_TEXT,selected:"{object>/FieldsValue/"+Q+"/BOOL_VALUE}",select:Z?N:function(){}});if(U.IS_HIDDEN_SETTING&&U.IS_HIDDEN_SETTING===1){i1.setTooltip(z.getText("IDEA_EDIT_FORM_HIDDEN_TOOLTIP"));}else if(U.IS_HIDDEN_SETTING===undefined&&U.IS_HIDDEN===1){i1.setTooltip(z.getText("IDEA_EDIT_FORM_HIDDEN_TOOLTIP"));}var j1=i1._getLabel();if(Z){j1.addStyleClass("sapMLabelRequired");z.aCheckBoxes.push(i1);}j1.addStyleClass("sapInoIdeaFormLabelStyle");e.addItem(i1);}else{var k1;var l1=new k({text:Y,tooltip:U.DEFAULT_LONG_TEXT,required:Z});if(U.IS_HIDDEN_SETTING&&U.IS_HIDDEN_SETTING===1){l1.setTooltip(z.getText("IDEA_EDIT_FORM_HIDDEN_TOOLTIP"));}else if(U.IS_HIDDEN_SETTING===undefined&&U.IS_HIDDEN===1){l1.setTooltip(z.getText("IDEA_EDIT_FORM_HIDDEN_TOOLTIP"));}l1.addStyleClass("sapInoIdeaFormLabelStyle");e.addItem(l1);var m1={path:"object>/FieldsValue/"+Q+"/"+_,type:G(U)};if(U.DATATYPE_CODE==="RICHTEXT"){k1=sap.ui.xmlfragment({id:z.getView().getId(),fragmentName:"sap.ino.vc.idea.fragments.IdeaRichTxt"},z);k1.attachReady(function(){this.bindProperty("value",{path:m1.path,type:G(U)});});}else if(U.DATATYPE_CODE==="DATE"){k1=new sap.m.DatePicker({enabled:O,tooltip:U.DEFAULT_LONG_TEXT,value:{path:m1.path,type:G(U)},width:"100%"});}else{k1=new m({enabled:O,tooltip:U.DEFAULT_LONG_TEXT,value:m1,width:"100%"});}if(k1.addAriaLabelledBy){k1.addAriaLabelledBy(l1);}k1.addStyleClass("sapUiSmallMarginBottom");e.addItem(k1);}}});},setRespListProperty:function(i,c){var e=this.byId("RespList");if(c){e.setVisible(true);}else{e.setVisible(false);}if(i.oData.RESP_CODE){this.getModel("data").read("/ResponsibilityValueSearchParams(searchToken='',respCode='"+i.oData.RESP_CODE+"')/Results",{urlParameters:{"$orderby":"NAME"},success:function(j){i.setProperty("/Resp_Value",j.results);}});}},onSuggestionList:function(e){var c=this;var i=this.getObjectModel();var E=jQuery.extend({},e,true);var j=jQuery.sap.encodeURL(E.getParameter("suggestValue"));this.resetClientMessages();this.getModel("data").read("/ResponsibilityValueSearchParams(searchToken='"+j+"',respCode='"+i.oData.RESP_CODE+"')/Results",{urlParameters:{"$orderby":"NAME"},success:function(z){i.setProperty("/Resp_Value",z.results);c.byId("RespList").setFilterSuggests(false);}});},onSuggestionSelected:function(e){},onHandleValueHelp:function(e){var c=this;var i=c.createRespListDialog();i.open();i.setBusy(true);var j=c.byId('respValueTreeTable');var z=this.getObjectModel();this.getModel("data").read("/ResponsibilityValueSearchParams(searchToken='',respCode='"+z.oData.RESP_CODE+"')/Results",{urlParameters:{"$orderby":"SEQUENCE_NO"},success:function(E){i.setBusy(false);z.setProperty("/Resp_Value",E.results);var G=c.convertToHierarchy(E.results,"ID","PARENT_VALUE_ID");z.setProperty("/Resp_Value_Tree",G);c.setViewProperty("/ENABLE_OK_BTN",false);c.resetClientMessages();c.byId('RespList')._closeSuggestionPopup();j.attachBrowserEvent("dblclick",function(){if(j.isIndexSelected(c._treeTableIndex)){j.removeSelectionInterval(c._treeTableIndex,c._treeTableIndex);}else{j.addSelectionInterval(c._treeTableIndex,c._treeTableIndex);}if(c._treeTableIndex>-1){var K=j.getContextByIndex(c._treeTableIndex).getPath();c.onRespValueChangedMessageBox.call(c,z,K);if(c._oRespListDialog){c._oRespListDialog.close();c._oRespListDialog.destroy();c._oRespListDialog=undefined;}}c._treeTableIndex=-1;});},error:function(E){z.setProperty("/Resp_Value_Tree",[]);i.setBusy(false);M.show(E.message);}});},convertToHierarchy:function(O,K,P){var N=this.createStructure(O,P);var c=N.root;this.arrToHierarchy(c,N,K);return c;},createStructure:function(N,P){var O={root:[]};for(var i=0;i<N.length;i++){var c="Sub_"+N[i][P];if(!N[i].children||!jQuery.isArray(N[i].children)){N[i].children=[];}if(isNaN(parseInt(N[i][P],10))){O.root.push(N[i]);}else{if(!O.hasOwnProperty(c)){O[c]=[];}O[c].push(N[i]);}}return O;},arrToHierarchy:function(c,N,K){if(!c||c.length===0){return;}for(var i=0;i<c.length;i++){var P="Sub_"+c[i][K];if(N.hasOwnProperty(P)){c[i].children=N[P];this.arrToHierarchy(c[i].children,N,K);}}},onRespValueDialogClose:function(){if(this._oRespListDialog){this._oRespListDialog.close();this._oRespListDialog.destroy();this._oRespListDialog=undefined;}},onRespRowSelectionChange:function(e){var c=this;var i=c.byId("respValueTreeTable");var j=i.getSelectedIndex();if(j>-1){this.setViewProperty("/ENABLE_OK_BTN",true);this._treeTableIndex=j;}else{this.setViewProperty("/ENABLE_OK_BTN",false);}},createRespListDialog:function(){if(!this._oRespListDialog){this._oRespListDialog=this.createFragment("sap.ino.vc.idea.fragments.ResponsibilityListValue",this.getView().getId());this.getView().addDependent(this._oRespListDialog);}return this._oRespListDialog;},onSearchRespValue:function(e){var V=jQuery.sap.encodeURL(e.getParameter("value"));var i=this.getObjectModel();this.getModel("data").read("/ResponsibilityValueSearchParams(searchToken='"+V+"',respCode='"+i.oData.RESP_CODE+"')/Results",{urlParameters:{"$orderby":"NAME"},success:function(c){i.setProperty("/Resp_Value",c.results);}});},onSelectedItem:function(e){var c=this;var i=this.getObjectModel();var j=c.byId("respValueTreeTable");var z=j.getSelectedIndex();if(z>-1){var E=j.getContextByIndex(z).getPath();c.onRespValueChangedMessageBox.call(c,i,E);}if(this._oRespListDialog){this._oRespListDialog.close();this._oRespListDialog.destroy();this._oRespListDialog=undefined;}},setIdeaModelRespValueProperty:function(i,c){i.setProperty("/RESP_VALUE_CODE",i.getProperty(c).CODE);i.setProperty("/RESP_VALUE_NAME",i.getProperty(c).NAME);i.setProperty("/RESP_VALUE_BINDING_CODE",i.getProperty(c).CODE);i.setProperty("/OLD_RESP_NAME",i.getProperty("/RESP_VALUE_NAME"));},onRespValueChangedMessageBox:function(i,c){var e=this;if(!i._isNew){var j=C.getCurrentUser();var z=i.oData.SubmitterContributors;var E=z.filter(function(N){return N.IDENTITY_ID===j.USER_ID;});var G=i.getProperty("/RESP_VALUE_CODE");var K=i.getProperty(c).CODE;if(!E.length&&G!==K){h.show(this.getText("IDEA_OBJECT_MSG_RESP_LIST_VALUE_CHG",i.getProperty("/RESP_NAME")),{title:this.getText("IDEA_OBJECT_RESP_LIST_POP_TITLE",i.getProperty("/RESP_NAME")),icon:h.Icon.WARNING,actions:[h.Action.YES,h.Action.NO],onClose:function(N){if(N===h.Action.YES){e.setIdeaModelRespValueProperty(i,c);}else{i.setProperty("/RESP_VALUE_NAME",i.getProperty("/OLD_RESP_NAME"));}}});}else{e.setIdeaModelRespValueProperty(i,c);}}else{e.setIdeaModelRespValueProperty(i,c);}},onRespListValueChange:function(){var c=this.byId("RespList");var i=this.getObjectModel();var V=c.getValue().trim();var e=i.getProperty("/Resp_Value");var j;var z=this;jQuery.each(e,function(E,G){if(V===G.NAME.trim()){j="/Resp_Value/"+E;return false;}});if(j){z.onRespValueChangedMessageBox.call(z,i,j);}else{i.setProperty("/RESP_VALUE_BINDING_CODE","");z.resetClientMessages();z.setClientMessage(new g({code:"IDEA_OBJECT_MSG_RESP_LIST_VALUE_WRONG_INPUT",type:f.Error}),z.byId("RespList"));}},onFormChanged:function(i,c,e,j){var z;var E=this;var G=E._oldCampaignForm;var K=i.getPropertyModel().getProperty("/nodes/Root/attributes/NAME/changeable");this.getModel("data").read("/CampaignSmall("+c+")/FormFields",{urlParameters:{"$orderby":"SEQUENCE_NO"},success:function(N){z=N.results;if(K){if(!z.length&&G){h.confirm(E.getText("IDEA_OBJECT_MSG_CONFIRM_CAMPAIGN_CHG"),{title:E.getText("IDEA_OBJECT_EDIT_POP_TITLE"),icon:h.Icon.WARNING,actions:[h.Action.OK,h.Action.CANCEL],onClose:function(O){if(O===h.Action.OK){i.oData.FieldsValue=z;i.setProperty("/NEW_ADDED_FIELDS",[]);E.addFormFields.call(E,z,e,i,O);E._oldCampaignId=j.getSelectedKey();E._oldCampaignForm=null;}else{E.addFormFields.call(E,i.oData.FieldsValue,e,i);j.setSelectedKey(E._oldCampaignId);}}});}else if(z.length&&G!==z[0].FORM_CODE){h.show(E.getText("IDEA_OBJECT_MSG_EDIT_CAMPAIGN_CHG"),{title:E.getText("IDEA_OBJECT_EDIT_POP_TITLE"),icon:h.Icon.WARNING,actions:[h.Action.OK,h.Action.CANCEL],onClose:function(O){if(O===h.Action.OK){i.oData.FieldsValue=z;i.setProperty("/NEW_ADDED_FIELDS",[]);E.addFormFields.call(E,z,e,i,O);E._oldCampaignId=j.getSelectedKey();E._oldCampaignForm=z[0].FORM_CODE;}else{E.addFormFields.call(E,i.oData.FieldsValue,e,i);j.setSelectedKey(E._oldCampaignId);}}});}else{E.addFormFields.call(E,i.oData.FieldsValue,e,i);}}else{E.addFormFields.call(E,i.oData.FieldsValue,e,i);}},error:function(N){M.show(N.message);}});},onContributorsTokenChanged:function(c){if(this._checkContributionReadOnly()||!this._checkContributionEnable()||!c||c.getParameters().type!=="tokensChanged"){return;}var i=this.getObjectModel();var e=c.getParameters().removedTokens;var j=C.getCurrentUser();var z=c.getParameters().addedTokens;var E=i.getProperty("/ContributionShare");var G=i.isNew()?j.USER_ID:i.getProperty("/CREATED_BY_ID");var K=i.isNew()?j.NAME:i.getProperty("/CREATED_BY_NAME");if(!!e&&e.length>0){var N=parseInt(e[0].getKey(),10);if(G===N){return;}for(var O=E.length-1;O>=0;--O){if(E[O].AUTHOR_ID===N){E.splice(O,1);}}if(!!E&&E.length===1&&E[0].AUTHOR_ID===G){E=[];}i.setProperty("/ContributionShare",E);}else if(!!z&&z.length>0){var P=parseInt(z[0].getKey(),10);if(!E||E.length===0){i.addChild({AUTHOR_ID:G,AUTHOR_NAME:K},"ContributionShare");}if(G===P){return;}i.addChild({AUTHOR_ID:P,AUTHOR_NAME:z[0].getText()},"ContributionShare");}},setRespValueChangeMsg:function(){var c=this.byId("RespList");var i=this.getObjectModel();var e=i.getProperty("/RESP_VALUE_BINDING_CODE");var j=i.getProperty("/Resp_Value");var z=this;if(!j&&!e){e=i.getProperty("/RESP_VALUE_CODE");}if(!e){var V=c.getValue().trim();jQuery.each(j,function(E,G){if(V===G.NAME.trim()){e=G.CODE;return false;}});if(!e){z.setClientMessage(new g({code:"IDEA_OBJECT_MSG_RESP_LIST_VALUE_WRONG_INPUT",type:f.Error}),z.byId("RespList"));}}},createObjectModel:function(O,c,e){var i={nodes:["Root","Extension"],actions:["modify","modifyAndSubmit","del"],continuousUse:true,concurrencyEnabled:true,readSource:{model:this.getDefaultODataModel(),includeNodes:[{name:"ReassignCampaigns",parentNode:"Root",primaryKey:"KEY"},{name:"RespExperts",parentNode:"Root",primaryKey:"ID"}]}};var j;if(!O){var Q=e["?query"]||{};var z;try{z={CAMPAIGN_ID:Q.campaign?parseInt(Q.campaign,10):0,NAME:Q.title,RESP_VALUE_CODE:Q.RespList,RESP_VALUE_NAME:Q.RespList&&o.getText("sap.ino.xs.object.subresponsibility.ResponsibilityStage.RespValues",Q.RespList),DESCRIPTION:Q.description,Tags:Q.tags&&Q.tags.split(","),Walls:Q.wall?[{WALL_ID:parseInt(Q.wall,10)}]:undefined};}catch(E){jQuery.sap.log.error("Failed parsing creation arguments",E,"sap.ino.vc.idea.Modify.controller");}j=new I(z,i);}else{W.logIdeaView(O);j=new I(O,i);}return j;},initIdeaDetails:function(){this._sTitleText=undefined;this._sDescriptionText=undefined;this._aTags=undefined;this._oSimilarModel=undefined;this.expandSimilarIdeasOnInit();},onAnonymousSelectionChange:function(e){var c=this.byId("anonymousComboBox");var i=this.getObjectModel();var j=c.getSelectedKey();i.setProperty("/AnonymousFor/0/",{"ANONYMOUS_FOR":j});},bindAnonymousList:function(c,i,e){var j=this.byId("anonymousComboBox");var z=this.byId("anonymousOptionLabel");var E=c.CAMPAIGN_ID;if(e){E=e;}if(j){var G=this.getModel("user").getProperty("/data").USER_ID;var K,N;var O=this;if(c.AnonymousFor&&c.AnonymousFor.length>0){j.setSelectedKey(c.AnonymousFor[0].ANONYMOUS_FOR);}else{j.setSelectedKey("");}K=new L({key:"{data>ANONYMOUS_FOR}",text:{path:"data>ANONYMOUS_FOR",formatter:function(U){switch(U){case"NONE":return O.getText("IDEA_NOT_ANONYMOUS");case"ALL":return O.getText("IDEA_ANONYMOUS_FOR_ALL");case"PARTLY":return O.getText("IDEA_NOT_ANONYMOUS_CAMPAIGN_MANAGER");case"COACH":return O.getText("IDEA_NOT_ANONYMOUS_COACH");case"EXPERT":return O.getText("IDEA_NOT_ANONYMOUS_EXPERT");case"PARTICIPANT":return O.getText("IDEA_NOT_ANONYMOUS_PARTICIPANT");case"COACH_AND_EXPERT":return O.getText("IDEA_NOT_ANONYMOUS_COACH_AND_EXPERT");case"COACH_POOL":return O.getText("IDEA_NOT_ANONYMOUS_COACH_POOL");case"EXPERT_POOL":return O.getText("IDEA_NOT_ANONYMOUS_EXPERT_POOL");case"COACH_POOL_AND_EXPERT_POOL":return O.getText("IDEA_NOT_ANONYMOUS_COACH_POOL_AND_EXPERT_POOL");}}}});N="data>/IdeaAnonymous";if(E){j.bindItems({path:N,template:K,filters:[new F({path:"CAMPAIGN_ID",operator:a.EQ,value1:Number(E)})]});}else{j.bindItems({path:N,template:K});}var P=this.getObjectModel();var Q=j.getBinding("items");if(Q){Q.attachDataReceived(function(U){if(U.getParameters().data.results.length<=1){if(U.getParameters().data.results.length>0){j.setSelectedKey(U.getParameters().data.results[0].ANONYMOUS_FOR);var V=j.getSelectedKey();P.setProperty("/AnonymousFor/0/",{"ANONYMOUS_FOR":V});}else{z.setVisible(false);j.setVisible(false);}j.setEditable(false);}else{j.setEditable(true);}if(c.CREATED_BY_ID===G||i){j.setEditable(true);}else{j.setEditable(false);}},this);}}},bindCampaignList:function(c,i){var e=this.byId("campaignComboBox");var j,z;var E=this;if(c.CAMPAIGN_ID&&!i){j=new L({key:"{object>ID}",text:"{object>SHORT_NAME}"});z="object>/ReassignCampaigns";}else{j=new L({key:"{data>ID}",text:"{data>SHORT_NAME}"});z="data>/CampaignSmallIdeaAssign";}e.bindItems({path:z,template:j,sorter:new S("SHORT_NAME"),length:500});var G=e.getBinding("items");if(G){G.attachDataReceived(function(){E.checkCampaignAllowtoAssign(c.CAMPAIGN_ID);},this);}},initRTE:function(P){var e=this;if(!D.system.desktop){return;}this.destroyRTE();var E=(P&&P.nodes.Root.attributes)?P.nodes.Root.attributes.DESCRIPTION.changeable:true;var i=this.byId("rteContainer");var j;e._TextControlID="richtextControl_"+new Date().getTime();if(E){jQuery.sap.require("sap.ino.controls.RichTextEditor");j=new sap.ino.controls.RichTextEditor({id:this.createId(e._TextControlID),width:"100%",editable:true,editorType:"TinyMCE4",height:"300px",showGroupInsert:true,showGroupLink:true,showGroupFont:true,beforeEditorInit:function(c){c.mParameters.configuration.plugins=c.mParameters.configuration.plugins.replace("image,","");c.mParameters.configuration.link_context_toolbar=true;c.mParameters.configuration.plugins=c.mParameters.configuration.plugins.replace("powerpaste","powerpaste,imagetools");c.mParameters.configuration.paste_data_images=true;c.mParameters.configuration.automatic_uploads=true;c.mParameters.configuration.powerpaste_word_import="clean";c.mParameters.configuration.powerpaste_html_import="clean";c.mParameters.configuration.default_link_target="_blank";c.mParameters.configuration.images_upload_handler=function(z,G,K){var N=z.blob();if(N){A.uploadFile(N).done(function(O){var Q=e.getObjectModel();G(C.getAttachmentDownloadURL(O.attachmentId));Q.setProperty("/DESCRIPTION",jQuery.sap._sanitizeHTML(window.tinymce.activeEditor.getContent()));}).fail(function(){K();M.show(e.getText("IDEA_OBJECT_MSG_TITLE_IMAGE_CROP_FAILED"));});}};c.mParameters.configuration.paste_postprocess=function(z,G){window.tinymce.activeEditor.uploadImages();};}});j.attachReady(function onRTEReady(){this.bindProperty("value",{model:"object",path:"DESCRIPTION"});e._onResize();if(!this._sResizeRegId){this._sResizeRegId=R.register(e.getView(),e._onResize);}});j.onAfterRendering=function(){sap.ino.controls.RichTextEditor.prototype.onAfterRendering.apply(this);e.byId("NAME").focus();jQuery("#"+e.byId('objectpage').getId()+"-opwrapper").animate({scrollTop:0},100);};}else{j=new H({id:this.createId(e._TextControlID),sanitizeContent:true,preferDOM:false,content:{model:"object",path:"DESCRIPTION",formatter:this.formatter.wrapHTML}});}setTimeout(function(){i.destroyItems();i.addItem(j);},500);},destroyRTE:function(){if(this._sResizeRegId){R.deregister(this._sResizeRegId);}var c=this.getRTE();if(c){c.destroy();}},getRTE:function(){return this.byId(this._TextControlID);},_onResize:function(e){var V;var i;var O;if(e){V=e.control;i=e.size.height;O=e.oldSize.height;}else{V=this.getView();i=V.$().height();O=0;}var c=V.getController().getRTE();if(!c||c.getMetadata().getName()!=="sap.ino.controls.RichTextEditor"){return;}if(Math.abs(i-O)>0){var j=V.$().find(".sapInoIdeaModify");var z=parseInt(j.css("min-height"),10)||400;var E=parseInt(j.css("max-height"),10)||1000;i=i-600;i=i<z?z:i;i=i>E?E:i;c.setHeight(i+"px");setTimeout(function(){var G=V.$().find(".mce-tinymce.mce-container");var K=G.css("height");var N=parseFloat(G.css("border-width"),10);if(N){K=(parseFloat(K,10)+(2*N))+"px";}var P=V.getController().byId("similarIdeas");P.setHeight(K);},0);}},onCampaignPressed:function(e){var i=this.getObjectModel().getProperty("/CAMPAIGN_ID");this.navigateTo("campaign",{id:i},true);},onTagChanged:function(e){var c=e.getSource();var V=e.getParameter("value");if(!V){return;}if(!e.getSource().getAggregation("tokenizer")){return;}var i=e.getSource().getAggregation("tokenizer").getAggregation("tokens");var j=V.split(",");j.forEach(function(z){z=z.trim();if(z===""){return;}var E=new T({text:z});var G;i.forEach(function(E){if(E.getProperty("text")===z){G=true;return;}});if(!G){E.bApplicationCreated=true;c.addToken(E);}});c.setValue("");},onTagTokenChanged:function(e){var c=e.getSource();if(!e.getSource().getAggregation("tokenizer")){return;}c.setValue("");},getLinkDialog:function(){if(!this._oLinkDialog){this._oLinkDialog=this.createFragment("sap.ino.vc.idea.fragments.Link",this.getView().getId());this.getView().addDependent(this._oLinkDialog);this._oLinkDialog.setInitialFocus(this.createId("URLInput"));}return this._oLinkDialog;},onAddLinkDialogCancel:function(e){this.resetClientMessages();this._oLinkDialog.close();},onAddLink:function(e){var c=this.getLinkDialog();c.setModel(new J({URL:"",LABEL:""}),"link");c.bindElement({path:"link>/"});this.resetClientMessages();c.open();},onAddLinkDialogOK:function(e){var c=this.getLinkDialog();var i=c.getModel("link");var j=i.getProperty("/ID");var U=i.getProperty("/URL");var z=i.getProperty("/LABEL");this.resetClientMessages();var E=this.getObjectModel().modifyLink(j,U,z);if(E){this.setClientMessage(E,this.byId("URLInput"));}else{c.close();}},onEditLink:function(e){var c=this.getLinkDialog();var i=e.getSource().getBindingContext("object");var j=this.getObjectModel().getProperty(i.sPath+"/ID");var U=this.getObjectModel().getProperty(i.sPath+"/URL");var z=this.getObjectModel().getProperty(i.sPath+"/LABEL");this.resetClientMessages();c.setModel(new J({ID:j,URL:U,LABEL:z}),"link");c.bindElement({path:"link>/"});c.open();},onDeleteLink:function(e){var O=this.getObjectModel();var c=e.getSource().getBindingContext("object").getObject();O.removeChild(c);},crop:function(){var c=this;var e=jQuery.Deferred();var i=this.byId("imageCropping");var j=i.crop();if(j){var z=this.getObjectModel().getData().TITLE_IMAGE_ID;A.uploadFile(j,null,z,true).done(function(E){if(E.attachmentId){var O=c.getObjectModel();O.setTitleImage({"ATTACHMENT_ID":E.attachmentId,"FILE_NAME":E.fileName,"MEDIA_TYPE":E.mediaType});}e.resolve({messages:[{"TYPE":"I","MESSAGE":"IDEA_OBJECT_MSG_TITLE_IMAGE_CROP","MESSAGE_TEXT":c.getText("IDEA_OBJECT_MSG_TITLE_IMAGE_CROP"),"REF_FIELD":""}]});}).fail(function(){M.show(c.getText("IDEA_OBJECT_MSG_TITLE_IMAGE_CROP_FAILED"));e.reject();});}else{e.resolve();}return e.promise();},checkContributionShare:function(){if(!this._checkContributionEnable()){return true;}var c=this.getObjectModel().getProperty("/ContributionShare");if(!c||c.length===0){return true;}var e=0;jQuery.each(c,function(i,j){e+=j.PERCENTAGE;});return e===100;},addAuthorToContributionShare:function(){if(!this._checkContributionEnable()){return;}var i=this.getObjectModel();var c=C.getCurrentUser();var e=i.getProperty("/ContributionShare");var j=i.isNew()?c.USER_ID:i.getProperty("/CREATED_BY_ID");var z=i.isNew()?c.NAME:i.getProperty("/CREATED_BY_NAME");if(!e||e.length===0){i.addChild({AUTHOR_ID:j,AUTHOR_NAME:z,PERCENTAGE:100.00},"ContributionShare");}},formatterContributionShare:function(){var i=this.getObjectModel();var c=i.getProperty("/ContributionShare");jQuery.each(c,function(e,j){if(j.PERCENTAGE>0){i.setProperty("/ContributionShare/"+e+"/PERCENTAGE",parseInt(j.PERCENTAGE,10));}else{i.setProperty("/ContributionShare/"+e+"/PERCENTAGE",0);}});},checkCampaignAllowtoAssign:function(c){var e=String(c);var i=this.byId("campaignComboBox");var j=this;if(c&&!i.getItemByKey(e)){j.setClientMessage(new g({code:"IDEA_OBJECT_MSG_CAMPAIGN_NOT_ALLOWED",type:f.Error}),j.byId("campaignComboBox"));i.setSelectedItemId();}},syncAuthorToContributionShareBinding:function(){if(!!arguments&&arguments.length>0&&!!arguments[0].getParameters()&&arguments[0].getParameters().hasOwnProperty("url")&&/xsodata\/CampaignSmall\(\d+\)$/i.test(arguments[0].getParameters().url)){this.syncAuthorToContributionShare();var i=this.getModel("data");i.detachRequestCompleted(this.syncAuthorToContributionShareBinding,this);}},syncAuthorToContributionShare:function(){var i=this.getObjectModel();var c=C.getCurrentUser();var e=i.getProperty("/ContributionShare");var j=i.getProperty("/Contributors");if(this._checkContributionEnable()){jQuery.each(j,function(G,K){if(jQuery.grep(e,function(N){return N.AUTHOR_ID===K.IDENTITY_ID;}).length===0){i.addChild({AUTHOR_ID:K.IDENTITY_ID,AUTHOR_NAME:K.NAME},"ContributionShare");}});e=i.getProperty("/ContributionShare");var z=i.isNew()?c.USER_ID:i.getProperty("/CREATED_BY_ID");var E=i.isNew()?c.NAME:i.getProperty("/CREATED_BY_NAME");for(var G=e.length-1;G>=0;--G){if(e[G].AUTHOR_ID!==z&&jQuery.grep(j,function(K){return K.IDENTITY_ID===e[G].AUTHOR_ID;}).length===0){if(e[G].ID<0){e.splice(G,1);}}}e=i.getProperty("/ContributionShare");if(jQuery.grep(e,function(K){return z===K.AUTHOR_ID;}).length===0){i.addChild({AUTHOR_ID:z,AUTHOR_NAME:E,PERCENTAGE:e.length>1?0.00:100.00},"ContributionShare");}}},clearIdeaFormDisplayOnlyFields:function(){var i=this.getObjectModel();var c=i.getProperty("/FieldsValue");var e=[];jQuery.each(c,function(j,z){if(!z.IS_DISPLAY_ONLY){e.push(z);}});if(e.length>0){i.setProperty("/FieldsValue",e);}},onSave:function(){var c=this;c.resetClientMessages();c.addAuthorToContributionShare();c.formatterContributionShare();if(!c.checkContributionShare()){M.show(c.getText("MSG_REWARD_CONTRIBUTION_SHARE_SUM_ERROR"));return;}var i;var e=function(){c.crop().done(function(G){c._CheckContentAttachments(c.getObjectModel());if(c.byId("RespList").getVisible()&&c.getObjectModel().getProperty("/SUBMITTED_AT")){if(!c.getObjectModel().getProperty("/RESP_VALUE_NAME")){c.setClientMessage(new g({code:"IDEA_OBJECT_MSG_RESP_LIST_VALUE_EMPTY_SAVE",type:f.Error}),c.byId("RespList"));}else{c.setRespValueChangeMsg.call(c);}}if(c.getObjectModel().getProperty("/SUBMITTED_AT")){jQuery.each(c.aComboBoxes,function(P,Q){if(Q instanceof sap.m.ComboBox&&!Q.getItemByText(Q.getValue())){Q.fireChange();}});jQuery.each(c.aCheckBoxes,function(P,Q){Q.fireSelect();});}var K=c.getObjectModel().isNew();var N,O;O=c.getObjectModel();if(!O.getUserChanges().RESP_VALUE_CODE){i=null;}if(i){N=c.executeObjectAction("modifyAndAutoAssignCoach",{parameters:{DEFAULT_COACH:i}});}else{N=c.executeObjectAction("modify");}N.done(function(P){var z=c.getObjectModel();if(!c.getObjectModel().oData.CAMPAIGN_ID){z.setProperty("/RESP_LIST_VISIBLE",false);}c._refreshWallList();c.navigateTo("idea-display",{id:z.getKey()},true);if(G){z.getMessageParser().parse(G);}});});};var j=function(){if(c.getObjectModel().delVotesSimulate()){h.confirm(c.getText("OBJECT_MSG_VOTES_DELETE_CONFIRMATION"),{onClose:function(G){if(G===h.Action.OK){e();}}});}else{e();}};var z=c.getObjectModel();var E=z.getProperty("/Coach");i=c.defaultAutoAssignCoach(c,z);if(z.getProperty("/SUBMITTED_AT")&&E&&E.length>0&&i&&z.getUserChanges().RESP_VALUE_CODE){h.confirm(c.getText("IDEA_OBJECT_MSG_CONFIRM_COACH_CHG"),{icon:h.Icon.WARNING,actions:[h.Action.YES,h.Action.NO],onClose:function(G){if(G===h.Action.NO){i=null;}j();}});}else{if(!z.getProperty("/SUBMITTED_AT")){i=null;}j();}},defaultAutoAssignCoach:function(c,i){var e=i.getProperty("/Resp_Value");var j=i.getProperty("/RESP_VALUE_CODE");var z=i.getProperty("/AUTO_ASSIGN_RL_COACH");var E;if(!e&&i.getProperty("/STATUS")==="sap.ino.config.DRAFT"){E=i.getProperty("/DEFAULT_COACH");}else{if(z&&j&&e){jQuery.each(e,function(G,K){if(K.CODE===j){E=K.DEFAULT_COACH;return false;}});}}return E;},matchTemplate:function(){var i=this.getObjectModel();var c=i.getProperty("/DESCRIPTION");var e=i.getProperty("/IDEA_DESCRIPTION_TEMPLATE")||"";var j="<p>"+e+"</p>";return e!==""&&(c===e||c===j);},onSubmit:function(){var c=this;c.resetClientMessages();c.addAuthorToContributionShare();c.formatterContributionShare();jQuery.each(c.aComboBoxes,function(j,z){if(z instanceof sap.m.ComboBox&&!z.getItemByText(z.getValue())){z.fireChange();}});jQuery.each(c.aCheckBoxes,function(j,z){z.fireSelect();});if(!c.checkContributionShare()){M.show(c.getText("MSG_REWARD_CONTRIBUTION_SHARE_SUM_ERROR"));return;}var i=c.getObjectModel();var e=c.defaultAutoAssignCoach(c,i);this.crop().done(function(j){c._CheckContentAttachments(i);if(!c.getObjectModel().getProperty("/CAMPAIGN_ID")){c.setClientMessage(new g({code:"IDEA_OBJECT_MSG_CAMPAIGN_EMPTY_SUBMIT",type:f.Error}),c.byId("campaignComboBox"));}if(c.byId("RespList").getVisible()){if(!c.getObjectModel().getProperty("/RESP_VALUE_NAME")){c.setClientMessage(new g({code:"IDEA_OBJECT_MSG_RESP_LIST_VALUE_EMPTY_SUBMIT",type:f.Error}),c.byId("RespList"));}else{c.setRespValueChangeMsg.call(c);}}if(c.matchTemplate()){c.setClientMessage(new g({code:"IDEA_OBJECT_MSG_TEMPLATE_NOT_CHANGE",type:f.Error}),c.getRTE());}var z=c.executeObjectAction("modifyAndSubmit",{messages:{confirm:"IDEA_OBJECT_MSG_SUBMIT_CONFIRM",success:function(){return c.getText("IDEA_OBJECT_MSG_SUBMIT_OK",i.getProperty("/NAME"));}},parameters:{CAMPAIGN_ID:i.getProperty("/CAMPAIGN_ID")}});z.done(function(E){if(E&&E.confirmationCancelled===true){c.byId("ideaSubmitBtn").focus();return;}if(e){var G=c.executeObjectActionPrototypeDirectly("autoAssignCoach",{parameters:{DEFAULT_COACH:e}});G.always(function(){c.navigateTo("idea-display",{id:i.getKey()},true);if(j){i.getMessageParser().parse(j);}});}else{c.navigateTo("idea-display",{id:i.getKey()},true);if(j){i.getMessageParser().parse(j);}}});});},onFileUploaderChange:function(e){var c=e.getSource();var i=e.getParameter("files");c.setBusy(true);A.prepareFileUploader(c,i);},onFileUploaderComplete:function(e){var c=A.parseUploadResponse(e.getParameter("responseRaw"));var i=e.getSource();if(c){var O=this.getObjectModel();O.getMessageParser().parse(c);if(c.success){O.setTitleImage({"ATTACHMENT_ID":c.attachmentId,"FILE_NAME":c.fileName,"MEDIA_TYPE":c.mediaType});}else{M.show(this.getText("IDEA_OBJECT_MSG_TITLE_IMAGE_FAILED"));}}else{M.show(this.getText("IDEA_OBJECT_MSG_TITLE_IMAGE_ERROR"));}i.setBusy(false);i.clear();},onFileTypeMissMatch:function(e){M.show(this.getText("IDEA_OBJECT_MSG_TITLE_IMAGE_TYPE_MISS_MATCH"));},onTitleImageClear:function(e){var O=this.getObjectModel();O.clearTitleImage();},onTitleImageCrop:function(e){this.crop();},_refreshWallList:function(){this.getView().byId("wallsection").invalidate();},onTitleChange:function(e){this.bindSimilarIdeas();},getIdeaDisplayLink:function(i){return this.getNavigationLink("idea-display",{id:i});},formatSimilarIdeaName:function(c,e){if(e==="sap.ino.config.DRAFT"){return"["+this.getText("IDEA_OBJECT_FIELD_SIMILAR_IDEAS_DRAFT")+"]"+c;}else{return c;}},getEditorContentLive:function(){var c=this.getRTE();if(!c){return"";}if(c.getContent){return c.getContent();}try{if(c&&c.getNativeApi()&&(c.getNativeApi().getDoc()||c.getNativeApi().bodyElement)){return c&&c.getNativeApi()&&c.getNativeApi().getContent();}else{return"";}}catch(e){jQuery.sap.log.error("Editor content could not be retrieved: "+e.toString(),"","sap.ino.vc.idea.Modify.controller.js");}},onAfterShow:function(){this._dViewShown.resolve();},onBeforeHide:function(){jQuery.sap.clearIntervalCall(this._sRefreshSimilarIdeasTimer);this._sRefreshSimilarIdeasTimer=null;},onAfterHide:function(){this._dViewShown=jQuery.Deferred();this.destroyRTE();},expandSimilarIdeasOnInit:function(){if(!D.system.desktop){return;}var c=this.byId("similarIdeas");var i=this.getObjectModel();var e=i&&i.getProperty("/STATUS_CODE");var P=i&&i.getProperty("/STEP");var j=C.getPersonalize().SIMILAR_IDEA;if(i.isNew()){this.getView().setModel(new J({}),"similarIdeas");this._setInterval4SimilarIdeas();if(j){this.onShowSimilarIdeas();}}else if(c&&((e==='sap.ino.config.NEW_IN_PHASE'&&P===0)||e==='sap.ino.config.DRAFT')){this.bindSimilarIdeas();this._setInterval4SimilarIdeas();if(j){this.onShowSimilarIdeas();}}else{this.onToggleSimilarIdeas(undefined,true);}},getAvaliableWidth:function(){return this.getView().$().find(".sapInfoIdeaName").width();},onShowSimilarIdeas:function(){var c=this.getView().byId("similarIdeas");var e=c.hasStyleClass('sapInoIdeaSimilarIdeasExpanded');if(!e){c.addStyleClass("sapInoIdeaSimilarIdeasExpanded");}},bindSimilarIdeas:function(){var c=this;var i=this.getObjectModel();this._oSimilarModel=new J();var e=i.getProperty("/ID");var P={name:i.getProperty("/NAME"),description:this.getEditorContentLive(),campId:i.getProperty("/CAMPAIGN_ID"),filterDraft:true,limit:12};if(i&&i.getProperty("/Tags")&&i.getProperty("/Tags").length>0){var j=[];i.getProperty("/Tags").forEach(function(z){j.push(z.NAME);});P.tags=JSON.stringify(j);}if(C.getRelatedIdeasByTextURL(e)){this._oSimilarModel.loadData(C.getRelatedIdeasByTextURL(e),P,true,"POST");this._oSimilarModel.attachRequestCompleted(null,function(){var z=c.groupByCampaignId(c._oSimilarModel.getData(),i.oData.CAMPAIGN_ID,i.oData.CAMPAIGN_NAME);c._oSimilarModel.setData({"similarIdeasData":z},false);this.getView().setModel(this._oSimilarModel,"similarIdeas");},this);}},isDescriptionChanged:function(N){if(N===null||N===undefined){return false;}return(this._sDescriptionText===undefined&&N.length>0)||(this._sDescriptionText!==undefined&&this._sDescriptionText!==N);},isTitleChanged:function(N){if(N===null||N===undefined){return false;}return(this._sTitleText===undefined&&N.length>0)||(this._sTitleText!==undefined&&this._sTitleText!==N);},isTagsChanged:function(N){return $(this._aTags).not(N).length!==0||$(N).not(this._aTags).length!==0;},refreshSimilarIdeas:function(){var N=this.getObjectModel().getProperty("/NAME");var c=this.getEditorContentLive();var e=this.getObjectModel().getProperty("/Tags");if(this.isDescriptionChanged(c)||this.isTitleChanged(N)||this.isTagsChanged(e)){this.bindSimilarIdeas();this._sTitleText=N;this._sDescriptionText=c;this._aTags=e;}},onToggleSimilarIdeas:function(e,c){var i=this.getView().byId("similarIdeas");if(c||i.hasStyleClass('sapInoIdeaSimilarIdeasExpanded')){i.removeStyleClass("sapInoIdeaSimilarIdeasExpanded");if(this._sRefreshSimilarIdeasTimer){jQuery.sap.clearIntervalCall(this._sRefreshSimilarIdeasTimer);this._sRefreshSimilarIdeasTimer=null;}}else{i.addStyleClass("sapInoIdeaSimilarIdeasExpanded");this.bindSimilarIdeas();this._setInterval4SimilarIdeas();}},onRespListHint:function(e){var c=this._getRespListHintDialog();var i=this.getObjectModel();var j=i.getProperty("/RESP_VALUE_CODE");c.bindElement({path:"data>/RespValues('"+j+"')/"});c.open();},onRespListHintDialogClose:function(){var c=this._getRespListHintDialog();c.close();},_getRespListHintDialog:function(){var c=this._oRespListHintDialog;if(!c){c=this.createFragment("sap.ino.vc.idea.fragments.ResponsibilityDetail",this.getView().getId());this.getView().addDependent(c);this._oRespListHintDialog=c;this._oRespListHintDialog.setInitialFocus(this.createId("TagToken"));}return c;},_setInterval4SimilarIdeas:function(){if(!this._sRefreshSimilarIdeasTimer){this._sRefreshSimilarIdeasTimer=jQuery.sap.intervalCall(5000,this,this.refreshSimilarIdeas);}},contributionShareFormatter:function(c,e){if(!e||!c||c.length<=1){return false;}return true;},_checkContributionReadOnly:function(){return this.getObjectModel().getProperty("/CONTRIBUTION_READ_ONLY");},_checkContributionEnable:function(){return this.getObjectModel().getProperty("/REWARD_ACTIVE");},_CheckContentAttachments:function(c){var e=c.getProperty("/DESCRIPTION"),z=[],N=[],O=c.getProperty("/ContentAttachments");if(!e){return;}var E=new RegExp("<img.*attachment_download\.xsjs/(\\d+)\"","g"),G;do{G=E.exec(e);if(G&&G.length===2){z.push(G[1]);}}while(G!==null);var K=false,P=void 0;for(var i=0;i<=z.length-1;i++){K=false;P=undefined;for(var j=0;j<=O.length-1;j++){if(Number(z[i])===O[j].ATTACHMENT_ID){K=true;P=O[j];break;}}if(K){N.push(P);}else{N.push({ID:c.getNextHandle(),ATTACHMENT_ID:Number(z[i])});}}c.setProperty("/ContentAttachments",N);},resetPendingChanges:function(){B.prototype.resetPendingChanges.apply(this,arguments);}}));});
