sap.ui.define(["sap/ino/vc/commons/BaseObjectController","sap/ui/model/json/JSONModel","sap/ino/commons/application/Configuration","sap/ino/commons/models/object/User","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/Device","sap/ui/core/ListItem","sap/m/MessageToast","sap/m/MessageBox","sap/ino/vc/idea/mixins/AddExpertFromClipboardMixin"],function(B,J,C,U,F,a,D,L,M,b,A){"use strict";return B.extend("sap.ino.vc.idea.Experts",jQuery.extend({},A,{view:{IDEACARD_SECTION_VISIBLE:'STAT',CLIPBOARD_ITEM_SELECT_COUNTER:0,IS_EVALUATION_REQUEST:false},aSelectedExperts:[],onInit:function(){B.prototype.onInit.apply(this,arguments);this.getView().setModel(new J(this.view),"view");},onBeforeRendering:function(){var t=this;var v=this.getView();var i;if(this.getObjectModel()&&this.getObjectModel().getData().hasOwnProperty("IDEA_ID")){this.setViewProperty("/IS_EVALUATION_REQUEST",true);i=this.getObjectModel()&&this.getObjectModel().getData().IDEA_ID;}else{this.setViewProperty("/IS_EVALUATION_REQUEST",false);i=this.getObjectModel()&&this.getObjectModel().getKey();}if(!this._iIdeaId||this._iIdeaId!==i){this._iIdeaId=i;var p=new J(C.getIdeaExpertsByIdeaURL(i));v.setModel(p,"proposedExperts");}if(!this.getViewProperty("/IS_EVALUATION_REQUEST")){this.getObjectModel().read("/Experts",{success:function(){var o=t.byId("ideaExperts").getBindingInfo("content");t.byId("ideaExperts").unbindAggregation("content");t.byId("ideaExperts").bindAggregation("content",o);}});}},onExpertExpand:function(e){var i=e.getSource().getParent();i.toggleStyleClass("sapInoIdeaExpertItemSelected");},onOpenIdea:function(e){if(D.system.phone){this.getView().getParent().close();}var c=e.getSource().getBindingContext("proposedExperts");var i=c.getProperty("IDEA/ID");if(i){this.navigateTo("idea-display",{id:i});}},onSuggestIdeaExpert:function(e){var c=e.getSource();var v=e.getParameter("suggestValue");var t=new L({text:"{data>NAME}",additionalText:"{data>USER_NAME}",key:"{data>ID}"});var s="/SearchIdentity(searchToken='"+jQuery.sap.encodeURL(v)+"')/Results";var f=this._getSuggestExpertFilter();if(D.system.desktop){c.bindAggregation("suggestionItems",{path:"data>"+s,template:t,filters:f,parameters:{select:"searchToken,ID,NAME,USER_NAME"}});}else{c._bBindingUpdated=true;c.getModel("data").read(s,{filters:f,success:function(d){c.removeAllSuggestionItems();for(var i=0;i<d.results.length-1;i++){c.addAggregation("suggestionItems",new L({key:d.results[i].ID,text:d.results[i].NAME,additionalText:d.results[i].USER_NAME}),true);}if(d.results.length>0){c.addSuggestionItem(new L({key:d.results[d.results.length-1].ID,text:d.results[d.results.length-1].NAME,additionalText:d.results[d.results.length-1].USER_NAME}));}}});}this.aSelectedExperts=[];},_getSuggestExpertFilter:function(){var f=[];var c=this.getObjectModel().getProperty("/SubmitterContributorsCoach");jQuery.each(c,function(i,o){if(o.ROLE_CODE==="IDEA_SUBMITTER"||o.ROLE_CODE==="IDEA_CONTRIBUTOR"){var d=new F({path:"ID",operator:a.NE,value1:o.IDENTITY_ID});f.push(d);}});return(f.length===0)?[]:[new F(f,true)];},onAddInputExpert:function(e){var i=this.byId("suggestUser");var s=e.getParameters().selectedItem;if(!s){var r=jQuery.grep(i.getSuggestionItems(),function(S){return S.getText()===i.getValue();});if(r.length>0){s=r[0];}}if(s){var E=s&&parseInt(s.getKey(),10);this.openAddExpertDialog(E);}i.setValue("");i.focus();},onAddInputExpertForDialog:function(e){var s=e.getParameters().selectedItem;if(s){var E=s&&parseInt(s.getKey(),10);var c=s.getText();var d=[{IDENTITY_ID:E,NAME:c}];this._addExpert(d,c);}},getAddExpertDialog:function(){if(!this._oAddExpertDialog){this._oAddExpertDialog=this.createFragment("sap.ino.vc.idea.fragments.AddExpert");this.getView().addDependent(this._oAddExpertDialog);}return this._oAddExpertDialog;},openAddExpertDialog:function(e){var E="data>/Identity("+e+")";var d=this.getAddExpertDialog();d.bindElement({path:E});d.open();},onAddExpertDialogOK:function(){var c=this.getAddExpertDialog().getBindingContext("data");var e=c.getProperty("ID");var E=[{IDENTITY_ID:e}];this._addExpert(E,c.getProperty("NAME"));var d=this.getAddExpertDialog();d.close();},onAddExpertDialogCancel:function(){var d=this.getAddExpertDialog();d.close();},onAddRemoveExpert:function(e){var s=e.getParameter("action");var E=e.getParameter("identityId");var c=e.getParameter("userName");var d=[{IDENTITY_ID:E}];switch(s){case"add":this.openAddExpertDialog(E);break;case"remove":this._removeExpert(d,c);break;default:break;}},onAddRemoveExpertForDialog:function(e){var s=e.getParameter("action");var E=e.getParameter("identityId");var c=e.getParameter("userName");var d=[{IDENTITY_ID:E,NAME:c}];switch(s){case"add":this._addExpert(d);break;case"remove":this._removeExpert(d);break;default:break;}},onTokenDelete:function(e){var t=e.getSource();var E=Number(t.getKey());var c=[{IDENTITY_ID:E}];this._removeExpert(c);},isExpertActionable:function(e,p,i){p=p||this.getObjectModel().getProperty("/property/nodes/Root/customProperties/backofficeChangeExpertPrivilege");i=i||this.getObjectModel().getProperty("/Experts");var c=this.getObjectModel().getProperty("/SubmitterContributorsCoach");return!!(p&&i&&jQuery.isArray(i)&&jQuery.grep(i,function(o){return o.IDENTITY_ID===e;}).length===0&&jQuery.grep(c,function(o){return(o.ROLE_CODE==="IDEA_SUBMITTER"||o.ROLE_CODE==="IDEA_CONTRIBUTOR")&&o.IDENTITY_ID===e;}).length===0);},isExpertAddedForDialog:function(e,E){E=E||this.getObjectModel().getProperty("/Experts")||[];return!!(jQuery.isArray(E)&&jQuery.grep(E,function(o){return o.IDENTITY_ID===e;}).length===0);},respExpertsFormatter:function(t,v){return jQuery.sap.formatMessage(t,v||"");},}));});
