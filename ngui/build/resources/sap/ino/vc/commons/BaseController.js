sap.ui.define(["sap/ino/commons/formatters/BaseFormatter","sap/ui/core/mvc/Controller","sap/ui/core/message/ControlMessageProcessor","sap/m/InputBase","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","sap/ui/core/UIComponent","sap/ui/Device","sap/ino/commons/application/Configuration","sap/ui/core/ListItem","sap/m/MessageToast","sap/m/MessageBox","sap/ui/core/MessageType","sap/m/MultiInput","sap/ino/commons/util/UIObjectConfig","sap/m/Select","sap/ino/commons/util/SmartControl","sap/ui/core/ResizeHandler","sap/m/ComboBox","sap/ino/commons/models/aof/MetaModel"],function(B,C,a,I,J,R,U,D,b,L,M,c,d,e,f,S,g,h,j,k){k.getBackendAllMetadata();return C.extend("sap.ino.vc.commons.BaseController",{formatter:B,aBusyControls:[],onInit:function(){sap.ui.getCore().getMessageManager().registerObject(this.getView(),true);this._previousClientMessages=[];this._controlMessageProcessor=new a();if(C.prototype.onInit){C.prototype.onInit.apply(this,arguments);}if(this._onInit){this._onInit();}if(!this.getModel("view")){this.setModel(new J({Layouts:{SimpleFormLayout:{labelSpanL:12,labelSpanM:12,emptySpanL:1,emptySpanM:1,breakpointL:1024,breakpointM:600,layout:"ResponsiveGridLayout"}}}),"view");}this.setObjectExists(true);if(this.getOwnerComponent()){this.setModel(this.getOwnerComponent().getModel("component"),"component");}var o=this.getView().data();if(!o.aofSmartControl&&this.getView().getContent()){o=this.getView().getContent()[0].data();}if(o.aofSmartControl){g.bindAll(this,this.getView());}},onAfterRendering:function(){var p=b.getPersonalize();if(p&&p.SCREEN_SIZE){this.setFullScreen(p.SCREEN_SIZE);}},onExit:function(){if(this._onExit){this._onExit();}var v=this.getModel("view");if(v){v.destroy();}if(C.prototype.onExit){C.prototype.onExit.apply(this,arguments);}},destroy:function(){C.prototype.destroy.apply(this.arguments);},getCurrentRoute:function(){return this.getOwnerComponent().getCurrentRoute();},getBusyControls:function(){return this.aBusyControls;},getDensityClass:function(){if(jQuery("body").hasClass("sapUiSizeCozy")){return"sapUiSizeCozy";}else{return"sapUiSizeCompact";}},createView:function(v){var V;this.getOwnerComponent().runAsOwner(function(){V=sap.ui.view(v);});return V;},getLocalElementId:function(E){var i=E.getId();var l=i.split("--");return l[l.length-1];},createFragment:function(F,s){var o=this;var i;this.getOwnerComponent().runAsOwner(function(){if(!s){i=sap.ui.xmlfragment(o.getView().getId(),F,o);}else{i=sap.ui.xmlfragment(s,F,o);}o.onFragmentCreated(F,i);});return i;},getFragment:function(F,s){if(!this._mFragmentCache){this._mFragmentCache={};}if(!this._mFragmentCache[F]){this._mFragmentCache[F]=this.createFragment(F,s);}return this._mFragmentCache[F];},onFragmentCreated:function(F,o){if(jQuery.type(o)==="object"&&o.data("aofSmartControl")){g.bindAll(this,o);}},setViewData:function(v,m){this.getModel("view").setData(v,m);},setViewProperty:function(p,v){return this.getModel("view").setProperty(p,v);},getViewProperty:function(p){return this.getModel("view").getProperty(p);},setObjectExists:function(o){this.setViewProperty("/objectExists",o);},getObjectExists:function(){return this.getViewProperty("/objectExists");},onNavBack:function(){this.getOwnerComponent().getRouter().onNavBack();},onDeleteNavBack:function(o,r){this.getOwnerComponent().getRouter().onDeleteNavBack(o,r);},navigateBack:function(){this.onNavBack();},navigateTo:function(t,o,r,n){this.getOwnerComponent().navigateTo(t,o,r,n);},navigateToWall:function(t,o,r,n){t=(t==="wall"&&D.system.phone)?"wallremote":t;this.getOwnerComponent().navigateTo(t,o,r,n);},navigateToExternal:function(t,o){this.getOwnerComponent().navigateToExternal(t,o);},navigateToByURL:function(u){this.getOwnerComponent().navigateToByURL(u);},navigateToInNewWindow:function(t,o){this.getOwnerComponent().navigateToInNewWindow(t,o);},navigateToByURLInNewWindow:function(u){this.getOwnerComponent().navigateToByURLInNewWindow(u);},getRouter:function(){return U.getRouterFor(this);},getOwnerComponent:function(){if(this._oComponent){return this._oComponent;}this._oComponent=C.prototype.getOwnerComponent.apply(this,arguments);if(this._oComponent){return this._oComponent;}var v=this.getView();while(v.getParent()){v=v.getParent();this._oComponent=v.getController&&v.getController().getOwnerComponent();if(this._oComponent){break;}}return this._oComponent;},setBusy:function(i){this.getView().setBusy(i);},getBusy:function(){this.getView().getBusy();},_getTextModel:function(){if(!this._i18n){this._i18n=this.getOwnerComponent()&&this.getOwnerComponent().getModel("i18n");}return this._i18n;},getText:function(t,p){if(this._getTextModel()){return this._getTextModel().getResourceBundle().getText(t,p);}},hasOwnModel:function(m){return!!this.getView().oModels[m];},getDefaultODataModel:function(){return this.getOwnerComponent().getModel("data");},getModel:function(n){return this.getView().getModel(n);},setModel:function(m,n){return this.getView().setModel(m,n);},_onBindingChange:function(){var E=this.getView().getElementBinding();if(E&&!E.getBoundContext()){this.getOwnerComponent().getRouter().getTargets().display("notFound");}},setViewFocus:function(){var t=this;setTimeout(function(){if(!sap.ui.getCore().getCurrentFocusedControlId()){var o;if(jQuery.type(t.initialFocus)==="string"){o=t.byId(t.initialFocus);if(o&&o.$()&&o.$().is(":visible")&&jQuery.type(o.focus)==="function"){o.focus();}}else if(jQuery.type(t.initialFocus)==="array"){for(var i=0;i<t.initialFocus.length;i++){o=t.byId(t.initialFocus[i]);if(o&&o.$()&&o.$().is(":visible")&&jQuery.type(o.focus)==="function"){o.focus();break;}}}}},100);},toggleFullScreen:function(){var m=this.getOwnerComponent().getShell();m.setAppWidthLimited(!m.getAppWidthLimited());this.getModel("component").setProperty("/FULLSCREEN",!m.getAppWidthLimited());var i=this.byId('ideaLink');if(i&&m.getAppWidthLimited()){i.addStyleClass("sapInoIdeaListIdeaNameTitle");}else if(i&&!m.getAppWidthLimited()&&i.hasStyleClass("sapInoIdeaListIdeaNameTitle")){i.removeStyleClass("sapInoIdeaListIdeaNameTitle");}},setFullScreen:function(s){var m=this.getOwnerComponent().getShell();var i=this.getModel("component");m.setAppWidthLimited(!s);if(i){i.setProperty("/FULLSCREEN",!m.getAppWidthLimited());}},getFullScreen:function(){return!this.getOwnerComponent().getShell().getAppWidthLimited();},_createSuggestHandler:function(s){if(D.system.desktop){return function(E){var o=E.getSource();if(o.getMaxTokens()&&o.getMaxTokens()<=o.getTokens().length){o.removeAllSuggestionItems();return;}var t=E.getParameter("suggestValue");var l=new L({key:"{data>"+s.key+"}",text:"{data>"+s.text+"}",additionalText:s.additionalText&&"{data>"+s.additionalText+"}"});var i=s.path.replace("$suggestValue",jQuery.sap.encodeURL(t));var m=s.key+","+s.text;if(s.additionalText){m=m+","+s.additionalText;}E.getSource().bindAggregation("suggestionItems",{path:i,template:l,filters:s.filters,sorter:s.sorter,parameters:{select:m}});};}else{return function(E){var o=E.getSource();if(o.getMaxTokens()&&o.getMaxTokens()<=o.getTokens().length){o.removeAllSuggestionItems();return;}var t=E.getParameter("suggestValue");var i=s.path.replace("$suggestValue",jQuery.sap.encodeURL(t));i=i.replace("data>","");i=i.replace("object>","");var l=s.key+","+s.text;if(s.additionalText){l=l+","+s.additionalText;}o._bBindingUpdated=true;o.getModel("data").read(i,{filters:s.filters,sorter:s.sorter,success:function(m){o.removeAllSuggestionItems();for(var n=0;n<m.results.length-1;n++){o.addAggregation("suggestionItems",new L({key:m.results[n][s.key],text:m.results[n][s.text],additionalText:s.additionalText&&m.results[n][s.additionalText]}),true);}if(m.results.length>0){o.addSuggestionItem(new L({key:m.results[m.results.length-1][s.key],text:m.results[m.results.length-1][s.text],additionalText:s.additionalText&&m.results[m.results.length-1][s.additionalText]}));}}});};}},executeObjectAction:function(o,A,O){var t=this;var m=O&&O.messages||{};var p=O&&O.parameters||{};var s=O&&O.staticparameters||null;var E;function i(v,r,u){if(!v){return t.getText(r);}if(typeof v==="function"){return v(u);}else{return t.getText(v);}}function l(){if(!t._oConcurrentEditDialog){var r=t._getTextModel();t._oConcurrencyModel=o;t._sActionName=A;t._oConcurrentEditDialog=t.createFragment("sap.ino.vc.commons.fragments.ConcurrentEditDialog");t._oConcurrentEditDialog.setModel(r,'i18n');t.getView().addDependent(t._oConcurrentEditDialog);}t._oConcurrentEditDialog.open();}var n=function(){t.getView().setBusy(true);var r;if(s){r=o[A].apply(o,[s,p]);}else{r=o[A].apply(o,[p]);}r.always(function(){t.getView().setBusy(false);});r.done(function(u){var v=i(m.success,"MSG_SAVE_SUCCESS",u);if(v){M.show(v,{autoClose:false});}});r.fail(function(u){if(u){if(u.concurrencyConflict){l();}else{var v=i(m.error,"MSG_SAVE_USER_ERROR",u);if(v){M.show(v,{autoClose:false});}}}});return r;};if(m.confirm){var q=new jQuery.Deferred();c.confirm(i(m.confirm),{onClose:function(r){if(r!==c.Action.OK){q.resolve({confirmationCancelled:true});return;}else{var u=n();u.done(q.resolve);u.fail(q.reject);}}});E=q.promise();}else{E=n();}return E;},onIngoreConflict:function(){if(this._oConcurrentEditDialog){var o={};o.parameters={};o.parameters.bIgnoreConcurrencyConflict=true;this.executeObjectAction(this._sActionName,o);this._oConcurrentEditDialog.close();}this._cleanConcurrencyState();},onMergeConflict:function(){if(this._oConcurrentEditDialog){this._oConcurrencyModel.mergeConcurrentChanges();this._oConcurrentEditDialog.close();}this._cleanConcurrencyState();},showLatestVestion:function(){var o,p,K,l;o=this._oConcurrencyModel.getObjectName();var u=f.getDefinition(o);p=u.navigation.path;K=u.navigation.key;var P={};P[K]=this._oConcurrencyModel.getKey();l=this.getNavigationLink(p,P);var w=window.open(l,"_blank");w.opener=null;},onCancelConflict:function(){if(this._oConcurrentEditDialog){this._oConcurrentEditDialog.close();}this._cleanConcurrencyState();},_cleanConcurrencyState:function(){this._oConcurrentEditDialog.destroy();delete this._oConcurrencyModel;delete this._sActionName;delete this._oConcurrentEditDialog;},getNavigationLink:function(r,p){return this.getOwnerComponent().getNavigationLink(r,p);},setHelp:function(){if(!arguments||!arguments.length){return false;}var t='';for(var i=0;i<arguments.length;i++){t+=this.getText("HELP_EXP_"+arguments[i]);}var o=this.getOwnerComponent();o.setHelpContent(t);},scrollDockElement:function(p,E,i,o){var t=this;var l=0;var m=0;function s($,n){var q=parseInt($.parent().find(".sapUxAPObjectPageWrapperTransform").css("padding-top"),10);if(l===0){l=q;}q=q===0?l:q;var r=parseInt($.find(".sapUxAPObjectPageHeaderDetails").height(),10);if(m===0){m=r;}r=r===0?m:r;var O=o!==undefined?o:q;var u=i!==undefined?i:r;if($.scrollTop()>=u){n.css("position","absolute");n.css("top",($.scrollTop()+O)+"px");}else{n.css("position","relative");n.css("top",0);}}this.byId(p).addEventDelegate({onAfterRendering:function(n){var $=jQuery(n.srcControl.getDomRef()).find(".sapUxAPObjectPageWrapper");$.scroll(function(){s(jQuery(this),jQuery(t.byId(E).getDomRef()));});}});this.byId(E).addEventDelegate({onAfterRendering:function(n){var $=jQuery(t.byId(p).getDomRef()).find(".sapUxAPObjectPageWrapper");s($,jQuery(n.srcControl.getDomRef()));}});},attachListControlResized:function(l){if(l){return h.register(l,this.onListControlResize);}},detachListControlResized:function(r){if(r){h.deregister(r);}},onListControlResize:function(E){var t=E.control;var w=E.size.width;var o=E.oldSize?E.oldSize.width:-1;var T=[400,500,600,700,800,900,1000,1100,1200,1300,Infinity];var s=["sapInoListWidthXXXXS","sapInoListWidthXXXS","sapInoListWidthXXS","sapInoListWidthXS","sapInoListWidthS","sapInoListWidthM","sapInoListWidthL","sapInoListWidthXL","sapInoListWidthXXL","sapInoListWidthXXXL","sapInoListWidthXXXXL"];var O=T.reduce(function(p,m,n){if(o>=m){return n;}else{return p;}},0);var l=T.reduce(function(p,m,n){if(w>=m){return n;}else{return p;}},0);if(O!==l||o===-1||o===0){for(var i=0;i<s.length;i+=1){t.removeStyleClass(s[i]);}t.addStyleClass(s[l]);}},setClientMessage:function(m,t){this.resetClientMessages();var T=t&&t.getId()+"/value";m.setTarget(T);m.setMessage(this.getText(m.getCode()));m.processor=this._controlMessageProcessor;var i=[m];sap.ui.getCore().getMessageManager().addMessages(i);this._previousClientMessages=i;},resetClientMessages:function(t){var m=sap.ui.getCore().getMessageManager();var i=m.getMessageModel().getData();if(i.length>0){var l=jQuery.grep(this._previousClientMessages,function(o){return jQuery.grep(i,function(n){return n.id===o.id&&(!t||(t&&n.target&&n.target.indexOf(t)>-1));}).length>0;});if(l.length>0){m.removeMessages(this._previousClientMessages);this._previousClientMessages=[];}}},hasClientMessages:function(){return this._previousClientMessages&&this._previousClientMessages.length>0;},hasAnyClientErrorMessages:function(){this.enforceInputTypeValidations();var m=this.getOwnerComponent().getModel("message");var i=m.getData();if(this.hasClientMessages()){return true;}return i.reduce(function(p,o){var P=o.processor.getMetadata().getName();return p||(P==="sap.ui.core.message.ControlMessageProcessor"&&o.type===d.Error);},false);},getInputReadyControls:function(v){var V=v;if(!V){V=this.getView();}var i=V.findAggregatedObjects(true,function(o){return(!o.getVisible||o.getVisible())&&(!o.getEnabled||o.getEnabled())&&(!o.getEditable||o.getEditable())&&(o instanceof I||o instanceof S||o.getMetadata().getName()==="sap.ino.controls.MobileTextEditor"||o.getMetadata().getName()==="sap.ui.richtexteditor.RichTextEditor"||o.getMetadata().getName()==="sap.ino.controls.RichTextEditor");});return i;},resetInputTypeValidations:function(v){sap.ui.getCore().getMessageManager().removeMessages(this.getViewMessages(v));},hasMessages:function(v){var V=this.getViewMessages(v);if(V&&V.length>0){return true;}return false;},getViewMessages:function(v){var i=this.getInputReadyControls(v);var V=[];jQuery.each(i,function(l,o){if(o.fireValidationSuccess){o.fireValidationSuccess({element:o},false,true);}if(o.setValueState){o.setValueState(sap.ui.core.ValueState.None);}var m;if(o.getValue){m=o.getBinding("value");}else if(o.getSelectedKey){m=o.getBinding("selectedKey");}var n=m&&m.getDataState()&&m.getDataState().getMessages();if(n&&n.length>0){V=V.concat(n);}});return V;},enforceInputTypeValidations:function(){var t=this;var i=this.getInputReadyControls();jQuery.each(i,function(l,o){if(o.getDateValue&&o.isBound("dateValue")){o.updateModelProperty("dateValue",o.getDateValue(),o.getDateValue());}else if(o.getSelectedKey&&o.mProperties&&o.mProperties.hasOwnProperty("selectedKey")){o.updateModelProperty("selectedKey",o.getSelectedKey(),o.getSelectedKey());}else if(o._oEditor&&o._oEditor.getContent){if(o._oEditor.getBody()){o.updateModelProperty("value",o._oEditor.getContent(),o._oEditor.getContent());}}else if(o.getValue){o.updateModelProperty("value",o.getValue(),o.getValue());if(o instanceof e){if(o.getValue()){o.fireValidationError({element:o,property:"value",message:t.getText("MSG_MULTI_INPUT_INVALID_VALUE")},false,true);}else{o.fireValidationSuccess({element:o,property:"value"},false,true);}}}else{console.assert(false,"no property found to enforceInputTypeValidations of sap.ino.vc.commons.BaseObjectController");}});},getModuelModel:function(){var m=new R({bundleUrl:b.getResourceBundleURL("moduletexts")+'?t='+Date.now()});return m;},onTermsConditionsClose:function(){var t=this;var T={"TERM_CODE":this.getModel('module').getProperty("sap.ino.config.TERM_CODE"),"TERM_CHANGED_AT":this.getModel('module').getProperty('sap.ino.config.TERM_CHANGED_AT')};var i=b.getUserModel().getProperty("/data/TERMACCEPTCALLBACK");var A=function(){t.getTermsDialog().close();b.getUserModel().setProperty("/data/TERM_ACCEPTED",1);if(i){i();}};var l=function(){M.show(t.getText("USER_TERM_AND_CONDITIONS_FAILD"));};var s=b.getSystemSetting("sap.ino.config.TERMS_AND_CONDITIONS_ACTIVE");var m=b.getSystemSetting("sap.ino.config.TERMS_AND_CONDITIONS_TEXT");if(s==='1'&&m){this.setUserTermCondition(T,A,l);}else{this.getTermsDialog().close();if(i){i();}}},onTermConditionSelected:function(E){var s=E.getParameter("selected");b.getUserModel().setProperty("/data/USER_ACCEPTED",s?1:0);},getTermsDialog:function(o){if(!this._oTermsDialog){this._oTermsDialog=sap.ui.xmlfragment("sap.ino.vc.shell.fragments.TermsDialog",o);this._oTermsDialog.setModel(this._oComponent.getModel("i18n"),'i18n');this._oTermsDialog.setModel(b.getSystemSettingsModel(),'config');o.getView().addDependent(this._oTermsDialog);}return this._oTermsDialog;},setUserTermCondition:function(o,s,F){var t;if(!s){return;}if(!F){return;}t="/"+b.getSystemSetting("sap.ino.config.URL_PATH_XS_TERM_ACCEPT");jQuery.ajax({url:b.getBackendRootURL()+t,headers:{"X-CSRF-Token":b.getXSRFToken()},method:"POST",cache:false,data:JSON.stringify(o),success:s,error:F});},checkObjectExists:function(o,n){var t=this;t.setBusy(true);jQuery.ajax({url:b.getBackendRootURL()+"/sap/ino/xs/rest/community/objectCheck.xsjs",headers:{"X-CSRF-Token":b.getXSRFToken()},method:"POST",cache:false,data:JSON.stringify({"ObjectName":o,"ID":n}),success:function(r){t.setBusy(false);if(!r){t.setViewProperty("/insufficientObjectExists",{EXISTS:false});return;}t.setViewProperty("/insufficientObjectExists",{EXISTS:true,ID:r.ID,REF_ID:r.REF_ID,REF_NAME:r.REF_NAME,OBJECT_NAME:o});},error:function(){t.setBusy(false);t.setViewProperty("/insufficientObjectExists",{EXISTS:false});}});}});});
