sap.ui.define(["sap/ino/commons/application/Configuration","sap/ui/core/format/DateFormat","sap/m/MessageToast","sap/ui/core/BusyIndicator","sap/ino/vc/idea/mixins/IdeaFormCriteriaFilterMixin"],function(C,D,M,B){"use strict";var E=function(){throw"Mixin may not be instantiated directly";};var a=function(f,e){var t=this;var p=this._getExportParam(f,e);if(!p){B.hide();return;}jQuery.ajax({url:C.getBackendRootURL()+"/sap/ino/xs/rest/common/export_idea.xsjs",data:p,beforeSend:function(){t.setBusy(true);},success:function(r,s,x){t.setBusy(false);B.hide();M.show(t.getText(r.messageKey));},error:function(r,s,x){t.setBusy(false);B.hide();M.show(t.getText(r.responseJSON.messageKey));}});};E.onListExport=function(e){if(!this._oExportActionSheet){this._oExportActionSheet=this.createFragment("sap.ino.vc.commons.fragments.ExportActionSheet",this.getView().getId());this.getView().addDependent(this._oExportActionSheet);}if(e.getSource().data("placement")){this._oExportActionSheet.setPlacement(e.getSource().data("placement"));}this._oExportActionSheet.triggerButton=e.getSource();this._oExportActionSheet.openBy(e.getSource());};E.onListExportXLS=function(e){var t=this,l={xls:2000};if(!t._checkExportCount("xls",l)){M.show(t.getText("EXPORT_XLS_LIMIT_COUNT_MSG",l.xls));return;}B.show(0);setTimeout(function(){sap.ui.require(["sap/ino/commons/util/Export"],function(b){b.i18n=t.getModel("i18n");var o=typeof t.getExportControl==="function"?t.getExportControl():t.getList();var c=typeof t.fnCompleted==="function"?t.fnCompleted:null;if(t._IsExportIdeaViaEmail()){a.call(t,"xls",o);}else if(t._IsExportIdeaDirectly()){var p=t._getExportParam("xls",o);if(!p){B.hide();return;}p.ISNOTSENDEMAIL=true;b.exportAdvancedIdea("xls",p,t._oExportActionSheet.triggerButton,t.getText.bind(t));}else if(c){b.exportAdvanced(o,"xls",t.getExportPrefix&&t.getExportPrefix(),t._oExportActionSheet.triggerButton,C.getCurrentUser().NAME,null,c(t));}else{b.exportAdvanced(o,"xls",t.getExportPrefix&&t.getExportPrefix(),t._oExportActionSheet.triggerButton,C.getCurrentUser().NAME);}});});};E.onListExportCSV=function(e){var t=this,l={csv:3000};if(!t._checkExportCount("csv",l)){M.show(t.getText("EXPORT_CSV_LIMIT_COUNT_MSG",l.csv));return;}B.show(0);setTimeout(function(){sap.ui.require(["sap/ino/commons/util/Export"],function(b){b.i18n=t.getModel("i18n");var o=typeof t.getExportControl==="function"?t.getExportControl():t.getList();var c=typeof t.fnCompleted==="function"?t.fnCompleted:null;if(t._IsExportIdeaViaEmail()){a.call(t,"csv",o);}else if(t._IsExportIdeaDirectly()){var p=t._getExportParam("csv",o);if(!p){B.hide();return;}p.ISNOTSENDEMAIL=true;b.exportAdvancedIdea("csv",p,t._oExportActionSheet.triggerButton,t.getText.bind(t));}else if(c){b.exportAdvanced(o,"csv",t.getExportPrefix&&t.getExportPrefix(),t._oExportActionSheet.triggerButton,C.getCurrentUser().NAME,null,c(t));}else{b.exportAdvanced(o,"csv",t.getExportPrefix&&t.getExportPrefix(),t._oExportActionSheet.triggerButton,C.getCurrentUser().NAME);}});});};E.onListExportPPT=function(e){var t=this,l={pptx:2000};if(!t._checkExportCount("pptx",l)){M.show(t.getText("EXPORT_PPTX_LIMIT_COUNT_MSG",l.pptx));return;}B.show(0);setTimeout(function(){sap.ui.require(["sap/ino/commons/util/Export"],function(b){b.i18n=t.getModel("i18n");var o=typeof t.getExportControl==="function"?t.getExportControl():t.getList();var c=typeof t.fnCompleted==="function"?t.fnCompleted:null;if(t._IsExportIdeaViaEmail()){a.call(t,"pptx",o);}else if(t._IsExportIdeaDirectly()){var p=t._getExportParam("pptx",o);if(!p){B.hide();return;}p.ISNOTSENDEMAIL=true;b.exportAdvancedIdea("pptx",p,t._oExportActionSheet.triggerButton,t.getText.bind(t));}else if(c){b.exportAdvanced(o,"pptx",t.getExportPrefix&&t.getExportPrefix(),t._oExportActionSheet.triggerButton,C.getCurrentUser().NAME,null,c(t));}else{b.exportAdvanced(o,"pptx",t.getExportPrefix&&t.getExportPrefix(),t._oExportActionSheet.triggerButton,C.getCurrentUser().NAME,50);}});});};E._IsExportIdeaViaEmail=function(){return this.getExportPrefix&&this.getExportPrefix()===this.getText("EXPORT_PREFIX_IDEA")&&this.getViewProperty("/List/EXPORT_IDEA_VIA_EMAIL");};E._IsExportIdeaDirectly=function(){return this.getExportPrefix&&this.getExportPrefix()===this.getText("EXPORT_PREFIX_IDEA");};E._getExportParam=function(f,e){var b=this.getBindingParameter();var i=this._check4ManagingList();var F=e.getBinding('items').sFilterParams;var d=D.getDateTimeInstance({pattern:"dd-MM-yyyy_HH-mm"});var s=this.getText("EXPORT_PREFIX_IDEA")+"_"+d.format(new Date());var I=typeof this.getIdeaformFilters==="function"?this.getIdeaformFilters().replace(/\'/g,"").replace(/\"/g,"").split(","):undefined;var c=typeof this.getCompanyViewFilters==="function"?this.getCompanyViewFilters().replace(/\'/g,"").replace(/\"/g,"").split(","):undefined;var t=this.getViewProperty("/List/TAGS");var g={};var h=[];t.forEach(function(l,m){if(!g[l.ROOTGROUPID]){g[l.ROOTGROUPID]=[];g[l.ROOTGROUPID].push(l.ID);h.push(l.ROOTGROUPID);}else{g[l.ROOTGROUPID].push(l.ID);}});var P={searchToken:b.SearchTerm||"",tagsToken:g[h[0]]?g[h[0]].join(","):"",tagsToken1:g[h[1]]?g[h[1]].join(","):"",tagsToken2:g[h[2]]?g[h[2]].join(","):"",tagsToken3:g[h[3]]?g[h[3]].join(","):"",tagsToken4:g[h[4]]?g[h[4]].join(","):"",filterName:b.VariantFilter||"",filterBackoffice:i?"1":"0",c1:I?(I[1].slice(3)||""):"",o1:I?(I[2].slice(3)||-1):-1,v1:I?(decodeURIComponent(I[3].slice(3))||""):"",c2:I?(I[4].slice(3)||""):"",o2:I?(I[5].slice(3)||-1):"",v2:I?(decodeURIComponent(I[6].slice(3))||""):"",c3:I?(I[7].slice(3)||""):"",o3:I?(I[8].slice(3)||-1):-1,v3:I?(decodeURIComponent(I[9].slice(3))||""):"",cvy:c?(c[3].slice(4)||0):0,cvr:c?(c[2].slice(4)||0):0,cvt:c?(decodeURIComponent(c[1].slice(4))||""):"",filterString:F||"",fileName:s,fileFormat:f};if(!i){var G=typeof this.getGroupViewParameters==="function"?this.getGroupViewParameters(b):undefined;P.cvy=G?G.groupType:0;P.cvr=G?G.groupRole:0;P.cvt=G?G.groupToken:"";}else{P.searchType=typeof this.getSearchType==="function"?this.getSearchType():0;}var j=P.filterString?(/\$filter=(.*)/gm.exec(F)[1]):"";var k=[];if(this.getViewProperty("/List/SELECT_ALL")||this.getViewProperty("/List/EXPORT_ALL")){P.ideasId="";for(var p in this._oDeselectionMap){if(this._oDeselectionMap.hasOwnProperty(p)){j+="%20and%20ID%20ne%20"+p;}}if(j.indexOf("%20and%20")===0){j=j.slice(9);}P.filterString="$filter=("+j+")";}else{jQuery.each(this._oSelectionMap,function(l,o){k.push(o.ID);});if(k.length===0){M.show(this.getText("MSG_EXPORT_IDEA_NO_SELECTED"));return undefined;}P.ideasId=k.join(",");}return P;};E.onChartExportSVG=function(e){var t=this;B.show(0);setTimeout(function(){sap.ui.require(["sap/ino/commons/util/Export"],function(b){b.i18n=t.getModel("i18n");var o=typeof t.getExportChartControl==="function"?t.getExportChartControl():t.getChart();b.exportChartAdvanced(o,t.getChartTitle&&t.getChartTitle(),e.getSource());});});};E._checkExportCount=function(t,l){var b=this,c={"xls":2000,"csv":3000,"pptx":2000};var v=b.getView().getProperty("viewName");if(v&&v.indexOf("idea")<=0){return true;}var s=C.getSystemSetting("sap.ino.config.COUNT_LIMIT_EXPORT_IDEAS"),d;if(s){d=s.split("|");c.xls=Number(d[0]);c.csv=Number(d[1]);c.pptx=Number(d[2]);}l[t]=c[t];var e=typeof b.getExportControl==="function"?b.getExportControl():b.getList();if(!e){return true;}var p=b._getExportParam(t,e);if(!p){return true;}if(p.ideasId&&p.ideasId.split(",").length<=c[t]){return true;}if(!b.getView().getModel("view")||!b.getView().getModel("view").getProperty("/List/VARIANT")){return true;}var f=b.getView().getModel("view").getProperty("/List/VARIANT");var o=C.getIdeaFilterCountData();if(o&&o[f]&&o[f]>c[t]){return false;}return true;};return E;});
