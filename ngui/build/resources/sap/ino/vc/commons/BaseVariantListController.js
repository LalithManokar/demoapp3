sap.ui.define(["./BaseListController","sap/ui/Device","sap/ino/commons/formatters/ListFormatter","sap/ui/model/json/JSONModel","sap/ino/commons/application/Configuration","sap/ui/model/Sorter","sap/m/MessageBox","sap/ui/core/InvisibleText"],function(B,D,L,J,C,S,M,I){"use strict";var o={ASC:"ASC",DESC:"DESC"};var s={SEARCH_SCORE:"SEARCH_SCORE"};return B.extend("sap.ino.vc.commons.BaseVariantListController",{formatter:L,onInit:function(){B.prototype.onInit.apply(this,arguments);this._eOrientation=null;},onExit:function(){this.getList().detachUpdateFinished(this.onUpdateFinished,this);},onAnyRouteMatched:function(e){var r=e.getParameter("name");if(this.routes&&this.routes.indexOf(r)>-1){this.openDefaultFilterBar();}if(!this._bInnerViewNavigation){return;}if(this.routes&&this.routes.indexOf(r)===-1){this._bInnerViewNavigation=false;}},openDefaultFilterBar:function(){if(this.getModel("filterItemModel")){this.getModel("filterItemModel").setProperty("/isShowFilterSideFilterButtonGroup",false);}if(!D.system.desktop){return;}var f=this.getFilterButton();var F=this.getFilterPanel();var a=this.getSortPanel();var O=this.getListLayout();var p=C.getPersonalize();if(!p.FILTER){if(F&&F.hasStyleClass("sapInoFilterSidePanelVisible")){if(this.getModel("filterItemModel")){this.getModel("filterItemModel").setProperty("/isShowFilterSideFilterButtonGroup",true);}}return;}if(F&&!F.hasStyleClass("sapInoFilterSidePanelVisible")){if(f){f.setPressed(true);}O.addStyleClass("sapInoObjectListLayoutFit");F.addStyleClass("sapInoFilterSidePanelVisible");if(this.onSetFilterBarVisible){this.onSetFilterBarVisible();if(this.getModel("filterItemModel")){this.getModel("filterItemModel").setProperty("/isShowFilterSideFilterButtonGroup",true);}}if(a){O.addStyleClass('sapInoObjectListLayoutTop');a.addStyleClass('sapInoSortPanelLayoutFit');}}if(F&&F.hasStyleClass("sapInoFilterSidePanelVisible")){if(this.onSetFilterBarVisible){this.onSetFilterBarVisible();if(this.getModel("filterItemModel")){this.getModel("filterItemModel").setProperty("/isShowFilterSideFilterButtonGroup",true);}}}},setParameters:function(q,v){q=q||{};var a=this.checkSort(q,v.DEFAULT_SORT);var t=this.checkTags(q.tags);this.setViewProperty("/List/VARIANT",v.ACTION);this.setViewProperty("/List/SORT",a);this.setViewProperty("/List/QUICKSORT",q.quickSort);this.setViewProperty("/List/SEARCH",q.search);this.setViewProperty("/List/TAGS",t);this.setViewProperty("/List/IS_TAGS_SELECTION",t.length>0);},saveState:function(v){var r=this.getCurrentRoute();v=v||this.getBindingParameter().Variant;var q=this.getQuery({bFilterChange:true,bSorterChange:true});var p=D.orientation.portrait;var c=this.getContextObjectId();this._oState=this.createState(r,v,q,p,c);},createState:function(r,v,q,p,c){q=q||{};var a={route:r,variant:v,query:{}};Object.keys(q).forEach(function(k){if(k){a.query[k]=q[k];}});if(p!==undefined){a.portrait=p;}if(c>0){a.contextObjectId=c;}return a;},hasStateChanged:function(r,v,q,p,c){return JSON.stringify(this.createState(r,v,q,p,c))!==JSON.stringify(this._oState);},getQuery:function(){var q={};var a=this.getViewProperty("/List/SORT");var b=this.getViewProperty('/List/QUICKSORT');var O=this.getViewProperty("/List/ORDER");var c=this.getViewProperty("/List/SEARCH");var t=this.getViewProperty("/List/TAGS");if(b){q.quickSort=b;}if(a){q.sort=a;if(O){q.order=O;}}if(c){q.search=c;}if(t&&t.length>0){q.tags=JSON.stringify(t);}return q;},getVariant:function(a){return this._getListDefinitionEntry(a,"ACTION","/Variants/Values");},getVariantsPopover:function(){if(!this._oVariantsPopover){if(!D.system.desktop){this._oVariantsPopover=sap.ui.xmlfragment("sap.ino.vc.commons.fragments.ListVariantsDialog",this);}else{this._oVariantsPopover=sap.ui.xmlfragment("sap.ino.vc.commons.fragments.ListVariants",this);}this.getView().addDependent(this._oVariantsPopover);}return this._oVariantsPopover;},_onListVariants:function(e){var b=e.getSource();var p=this.getVariantsPopover();p.attachAfterClose(function(){b.focus();},this);if(typeof p.openBy==="function"){p.openBy(b);}else{p.open();}},onListVariants:function(){this._onListVariants.apply(this,arguments);},onListVariatsClose:function(){this.getVariantsPopover().close();},onVariantPress:function(v){var q=this.getQuery();this.removeInvalidFilters(q);if(v){this.navigateTo(this.getRoute(true),{variant:v,query:q},false,true);}else{this.navigateTo(this.getRoute(false),{query:q},false,true);}},removeInvalidFilters:function(q){},onVariantBasePress:function(e){var i=e.getSource();if(i.getSelectedItem&&i.getSelectedItem()){i=i.getSelectedItem();}var c=i.getBindingContext("list");var a;var O;var p;if(c){O=c.getObject();a=O?O.ACTION:undefined;this.setViewProperty("/List/VARIANT",a);this.setViewProperty("/List/CURRENTVAR",O);}this.setViewProperty("/List/SORT",undefined);this.setViewProperty("/List/ORDER",undefined);this.setViewProperty("/NAVIGATETOPLINK",false);this.getModel("list").setProperty("/CURRENTQUICKLINK",undefined);this.getModel("list").setProperty("/CURRENTSELECTLINK",O);this.getModel("list").setProperty("/TITLESELECTQUICKLINK",O);this.getModel("list").setProperty("/List/SELECTQUICKLINKID",O.ID);if(!D.system.desktop){return;}if(O.ID){this.setViewProperty("/List/SELECTQUICKLINKID",O.ID);}else{this.setViewProperty("/List/SELECTQUICKLINKID",undefined);}if(O.TYPE_CODE==="QUICK_LINK_CUSTOM_IDEA"){this.getModel("list").setProperty("/CURRENTQUICKLINK",O);var b=this.campaignId?location.href.split("#")[0]+"#/campaign/"+this.campaignId+"/"+O.LINK_URL:location.href.split("#")[0]+"#/"+O.LINK_URL;this.navigateToByURL(b);}else{this.onVariantPress(a,e);}},onApplyFilter:function(){var f=this.byId("filterDialog");if(JSON.stringify(this.getViewModelBackup())!==JSON.stringify(this.getViewProperty("/"))||JSON.stringify(this.getFilterItemModelBackup())!==JSON.stringify(this.getModel("filterItemModel"))){var q=this.getQuery();var v=this.getViewProperty("/List/VARIANT");if(v===this.getListProperty("/Variants/DEFAULT_VARIANT")){this.navigateTo(this.getRoute(false),{query:q},true,true);}else{this.navigateTo(this.getRoute(true),{variant:v,query:q},true,true);}}this.resetViewModelBackup();f.close();},initialSorterItems:function(){if(!D.system.desktop){return;}var a=this;var O=["ASC","DESC"];var b=this.getViewProperty("/List/SORT");if(!b){return;}if(!this._oSorterContainer){this._oSorterContainer=this.byId(this.getSortFragmnetId()+"--SorterContainer");}var c=b.split(",");var f;var t=this;var i=0;var _=function(e,g){var h=g.split(" ");e[0].setSelectedKey(h[0]);e[1].setPressed(O.indexOf(h[1]));a.setSorterIcon(e[1]);};f=this._oSorterContainer.getItems()[0];_(f.getItems(),c.shift());if(c.length>0){jQuery.each(c,function(e,T){if(t._oSorterContainer.getItems()[e+1]){f=t._oSorterContainer.getItems()[e+1];}else{f=t.addSorter(t._oSorterContainer);}_(f.getItems(),T);i=e+1;});}var d=this._oSorterContainer.getItems();for(i=i+1;i<d.length;i++){this._oSorterContainer.removeItem(d[i]);d[i].destroy();}a.checkSorterLimit(a._oSorterContainer);},onSorterAdd:function(e){var a=this._oSorterContainer||e.getSource().getParent().getParent();this.addSorter(a);this.checkSorterLimit(a);this._oLastFocusedControl=e.getSource();},addSorter:function(a){var f=this.createFragment("sap.ino.vc.commons.fragments.SorterItems");a.addItem(f);var i=a.getItems();var F=i[i.length-1].getItems();F[0].insertItem(new sap.ui.core.Item({text:"",key:''}),0);F[0].addEventDelegate({onAfterRendering:function(){F[0].focus();}});return i[i.length-1];},onSorterChange:function(e){var a=e.getSource();if(!a.getSelectedItem().getProperty("key")){return;}if(a.getBindingPath("items").indexOf("Sorter")<0){var b=a.getParent().getItems()[0];if(!b.getSelectedItem().getProperty("key")){return;}}var c=this.getSortCombination();if(c==="-1"){M.show(this.getText("MSG_REPEAT_IDEAT_SORTER"),M.Icon.INFORMATION,"",[M.Action.OK],function(){a.setSelectedKey("");});return;}this.setViewProperty("/List/SORT",c);this.navigateIntern(this.getQuery({bSorterChange:true}),true);},onSorterRemove:function(e){var a=e.getSource().getParent().getParent();var f=e.getSource().getParent();if(a&&a.indexOfItem(f)>0){a.removeItem(f);f.destroy();}this.checkSorterLimit(a);var b=this.getViewProperty("/List/SORT");var i=b.split(",").length;var c=a.getItems().length-1;if(i>c){this.setViewProperty("/List/SORT",this.getSortCombination());this.navigateIntern(this.getQuery({bSorterChange:true}),true);}var t=this;setTimeout(function(){if(t._oLastFocusedControl){t._oLastFocusedControl.focus();}},2000);},setSorter:function(a){if(Object.prototype.toString.call(a)!=="[object Array]"){a=[a];}var t=[];jQuery.each(a,function(i,b){if(b instanceof S){t.push(b);}else{t.push(new S(b.ACTION,b.DEFAULT_ORDER===o.DESC));}});this._oSorter=t;},getSort:function(a){if(a){var b=a.split(",");var t=this;var c=[];jQuery.each(b,function(i,d){var e=B.prototype.getSort.call(t,d.split(" ")[0]);if(e){if(d.split(" ")[1]){e.DEFAULT_ORDER=d.split(" ")[1];}c.push(e);}});return c;}},getQuickSort:function(q){var Q=[],a;var b=this.getListProperty('/QuickSorter');if(!q||!b||!b.length){return Q;}a=q.split(' ');for(var i=0;i<b.length;i++){if(b[i].ACTION===a[0]){Q.push(b[i]);}}return Q;},getSortCombination:function(){var O=["ASC","DESC"];var a="";var b=[];var v=true;var c=this._oSorterContainer.getItems();jQuery.each(c,function(i,d){var e=d.getItems();var f=e[0].getSelectedItem().getProperty("key");var g=e[1].getPressed()?O[1]:O[0];if(f!==""&&jQuery.inArray(f,b)===-1){b.push(f);a+=f+" "+g+",";}else if(jQuery.inArray(f,b)>-1){v=false;}});if(v){return a.slice(0,a.length-1);}else{return"-1";}},setSortIcon:function(O,a){var i=["sap-icon://sort-ascending","sap-icon://sort-descending"];var b=["ASC","DESC"];if(b.indexOf(a)===-1){return;}if(O&&O.setIcon){O.setIcon(i[b.indexOf(a)]);}},reverseSort:function(r,e){var O=["ASC","DESC"];var a=this.getViewProperty("/List/ORDER");this.setViewProperty("/List/ORDER",O[!O.indexOf(a)?1:0]);this.setSortIcon(e.getSource(),this.getViewProperty("/List/ORDER"));if(!r&&!D.system.desktop){return;}this.navigateIntern(this.getQuery(),false);},onListSortReverse:function(){this.reverseSort(true);},onSortReverse:function(e){this.reverseSort(false,e);},resetFilter:function(){this.setViewProperty("/List/TAGS",[]);this.setViewProperty("/List/IS_TAGS_SELECTION",false);this.setViewProperty("/List/SORT","");this.setViewProperty("/List/QUICKSORT","");if(!D.system.desktop){return;}this.navigateIntern(this.getQuery({bFilterChange:true,bSorterChange:true}),true);},onFilterReset:function(e){this.resetFilter();},checkSort:function(q,d){var a={"TEXT":"SORT_MIT_SEARCH_SCORE","ACTION":s.SEARCH_SCORE,"DEFAULT_ORDER":o.DESC};if(q&&q.search!==undefined&&(!this._oState||!this._oState.query.search)){this.addSorterConfig(a);}else if(q&&q.search===undefined&&(this._oState&&!this._oState.query.search)){this.removeSorterConfig(a);}if(q&&q.search!==undefined&&!q.sort){return s.SEARCH_SCORE;}return q&&this.getSort(q.sort)?q.sort:d;},checkOrder:function(q,d){if(jQuery.type(q.order)==="string"){q.order=q.order.toUpperCase();if(q.order===o.ASC||q.order===o.DESC){return q.order;}}return d;},checkTags:function(t){try{return JSON.parse(t);}catch(e){return[];}},checkRespList:function(r){try{return JSON.parse(r);}catch(e){return[];}},getBindingParameter:function(){return{Variant:null,VariantFilter:null,SearchTerm:null,TagIds:[]};},setContextObjectId:function(c){this._iContextObjectId=c;},getContextObjectId:function(){return this._iContextObjectId;},getCurrentVariant:function(){return this.getVariant(this.getViewProperty("/List/VARIANT"));},getRoute:function(v){if(this.routes&&this.routes.length){if(v){return this.routes[1];}else{return this.routes[0];}}return undefined;},getFilterFragmentId:function(){return D.system.desktop?"panelFilterFragment":"dialogFilterFragment";},getSortFragmnetId:function(){return D.system.desktop?"panelSortFragment":"dialogFilterFragment";},setSorterIcon:function(a){var i=["sap-icon://sort-ascending","sap-icon://sort-descending"];return a.getPressed()?a.setIcon(i[1]):a.setIcon(i[0]);},onOrder:function(e){var a=this.getSortCombination();this.setSorterIcon(e.getSource());this.setViewProperty("/List/SORT",a);if((a.split(" "))[1]==="ASC"){e.getSource().setTooltip(this.getText('EXP_ASCENDING_SORT_BUTTON'));}else if((a.split(" "))[1]==="DESC"){e.getSource().setTooltip(this.getText('EXP_DESCENGDING_SORT_BUTTON'));}this.navigateIntern(this.getQuery({bSorterChange:true}),true);},onQuickSort:function(e){var p=e.getParameters();var i=p.item;var q=i.getKey();var c=this.getViewProperty('/List/QUICKSORT');if(c===q){q='';}this.setViewProperty('/List/QUICKSORT',q);this.navigateIntern(this.getQuery({bSorterChange:true}),true);},checkSorterLimit:function(a){if(!a){return false;}var i=a.getItems();var l=this.getListProperty('/Sorter/Limit');if(!l){return false;}if(i.length>=l){this.setListProperty('/Sorter/disableAddButton',true);}else{this.setListProperty('/Sorter/disableAddButton',false);}},transListValue:function(l){return l&&!!l.length||false;},isDisable:function(b){return!b;},quickSortEnable:function(a,c){if(a==="CHANGED_AT_DT"&&c){if(a===c.split(" ")[0]){return false;}else{return true;}}else{return true;}}});});
