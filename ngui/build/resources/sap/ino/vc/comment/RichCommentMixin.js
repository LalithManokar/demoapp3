/*!
 * SAP Innovation Management (c) Copyright 2014 SAP AG. All rights reserved.
 */
sap.ui.define(["sap/ui/core/mvc/ViewType","sap/ino/vc/commons/BaseObjectController","sap/ino/commons/application/Configuration","sap/ino/commons/models/object/IdeaFollow","sap/m/MessageToast","sap/m/MessageBox","sap/m/Button"],function(V,B,C,I,M,a,b){"use strict";var o={idea:"IDEA",campaign:"CAMPAIGN",blog:"BLOG"};var R=function(){throw"Mixin may not be instantiated directly";};R.defaultRichCommentSetting={commentContainerId:"rteContainer",commentInputId:"rteCtrlInput",commentListId:"commentList",type:"comment",successMessageKey:"MSG_CREATE_SUCCESS_COMMENT",validateMsgKey:"MSG_CREATE_EMPTY_COMMENT",updateMsgKey:"MSG_UPDATE_SUCCESS_COMMENT",createReplyMsgKey:"MSG_CREATE_REPLY_SUCCESS_COMMENT",editDialogViewName:"sap.ino.vc.comment.RichEditCommentDialog",delDialogViewName:"sap.ino.vc.comment.RichDelDialog",editAttachmentDialogViewName:"sap.ino.vc.comment.RichAttachmentDialog",delReplyConfirmMsgKey:"MSG_COMMENT_REPLY_DEL_CONFIRM",delAllDataComfirmMsgKey:"MSG_COMMENT_DELETE_ALL_DATA_CONFIRM",delSuccessfulMsgKey:"MSG_COMMENT_DEL_SUCCESS",delBtnKey:"COMMENT_OBJECT_BTN_DELETE_COMMENT",delBtnAllDataKey:"COMMENT_OBJECT_BTN_DELETE_ALL_DATA"};R.richCommentMixinInitRouterEvent=function(s){if(s){this.defaultRichCommentSetting=s;}this._oRouter=this.getOwnerComponent().getRouter();this._oRouter.getRoute(this.routes).attachMatched(this._onCommentMixinRouteMatched,this);};R.onExit=function(){this._oRouter.getRoute(this.routes).detachMatched(this._onCommentMixinRouteMatched,this);};R.richCommentMixinInit=function(s){var c=this;c._commentMixinSettings=s||this.defaultRichCommentSetting;c._initRTE();c._commentMixinResetCommentModel();};R.richCommentMixinSubmit=function(){var v=this.getBlockView();var m=this.getModel("comment")?this.getModel("comment"):this._commentMixinGetCommentModel();var t=v.data("modelObjectType");var s=this._commentMixinSettings.successMessageKey;if(!m.getProperty("/COMMENT")){M.show(this.getText(this._commentMixinSettings.validateMsgKey));return;}v.setBusy(true);m.setProperty("/Imgs",this._getImgIds(m.getProperty("/COMMENT")));var c=B.prototype.executeObjectAction.call(this,"create",{messages:{success:s,error:function(S){if(S&&S.MESSAGES&&S.MESSAGES.length>0){M.show(S.MESSAGES[0].MESSAGE_TEXT);}}},objectModelExt:m});var r=this.getRouter();var d=this;c.done(function(){if(d.getCurrentRoute()==="idea-display"&&(r.getContext().indexOf("sectionComment")>-1||r.getContext().indexOf("sectionInternal")>-1)){d._commentMixinSetCommentModel(null);}d._commentMixinResetCommentModel();d._commentMixinRefresh();d.onVotedFollow(t);});c.always(function(){v.setBusy(false);});};R.richCommentMixinOnUserPressed=function(e){var s=e.getSource();var d=e.getParameter("domRef");var c=s.getBindingContext("data");var i=c.getProperty("CHANGED_BY_ID");if(d){var r=sap.ui.getCore().byId(d.id);}if(!this.oIdentityCardView){this.oIdentityCardView=sap.ui.xmlview({viewName:"sap.ino.vc.iam.IdentityCard"});this.getBlockView().addDependent(this.oIdentityCardView);}if(r){this.oIdentityCardView.getController().open(r,i);}else{this.oIdentityCardView.getController().open(s,i);}};R.richCommentMixinOnDetailPress=function(e){this._commentMixinResetCommentModel();var m=this.getBlockView().data("modelObjectType");if(!this.oEditDialog){var v=this._commentMixinSettings.editDialogViewName;this.oEditDialog=this.createView({type:V.XML,viewName:v});this.getBlockView().addDependent(this.oEditDialog);}var c=e.getSource().getBindingContext("data");var i=c.getProperty(c.sPath).ID;this.oEditDialog.getController().open(i,m);};R.onVotedFollow=function(t){var i=this.getModel("object");if(i&&i.getProperty("/AUTO_FOLLOW")){var A=i.getProperty("/AUTO_FOLLOW");var f=i.getProperty("/FOLLOW");var c=i.getProperty("/SubmitterContributorsCoach");var p=c.filter(function(s){return s.IDENTITY_ID===C.getCurrentUser().USER_ID;});if(t==="sap.ino.commons.models.object.IdeaComment"&&A&&!f&&!p.length){var d=i.getProperty("/ID");var F=I.follow(d,"IDEA",0);F.done();}}};R.richCommentMixinOnReply=function(e){var c=e.getSource().getCustomData()[0];this._commentMixinOnEdit(-1,c.getValue());};R.richCommentMixinOnEdit=function(e){var c=e.getSource().getCustomData();this._commentMixinOnEdit(c[0].getValue(),c[1].getValue());};R._commentMixinOnEdit=function(i,p){var m=this.getBlockView().data("modelObjectType");if(!this.oEditDialog){var v=this._commentMixinSettings.editDialogViewName;this.oEditDialog=this.createView({type:V.XML,viewName:v});this.getBlockView().addDependent(this.oEditDialog);}this.oEditDialog.getController().open(i,p,m,this._commentMixinSettings);};R.richCommentMixinOnAttach=function(i){var m=this.getBlockView().data("modelObjectType");if(!this.oAttachmentDialog){var v=this._commentMixinSettings.editAttachmentDialogViewName;this.oAttachmentDialog=this.createView({type:V.XML,viewName:v});this.getBlockView().addDependent(this.oAttachmentDialog);}this.oAttachmentDialog.getController().open(i,m);};R.onRichAttachmentFileDeleted=function(e){var c=this;var d;if(e.getParameter("item")&&e.getParameter("item").getCustomData()&&e.getParameter("item").getCustomData().length>0){d=e.getParameter("item").getCustomData()[0].getValue();}var r=c._commentMixinGetStaticCommentModel().removeAttachments({ATTACHMENT_ID:e.getParameter("documentId"),ID:d});this.getBlockView().setBusy(true);r.done(function(){c._commentMixinRefresh();});r.fail(function(f){M.show(f.MESSAGES[0].MESSAGE_TEXT);});r.always(function(){c.getBlockView().setBusy(false);});};R.richCommentMixinOnDel=function(i,p,m){var c=this;var O;if(m.indexOf("IdeaComment")>-1){O=o.idea;}else if(m.indexOf("CampaignComment")>-1){O=o.campaign;}else if(m.indexOf("BlogComment")>-1){O=o.blog;}if(!c.getModel("comment")){this._commentMixinGetCommentModel();}var s=p?c._commentMixinSettings.delReplyConfirmMsgKey:c._commentMixinSettings.delAllDataComfirmMsgKey;jQuery.sap.require(m);var d=jQuery.sap.getObject(m,0);var D=new jQuery.Deferred();var A=p?[a.Action.OK,a.Action.CANCEL]:[c.getText(c._commentMixinSettings.delBtnKey),c.getText(c._commentMixinSettings.delBtnAllDataKey),a.Action.CANCEL];a.confirm(c.getText(s),{actions:A,onClose:function(e){var f=Math.pow(A.length,A.indexOf(e)+1);if(f===4||f===27||f===1){D.resolve({confirmationCancelled:true});return;}else{var g=B.prototype.executeObjectAction.call(c,"delComment",{staticparameters:{COMMENT_ID:i,ALL_DATA:f===9?1:0,OBJECT_TYPE:O,OBJECT_ID:c.getModel("comment").getProperty("/OBJECT_ID")},messages:{success:c._commentMixinSettings.delSuccessfulMsgKey},objectModelExt:d});g.done(D.resolve);g.fail(D.reject);}}});return D.promise();};R.richCommentMixinOnRemoveComments=function(e){var c=e.getSource().getCustomData();var i=c[0].getValue();var p=c[1].getValue();var m=this.getBlockView().data("modelObjectType");var d=this;var D=this.richCommentMixinOnDel(i,p,m);D.done(function(r){if(r&&r.confirmationCancelled===true){return;}else{d._commentMixinRefresh();}});};R.setAccessibilityProperty=function(){if(this.byId(this._commentMixinSettings.commentListId)){this.byId(this._commentMixinSettings.commentListId).addEventDelegate({onAfterRendering:function(e){var l=e.srcControl;var i=l.$().find("li");jQuery.each(i,function(c,d){var $=jQuery(d);$.attr("aria-label",$.getEncodedText());});}});}};R._commentMixinResetCommentModel=function(){this._commentMixinGetCommentModel();};R.commentMixinForceInitCommentModel=function(){if(!this.getBlockView().getModel("comment")){var O=this.getBlockView().data("object_id")||(this.getModel("object")&&this.getModel("object").getProperty("/ID"));if(O>0){this._commentMixinInitCommentModel(O);}}};R._commentMixinInitCommentModel=function(O){var s={continuousUse:true,readSource:{model:this.getDefaultODataModel()}};var m=this.getBlockView().data("modelObjectType");jQuery.sap.require(m);var c=jQuery.sap.getObject(m,0);var d=new c({OBJECT_ID:O},s);this.addSomeMethodIntoModel(d);this._commentMixinSetCommentModel(d);};R._commentMixinSetCommentModel=function(m){this.getBlockView().setModel(m,"comment");};R._commentMixinGetCommentModel=function(){if(this.getCurrentRoute()!=="idea-display"){this._commentMixinSetCommentModel(null);}if(this.getCurrentRoute()==="idea-display"){var i=this.getModel("object");if(this.getBlockView().getViewName()==="sap.ino.vc.comment.RichComment"){i.setProperty("/IDEA_COMMENT_VIEW",this.getBlockView());}if(this.getBlockView().getViewName()==="sap.ino.vc.internal.InternalSection"){i.setProperty("/IDEA_INTERNAL_COMMENT_VIEW",this.getBlockView());}if(this.getBlockView().getModel("comment")&&this.getModel("object")&&this.getBlockView().getModel("comment").getProperty("/OBJECT_ID")!==this.getModel("object").getProperty("/ID")){this._commentMixinSetCommentModel(null);}}this.commentMixinForceInitCommentModel();return this.getBlockView().getModel("comment");};R._commentMixinGetStaticCommentModel=function(){var m=this.getBlockView().data("modelObjectType");jQuery.sap.require(m);return jQuery.sap.getObject(m,0);};R._commentMixinGetSingleCommentModel=function(O){var m=this.getBlockView().data("modelObjectType");jQuery.sap.require(m);var c=jQuery.sap.getObject(m,0);var s={continuousUse:true,readSource:{model:this.getDefaultODataModel()}};return new c(O,s);};R._commentMixinRefresh=function(c){var d=this;jQuery.sap.delayedCall(0,d,function(){var l=d._commentMixinSettings.commentListId;var e=c||jQuery.extend(true,{},d.getBlockView().byId(l).getBindingInfo("items"));d.getBlockView().byId(l).destroyItems();d.getBlockView().byId(l).bindItems(e);});};R._onCommentMixinRouteMatched=function(e){var r=e.getParameter("arguments");var q=r["?query"];var s=(q&&q.section)||"sectionDetails";if(s==="sectionComments"){this.getModel("view").setProperty("/IDEA_COMMENT",true);}else{this.getModel("view").setProperty("/IDEA_COMMENT",false);}this._commentMixinGetCommentModel();};return R;});
