/*!
 * SAP Innovation Management (c) Copyright 2014 SAP AG. All rights reserved.
 */
sap.ui.define(["sap/ino/commons/application/Configuration","sap/ui/unified/FileUploaderParameter","sap/ino/commons/models/object/Attachment","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/m/UploadCollection","sap/ui/Device"],function(C,F,A,M,J,U,D){"use strict";var R=function(){throw"Mixin may not be instantiated directly";};R.richAttachmentMixinInit=function(){this._attachmentCtlSetting={listId:"commentAttachmentList",uploaderId:"commentAttachmentUploader"};if(!this.getBlockView().getModel("local")){this.setModel(new J({ATTACHMENT_UPLOAD_URL:A.getEndpointURL()}),"local");}var a=this.byId(this._attachmentCtlSetting.listId);var b=this.getBlockView().byId(this._attachmentCtlSetting.listId);if(!a.getUploadEnabled()){a.addStyleClass("sapInoAttachmentUploadInvisible");}b.addEventDelegate({onAfterRendering:jQuery.proxy(function(){this.setRichAttachmentAccessibility();},this)});};R.onRichCommentFileUploaderChange=function(e){var f=e.getSource();var a=e.getParameter("files");f.setBusy(true);A.prepareFileUploader(f,a);};R.onRichCommentFileUploaderComplete=function(e){var r=A.parseUploadResponse(e.getParameter("responseRaw"));var f=e.getSource();if(r){var o=this.getObjectModel();o.getMessageParser().parse(r);if(r.success){o.setTitleImage({"ATTACHMENT_ID":r.attachmentId,"FILE_NAME":r.fileName,"MEDIA_TYPE":r.mediaType});}else{M.show(this.getText("MSG_COMMENT_ATTACHMENT_IMAGE_FAILED"));}}else{M.show(this.getText("MSG_COMMENT_ATTACHEMENT_IMAGE_ERROR"));}f.setBusy(false);f.clear();};R.richAttachmentMixinOnChange=function(e){var u=e.getSource();var c=new F({name:"x-csrf-token",value:C.getXSRFToken()});u.removeAllAggregation("headerParameters",true);u.addHeaderParameter(c);this._onRichCommentChange(e);};R._onRichCommentChange=function(e){if(!e){return;}var t=this;var r,c,i,f,I,s;if(D.browser.msie&&D.browser.version<=9){var n=e.getParameter("newValue");if(!n){return;}f=n.split(/\" "/)[0];if(f.length===0){return;}}else{c=e.getParameter("files").length;if(c===0){return;}}var a=t.byId(this._attachmentCtlSetting.listId),u=t.byId(this._attachmentCtlSetting.uploaderId);var p=a.getAggregation("parameters");if(p){jQuery.each(p,function(b,d){var P=new sap.ui.unified.FileUploaderParameter({name:d.getProperty("name"),value:d.getProperty("value")});u.addParameter(P);});}s=U._uploadingStatus;if(D.browser.msie&&D.browser.version<=9){I=new sap.m.UploadCollectionItem({fileName:f});I._status=s;I._internalFileIndexWithinFileUploader=1;I._percentUploaded=0;a.aItems.unshift(I);}else{a._requestIdValue=a._requestIdValue+1;r=a._requestIdValue.toString();var h=a.getAggregation("headerParameters");for(i=0;i<c;i++){I=new sap.m.UploadCollectionItem({fileName:e.getParameter("files")[i].name});I._status=s;I._internalFileIndexWithinFileUploader=i+1;I._requestIdName=r;I._percentUploaded=0;a.aItems.unshift(I);}if(h){jQuery.each(h,function(b,d){u.addHeaderParameter(new sap.ui.unified.FileUploaderParameter({name:d.getProperty("name"),value:d.getProperty("value")}));});}u.addHeaderParameter(new sap.ui.unified.FileUploaderParameter({name:a._headerParamConst.requestIdName,value:r}));}a.invalidate();};R.richAttachmentMixinonFileDeleted=function(e){var i=e.getParameter("item");var o=this.getBlockView().getModel("comment");o.removeAttachment(parseInt(i.getDocumentId(),10));};R.richAttachmentMixinonBeforeUploadStarts=function(e){var c=new F({name:"unicode_filename",value:A.stringToUnicode(e.getParameter("fileName"))});e.getParameter("requestHeaders").push(c);};R.richAttachmentMixinonUploadProgress=function(e){if(!e){return;}var a=this.byId(this._attachmentCtlSetting.listId);var i,p,P,r,c,o,I,$;r=a._getRequestId(e);P=Math.round(e.getParameter("loaded")/e.getParameter("total")*100);if(P===100){p=a._oRb.getText("UPLOADCOLLECTION_UPLOAD_COMPLETED");}else{p=a._oRb.getText("UPLOADCOLLECTION_UPLOADING",[P]);}c=a.aItems.length;for(i=0;i<c;i++){if(a.aItems[i]._requestIdName===r&&a.aItems[i]._status===U._uploadingStatus){o=sap.ui.getCore().byId(a.aItems[i].getId()+"-ta_progress");if(!o){continue;}o.setText(p);a.aItems[i]._percentUploaded=P;I=a.aItems[i].getId();$=jQuery.sap.byId(I+"-ia_indicator");if(P===100){$.attr("aria-label",p);}else{$.attr("aria-valuenow",P);}break;}}};R._onRichCommentUploadComplete=function(e){var t=this;var o=this.getBlockView().getModel("comment");var f=[{fileName:e.getParameter("fileName"),responseRaw:e.getParameter("responseRaw"),reponse:e.getParameter("response"),status:e.getParameter("status"),headers:e.getParameter("headers")}];if(f.length>0){var E=false;f.forEach(function(a){var r=A.parseUploadResponse(a.responseRaw);o.getMessageParser().parse(r);if(r){if(r.success){E=t.uploadRichAttachmentSuccess(o,r);}else{M.show(t.getText("OBJECT_MSG_ATTACHMENT_FAILED"));E=true;}}else{M.show(t.getText("OBJECT_MSG_ATTACHMENT_ERROR"));E=true;}});if(E){var u=this.byId(this._attachmentCtlSetting.listId);u.aItems=[];u.rerender();}}};R.richAttachmentMixinonUploadComplete=function(e){if(!e){return;}var u=this.byId(this._attachmentCtlSetting.listId);var i,r,s,c,b=d();r=u._getRequestId(e);s=e.getParameter("fileName");if(!s){var a=(e.getSource().getProperty("value")).split(/\" "/);s=a[0];}c=u.aItems.length;for(i=0;i<c;i++){if(!r){if(u.aItems[i]._status===U._uploadingStatus&&b){u.aItems[i]._percentUploaded=100;u.aItems[i]._status=U._displayStatus;u._oItemToUpdate=null;break;}else if(u.aItems[i]._status===U._uploadingStatus){u.aItems.splice(i,1);u._oItemToUpdate=null;break;}}else if(u.aItems[i]._requestIdName===r&&u.aItems[i]._status===U._uploadingStatus&&b){u.aItems[i]._percentUploaded=100;u.aItems[i]._status=U._displayStatus;u._oItemToUpdate=null;break;}else if(u.aItems[i]._requestIdName===r&&u.aItems[i]._status===U._uploadingStatus||u.aItems[i]._status===U._pendingUploadStatus){u.aItems.splice(i,1);u._oItemToUpdate=null;break;}}this._onRichCommentUploadComplete(e);u.invalidate();function d(){var f=e.getParameter("status").toString()||"200";if(f[0]==="2"||f[0]==="3"){return true;}else{return false;}}};R.setRichAttachmentAccessibility=function(){var v=this.getBlockView();var e=v.byId(this._attachmentCtlSetting.listId).$();var i=e.find('.sapMListNoData');var l=e.find('.sapMListModeNone ');if(i.length){l.hide();l.siblings().attr('tabindex','-1');}};R.uploadRichAttachmentSuccess=function(o,r){o.addAttachment({"CREATED_BY_NAME":C.getCurrentUser().NAME,"ATTACHMENT_ID":r.attachmentId,"FILE_NAME":r.fileName,"MEDIA_TYPE":r.mediaType,"CREATED_AT":new Date()});};R.onRichCmtImgPressed=function(e){sap.m.URLHelper.redirect(e.oSource.getProperty("src"),true);};R.onRichCmtIconPressed=function(e){var i=e.oSource.oParent.getItems();if(i&&i.length>=2){sap.m.URLHelper.redirect(i[2].getProperty("href"),true);}};R.addSomeMethodIntoModel=function(m){m.addAttachment=function(n){n.ROLE_TYPE_CODE="ATTACHMENT";this.addChild(n,"Attachments");};m.removeAttachment=function(i){var a=jQuery.grep(this.getProperty("/Attachments")||[],function(o){return o.ID===i;});var f=a&&a[0];if(f){this.removeChild(f);}};};return R;});
