sap.ui.define(["sap/ui/Device","sap/ino/vc/commons/BaseVariantListController","sap/ui/model/Sorter","sap/ino/commons/formatters/ObjectListFormatter","sap/ino/vc/commons/TopLevelPageFacet","sap/ui/model/odata/ODataModel","sap/ui/model/odata/v4/ODataModel","sap/ui/model/json/JSONModel","sap/ino/commons/models/object/Report","sap/ino/commons/util/ReportUtil","sap/ui/model/Filter","sap/ino/commons/application/Configuration","sap/suite/ui/microchart/ColumnMicroChart","sap/suite/ui/microchart/AreaMicroChart","sap/suite/ui/microchart/ComparisonMicroChart","sap/suite/ui/microchart/HarveyBallMicroChart","sap/suite/ui/microchart/RadialMicroChart","sap/ino/commons/models/core/CodeModel","sap/m/MessageBox","sap/ui/core/HTML","sap/m/Text","sap/m/MessageToast","sap/ino/commons/models/object/Attachment"],function(D,B,S,O,T,a,V,J,R,b,F,C,d,A,e,H,f,g,M,h,j,k,l){"use strict";var m={IDENTITY_ID:"IDENTITY_ID"};var v={MY:"my",STANDARD:"standard",CUSTOM_REPORTS:"customReports"};var p={MY:"data>/MyReports",STANDARD:"data>/ReportTemplates"};var n={bar:"Comparison",column:"Column",line:"Area",pie:"HarveyBall",donut:"Radial",heatmap:"Column",bullet:"Comparison",barstacked:"Comparison",columnstacked:"Column",barstacked100:"Comparison",columnstacked100:"Column",waterfall:"Column",combination:"Column",scatter:"Area",bubble:"Area",combinationstacked:"Column",bardual:"Comparison",columndual:"Column",linedual:"Area",barstackeddual:"Comparison",columnstackeddual:"Column",combinationstackeddual:"Column",barstackeddual100:"Comparison",columnstackeddual100:"Column",lastmonthschart:"Column",processindicator:"Column",piechart:"HarveyBall",toplist:"Comparison",currentmonthlist:"Comparison"};var o=["Good","Neutral","Critical","Error"];var L={ADJUSTMENT_TITLE:"ANALYTICS_LIST_TIT_ADJUSTMENT",Variants:{DEFAULT_VARIANT:v.MY,TITLE:"ANALYTICS_LIST_TIT_VARIANTS",Values:[{TEXT:"ANALYTIC_MY_REPORT_LIST",ACTION:v.MY,FILTER:m.IDENTITY_ID,FILTER_VALUE:C.getCurrentUser(true).USER_ID,PATH:p.MY,VISIBLE:true},{TEXT:"ANALYTIC_STANDARD_REPORT_LIST",ACTION:v.STANDARD,PATH:p.STANDARD,VISIBLE:true},{TEXT:C.getCustomReportsTile(),ACTION:v.CUSTOM_REPORTS,VISIBLE:C.getCustomReportsEnable()}]}};var q={formatterReportText:function(t,s){if(s===v.CUSTOM_REPORTS){return t;}else{return this.getText(t);}return"";},visibleCreateBtn:function(c){return c;},formatNoDataVisible:function(c,E){return!c&&!E;},visibleEditRichtext:function(E,c){return!!E&&c;},visibleOperationBox:function(i,s){return i&&(s===v.CUSTOM_REPORTS);},visibleSaveActionsBtn:function(E,c,s){return!!E&&c&&(s===v.CUSTOM_REPORTS);}};jQuery.extend(q,O);return B.extend("sap.ino.vc.analytics.List",jQuery.extend({},T,{routes:["reportlist","reportlistvariant"],list:L,initialFocus:"filterButton",view:{"List":{"VARIANT":v.MY,"CAMPAIGN":undefined,"TAGCLOUD":false}},formatter:q,onInit:function(){B.prototype.onInit.apply(this,arguments);sap.ui.getCore().loadLibrary("sap.suite.ui.microchart");sap.ui.getCore().loadLibrary("sap.ui.comp");sap.ui.getCore().loadLibrary("sap.chart");sap.ui.getCore().loadLibrary("sap.viz");var s=C.getBackendRootURL()+"/"+C.getApplicationPath("sap.ino.config.URL_PATH_OD_ANALYTICS");this.oDataModel=new a(s);var c=this.getModel("view");c.setData(this.view,true);},onRouteMatched:function(E,c){var i=this.getModel("user").getProperty("/privileges")["sap.ino.ui::backoffice.access"];if(!i){this.navigateTo("home");return;}var s;var Q;if(E&&E.getParameter){var r=E.getParameter("arguments");this._sRoute=E.getParameter("name");Q=r["?query"];s=r.variant;}else{this._sRoute=E;Q=c;s=c.variant;}var t=this.getListProperty("/Variants/DEFAULT_VARIANT");var u=this.getVariant(s);var w=this.getList().isBound("items");var x=this.hasStateChanged(this._sRoute,s,Q);this.constructCustomReportsInfo(s);if(!w||x){u=u||this.getVariant(t);this.setParameters(Q,u);this.bindList();}this.setHelp("REPORT_LIST");},onBeforeHide:function(){this._bFullscreenReset=true;this.setFullScreen(this._bPreviouslyFullscreen);},onAfterShow:function(){if(this.byId("sapInoPanelAnalytics")&&this.byId("sapInoPanelAnalytics").getDomRef()&&this.byId("sapInoPanelAnalytics").getDomRef().querySelector(".sapMPanelContent")){var c=this.byId("sapInoPanelAnalytics").getDomRef();var s=c.querySelector(".sapMPanelContent").style.height;if(s==="0px"||s==="100%"){var t=jQuery(c.querySelector(".sapInoHomeTitledPanelNav"));c.querySelector(".sapMPanelContent").style.height=(jQuery(c).height()-t.height()-parseInt(t.css("padding-top"),10)-parseInt(t.css("padding-bottom"),10))+"px";}}},setParameters:function(Q,c){Q=Q||{};var i=Q.campaign;this.setViewProperty("/List/VARIANT",c.ACTION);this.setViewProperty("/List/CAMPAIGN",i);},getList:function(){return this.byId("reportlist");},bindList:function(){var t=this;if(this.getViewProperty("/List/VARIANT")===v.CUSTOM_REPORTS){}else if(this.getViewProperty("/List/CAMPAIGN")&&this.getViewProperty("/List/VARIANT")==="standard"){this.getModel("data").read("/CampaignSmall("+this.getViewProperty("/List/CAMPAIGN")+")",{success:function(c){t.bindItems(c);}});}else{this.bindItems();}},bindItems:function(c){var t=this;var i=this.getCurrentVariant();var r=[];if(i.FILTER&&i.FILTER_VALUE){r=[new F(i.FILTER,"EQ",i.FILTER_VALUE)];}if(i.ACTION===v.MY&&this.getViewProperty("/List/CAMPAIGN")){r.push(new F("CAMPAIGN_ID","EQ",this.getViewProperty("/List/CAMPAIGN")));}if(!C.isComponentActive('sap.ino.config.USAGE_REPORTING_ACTIVE')){var u=new sap.ui.model.Filter("IS_USAGE_REPORT",sap.ui.model.FilterOperator.NE,1);r.push(u);}var s=this.getList();var G=sap.ino.commons.models.core.CodeModel.getFormatter("sap.ino.xs.object.analytics.ReportTemplate.Root");s.bindItems({path:i.PATH,filters:r,factory:function(I,w){var x={DELETE_BUTTON_VISIBLE:true,CHART_VISIBLE:true};var y=t.createFragment("sap.ino.vc.analytics.fragments.CardListItem",I);var z=w.getObject();var E;if(typeof(z.CONFIG)==='string'){E=JSON.parse(z.CONFIG);}else{E=JSON.parse(JSON.stringify(z.CONFIG));}x.TITLE=E.Title||G(z.CODE);x.CAMPAIGN_NAME=z.CAMPAIGN_NAME||(c&&c.SHORT_NAME)||t.getText("ANALYTICS_LIST_CROSS_CAMPAIGN");var K=z.CAMPAIGN_COLOR||(c&&c.COLOR_CODE);if(K&&K.length===6){K="background-color: #"+K;}x.CAMPAIGN_COLOR="<div style=\"height: 4px; width: 200px; "+K+" \" />";if(t.getViewProperty("/List/VARIANT")===v.STANDARD){x.DELETE_BUTTON_VISIBLE=false;}if(c&&E.Parameters&&E.Parameters.Campaign){E.Parameters.Campaign.Selection=[c.ID];}if(!b.checkMandatoryParameters(E)){x.CHART_VISIBLE=false;x.UNIT=t.getText("ANALYTICS_LIST_MISSING_PARAMETER");}else{var N=jQuery.extend({},E.Views[E.SelectedView],E.Tile);N.Chart.Type=n[(N.Content||N.Chart.Type.split("/")[1]).toLowerCase()];var P=t.getReadParameter(E,N);var Q=N.Unit||N.Tile.Unit;x.UNIT=Q?t.getText(Q):undefined;P.success=function(U){var W=t.createChart(N);W.setTooltip(t.createChartTooltip(U.results,N));t.addChartItems(W,U.results,N);if(y.getContent().length>0){var X=y.getContent()[0].getItems()[2].getItems()[1];X.removeAllItems();X.addItem(W);}};t.oDataModel.read("/"+E.DataSource,P);}y.setModel(new J(x),"tile");return y;},events:{dataRequested:function(){jQuery.each(t.getBusyControls(),function(I,w){if(jQuery.type(w.setBusy)==="function"){w.setBusy(true);}});},dataReceived:function(){jQuery.each(t.getBusyControls(),function(I,w){if(jQuery.type(w.setBusy)==="function"){w.setBusy(false);}});}}});},onDelete:function(E){var c=this.getList();var i=E.getSource().getParent().getParent().getParent();var r=/(.+)?(?:\(|（)(.+)(?=\)|）)/.exec(i.getBindingContext("data").sPath)[2];var s=parseInt(r,0);var t=this.getView();M.confirm(this.getText("MSG_DEL_CONFIRM"),{onClose:function(u){if(u!==M.Action.OK){return;}else{t.setBusy(true);var w=R.del(s);w.always(function(){t.setBusy(false);});w.done(function(){c.removeItem(i);});w.fail(function(){});}}});},onItemPress:function(E){var i=E.getSource();var c=i.getBindingContext("data");var P=c.sPath.substr(1);this.navigateTo("report",{code:P});},initFullScreen:function(){if(this._bFullscreenReset===undefined||this._bFullscreenReset===true){this._bPreviouslyFullscreen=this.getFullScreen();}this.setFullScreen(true);this._bFullscreenReset=false;},getReadParameter:function(c,t){var r;if(t.Sorter){r=[new S({path:t.Sorter.Path,descending:t.Sorter.Descending})];}var s;if(t.Dimension&&t.Dimension[0]){s=[t.Dimension,t.Dimensions[0]];}else if(t.Dimensions&&t.Dimensions[0]){s=[t.Dimensions[0]];}if(t.Sorter&&s[0]!==t.Sorter.Path){s.push(t.Sorter.Path);}if(t.Measure&&t.Measure[0]){s.push(t.Measure,t.Measures[0]);}else if(t.Measures&&t.Measures[0]){s.push(t.Measures[0]);}var u=[];for(var i=0;i<s.length;i++){if(s[i]){u.push(s[i]);}}s=u;return{async:true,sorters:r,urlParameters:{"$select":s.join(","),"$top":t.Top||5}};},createChart:function(t){var c;var i={"size":"S","tooltip":this.getText("ANALYTICS_LIST_MISSING_PARAMETER")};switch(t.Chart.Type){case"Area":c=new A(i);break;case"Comparison":c=new e(i);break;case"HarveyBall":c=new H(jQuery.extend(i,{total:100,totalScale:" ",showFractions:true}));break;case"Radial":c=new f(i);break;default:c=new d(i);break;}c.addStyleClass("sapUiSmallMargin");c.addStyleClass("sapUiMediumMarginBegin");c.addStyleClass("sapInoAnalyticsDefaultChart");return c;},addChartItems:function(c,i,t){var s=t.Chart.Type;var r=t.Dimension||t.Dimensions[0];var u=t.Measure||t.Measures[0];switch(s){case"Column":jQuery.each(i,function(I,E){c.addColumn(new sap.suite.ui.microchart.ColumnMicroChartData({color:o[I%4],label:E[r],value:E[u]}));});break;case"Area":var w=new sap.suite.ui.microchart.AreaMicroChartItem({color:"Good"});var x=100/i.length;jQuery.each(i,function(I,E){w.addPoint(new sap.suite.ui.microchart.AreaMicroChartPoint({x:x*I,y:E[u]}));});c.addLine(w);break;case"Comparison":jQuery.each(i,function(I,E){c.addData(new sap.suite.ui.microchart.ComparisonMicroChartData({color:o[I%4],title:E[r],value:E[u]}));});break;case"HarveyBall":var y=0;jQuery.each(i,function(I,E){c.addItem(new sap.suite.ui.microchart.HarveyBallMicroChartItem({color:"Good",fractionLabel:E[r],fraction:E[u],fractionScale:" "}));y+=E[u];});if(y){c.setTotal(y);}break;case"Radial":var z=0;jQuery.each(i,function(I,E){z+=E[u];});c.setTotal(z);c.setFraction(i[0][u]);c.setValueColor("Good");break;default:jQuery.each(i,function(I,E){c.addColumn(new sap.suite.ui.microchart.ColumnMicroChartData({color:o[I%4],label:E[r],value:E[u]}));});break;}},createChartTooltip:function(c,i){var t="";jQuery.each(c,function(I,r){t+=r[i.Dimension||i.Dimensions[0]]+" "+(r[i.Measure||i.Measures[0]]||0);t+=(I!==c.length)?"\n":"";});return t;},getQuery:function(){var Q={};var c=this.getViewProperty("/List/CAMPAIGN");if(c){Q.campaign=c;}return Q;},onVariantPress:function(s){var Q=this.getQuery();this.removeInvalidFilters(Q);if(s){this.navigateTo(this.getRoute(true),{variant:s,query:Q},true,true);}else{this.navigateTo(this.getRoute(false),{query:Q},true,true);}},constructCustomReportsInfo:function(s){var i=this.getModel("user").getProperty("/privileges/sap.ino.xs.rest.admin.application::execute");var c=this.getModel("user").getProperty("/privileges/sap.ino.ui::backoffice.access");this.getView().getModel("list").setProperty("/IS_INN_MGR",i);this.getView().getModel("list").setProperty("/BACKOFFICE_ACCESSABLE",c);this.getView().getModel("list").setProperty("/CURRENT_ACTION_SELECTED",s);if(!s){this.getView().getModel("list").setProperty("/CURRENT_ACTION_SELECTED",v.MY);}if(!this.getView().getModel("customReport")){var r=new J();this.getView().setModel(r,'customReport');}if(s===v.CUSTOM_REPORTS){if(!C.getCustomReportsEnable()){this.navigateTo(this.getRoute(true),{variant:v.MY,query:{}},true,true);}this.getXCSRFTOKEN();this.byId("reportlist").setVisible(false);this.byId('customReports').setVisible(true);this.getCustomReportsInfo();}else{this.byId('customReports').setVisible(false);this.byId("reportlist").setVisible(true);}},getCustomReportsInfo:function(){var r=this.byId('customReports');r.removeAllItems();r.destroyItems();var t=this;var c=sap.ui.xmlfragment({id:t.getView().getId(),fragmentName:"sap.ino.vc.analytics.fragments.CustomReportRichTxt"},t);c.attachReady(function(){this.bindProperty("value",{path:'customReport>/content'});});r.addItem(c);var i=new h({sanitizeContent:true,preferDOM:false,visible:{parts:['customReport>/hasContent','customReport>/EDIT_STATUS','list>/BACKOFFICE_ACCESSABLE'],formatter:function(x,E,y){return x&&!E&&y;},type:null},content:{model:"customReport",path:'/content',formatter:t.formatter.wrapHTML}});r.addItem(i);var s=new j({text:this.getText("ANALYITCS_CUSTOM_REPORTS_TEXT_NO_DATA"),visible:{parts:['customReport>/hasContent','customReport>/EDIT_STATUS'],formatter:function(x,E){return!x&&!E;},type:null}});r.addItem(s);var u={"ACTION":"QUERY"};var U=C.getBackendRootURL()+"/sap/ino/xs/rest/backoffice/customReports.xsjs";var w=jQuery.ajax({url:U,headers:{"X-CSRF-Token":t._xCSRFToken},data:JSON.stringify(u),type:"POST",contentType:"application/json; charset=UTF-8",async:false});w.done(function(x,y){var z=t.getView().getModel("customReport");z.setData(x.data);z.setProperty("/old_content",z.getProperty("/content"));z.setProperty("/EDIT_STATUS",false);if(z.getProperty("/hasContent")){z.setProperty("/CAN_CREATE",false);z.setProperty("/CAN_DELETE",true);z.setProperty("/CAN_MODIFY",true);}else{z.setProperty("/CAN_CREATE",true);z.setProperty("/CAN_DELETE",false);z.setProperty("/CAN_MODIFY",false);}});},beforeEditorInit:function(c){c.mParameters.configuration.paste_data_images=true;c.mParameters.configuration.automatic_uploads=true;c.mParameters.configuration.powerpaste_word_import="clean";c.mParameters.configuration.powerpaste_html_import="clean";c.mParameters.configuration.images_upload_handler=function(i,s,r){var t=i.blob();var u="CUSTOM_REPORT";if(t){l.uploadFileIncludeFileLabel(t,u).done(function(w){s(C.getAttachmentDownloadURL(w.attachmentId));}).fail(function(){r();});}};c.mParameters.configuration.paste_postprocess=function(i,r){window.tinymce.activeEditor.uploadImages();};},getXCSRFTOKEN:function(){var t=this;var P=window.location.protocol+'//'+window.location.host+"/sap/ino/xs/rest/common/ping.xsjs";var c=jQuery.ajax({url:P,headers:{"X-CSRF-Token":"Fetch"},type:"GET",contentType:"application/json; charset=UTF-8",async:false});c.done(function(r,s,i){t._xCSRFToken=i.getResponseHeader("X-CSRF-Token");});},onCreateCustomReportStyle:function(){var c=this.getView().getModel("customReport");c.setProperty("/CAN_CREATE",false);c.setProperty("/ACTION","CREATE");c.setProperty("/EDIT_STATUS",true);},onModifyCustomReportStyle:function(){var c=this.getView().getModel("customReport");c.setProperty("/CAN_MODIFY",false);c.setProperty("/ACTION","UPDATE");c.setProperty("/EDIT_STATUS",true);},onDeleteCustomReportStyle:function(){var c=this.getView().getModel("customReport");c.setProperty("/CAN_DELETE",false);var t=this;var i=function(){var r={"ACTION":"DELETE"};var s=t.byId('customReports');s.setBusy(true);var u=C.getBackendRootURL()+"/sap/ino/xs/rest/backoffice/customReports.xsjs";var w=jQuery.ajax({url:u,headers:{"X-CSRF-Token":t._xCSRFToken},data:JSON.stringify(r),type:"POST",contentType:"application/json; charset=UTF-8",async:false});w.done(function(x){s.setBusy(false);if(x.type==="S"){k.show(t.getText("ANALYITCS_CUSTOM_REPORTS_DELETE_SUCCESSFULLY"));t.constructCustomReportsInfo(v.CUSTOM_REPORTS);}else{c.setProperty("/CAN_DELETE",true);k.show(x.message);}});w.fail(function(x){s.setBusy(false);c.setProperty("/CAN_DELETE",true);k.show(x.responseText);});};M.show(this.getText("ANALYITCS_CUSTOM_REPORTS_DELETE_BOX_MSG"),{title:this.getText("ANALYITCS_CUSTOM_REPORTS_DELETE_BOX_TITLE"),icon:M.Icon.WARNING,actions:[M.Action.YES,M.Action.NO],onClose:function(s){if(s===M.Action.YES){i();c.setProperty("/EDIT_STATUS",false);}else{c.setProperty("/CAN_DELETE",true);}}});},onCustomReportStyleCancel:function(){var c=this.getView().getModel("customReport");var t=this;if(c.getProperty("/old_content")===c.getProperty("/content")){this.constructCustomReportsInfo(v.CUSTOM_REPORTS);}else{M.show(this.getText("ANALYITCS_CUSTOM_REPORTS_CANCEL_BOX_MSG"),{title:this.getText("ANALYITCS_CUSTOM_REPORTS_CANCEL_BOX_TITLE"),icon:M.Icon.WARNING,actions:[M.Action.YES,M.Action.NO],onClose:function(s){if(s===M.Action.YES){c.setProperty("/ACTION",null);t.constructCustomReportsInfo(v.CUSTOM_REPORTS);}}});}},hasPendingChanges:function(){var c=this.getView().getModel("customReport");if(c&&c.getProperty("/old_content")!==c.getProperty("/content")){return true;}return false;},resetPendingChanges:function(){var c=this.getView().getModel("customReport");if(c&&c.getProperty("/old_content")!==c.getProperty("/content")){c.setProperty("/content",c.getProperty("/old_content"));}},cancelOperationAction:function(){var s=this.byId("sapInoCampHomeIdeasButtons");s.setSelectedKey(v.CUSTOM_REPORTS);},onCustomReportStyleSave:function(){var c=this.getView().getModel("customReport");var t=this;var r={"ACTION":c.getProperty("/ACTION"),"CONTENT":c.getProperty("/content")};if(!c.getProperty("/ACTION")){return;}var i=this.byId('customReports');i.setBusy(true);var u=C.getBackendRootURL()+"/sap/ino/xs/rest/backoffice/customReports.xsjs";var s=jQuery.ajax({url:u,headers:{"X-CSRF-Token":t._xCSRFToken},data:JSON.stringify(r),type:"POST",contentType:"application/json; charset=UTF-8",async:false});s.done(function(w,x){i.setBusy(false);if(w.type==="S"){k.show(t.getText("ANALYITCS_CUSTOM_REPORTS_SAVE_SUCCESSFULLY"));t.constructCustomReportsInfo(v.CUSTOM_REPORTS);}else{k.show(w.message);}});s.fail(function(w){i.setBusy(false);k.show(w.responseText);});}}));});
