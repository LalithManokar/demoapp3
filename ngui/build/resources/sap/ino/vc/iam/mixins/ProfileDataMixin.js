sap.ui.define(["sap/ino/commons/application/Configuration","sap/ino/commons/models/object/UserSettings","sap/ino/commons/models/object/Attachment","sap/m/MessageToast","sap/ino/commons/models/core/ModelSynchronizer","sap/ino/commons/models/object/PersonalizeSetting"],function(C,U,A,M,a,P){"use strict";var b=function(){throw"Mixin may not be instantiated directly";};b.getProfileDataSetting=function(){var u=C.getCurrentUser().USER_ID;var o=new U(u,{continuousUse:true,actions:["updateUserLocale"],readSource:{model:this.getDefaultODataModel()}});this.setObjectModel(o);this.bindDefaultODataModel(u);if(this._oUserDataModel){a.addAOInstanceDependency(o,this._oUserDataModel,function(c,d){if(c&&c.getProperty("/Settings")&&d){d.setProperty("/IMAGE_ID",c.getProperty("/Settings").TITLE_IMAGE_ID);}});}};b.formattermailLanguageText=function(d,c){return d;};b.setUserDataModel=function(u){this._oUserDataModel=u;};b.getODataEntitySet=function(){return"Identity";};b.onFileUploaderChange=function(e){var f=e.getSource();var F=e.getParameter("files");f.setBusy(true);A.prepareFileUploader(f,F);};b.onFileUploaderComplete=function(e){var r=A.parseUploadResponse(e.getParameter("responseRaw"));var f=e.getSource();if(r){var o=this.getObjectModel();if(r.success){o.setUserImage({"ATTACHMENT_ID":r.attachmentId,"FILE_NAME":r.fileName,"MEDIA_TYPE":r.mediaType});}else{M.show(this.getText("SETTINGS_MSG_USER_IMAGE_FAILED"));}}else{M.show(this.getText("SETTINGS_MSG_USER_IMAGE_ERROR"));}f.setBusy(false);f.clear();};b.onImageSettingClear=function(e){var o=this.getObjectModel();o.clearUserImage();var f=this.byId("imageSettingUploader");f.setValue(null);};b.onImageSettingCrop=function(){var i=this.byId("imageSettingCropping");this._cropImage(i);};b.formatConsentTermsCondiftions=function(v){return C.getSystemSetting("sap.ino.config.TERMS_AND_CONDITIONS_ACTIVE")==='1';};b._cropImage=function(i){var t=this;var d=jQuery.Deferred();var f=i.crop();if(f){jQuery.sap.require("sap.ino.commons.models.object.Attachment");var A=sap.ino.commons.models.object.Attachment;var o=t.getObjectModel();var s=o.getProperty('/Settings/TITLE_IMAGE_ID');A.uploadFile(f,null,s,true).done(function(r){o.setUserImage({"ATTACHMENT_ID":r.attachmentId||s,"FILE_NAME":r.fileName,"MEDIA_TYPE":r.mediaType});d.resolve({messages:[{"TYPE":"I","MESSAGE":"SETTINGS_MSG_USER_IMAGE_CROP","MESSAGE_TEXT":t.getText("SETTINGS_MSG_USER_IMAGE_CROP"),"REF_FIELD":""}]});}).fail(function(){M.show(t.getText("SETTINGS_MSG_USER_IMAGE_CROP_FAILED"));d.reject();});}else{d.resolve();}return d.promise();};b.onSettingsOk=function(){var t=this;var n=t.byId("settingMAIL");var _=function(){var o=t.getObjectModel();var l=t.byId("settingLOCALE");var h=t.byId("settingHCB");var H=h.getSelected()?U.Theme.HCB:"";t._sHCBPropOLD=o._oBeforeData.Settings.THEME;t._sHCBPropOLD=(t._sHCBPropOLD===null)?"":t._sHCBPropOLD;t._sLocalePropOLD=o._oBeforeData.Settings.LOCALE;t._sLocalePropOLD=(t._sLocalePropOLD===null)?"":t._sLocalePropOLD;t._sConsentTermsConditionPropOLD=o._oBeforeData.Settings.CONSENT_TERMS_CONDITIONS;t._sConsentTermsConditionPropOLD=(t._sConsentTermsConditionPropOLD===null)?"":t._sConsentTermsConditionPropOLD;var g=[{SECTION:"locale",KEY:"locale",VALUE:l.getSelectedKey()},{SECTION:"notification",KEY:"mail",VALUE:n&&n.getSelected()?U.Mail.Inactive:U.Mail.Active},{SECTION:"ui",KEY:"theme",VALUE:H}];if(C.getSystemSetting("sap.ino.config.TERMS_AND_CONDITIONS_ACTIVE")==='1'){var j=t.byId("settingTermsConditions");g.push({SECTION:"system",KEY:"consent_terms_condition",VALUE:j&&j.getSelected()?0:1});}var r=o.updateUserSettings(g);o.modify();r.done(function(){C.refreshBackendConfiguration();if(t.isEnableNewNotification){t.getNewNotificationSetting();t.getNewFeedsSetting();}else{t.getNotificationSetting();t.getFeedsSetting();}t.getOwnerComponent().getModel("user").setProperty("/data/IDENTITY_IMAGE_ID",o.getProperty("/IDENTITY_IMAGE_ID"));M.show(t.getText("FEEDS_SETTING_SAVE_SUCCESS"));});r.always(function(){var s=o.getProperty("/Settings/THEME");s=(s===null)?"":s;var L=o.getProperty("/Settings/LOCALE");L=(L===null)?"":L;if(C.getSystemSetting("sap.ino.config.TERMS_AND_CONDITIONS_ACTIVE")==='1'&&o.getProperty("/Settings/CONSENT_TERMS_CONDITIONS")!==t._sConsentTermsConditionPropOLD){location.reload();return;}var R=(L!==t._sLocalePropOLD)||(s!==t._sHCBPropOLD);if(R){t._openRestartDialog();}});};var c=function(){var D=jQuery.Deferred();var N={KEY:[{CODE:null,MAPPING_SETTING_CODE:"KEY",OBJECT_TYPE_CODE:"NOTIFICATION_KEY",SETTING_VALUE:-1,SUBCATEGORY_CODE:null}]};if(n&&!n.getSelected()){N={KEY:[{CODE:null,MAPPING_SETTING_CODE:"KEY",OBJECT_TYPE_CODE:"NOTIFICATION_KEY",SETTING_VALUE:0,SUBCATEGORY_CODE:null}]};}P.updateNotificationSettings({notification:N}).done(function(){D.resolve();}).fail(function(){D.reject();});return D.promise();};var d=function(){var D=jQuery.Deferred();var N={NEWKEY:[{ACTION_CODE:"NEWKEY",ACTION_TYPE_CODE:"NEWKEY",SETTING_VALUE:-1}]};if(n&&!n.getSelected()){N={NEWKEY:[{ACTION_CODE:"NEWKEY",ACTION_TYPE_CODE:"NEWKEY",SETTING_VALUE:0}]};}P.updateNewNotificationSettings({notification:N}).done(function(){D.resolve();}).fail(function(){D.reject();});return D.promise();};var e=function(){var D=jQuery.Deferred();var F={"feeds":{"CAMPAIGN_SETTING_VALUE":false,"IDEA_SETTING_VALUE":false,"TAG_SETTING_VALUE":false}};if(n&&!n.getSelected()){F={"feeds":{"CAMPAIGN_SETTING_VALUE":true,"IDEA_SETTING_VALUE":true,"TAG_SETTING_VALUE":true}};}P.updateFeedsSettings(F).done(function(){D.resolve();}).fail(function(){D.reject();});return D.promise();};var f=function(){var D=jQuery.Deferred();var N={"newfeeds":{"FEEDS_KEY":-1,"CAMPAIGN_SETTING_VALUE":0,"IDEA_SETTING_VALUE":0,"TAG_SETTING_VALUE":0}};if(n&&!n.getSelected()){N={"newfeeds":{"FEEDS_KEY":1,"CAMPAIGN_SETTING_VALUE":1,"IDEA_SETTING_VALUE":1,"TAG_SETTING_VALUE":1}};}P.updateNewFeedsSettings(N).done(function(){D.resolve();}).fail(function(){D.reject();});return D.promise();};var i=this.byId("imageSettingCropping");if(t.isEnableNewNotification){jQuery.when(this._cropImage(i),d(),f()).done(_);}else{jQuery.when(this._cropImage(i),c(),e()).done(_);}};return b;});
