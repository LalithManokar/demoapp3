sap.ui.define(["sap/ino/vc/commons/BaseObjectController","sap/ino/vc/commons/mixins/MailMixin","sap/ui/model/json/JSONModel","sap/ino/commons/application/Configuration","sap/ui/Device","sap/ino/commons/models/object/PersonalizeSetting","sap/m/MessageBox","sap/m/MessageToast","sap/ino/commons/models/object/Attachment","sap/ino/commons/models/core/CodeModel","sap/ino/vc/commons/mixins/UserGroupMixin","sap/ino/commons/formatters/BaseFormatter","sap/ui/core/format/NumberFormat","sap/ino/vc/iam/mixins/NotificationSettingMixin","sap/ino/vc/iam/mixins/FeedsSettingMixin","sap/ino/vc/iam/mixins/ProfileDataMixin","sap/ino/vc/iam/mixins/UserCommonMixin","sap/ino/controls/QuickViewGroupDimension","sap/ui/core/format/DateFormat",'sap/ui/export/library','sap/ui/export/Spreadsheet'],function(B,M,J,C,D,P,a,b,A,c,U,d,N,e,F,f,g,Q,h,j,S){"use strict";return B.extend("sap.ino.vc.iam.mySetting",jQuery.extend({},U,e,f,F,g,{formatter:jQuery.extend({helpMenuButton:function(s){return s.phone;},fullScreenToggle:function(s){return!s.desktop&&window.location.protocol==="https:";},displayTermsConditions:function(){return C.isComponentActive("sap.ino.config.DISPLAY_TERMS_CONDITIONS");},termsConditions:function(s){if(s===null||s===undefined){return undefined;}var m=this.getView().getModel("module");return m.getProperty(s);},version:function(){return this._i18n.getResourceBundle().getText("ABOUT_VERSION_FLD",[this._oComponent.getVersion(),this._oComponent.getVersionTimestamp()]);},text:function(t){return this._i18n.getResourceBundle().getText(t);},icon:function(i){if(jQuery.isNumeric(i)){i=C.getAttachmentTitleImageDownloadURL(i);}else if(i){i="/"+i;}else{i="sap-icon://error";}return i;},visibleWithSearch:function(s,p,l){return(p!==undefined&&!p)||!s||(l!==undefined&&!l);},visibleAppTitle:function(p,t){if(t.length===0||t.match(/^\s+$/g)){var i=true;}return(p!==undefined&&!p)&&(i===undefined||!i);},generateMailURL:function(m){return sap.m.URLHelper.normalizeEmail(m);},notificationTooltip:function(n){if(n){var o=N.getIntegerInstance({style:"short"});var i=o.format(n);if(i===0){return this._i18n.getResourceBundle().getText("SHELL_EXP_NOTIFICATION_EMPTY");}else if(i===1){return this._i18n.getResourceBundle().getText("SHELL_EXP_NOTIFICATION_SINGLE");}else{return this._i18n.getResourceBundle().getText("SHELL_EXP_NOTIFICATION_COUNT",[o.format(n)]);}}return this._i18n.getResourceBundle().getText("SHELL_EXP_NOTIFICATION_EMPTY");},notificationText:function(t){return t.split("{").join("").split("}").join("");},clipboardObjectName:function(s){return s?this._i18n.getResourceBundle().getText("CLIPBOARD_OBJECT_NAME_"+s):"";},navigationItemSelected:function(r,n){if(!r||!n){return false;}if(r===n||r===n+"variant"||r+"list"===n){return true;}var i=jQuery.grep(this.menu.Navigation,function(t){return r===t.TO||r===t.TO+"variant"||r+"list"===t.TO;});if(i.length===0&&r.indexOf("-")>-1){var R=r.split("-");if(R[1]===n||R[1]===n+"variant"){return true;}var s=jQuery.grep(this.menu.Navigation,function(t){return R[1]===t.TO||R[1]===t.TO+"variant";});if(s.length===0&&r.split("-")[0]+'list'===n){return true;}}return false;},navigationItemVisible:function(i,k,m,p,n){var v=(!p||(p&&m))&&(k||(!k&&i));if(n==="evalreqlist"){return v&&C.getSystemSetting("sap.ino.config.EVAL_REQ_ACTIVE")==="1";}if(n==="rewardlist"){return v&&(this.getModel("user").getProperty("/privileges/sap.ino.ui::campaign_manager")||this.getModel("user").getProperty("/privileges/sap.ino.xs.rest.admin.application::execute"))&&C.getSystemSetting("sap.ino.config.REWARD_ACTIVE")==="1";}if(n!=="expertfinder"){return v;}else{return v&&(this.getView().getModel("config").oData["sap.ino.config.EXPERT_FINDER_ACTIVE"]==="1");}},historyEnable:function(i){return Number(i)>=1;},historyTooltip:function(H,i){if(H.length){return this.getText("PAGE_TIT_"+(!H[0].title?"HOME":H[0].title.toUpperCase()));}else{return"";}},historyMenu:function(t){return this.getText("PAGE_TIT_"+(!t?"HOME":t.toUpperCase()));},formatChangeLogValue:function(s,i,k){if(k){return d.toDate(k);}else if(i){return i;}else if(s){return s;}else{return"";}},formatIdentityCode:function(s){return c.getFormatter("sap.ino.xs.object.iam.IdentityLogSetting.Root")(s);}},B.prototype.formatter),requestQueue:[],onInit:function(){B.prototype.onInit.apply(this,arguments);this.setViewProperty("/EDIT",true);this.setViewProperty("/ATTACHMENT_UPLOAD_URL",A.getEndpointURL());this.aBusyControls=[this.byId("userSettings")];var s=C.getSystemSettingsModel();this.isEnableNewNotification=s.getProperty("/sap.ino.config.ENABLE_NEW_NOTIFICATION")==="0"?false:true;this.setViewProperty("/ENABLE_NEW_NOTIFICATION",this.isEnableNewNotification);this.enableFeedEmail=s.getProperty("/sap.ino.config.SWITCH_OFF_FEED_EMAIL")==="0"?true:false;this.setViewProperty("/ENABLE_FEED_EMAIL",this.enableFeedEmail);},onBeforeRendering:function(){this.getProfileData();this.getPersonalizeSetting();if(this.isEnableNewNotification){this.getNewNotificationSetting();}else{this.getNotificationSetting();}this.getNewFeedsSetting();this.bindIdentityLog();this.getMemberGroup();this.bindUserGroup();this.getProfileDataSetting();},onAfterRendering:function(){},getPersonalizeSetting:function(){var s=this;var i=P.defaultPesonalize;P.getSettings().done(function(k){var l=$.extend(i,k.RESULT||{});s.getView().setModel(new J(l),'PERSONALIZE');C.setPersonalize(l);});},personalizeSave:function(){var s=this;var p=s.getView().getModel('PERSONALIZE');var i=p.getData();P.updateSettings({personalize:i}).done(function(){b.show(s.getText("PERSONALIZE_CHANGE_SUCCESS"));s.getView().setModel(new J(i),'PERSONALIZE');});},onSettingTabSelect:function(E){var s=E.getSource();var o=s.getSelectedKey();if(o.indexOf('mySettingIdentityCardPage')>-1){this.getProfileData();}},getProfileData:function(){var s=this;var i=C.getCurrentUser().USER_ID;s._oIdentityModel=new J();if(C.getUserProfileByTextURL(i)){s._oIdentityModel.loadData(C.getUserProfileByTextURL(i),{"USER_ID":i},true,"GET");s._oIdentityModel.attachRequestCompleted(null,function(){var k=s._oIdentityModel.getData();var l=s.byId("identityLogList");k.open_group=C.getSystemSetting('sap.ino.config.OPEN_GROUP_FOR_COMMUNITY_USER')*1;k.ENABLE_GAMIFICATION=s.getView().getModel("config").getProperty("/ENABLE_GAMIFICATION")===1?true:false;s._oIdentityModel.setData(k);s.getView().setModel(s._oIdentityModel,"identityData");if(k.ENABLE_GAMIFICATION){s.constructGamificationDimension(s._oIdentityModel,s.byId('mySettingIdentityCardPage'));}if(l){l.bindItems({path:"data>/"+this.getIdentityEntityName()+"("+i+")/IdentityLog",sorter:new sap.ui.model.Sorter("CHANGED_AT",true),template:this.getFragment("sap.ino.vc.iam.fragments.IdentityLogTemplate")});}},s);}},exportProfileData:function(){var E=j.EdmType;var i=[];var r,s,o,k;var l=this;var I=C.getCurrentUser().USER_ID;l._oIdentityModel=new J();if(C.getUserProfileByTextURL(I)){l._oIdentityModel.loadData(C.getUserProfileByTextURL(I),{"USER_ID":I},true,"GET");l._oIdentityModel.attachRequestCompleted(null,function(){var m=l._oIdentityModel.getData();i=[{label:l.getText("USER_DETAILS_FIRST_NAME"),property:'Firstname',type:E.String},{label:l.getText("SORT_MIT_LAST_NAME"),property:'Lastname',type:E.String},{label:l.getText("IDEA_LIST_REWARD_LIST_GAMIFICATION_FLD_FULL_NAME"),property:'Fullname',type:E.String},{label:l.getText("IDEA_LIST_REWARD_LIST_GAMIFICATION_FLD_USER_NAME"),property:'Username',type:E.String},{label:l.getText("SORT_MIT_VALID_TO"),property:'Validationto',type:E.String},{label:l.getText("USER_DETAILS_PHONE"),property:'Phone',type:E.String},{label:l.getText("USER_DETAILS_EMAIL"),property:'Email',type:E.String},{label:l.getText("USER_DETAILS_MOBILE"),property:'Mobile',type:E.String},{label:l.getText("USER_DETAILS_COST_CENTER"),property:'Costcenter',type:E.String},{label:l.getText("USER_DETAILS_COMPANY"),property:'Company',type:E.String},{label:l.getText("USER_DETAILS_OFFICE"),property:'Office',type:E.String},{label:l.getText("USER_DETAILS_ORGANIZATION"),property:'Organization',type:E.String},{label:l.getText("USER_DETAILS_COUNTRY"),property:'Country',type:E.String},{label:l.getText("USER_DETAILS_ZIP_CODE"),property:'Zipcode',type:E.String},{label:l.getText("USER_DETAILS_CITY"),property:'City',type:E.String},{label:l.getText("USER_DETAILS_STREET"),property:'Street',type:E.String}];r=[{Lastname:m.LAST_NAME,Firstname:m.FIRST_NAME,Username:m.USER_NAME,Fullname:m.NAME,Costcenter:m.CORP_INFO.COST_CENTER,Mobile:m.CONTACT_DETAIL.MOBILE,Email:m.CONTACT_DETAIL.EMAIL,Validationto:m.VALIDATION_TO,Phone:m.CONTACT_DETAIL.PHONE,Office:m.CORP_INFO.OFFICE,Company:m.CORP_INFO.COMPANY,Organization:m.ORGANIZATION,Street:m.ADDR_INFO.STREET,City:m.ADDR_INFO.CITY,Country:m.ADDR_INFO.COUNTRY,Zipcode:m.ADDR_INFO.ZIP_CODE}];var n=h.getDateTimeInstance({pattern:"dd-MM-yyyy_HH-mm"});k=l.getText('USER_DETAILS_MY_PERSONAL_DATA')+n.format(new Date())+".xlsx";s={workbook:{columns:i},dataSource:r,fileName:k};o=new S(s);o.build().finally(function(){o.destroy();});},l);}},bindIdentityLog:function(){var i=C.getCurrentUser().USER_ID;if(this.byId("changeHistoryLog")){this.byId("changeHistoryLog").bindItems({path:"data>/"+this.getIdentityEntityName()+"("+i+")/IdentityLog/Results"});}},getMemberGroup:function(){var s=this;var o=C.getSystemSetting('sap.ino.config.OPEN_GROUP_FOR_COMMUNITY_USER')*1;s.setModel(new J(o),'identityData>/open_group');if(o){if(!this.requestQueue.length){this.requestQueue.push(this.getMemberGroups());this.requestQueue[0].done(function(i){s.setModel(new J(i),'identityData>/groups');});}}this.getMemberGroups().done(function(i){s.setModel(new J(i),'identityData>/groups');});},bindUserGroup:function(){var s=this;var v=this.getView();var i=v.byId('mySettingUserGroup--userGroupTable');var k=this._bindUserGroupModel();i.getBinding('rows').filter([]);k.attachRequestCompleted(function(){s.reBindSelectedData(i);});},saveUserGroup:function(){var s=this;var v=this.getView();var i=v.byId('mySettingUserGroup--userGroupTable');this.putGroupSelected(i).done(function(){var t=s.getView().byId('mySettingUserGroup--userGroupTable');var k=t.getModel('USER_GROUPS').getData();var l=k.SELECTED_NONE||false;if(t.getSelectedIndices().length===0&&!l){b.show(s.getText('USER_GROUP_UNSELECT_SUCCESS'));}else{b.show(s.getText('USER_GROUP_SELECT_SUCCESS'));}});},getIdentityEntityName:function(){return"Identity";},constructGamificationDimension:function(m,I){var q,s,k,E,l,p,n;if(!I){return;}q=I.getContent()[0];var o=m.getData().GAMIFICATION_INFO;q.removeAllDimensionGroups();if(!Array.isArray(o)){return;}for(var i=0;i<o.length;i++){k="";E="";l=0;p=0;s="";n=0;if(JSON.stringify(o[i].BADGE)!=="{}"){k=o[i].BADGE.currentBadge.NAME;E=!o[i].BADGE.nextBadge.NAME?"":o[i].BADGE.nextBadge.NAME;if(o[i].BADGE.nextBadge.NAME&&o[i].BADGE.currentBadge.NAME){l=o[i].BADGE.nextBadge.BADGE_VALUE-o[i].BADGE.currentBadge.BADGE_VALUE;}if(o[i].BADGE.nextBadge.NAME&&!o[i].BADGE.currentBadge.NAME){l=o[i].BADGE.nextBadge.BADGE_VALUE;}if(!o[i].BADGE.nextBadge.NAME&&o[i].BADGE.currentBadge.NAME){l=o[i].BADGE.currentBadge.BADGE_VALUE;}p=o[i].BADGE.nextBadge.NAME?o[i].BADGE.nextBadge.BADGE_VALUE-parseInt(o[i].TOTAL,10):0;if(JSON.stringify(o[i].BADGE.currentBadge)!=="{}"&&o[i].BADGE.currentBadge.Attachment.length>0){s=C.getAttachmentTitleImageDownloadURL(o[i].BADGE.currentBadge.Attachment[0].ATTACHMENT_ID);}if(JSON.stringify(o[i].BADGE.currentBadge)!=="{}"){var r=parseInt(o[i].TOTAL,10)-o[i].BADGE.currentBadge.BADGE_VALUE;n=r>0?r:parseInt(o[i].TOTAL,10);}else{n=parseInt(o[i].TOTAL,10);}}q.addDimensionGroup(new Q({heading:o[i].NAME,headingIcon:s,totalPoints:parseInt(o[i].TOTAL,10),pointsToNextLevel:p,startLevel:k,nextLevel:E,currentPointsBWBadge:n,diffPointsToNextLevel:l,dimensionUnit:o[i].UNIT,redeemPoints:o[i].TOTAL_FOR_REDEEM,redeemEnabled:!!o[i].REDEEM}));}}}));});
