sap.ui.define(["sap/ino/vc/commons/BaseVariantListController","sap/ui/Device","sap/ui/model/json/JSONModel","sap/ui/model/Sorter","sap/ui/core/Item","sap/ino/commons/application/Configuration","sap/ino/commons/models/core/CodeModel","sap/ui/core/mvc/ViewType","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ino/commons/formatters/ObjectListFormatter","sap/ino/controls/OrientationType","sap/ino/vc/blog/mixins/DeleteActionMixin","sap/m/MessageToast","sap/m/MessageBox","sap/ino/commons/models/aof/ApplicationObjectChange","sap/ino/vc/commons/mixins/TagGroupMixin","sap/ino/vc/commons/mixins/TagCardMixin","sap/ino/vc/blog/mixins/BlogCardMixin"],function(B,D,J,S,I,C,a,V,F,b,O,c,d,M,e,A,T,f,g){"use strict";var o={ASC:"ASC",DESC:"DESC"};var m={BLOG:"bloglist",BLOG_VARIANT:"bloglistvariant"};var s={CREATED_AT:"CREATED_AT",CHANGED_AT:"CHANGED_AT",NAME:"tolower(TITLE)"};var v={ALL:"all",MY:"my",DRAFT:"draft",PUBLISH:"publish"};var h={NONE:undefined,MY:"myBlogs",DRAFT:"draftBlogs",PUBLISH:"publishedBlogs"};var l={ADJUSTMENT_TITLE:"BLOG_LIST_TIT_ADJUSTMENT",Filter:{},Sorter:{Values:[{TEXT:"SORT_MIT_CREATED",ACTION:s.CREATED_AT,DEFAULT_ORDER:o.DESC},{TEXT:"SORT_MIT_CHANGED",ACTION:s.CHANGED_AT,DEFAULT_ORDER:o.DESC},{TEXT:"SORT_MIT_TITLE",ACTION:s.NAME,DEFAULT_ORDER:o.ASC}]},Order:{Values:[{TEXT:"ORDER_MIT_ASC",ACTION:o.ASC},{TEXT:"ORDER_MIT_DESC",ACTION:o.DESC}]},Variants:{DEFAULT_VARIANT:v.ALL,TITLE:"BLOG_LIST_TIT_VARIANTS",Values:[{TEXT:"BLOG_LIST_MIT_ALL",ACTION:v.ALL,FILTER:h.NONE,INCLUDE_DRAFT:true,VISIBLE:true,DEFAULT_SORT:s.CREATED_AT,MANAGE:false},{TEXT:"BLOG_LIST_MIT_DRAFT",ACTION:v.DRAFT,FILTER:h.DRAFT,INCLUDE_DRAFT:true,DEFAULT_SORT:s.CREATED_AT,VISIBLE:false,HIERARCHY_LEVEL:"1",MANAGE:true},{TEXT:"BLOG_LIST_MIT_PUBLISH",ACTION:v.PUBLISH,FILTER:h.PUBLISH,INCLUDE_DRAFT:false,DEFAULT_SORT:s.CREATED_AT,VISIBLE:false,HIERARCHY_LEVEL:"1",MANAGE:true}]}};var j=B.extend("sap.ino.vc.blog.List",jQuery.extend({},d,T,f,g,{list:l,initialFocus:"filterButton",view:{"List":{"SORT":s.CREATED_AT,"ORDER":undefined,"VARIANT":v.ALL,"MANAGE":false,"TAGS":[],"IS_TAGS_SELECTION":false,"CAMPAIGN":undefined,"TAGCLOUD":true,"TAGCLOUD_EXPABLE":true,"TAGCLOUD_EXP":false,"TAGCLOUD_BAR_VISIBLE":false,"IS_FILTER_SUBPAGE":true},"ORIENTATION":c.PORTRAIT,"DISABLE_ORIENTATION":true,"IS_COMMUNITY_VIEW":false},formatter:jQuery.extend({},O),onInit:function(){this.formatter.filterStyleClass=function(i){return i===undefined?"":"sapUiTinyMarginBegin";};B.prototype.onInit.apply(this,arguments);this.oViewModel=this.getModel("view");this.oViewModel.setData(this.view,true);this.addSubFilterPageContent(this.getAdditionalFilter());this.getList().addStyleClass(this.getPortraitStyle());this.getList().attachUpdateFinished(this.onUpdateFinished,this);this.initApplicationObjectChangeListeners();},show:function(E,i){var q;var k;if(E&&E.getParameter){var n=E.getParameter("arguments");q=n["?query"];k=n.variant;}else{k=i.variant;q=i;}var t=this;var p=this.getListProperty("/Variants/DEFAULT_VARIANT");this.setViewProperty("/List/VARIANT",k||p);k=this.getViewProperty("/List/VARIANT");var r=this.getVariant(k);var u;var w=this.getList().isBound("items");if(!q||!q.sort){var x=r.DEFAULT_SORT;var y=this.getSort(x)[0].DEFAULT_ORDER;q=q||{};q.sort=q.sort||x;q.sort=q.sort+" "+(q.order||y);}var R=this.hasStateChanged(this.getCurrentRoute(),k,q,D.orientation.portrait);R=R||this._bListChanged;this._bListChanged=false;if(!w||R){this.setVariantVisibility();this.setParameters(q,r);u=this.getSort(this.getViewProperty("/List/SORT"));this.setSorter(u);this.updateFilter();var z=this.getViewProperty("/ORIENTATION");this.onOrientationChange(D.system.desktop?z:D.orientation);this.setSortIcon(this.byId("panelFilterFragment--sortreverse"),this.getViewProperty("/List/ORDER"));var G=this.getVariantVisibility(k);if(G===false||typeof(G)==="undefined"){e.show(t.getText("NOT_AUTHORIZED_MESSAGE"),e.Icon.INFORMATION,t.getText("NOT_AUTHORIZED_DIALOG_TITLE"),[e.Action.OK],function(){t.navigateTo("BlogList");});return;}this.bindList();this.initialSorterItems();if(this.isFilterVisible()){this.bindTagCloud();}}this.setHelp("BLOG_LIST");},setVariantVisibility:function(){var k=this.getModel("list").getProperty("/Variants/Values");for(var i=0;i<k.length;i+=1){var n=k[i];var p=n.MANAGE||false;var q=(!p)||(p&&C.hasCurrentUserPrivilege("sap.ino.ui::campaign_manager"));this.getModel("list").setProperty("/Variants/Values/"+i+"/VISIBLE",q);}},getVariantVisibility:function(k){var n,p;n=this.getModel("list").getProperty("/Variants/Values");for(var i=0;i<n.length;i+=1){var q=n[i];if(q.ACTION===k){p=q.VISIBLE;}}return p;},getPortraitStyle:function(){return"sapInoBlogList";},getList:function(){return this.byId("objectlist");},getBindingParameter:function(){var i,k;i=this.getViewProperty("/List/VARIANT");k=this.getCurrentVariant().FILTER;var n=this.getViewProperty("/List/SEARCH");var t=this.getViewProperty("/List/TAGS");var p=this.getViewProperty("/List/CAMPAIGN");var q=jQuery.map(t,function(r){return r.ID;});return{Variant:i,VariantFilter:k,SearchTerm:n,TagIds:q,CampaignId:p};},bindList:function(){this.saveState();var i=this.getBindingParameter();var p="";var k=i.SearchTerm||"";var n=false;var q=this._check4ManagingList();p+="BlogSearchParams";p+="(searchToken='"+k+"',"+"tagsToken='"+(i.TagIds.join(",")||"")+"',"+"filterName='"+(i.VariantFilter||"")+"'"+")/Results";this.setPath("data>/"+p);if((!D.system.desktop&&D.orientation.landscape)||(D.system.desktop&&this.getViewProperty("/ORIENTATION")===c.LANDSCAPE)){n=true;}var _=function(r){var t=this;var L=this.getList().bindItems({path:this.getPath(),template:this.getItemTemplate(),sorter:this.getSorter(),filters:this.getFilter(),groupHeaderFactory:this.getGroupHeaderFactory(),events:{dataRequested:function(){jQuery.each(t.getBusyControls(),function(u,w){if(jQuery.type(w.setBusy)==="function"){w.setBusy(true);}});},dataReceived:function(){jQuery.each(t.getBusyControls(),function(u,w){if(jQuery.type(w.setBusy)==="function"){w.setBusy(false);}});if(jQuery.type(r)==="function"){r.apply(this);}}}});};_.apply(this);},_check4ManagingList:function(){var i=C.hasCurrentUserPrivilege("sap.ino.ui::campaign_manager");if(i){var k=this.getViewProperty("/List/VARIANT");var n=this.getListProperty("/Variants/Values");var p=jQuery.grep(n,function(q){return q.ACTION===k;});p=(p&&p.length>0)?p[0]:{};return p.MANAGE||false;}return false;},includeDrafts:function(){return this.getCurrentVariant().INCLUDE_DRAFT;},bindTagCloud:function(){var i=this.getBindingParameter();var p=C.getBackendRootURL()+"/sap/ino/xs/rest/common/tagcloud_blogs.xsjs";var k=this;var P=[];if(!this.includeDrafts()){P.push("EXCL_STATUS=sap.ino.config.CAMP_DRAFT");}if(i&&i.TagIds){jQuery.each(i.TagIds,function(q,r){P.push("TAG="+r);});}if(i.SearchTerm&&i.SearchTerm.length>0){P.push("SEARCHTERM="+i.SearchTerm);}if(i.VariantFilter){P.push("FILTERNAME="+i.VariantFilter);}if(P.length>0){p=p+"?"+P.join("&");}if(this._lastTagServicePath!==p){var t=new J(p);var n=this.getText("BLOG_LIST_MIT_FILTER_TAG_OTHER");t.attachRequestCompleted(null,function(){var r=t.getData().RANKED_TAG;var q=k.groupByTagGroup(r,k.getViewProperty("/List/TAGS"),n);k.setTagCloudProperty(q,t.getData().WITHOUT_GROUP!=="X");t.setData({"RANKED_TAG":q},false);this.setFilterModel(t,"tag");},this);}this._lastTagServicePath=p;},onBlogItemPress:function(E){if(this._bIsTokenPressed){this._bIsTokenPressed=false;return;}var i=E.getSource();var k=i.getBindingContext("data");if(k){this.navigateTo("blog-display",{id:k.getProperty("ID")});}},updateFilter:function(){var i=this.getViewProperty("/List/VARIANT");var k=this.getViewProperty("/List/CAMPAIGN");var n=this._check4ManagingList();var p=[];this.setFilter([]);if(k&&k!=="0"){p.push(new F("CAMPAIGN_ID",b.EQ,k));}if(p.length>0){this.addFilter(new F({filters:p,and:true}));}},onFilterCampaignChange:function(E){var i=E.getSource().getSelectedItem();if(i.getSelectedItem){i=i.getSelectedItem();}var k=i.getProperty("key");this.setViewProperty("/List/CAMPAIGN",k);this.navigateIntern(this.getQuery(),true,true);},resetFilter:function(){this.setViewProperty("/List/CAMPAIGN",undefined);B.prototype.resetFilter.apply(this,arguments);},getQuery:function(){var q={};var i=this.getViewProperty("/List/SORT");var k=this.getViewProperty("/List/ORDER");var n=this.getViewProperty("/List/SEARCH");var p=this.getViewProperty("/List/CAMPAIGN");var t=this.getViewProperty("/List/TAGS");if(i){q.sort=i;if(k){q.order=k;}}if(n){q.search=n;}if(p){q.campaign=p;}if(t&&t.length>0){q.tags=JSON.stringify(t);}return q;},setParameters:function(q,i){q=q||{};var k=this.getSort(i.DEFAULT_SORT);var n=this.checkSort(q,i.DEFAULT_SORT);var p=this.checkOrder(q,k.DEFAULT_ORDER);var t=this.checkTags(q.tags);var r=q.campaign;this.setViewProperty("/List/VARIANT",i.ACTION);this.setViewProperty("/List/SORT",n);this.setViewProperty("/List/ORDER",p);this.setViewProperty("/List/TAGS",t);this.setViewProperty("/List/IS_TAGS_SELECTION",t.length>0);this.setViewProperty("/List/SEARCH",q.search);this.setViewProperty("/List/MANAGE",i.MANAGE);this.setViewProperty("/List/CAMPAIGN",r);},getItemTemplate:function(){return this.getFragment("sap.ino.vc.blog.fragments.ListItem");},createFilterController:function(){return sap.ui.controller("sap.ino.vc.blog.Filter");},createFilterView:function(){return this.createView({type:V.XML,viewName:"sap.ino.vc.blog.Filter",controller:this._oFilterController});},createState:function(r,i,q,p){var k=B.prototype.createState.apply(this,arguments);k.query.campaign=q.campaign;return k;},onOpenCampaign:function(E){this.navigateTo("campaign",{id:E.getParameter("campaignId")});},onSetFilterBarVisible:function(){this.bindTagCloud();},getAdditionalFilter:function(){var i=this.createFragment("sap.ino.vc.blog.fragments.FilterItems",this.createIdForFilterElement());return i;},reloadData:function(){this.bindList();this.bindTagCloud();},onApplyFilter:function(){var i=this.getFilterDialog();if(JSON.stringify(this.getViewModelBackup())===JSON.stringify(this.getViewProperty("/"))){i.close();return;}var q=this.getQuery();var k=this.getViewProperty("/List/VARIANT");if(k===this.getListProperty("/Variants/DEFAULT_VARIANT")){this.navigateTo(this.getRoute(false),{query:q},true,true);}else{this.navigateTo(this.getRoute(true),{variant:k,query:q},true,true);}i.close();},formatObjectListVariantsVisible:function(i){if(!i||(i&&C.hasCurrentUserPrivilege("sap.ino.ui::campaign_manager"))){return true;}return false;},initApplicationObjectChangeListeners:function(){var t=this;t._bListChanged=false;var i=["create","del","modifyAndSubmit","submit","majorPublishSubmit","publishSubmit","unPublishSubmit"];var k=function(E){var n=E.getParameter("actionName");if(n&&i.indexOf(n)>-1&&E.getParameter("object").getMetadata().getName()==="sap.ino.commons.models.object.Blog"){t._bListChanged=true;}};A.attachChange(A.Action.Create,k);A.attachChange(A.Action.Del,k);A.attachChange(A.Action.Action,k);},showPopupTagCard:function(E){if(!this._oPopover){this._oPopover=sap.ui.xmlfragment("sap.ino.vc.tag.fragments.TagCardPopover",this);this.getView().addDependent(this._oPopover);}var t=E.getSource();var p="/SearchTagsAll(searchToken='',ID="+t.getKey()+")";var i=this.getModel("data");var k=this;i.read(p,{async:true,success:function(n){var q=new J();q.setData(n);k._oPopover.setModel(q,"Tag");jQuery.sap.delayedCall(0,k,function(){k._oPopover.openBy(t);});}});}}));j.list=l;j.routes=m;return j;});
