sap.ui.define(["sap/ino/vc/commons/BaseObjectModifyController","sap/m/Token","sap/ino/commons/models/object/Blog","sap/ino/vc/commons/TopLevelPageFacet","sap/ui/core/ResizeHandler","sap/ui/Device","sap/ui/core/HTML","sap/ino/commons/models/object/Attachment","sap/m/MessageToast","sap/ino/commons/application/Configuration"],function(B,T,a,b,R,D,H,A,M,C){"use strict";return B.extend("sap.ino.vc.blog.Modify",jQuery.extend({},b,{routes:["blog-edit","blog-create"],onInit:function(){B.prototype.onInit.apply(this,arguments);this._dViewShown=jQuery.Deferred();this.setViewProperty("/EDIT",true);this.setViewProperty("/ATTACHMENT_UPLOAD_URL",A.getEndpointURL());this._bindingTags();},onRouteMatched:function(){var c=this;B.prototype.onRouteMatched.apply(c,arguments);c._destroyRTE();jQuery.when(this._dViewShown).done(function(){c._initRTE();});c.setHelp("CAMPAIGN_BLOG_MODIFY");},createObjectModel:function(o,r,c){var k=o;var s={nodes:["Root"],actions:["submit","publish","majorPublishSubmit","publishSubmit","del"],continuousUse:true,concurrencyEnabled:true,readSource:{model:this.getDefaultODataModel()}};if(!k){var q=c["?query"]||{};try{k={OBJECT_TYPE_CODE:"CAMPAIGN",OBJECT_ID:q.campaign?parseInt(q.campaign,10):0,CAMPAIGN_ID:q.campaign?parseInt(q.campaign,10):0,NAME:q.title,DESCRIPTION:q.description,Tags:q.tags&&q.tags.split(",")};}catch(e){jQuery.sap.log.error("Failed parsing creation arguments",e,"sap.ino.vc.blog.Modify.controller");}}return new a(k,s);},onAfterHide:function(){this._dViewShown=jQuery.Deferred();this._destroyRTE();},onCampaignPressed:function(){var i=this.getObjectModel().getProperty("/CAMPAIGN_ID");this.navigateTo("campaign",{id:i},true);},onFileUploaderChange:function(e){var f=e.getSource();var F=e.getParameter("files");f.setBusy(true);A.prepareFileUploader(f,F);},onFileUploaderComplete:function(e){var r=A.parseUploadResponse(e.getParameter("responseRaw"));var f=e.getSource();if(r){var o=this.getObjectModel();o.getMessageParser().parse(r);if(r.success){o.setTitleImage({"ATTACHMENT_ID":r.attachmentId,"FILE_NAME":r.fileName,"MEDIA_TYPE":r.mediaType});}else{M.show(this.getText("BLOG_OBJECT_MSG_TITLE_IMAGE_FAILED"));}}else{M.show(this.getText("BLOG_OBJECT_MSG_TITLE_IMAGE_ERROR"));}f.setBusy(false);f.clear();},onTagChanged:function(e){var m=e.getSource();var v=e.getParameter("value");if(!v){return;}if(!e.getSource().getAggregation("tokenizer")){return;}var t=e.getSource().getAggregation("tokenizer").getAggregation("tokens");var c=v.split(",");c.forEach(function(s){s=s.trim();if(s===""){return;}var o=new T({text:s});var d;t.forEach(function(o){if(o.getProperty("text")===s){d=true;return;}});if(!d){o.bApplicationCreated=true;m.addToken(o);}});m.setValue("");},onTagTokenChanged:function(e){var m=e.getSource();if(!e.getSource().getAggregation("tokenizer")){return;}m.setValue("");},onSave:function(){this._executeAction("submit");},onPublish:function(){this._executeAction("majorPublishSubmit");},onPublishAction:function(e){var i=e.getParameter("item");if(!i){return;}this._executeAction(i.getProperty("key")||"publishSubmit");},onUnPublish:function(){this._executeAction("unPublishSubmit");},onAfterShow:function(){this._dViewShown.resolve();},_executeAction:function(s){var c=this;c.resetClientMessages();var o=c.getObjectModel();var i=o.isNew();this._CheckContentAttachments(o);var m=c.executeObjectAction(s);m.done(function(){if(i&&s==="submit"){c.navigateTo("blog-edit",{id:o.getKey()},true);}else{c.navigateTo("blog-display",{id:o.getKey()},true);}});},_initDetails:function(){this._sTitleText=undefined;this._sDescriptionText=undefined;this._aTags=undefined;},_bindingTags:function(){this.addMultiInputHandling(this.byId("Tags"),{childNodeName:"Tags",childNodeNameSingular:"Tag",suggestion:{key:"NAME",text:"NAME",path:"data>/SearchTagsParams(searchToken='$suggestValue')/Results",filter:[],sorter:[]},token:{key:"NAME",text:"NAME"}});},_onResize:function(e){var v;var h;var o;if(e){v=e.control;h=e.size.height;o=e.oldSize.height;}else{v=this.getView();h=v.$().height();o=0;}var r=v.getController()._getRTE();if(!r||r.getMetadata().getName()!=="sap.ino.controls.RichTextEditor"){return;}if(Math.abs(h-o)>0){var c=v.$().find(".sapInoBlogModify");var m=parseInt(c.css("min-height"),10)||400;var i=parseInt(c.css("max-height"),10)||600;h=h-600;h=h<m?m:h;h=h>i?i:h;r.setHeight(h+"px");}},_initRTE:function(){var t=this;if(!D.system.desktop){return;}this._destroyRTE();var r=this.byId("rteContainer");var o;t._TextControlID="richtextBlogControl_"+new Date().getTime();jQuery.sap.require("sap.ino.controls.RichTextEditor");o=new sap.ino.controls.RichTextEditor({id:this.createId(t._TextControlID),width:"100%",editable:true,editorType:"TinyMCE4",height:"300px",showGroupInsert:true,showGroupLink:true,showGroupFont:true,beforeEditorInit:function(c){c.mParameters.configuration.plugins=c.mParameters.configuration.plugins.replace("image,","");c.mParameters.configuration.plugins=c.mParameters.configuration.plugins.replace("powerpaste","paste,imagetools");c.mParameters.configuration.paste_data_images=true;c.mParameters.configuration.automatic_uploads=true;c.mParameters.configuration.images_upload_handler=function(f,s,d){var F=f.blob();if(F){A.uploadFile(F).done(function(e){var g=t.getObjectModel();s(C.getAttachmentDownloadURL(e.attachmentId));g.setProperty("/DESCRIPTION",jQuery.sap._sanitizeHTML(tinymce.activeEditor.getContent()));}).fail(function(){d();M.show(t.getText("IDEA_OBJECT_MSG_TITLE_IMAGE_CROP_FAILED"));});}};c.mParameters.configuration.paste_postprocess=function(e,f){tinymce.activeEditor.uploadImages();};}});o.attachReady(function onRTEReady(){this.bindProperty("value",{model:"object",path:"DESCRIPTION"});t._onResize();if(!this._sResizeRegId){this._sResizeRegId=R.register(t.getView(),t._onResize);}});setTimeout(function(){r.destroyItems();r.addItem(o);},500);},_getRTE:function(){return this.byId(this._TextControlID);},_destroyRTE:function(){if(this._sResizeRegId){R.deregister(this._sResizeRegId);}var r=this._getRTE();if(r){r.destroy();}},alternativeBlogBy:function(v,i,c,d,e,s){if(s!=="sap.ino.config.BLOG_PUBLISHED"){return this.formatter.alternativeBy(v,i,c,d,e);}else{return this.formatter.alternativeBy(v,i,c,e,d);}},_CheckContentAttachments:function(m){var c=m.getProperty("/DESCRIPTION"),d=[],n=[],o=m.getProperty("/ContentAttachments");if(!c){return;}var r=new RegExp("<img.*attachment_download\.xsjs/(\\d+)\"","g"),e;do{e=r.exec(c);if(e&&e.length===2){d.push(e[1]);}}while(e!==null);var t=false,f=void 0;for(var i=0;i<=d.length-1;i++){t=false;f=undefined;for(var j=0;j<=o.length-1;j++){if(Number(d[i])===o[j].ATTACHMENT_ID){t=true;f=o[j];break;}}if(t){n.push(f);}else{n.push({ID:m.getNextHandle(),ATTACHMENT_ID:Number(d[i])});}}m.setProperty("/ContentAttachments",n);}}));});
