sap.ui.define(["sap/ui/Device","sap/ui/model/Sorter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox","sap/ino/commons/application/Configuration","sap/ino/commons/formatters/ObjectListFormatter","sap/ino/commons/models/aof/ApplicationObjectChange","sap/ino/commons/models/object/RewardList","sap/ino/controls/OrientationType","sap/ino/vc/commons/TopLevelPageFacet","sap/ino/vc/commons/BaseVariantListController","sap/ino/vc/evaluation/EvaluationFormatter","sap/ino/vc/reward/RewardFormatter","sap/ino/vc/reward/mixins/MassActionMixin","sap/ino/vc/reward/mixins/CreateActionMixin","sap/ino/vc/commons/mixins/ExportMixin","sap/ui/model/json/JSONModel"],function(D,S,F,a,M,C,O,A,R,b,T,B,E,c,d,e,f,J){"use strict";var r={REWARD:"rewardlist",REWARD_VARIANT:"rewardlistvariant"};var v={REWARD_MANAGE:"rewardmanage",REWARD_QUALIFIED:"rewardqualified",REWARD_REWARDED:"rewardobjects",REWARD_EXPORTED:"rewarddownloaded",REWARD_GAMIFICATION:"rewardgamificationreport"};var m={REWARD_MANAGE:"rewardManage",REWARD_QUALIFIED:"qualifiedIdeaForReward",REWARD_REWARDED:"readyForDownloadReward",REWARD_EXPORTED:"downloadedReward",REWARD_GAMIFICATION:"rewardGamificationReport"};var l={NAME:"IDEA_LIST_MIT_REWARD_NAME",Variants:{DEFAULT_VARIANT:v.REWARD_MANAGE,TITLE:"IDEA_LIST_MIT_REWARD_MANAGE",Values:[{TEXT:"IDEA_LIST_MIT_REWARD_MANAGE",ACTION:v.REWARD_MANAGE,FILTER:m.REWARD_MANAGE,CAMPAIGN_MANAGE:true,VISIBLE:true},{TEXT:"IDEA_LIST_MIT_REWARD_QUALIFIED",ACTION:v.REWARD_QUALIFIED,FILTER:m.REWARD_QUALIFIED,HIERARCHY_LEVEL:"1",CAMPAIGN_MANAGE:true,VISIBLE:true},{TEXT:"IDEA_LIST_MIT_REWARD_REWARDED",ACTION:v.REWARD_REWARDED,FILTER:m.REWARD_REWARDED,HIERARCHY_LEVEL:"1",CAMPAIGN_MANAGE:true},{TEXT:"IDEA_LIST_MIT_REWARD_EXPORTED",ACTION:v.REWARD_EXPORTED,FILTER:m.REWARD_EXPORTED,HIERARCHY_LEVEL:"1",CAMPAIGN_MANAGE:true},{TEXT:"IDEA_LIST_MIT_REWARD_GAMIFICATION_REPORT",ACTION:v.REWARD_GAMIFICATION,FILTER:m.REWARD_GAMIFICATION,HIERARCHY_LEVEL:"1",CAMPAIGN_MANAGE:true}]}};var L=B.extend("sap.ino.vc.reward.List",jQuery.extend({},T,f,d,e,{formatter:jQuery.extend({},O,E,c),initialFocus:"filterButton",list:l,routes:["rewardlist","rewardlistvariant"],view:{"List":{"VARIANT":v.REWARD_MANAGE,"MANAGE":false,"TAGS":[],"IS_TAGS_SELECTION":false,"TAGCLOUD":false,"TAGCLOUD_EXPABLE":true,"TAGCLOUD_EXP":false,"TAGCLOUD_BAR_VISIBLE":false,"HIDE_PPT_EXPORT":true,"SELECT_ALL_ENABLE":false,"SELECT_ALL":false,"IS_IDEA_LIST":false,"IS_GAMIFICATION_REPORT":false},"ORIENTATION":b.PORTRAIT},onInit:function(){B.prototype.onInit.apply(this,arguments);this.oViewModel=this.getModel("view");this.oViewModel.setData(this.view,true);this.initApplicationObjectChangeListeners();},onRouteMatched:function(o){this.setGlobalFilter([]);var g=this.getModel("user").getProperty("/privileges")["sap.ino.ui::backoffice.access"];if(!g){this.navigateTo("home");return;}this.setHelp("REWARD_LIST");this.setCurrentRouteCampaignID();this.show(o);},setCurrentRouteCampaignID:function(){var h=this.getModel("history");var s=h.getProperty("/CurrentHash/hash");if(s&&s.indexOf('campaign/')>=0){var g=s.substr(9);this.setViewProperty("/List/CAMPAIGN",g);var o=this.byId("panelFilterFragment--campaignFilterList");var j=o.getSuggestionItems();for(var i=0;i<j.length;i++){if(j[i].getProperty("key")===g){o.setSelectionItem(j[i]);break;}}this.setFilter(new F("CAMPAIGN_ID",a.EQ,g));}},onCampaignDialogItemsSelect:function(o){var s=o.getParameter("selectedItem").data("ID")+"";var g=this.byId("panelFilterFragment--campaignFilterList");g.getBinding("suggestionItems").filter([]);var h=g.getSuggestionItems();for(var i=0;i<h.length;i++){if(h[i].getProperty("key")===s){g.setSelectionItem(h[i]);break;}}if(s!==this.getViewProperty("/List/CAMPAIGN")){this.setViewProperty("/List/CAMPAIGN",s);this.setFilter(new F("CAMPAIGN_ID",a.EQ,s));var j=this.getList().getBindingInfo("items");j.filters=this._aFilter;this.getList().bindItems(j);}},onCampaignDialogSearch:function(o){var g=o.getParameter("itemsBinding");var V=jQuery.sap.encodeURL(o.getParameter("value"));g.filter(new F("SHORT_NAME",a.Contains,V));g.sort(new S("SHORT_NAME"));},onCampaignSuggestion:function(o){var V=this.getModel("view");var g=o.getSource().getBinding("suggestionItems");var h=jQuery.extend({},o,true);var s=h.getParameter("suggestValue");this.resetClientMessages();this.byId("panelFilterFragment--campaignFilterList").setFilterSuggests(false);V.setProperty("/campaignSuggestion",this._aCampaignSuggestion);g.filter(new F("SHORT_NAME",a.Contains,s));g.sort(new S("SHORT_NAME"));},onFilterReset:function(){this.setViewProperty("/List/CAMPAIGN",undefined);this.byId("panelFilterFragment--campaignFilterList").setValue(undefined);this.setFilter([]);if(!D.system.desktop){return;}this._filter();},onFilterCampaignChange:function(o){var s=o.getParameter("selectedItem")?Number(o.getParameter("selectedItem").getProperty("key")):undefined;if(s!==this.getViewProperty("/List/CAMPAIGN")){this.setViewProperty("/List/CAMPAIGN",s);this.setFilter(new F("CAMPAIGN_ID",a.EQ,s));this._filter();}},onClearCampaignFilter:function(o){var V=o.getParameter("value");if(V.trim()===""){this.setViewProperty("/List/CAMPAIGN",undefined);this.setFilter([]);this._filter();}},onHandleCampaignFilterHelp:function(){var V=this.getModel("view");if(!this._oCampaignlistDialog){this._oCampaignlistDialog=this.createCampaignListDialog();}V.setProperty("/campaignSuggestion",this._aCampaignSuggestion);this._oCampaignlistDialog.open();},onDownloadReward:function(){var t=this;var o=this.getList();var g=[];var h=[];var s=o.getSelectedIndices();if(s.length){for(var i=0;i<s.length;i++){g.push(o.getContextByIndex(s[i]).getProperty("ID"));if(h.indexOf(o.getContextByIndex(s[i]).getProperty("REWARD_LIST_ID"))===-1){h.push(o.getContextByIndex(s[i]).getProperty("REWARD_LIST_ID"));}}}var j=B.prototype.executeObjectAction.call(t,R,"download",{staticparameters:{"REWARD_ID":g,"REWARD_LIST_ID":h}});j.done(function(){if(t.bindList&&typeof(t.bindList)==="function"){t.bindList();}});},onListExportXLS:function(){var t=this;if(!this.getViewProperty("/List/IS_IDEA_LIST")&&this.isDownloaded()){M.confirm(this.getText("IDEA_LIST_REWARD_LIST_INS_EXPORT_CONFIRMATION"),{title:this.getText("GENERAL_EXPORT_TIT_EXPORT_CONFIRMATION"),icon:M.Icon.NONE,onClose:function(g){if(g==="OK"){f.onListExportXLS.call(t);}}});}else{f.onListExportXLS.call(t);}},onListExportCSV:function(){var t=this;if(!this.getViewProperty("/List/IS_IDEA_LIST")&&this.isDownloaded()){M.confirm(this.getText("IDEA_LIST_REWARD_LIST_INS_EXPORT_CONFIRMATION"),{title:this.getText("GENERAL_EXPORT_TIT_EXPORT_CONFIRMATION"),icon:M.Icon.NONE,onClose:function(g){if(g==="OK"){f.onListExportCSV.call(t);}}});}else{f.onListExportCSV.call(t);}},visibleItem:function(V){return V;},onTableSelectionChange:function(o){if(!this._bIsWarned){this._bIsWarned=true;M.show(this.getText("SELECTION_WITH_COAUTHOR_MESSAGE"),M.Icon.INFORMATION,this.getText("MESSAGE_TIT_WARNING"),[M.Action.OK]);}if(this._bIsTableSelectionChanging){return;}var t=this.getList();var s=t.getSelectedIndices();var g=o.getParameter("rowIndex")===-1||o.getParameter("selectAll")?0:t._iBindingLength;var h=o.getParameter("rowIndex")===-1||o.getParameter("selectAll")?0:t.getContextByIndex(o.getParameter("rowIndex")).getProperty("REWARD_LIST_ID");var k=s.indexOf(o.getParameter("rowIndex"))>=0?true:false;var n=false;var p=false;for(var j=0;j<g;j++){this._bIsTableSelectionChanging=true;if(t.getContextByIndex(j).getProperty("REWARD_LIST_ID")===h&&j!==o.getParameter("rowIndex")){if(k){t.addSelectionInterval(j,j);}else{t.removeSelectionInterval(j,j);}}}this._bIsTableSelectionChanging=false;s=t.getSelectedIndices();for(var i=0;i<s.length;i++){if(Number(t.getContextByIndex(s[i]).getProperty("DOWNLOAD_COUNT"))){n=false;break;}else{n=true;}}if(s.length){p=true;}if(this.byId("sapInoMassDeleteBtn")){this.byId("sapInoMassDeleteBtn").setEnabled(n);}if(this.byId("sapInoMassExportBtn")){this.byId("sapInoMassExportBtn").setEnabled(p);}},onOpenIdeaReward:function(o){var i=o.getSource().getBindingContext("data").getProperty("IDEA_ID");if(i){this.navigateTo("idea-display",{id:i,query:{section:"sectionRewards"}});}},onOrientationChange:function(){},_check4ManagingList:function(){var g=C.hasCurrentUserPrivilege("sap.ino.ui::backoffice.access");if(g){var V=this.getViewProperty("/List/VARIANT");var h=this.getListProperty("/Variants/Values");var i=jQuery.grep(h,function(o){return o.ACTION===V;});i=(i&&i.length>0)?i[0]:{};return i.MANAGE||i.CAMPAIGN_MANAGE||false;}return false;},_filter:function(){var g=[];if(this.getViewProperty("/List/CAMPAIGN")){g.push(new F("CAMPAIGN_ID",a.EQ,this.getViewProperty("/List/CAMPAIGN")));}if(this.getViewProperty("/List/IS_IDEA_LIST")){this.getList().getBinding("items").filter(g.length?new F(g,true):null,"Application");}else{this.getList().getBinding("rows").filter(g.length?new F(g,true):null,"Application");}},createCampaignListDialog:function(){if(!this._campaignDialog){this._campaignDialog=this.createFragment("sap.ino.vc.idea.fragments.CampaignSuggestionSelectList",this.getView().getId());this.getView().addDependent(this._campaignDialog);}return this._campaignDialog;},_setCampaignFilter:function(){var s=this.getViewProperty("/List/CAMPAIGN");var o=this.byId("panelFilterFragment--campaignFilterList");var g=o.getSuggestionItems();for(var i=0;i<g.length;i++){if(g[i].getProperty("key")===s){o.setSelectionItem(g[i]);break;}}},bindList:function(){var t=this;this.saveState();this.resetActionState();var p="";var i=this._check4ManagingList();var o=this.getBindingParameter();function g(){var h=arguments[0].getParameter("data").results;var n=[];var V=t.getModel("view");jQuery.each(h,function(I,j){if(jQuery.grep(n,function(N){return N.ID===j.CAMPAIGN_ID;}).length===0||n.length===0){n.push({ID:j.CAMPAIGN_ID,SHORT_NAME:j.CAMPAIGN_NAME});}});V.setProperty("/campaignSuggestion",n);t._aCampaignSuggestion=n;t._filter();t._setCampaignFilter();}if(o.Variant===v.REWARD_QUALIFIED){p+="IdeaMediumBackofficeSearchParams";p+="(searchToken='"+(o.SearchTerm?jQuery.sap.encodeURL(o.SearchTerm):"")+"',"+"searchType="+0+","+"tagsToken='"+(o.TagIds.join(",")||"")+"',"+"filterName='"+(o.VariantFilter||"")+"',"+"filterBackoffice="+(i?"1":"0")+",c1='',o1=-1,v1='',c2='',o2=-1,v2='',c3='',o3=-1,v3=''"+",cvt='"+""+"',"+"cvr=0,"+"cvy=0"+",tagsToken1='',tagsToken2='',tagsToken3='',tagsToken4='')/Results";}else if(o.Variant===v.REWARD_GAMIFICATION){p+="SearchGamificationReportParams(searchLanguage='"+C.getCurrentUser().LOCALE+"')/Results";}else{p+="RewardSearchParams";p+="(searchToken='"+(o.SearchTerm?jQuery.sap.encodeURL(o.SearchTerm):"")+"',"+"filterName='"+(o.VariantFilter||"")+"'"+")/Results";}this.setPath("data>/"+p);if(o.Variant===v.REWARD_QUALIFIED){this.getList().bindItems({parameters:{operationMode:"Client"},path:this.getPath(),filters:this._aFilter,template:this.getItemTemplate(),groupHeaderFactory:this.getGroupHeaderFactory(),events:{dataRequested:function(){jQuery.each(t.getBusyControls(),function(I,h){if(jQuery.type(h.setBusy)==="function"){h.setBusy(true);}});},dataReceived:function(){jQuery.each(t.getBusyControls(),function(I,h){if(jQuery.type(h.setBusy)==="function"){h.setBusy(false);}});if(jQuery.type(g)==="function"){g.apply(this,arguments);}}}});}else if(o.Variant===v.REWARD_GAMIFICATION){this.getList().bindRows({path:this.getPath()});}else{this.getList().bindRows({parameters:{operationMode:"Client"},path:this.getPath(),events:{dataRequested:function(){jQuery.each(t.getBusyControls(),function(I,h){if(jQuery.type(h.setBusy)==="function"){h.setBusy(true);}});},dataReceived:function(){jQuery.each(t.getBusyControls(),function(I,h){if(jQuery.type(h.setBusy)==="function"){h.setBusy(false);}});if(jQuery.type(g)==="function"){g.apply(this,arguments);}}}});}},fnCompleted:function(o){return function(){if(!o.getViewProperty("/List/IS_IDEA_LIST")&&!o.getViewProperty("/List/IS_GAMIFICATION_REPORT")){o.onDownloadReward();}else{return null;}};},getExportControl:function(){if(this.getViewProperty("/List/GAMIFICATION_DETAIL_OPEN")){return this.byId('gamificationReportTableDetail');}else{return this.getList();}},getBindingParameter:function(){var V,s;V=this.getViewProperty("/List/VARIANT");s=this.getCurrentVariant().FILTER;var g=this.getViewProperty("/List/SEARCH");var t=this.getViewProperty("/List/TAGS");var h=this.getViewProperty("/List/CAMPAIGN");var i=jQuery.map(t,function(o){return o.ID;});return{Variant:V,VariantFilter:s,SearchTerm:g,TagIds:i,CampaignId:h};},getList:function(){var o=this.getViewProperty("/List/IS_GAMIFICATION_REPORT")?this.byId("rewardTableGamificationFragment--gamificationReportTable"):this.byId("rewardTableFragment--objectTable");return this.getViewProperty("/List/IS_IDEA_LIST")?this.byId("rewardListFragment--objectlist"):o;},getVariantVisibility:function(V){var g,h;g=this.getModel("list").getProperty("/Variants/Values");for(var i=0;i<g.length;i+=1){var o=g[i];if(o.ACTION===V){h=o.VISIBLE;}}return h;},getExportPrefix:function(){if(!this.getViewProperty("/List/IS_IDEA_LIST")){if(this.getViewProperty("/List/IS_GAMIFICATION_REPORT")){return this.getText("EXPORT_PREFIX_GAMIFICATION");}return this.getText("EXPORT_PREFIX_REWARD");}else{return this.getText("EXPORT_PREFIX_IDEA");}},getItemTemplate:function(){return this.getFragment("sap.ino.vc.reward.fragments.RewardListItem");},isDownloaded:function(){var t=this.getList();var s=t.getSelectedIndices();var g=false;if(s.length){for(var i=0;i<s.length;i++){if(t.getContextByIndex(s[i]).getProperty("DOWNLOAD_COUNT")>0){g=true;break;}}}return g;},initApplicationObjectChangeListeners:function(){var t=this;var g=["create","del","modifyAndSubmit","executeStatusTransition","forward"];var h=function(o){var s=o.getParameter("actionName");if(s&&g.indexOf(s)>-1&&o.getParameter("object").getMetadata().getName()==="sap.ino.commons.models.object.RewardList"){t.bindList();}};A.attachChange(A.Action.Create,h);A.attachChange(A.Action.Del,h);A.attachChange(A.Action.Action,h);},show:function(o,g){var q;var V;if(o&&o.getParameter){var h=o.getParameter("arguments");q=h["?query"];V=h.variant;}else{V=g.variant;q=g;}if(V===this.list.Variants.Values[4].ACTION){this.setViewProperty("/List/IS_GAMIFICATION_REPORT",true);}else{this.setViewProperty("/List/IS_GAMIFICATION_REPORT",false);}var t=this;var s=this.getListProperty("/Variants/DEFAULT_VARIANT");this.setViewProperty("/isre",V||s);V=this.getViewProperty("/isre");var i=this.getVariant(V);this.setViewProperty("/List/VARIANT",i.ACTION);var j=this.getList()&&this.getList().isBound("rows")||this.getList()&&this.getList().isBound("items");var k=this.hasStateChanged(this.getCurrentRoute(),V,q,D.orientation.portrait);k=k||this._bListChanged;this._bListChanged=false;if(!j||k){this.setVariantVisibility();this.setParameters(q,i);var n=this.getViewProperty("/ORIENTATION");this.onOrientationChange(D.system.desktop?n:D.orientation);var p=this.getVariantVisibility(V);if(p===false||typeof(p)==="undefined"){M.show(t.getText("NOT_AUTHORIZED_MESSAGE"),M.Icon.INFORMATION,t.getText("NOT_AUTHORIZED_DIALOG_TITLE"),[M.Action.OK],function(){t.navigateTo("home");});return;}this.bindList();}},setParameters:function(q,V){q=q||{};var s=V.ACTION;this.setViewProperty("/List/TAGCLOUD",false);this.setViewProperty("/List/IDEA_NAVIGATION_SECTION","sectionRewards");this.setViewProperty("/DISABLE_ORIENTATION",true);this.setViewProperty("/List/VARIANT",V.ACTION);this.setViewProperty("/List/MANAGE",V.MANAGE||V.CAMPAIGN_MANAGE);if(this.byId("sapInoMassDeleteBtn")){this.byId("sapInoMassDeleteBtn").setVisible(s!==v.REWARD_EXPORTED);}if(s===v.REWARD_QUALIFIED){this.setViewProperty("/List/IS_IDEA_LIST",true);this.setViewProperty("/List/HIDE_PPT_EXPORT",false);if(!this._sResizeListId){this._sResizeListId=this.attachListControlResized(this.getList());}}else{this.setViewProperty("/List/IS_IDEA_LIST",false);this.setViewProperty("/List/HIDE_PPT_EXPORT",true);if(this._sResizeRegId){this.detachListControlResized(this.getList());}}},setVariantVisibility:function(){var V=this.getModel("list").getProperty("/Variants/Values");for(var i=0;i<V.length;i+=1){var o=V[i];var I=o.MANAGE||false;var g=o.EXPERT||false;var h=o.CAMPAIGN_MANAGE||false;var j=(!I&&!g&&!h)||(g&&C.hasCurrentUserPrivilege("sap.ino.ui::expert"))||(h&&(C.hasCurrentUserPrivilege("sap.ino.ui::campaign_manager")||C.hasCurrentUserPrivilege("sap.ino.xs.rest.admin.application::execute"))&&C.getSystemSetting("sap.ino.config.REWARD_ACTIVE")==="1")||(I&&C.hasCurrentUserPrivilege("sap.ino.ui::backoffice.access"));if(V[i].ACTION===v.REWARD_GAMIFICATION){j=j&&!!this.getView().getModel("config").getProperty("/ENABLE_GAMIFICATION");}this.getModel("list").setProperty("/Variants/Values/"+i+"/VISIBLE",j);}},onObjectListUpdateFinished:function(g){var p=g&&g.getParameters();if(p&&p.total>0){this.setViewProperty("/List/SELECT_ALL_ENABLE",true);}else{this.setViewProperty("/List/SELECT_ALL_ENABLE",false);}B.prototype.onObjectListUpdateFinished.apply(this,arguments);},onPressCurrentValue:function(o){var s=o.getSource();var p=s.getBindingInfo("text").binding.getContext().sPath;var g=this.getModel("data");var i,I,u;if(p){i=g.getProperty(p+"/DIMENSION_ID");I=g.getProperty(p+"/IDENTITY_ID");u=g.getProperty(p+"/USER_NAME");}var G=this.getGamificationDetailDialog();var h="data>/SearchGamificationReportDetailParams(dimensionId="+i+","+"identityId="+I+","+"searchLanguage='"+C.getCurrentUser().LOCALE+"'"+")/Results";var j=new sap.ui.model.Sorter("CREATED_AT",true);this.byId('gamificationReportTableDetail').bindAggregation("rows",{path:h,sorter:j});G.setTitle(this.getText("IDEA_LIST_REWARD_LIST_GAMIFICATION_REPORT_DETAIL_VIEW",u));this.setViewProperty("/List/GAMIFICATION_DETAIL_OPEN",true);G.open();},onPressGamificationDetailClose:function(o){var g=this.getGamificationDetailDialog();this.setViewProperty("/List/GAMIFICATION_DETAIL_OPEN",false);g.close();},getGamificationDetailDialog:function(){if(!this._oGamifcationDialog){this._oGamifcationDialog=this.createFragment("sap.ino.vc.reward.fragments.RewardGamificationReportDetail",this.getView().getId());this.getView().addDependent(this._oGamifcationDialog);}return this._oGamifcationDialog;},onGamiTableSelectionChange:function(o){var t=this.getList();var g=this.byId("sapInoMassExportBtn");var s=t.getSelectedIndices();if(s.length){g.setEnabled(true);}else{g.setEnabled(false);}},onGamiTableDetailSelectionChange:function(o){var t=this.byId("gamificationReportTableDetail");var g=this.byId("exportDetailBtn");var s=t.getSelectedIndices();if(s.length){g.setEnabled(true);}else{g.setEnabled(false);}},onOpenSubmitter:function(o){var s=o.getSource();var i=s.getBindingContext("data").getProperty(s.getBindingContext("data").sPath+"/EMPLOYEE_ID");this.openIdentityQuickView(s,i);}}));L.list=l;L.routes=r;return L;});
