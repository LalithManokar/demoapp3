sap.ui.define(["sap/ino/vc/commons/BaseObjectController","sap/ui/Device","sap/ui/model/json/JSONModel","sap/ino/vc/commons/TopLevelPageFacet","sap/ino/commons/application/Configuration","sap/ui/core/ResizeHandler","sap/ui/model/Sorter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ino/vc/evaluation/EvaluationFormatter","sap/ui/core/TextAlign","sap/ino/vc/comment/CommentMixin","sap/ino/vc/idea/mixins/VoteMixin","sap/ino/vc/commons/mixins/TagCardMixin","sap/ino/vc/commons/mixins/FollowMixin","sap/ino/commons/formatters/ObjectListFormatter","sap/ino/vc/campaign/mixins/RegistrationMixin","sap/ino/vc/campaign/mixins/CampaignProfileMixin","sap/ino/vc/idea/mixins/VolunteerMixin","sap/ino/vc/blog/mixins/BlogCardMixin","sap/ui/core/IconPool","sap/ino/vc/follow/mixins/FeedsMixin","sap/ino/vc/campaign/mixins/MilestoneMixin"],function(C,D,J,T,a,R,S,F,b,E,c,d,V,f,g,h,j,k,l,B,I,m,M){"use strict";var n={Community:{PATH_TEMPLATE:"/CampaignCommunityEntityCount",SHOW_BUTTONS_AUTH:true,Binding:[{ICON:"sap-icon://lightbulb",LINK_TEXT:"PROFILE_LNK_IDEAS_ALL",COUNT:"ALL_IDEAS_COUNT",Route:{NAME:"campaign-idealistvariant",QUERY:{variant:"all"}},ROLES:["camp_instance_mgr_role","camp_instance_coach_role","camp_instance_resp_coach_role","camp_instance_part_role","camp_instance_expert_role","camp_instance_resp_expert_role"]},{ICON:"sap-icon://lightbulb",LINK_TEXT:"PROFILE_LNK_IDEAS_OPEN_FOR_VOTING",COUNT:"OPEN_VOTING_IDEAS_COUNT",Route:{NAME:"campaign-idealistvariant",QUERY:{variant:"vote"}},ROLES:["camp_instance_mgr_role","camp_instance_coach_role","camp_instance_resp_coach_role","camp_instance_part_role"]},{ICON:"sap-icon://lightbulb",LINK_TEXT:"PROFILE_LNK_IDEAS_EVA_PENDING_FOR_ME",COUNT:"EVALUATION_PENDING_COUNT",Route:{NAME:"campaign-idealistvariant",QUERY:{variant:"evalpending"}},ROLES:["camp_instance_expert_role","camp_instance_resp_expert_role"]},{ICON:"sap-icon://lightbulb",LINK_TEXT:"PROFILE_LNK_IDEAS_OPEN_FOR_EVA",COUNT:"OPEN_EVALUATION_IDEA_COUNT",Route:{NAME:"campaign-idealistvariant",QUERY:{variant:"evalopen"}},ROLES:["camp_instance_expert_role","camp_instance_resp_expert_role"]},{ICON:"sap-icon://lightbulb",LINK_TEXT:"PROFILE_LNK_IDEAS_EVA_BY_ME",COUNT:"MY_EVALUATED_IDEA_COUNT",Route:{NAME:"campaign-idealistvariant",QUERY:{variant:"eval"}},ROLES:["camp_instance_expert_role","camp_instance_resp_expert_role"]},{ICON:"sap-icon://lightbulb",LINK_TEXT:"PROFILE_LNK_IDEAS_MY",COUNT:"MY_ALL_IDEA_COUNT",Route:{NAME:"campaign-idealistvariant",QUERY:{variant:"my"}},ROLES:["camp_instance_part_role","camp_instance_expert_role","camp_instance_resp_expert_role"]},{ICON:"sap-icon://comment",LINK_TEXT:"PROFILE_LNK_IDEAS_MY_COMMENTS",COUNT:"MY_COMMENT_IDEA_COUNT",Route:{NAME:"campaign-idealistvariant",QUERY:{variant:"commented"}},ROLES:["camp_instance_mgr_role","camp_instance_coach_role","camp_instance_resp_coach_role","camp_instance_part_role","camp_instance_expert_role","camp_instance_resp_expert_role"]},{ICON:"sap-icon://InoIcons/heart",LINK_TEXT:"PROFILE_LNK_IDEAS_MY_VOTES",COUNT:"MY_VOTE_IDEA_COUNT",Route:{NAME:"campaign-idealistvariant",QUERY:{variant:"voted"}},ROLES:["camp_instance_mgr_role","camp_instance_coach_role","camp_instance_resp_coach_role","camp_instance_part_role","camp_instance_expert_role","camp_instance_resp_expert_role"]},{ICON:"sap-icon://survey",LINK_TEXT:"HOMEPAGE_PANEL_CAMPAIGN_BLOGS",COUNT:"CAMPAIGN_BLOGS_COUNT",Route:{NAME:"campaign-bloglist",QUERY:{}},ROLES:["camp_instance_mgr_role","camp_instance_coach_role"]}]}};var L={XS:{centerProfileContainer:"CampaignProfileFragment--campaignProfile",centerCampaignManagerContainer:"CampaignManagersFragment--CampaignManagers",centerCampaignTagsContainer:"campaignTagsFragment--campaignTags",rightTopCommentatorContainer:undefined,centerTopCommentatorSplitContainer:undefined,centerCommentContainer:"commentFragment--campaignComment",centerBlogContainer:"blogsFragment--blogCommunity"},S:{leftProfileContainer:"CampaignProfileFragment--campaignProfile",centerCampaignManagerContainer:"CampaignManagersFragment--CampaignManagers",centerCampaignTagsContainer:"campaignTagsFragment--campaignTags",rightTopCommentatorContainer:undefined,centerTopCommentatorSplitContainer:undefined,centerCommentContainer:"commentFragment--campaignComment",centerBlogContainer:"blogsFragment--blogCommunity"},M:{leftProfileContainer:"CampaignProfileFragment--campaignProfile",centerCampaignManagerContainer:"CampaignManagersFragment--CampaignManagers",centerCampaignTagsContainer:"campaignTagsFragment--campaignTags",rightTopCommentatorContainer:undefined,centerTopCommentatorSplitContainer:undefined,centerCommentSplitContainer:"commentFragment--campaignComment",centerBlogSplitContainer:"blogsFragment--blogCommunity"},L:{leftProfileContainer:"CampaignProfileFragment--campaignProfile",leftCampaignManagerContainer:"CampaignManagersFragment--CampaignManagers",leftCampaignTagsContainer:"campaignTagsFragment--campaignTags",centerTopCommentatorSplitContainer:"topCommentatorFragment--topCommentator",centerCommentSplitContainer:"commentFragment--campaignComment",centerBlogContainer:"blogsFragment--blogCommunity"},XL:{leftProfileContainer:"CampaignProfileFragment--campaignProfile",leftCampaignManagerContainer:"CampaignManagersFragment--CampaignManagers",leftCampaignTagsContainer:"campaignTagsFragment--campaignTags",rightTopCommentatorContainer:"topCommentatorFragment--topCommentator",rightCommentContainer:"commentFragment--campaignComment",rightBlogContainer:"blogsFragment--blogCommunity"}};return C.extend("sap.ino.vc.campaign.CommunityHome",jQuery.extend({},h,d,V,f,g,j,k,l,B,m,M,{identityProfile:n,formatter:jQuery.extend({},this.formatter,E,h),initialFocus:["backofficeButton--backofficeToogle","identityProfileFragment--createIdea"],onInit:function(){C.prototype.onInit.apply(this,arguments);this.aBusyControls=[this.getView()];},bindViewData:function(){this.getModel("view").setProperty("/CAMPAIGN_COMMENT_NAVIGATION_SECTION","campaignSectionComments");this.setViewProperty("/IS_COMMUNITY_VIEW",true);this._bindIdeas(this.getCampaignId());this._bindBlogs(this.getCampaignId());this._bindTopList();this._bindComments();this._bindTags();this._bindRegisterButton();this.getView().setModel(new J({ID:this.getView().getBindingContext("data").getProperty("ID"),NAME:this.getView().getBindingContext("data").getProperty("SHORT_NAME"),_OBJECT_TYPE_CODE:"CAMPAIGN"}),"contextObject");},show:function(p){if(!this.getView().getBindingContext("data")){return;}this._oParentView=p;this.bindViewData();this.setIdentityProfileBinding();var e=this.byId('campaignBannerList');e.addEventDelegate({onAfterRendering:jQuery.proxy(function(){$(".sapMCrslInner.sapMCrslBottomOffset").height($('#'+e.getActivePage()).parents('.sapMCrslItem').height()+"px");$('#'+e.getActivePage()).parents('.sapMCrslItem ').fadeIn();},this)});this.bindMilestone(this.getCampaignId());},getLayout:function(s){return L[s];},setIdentityProfileBinding:function(){var s=this.getView().getBindingContext("data").getProperty("SHORT_NAME");var e=n.Community;e.HEADLINE=s;e.HEADLINE_BACKGROUND="#"+(this.getView().getBindingContext("data").getProperty("COLOR_CODE")||"FFFFFF");e.PATH=n.Community.PATH_TEMPLATE+"("+this.getCampaignId()+")";this.bindIdentityProfile(this.byId("CampaignProfileFragment--campaignProfile"),e,this.getCampaignId(),this.byId("CampaignProfileFragment--identityProfileButtons"));if(this.getModel("data").getProperty(e.PATH)){var i=this.byId("CampaignProfileFragment--identityProfileList");this.getModel("data").read(e.PATH,{success:function(){var o=i.getBindingInfo("items");i.bindItems(o);}});}},getCampaignId:function(){return this.getView().getBindingContext("data")?this.getView().getBindingContext("data").getProperty("ID"):undefined;},onResizeLayoutChange:function(o,N){var t=this;function s(q,r){for(var i=0;i<q.length;i+=1){if(i<r){q[i].setVisible(true);}else{q[i].setVisible(false);}}}function e(i){var q=t.byId(i);var r=q.getItems();switch(N){case"XL":if(i==="blogsFragment--blogsList"){s(r,3);}else{s(r,4);}break;case"L":s(r,4);break;case"M":s(r,3);break;case"S":s(r,2);break;case"XS":s(r,1);break;default:break;}}var p=this.getModel("device").getProperty("/system/phone");if(!p){e("ideasFragment--ideasList");e("blogsFragment--blogsList");}},_bindIdeas:function(i){if(i||this.getCampaignId()){var e=this.getModel("device").getProperty("/system/phone");var o=a.getSystemSetting("sap.ino.config.DISABLE_IDEA_IMAGE")*1||a.getSystemSetting("sap.ino.config.DISABLE_IDEA_IMAGE_HIDE_PHASE_BAR")*1;var t=Number(o)?this.getFragment("sap.ino.vc.idea.fragments.CardListItemNoImage"):this.getFragment("sap.ino.vc.idea.fragments.CardListItem");var p={path:"data>/IdeaMediumCommunity",template:t,sorter:new S("SUBMITTED_AT",true),filters:[new F("STATUS","NE","sap.ino.config.DRAFT"),new F("CAMPAIGN_ID","EQ",i||this.getCampaignId())],length:4,top:4};var q=this;var P="";var s="";var r="";var u="&$select(ID)";var v=a.hasCurrentUserPrivilege("sap.ino.ui::backoffice.access");var O="";if(v){O="/sap/ino/xs/rest/backoffice/odata.xsodata";}else{O="/sap/ino/xs/rest/community/odata.xsodata";}if(e){var w=this.byId("ideasFragment--ideasCarousel");w.bindAggregation("pages",p);P=a.getBackendRootURL()+O+w.mBindingInfos.pages.binding.sPath+"?$format=json";s=w.mBindingInfos.pages.binding.sFilterParams;r=w.mBindingInfos.pages.binding.sSortParams;}else{var x=this.byId("ideasFragment--ideasList");if(x){x.bindItems(p);x.attachEventOnce("updateFinished",function(){q.onResizeLayoutChange(null,q._sCurrentLayout);});P=a.getBackendRootURL()+O+x.mBindingInfos.items.binding.sPath+"?$format=json";s=x.mBindingInfos.items.binding.sFilterParams;r=x.mBindingInfos.items.binding.sSortParams;}}P=P+"&"+r+"&"+s+u;var y=new J();y.setData({path:P});sap.ui.getCore().setModel(y,"ideaSearchParams");}},_bindBlogs:function(){if(this.getCampaignId()){var i=this.getModel("device").getProperty("/system/phone");var p="data>/BlogSearchParams(searchToken='',"+"tagsToken='',"+"filterName='publishedBlogs')/Results";var o={path:p,template:this.getFragment("sap.ino.vc.blog.fragments.ListItemHome"),sorter:new S("PUBLISHED_AT",true),filters:[new F("CAMPAIGN_ID","EQ",this.getCampaignId())],length:4,top:4};var t=this;if(i){var e=this.byId("blogsFragment--blogsCarousel");e.bindAggregation("pages",o);}else{var q=this.byId("blogsFragment--blogsList");if(q){q.bindItems(o);q.attachEventOnce("updateFinished",function(){t.onResizeLayoutChange(null,t._sCurrentLayout);});}}var r=this.byId("blogsFragment--panelBlogTitle");r.setText(this.getText("HOMEPAGE_PANEL_CAMPAIGN_BLOGS"));}},_bindTopList:function(){var H=!!this.getView().getBindingContext("data").getProperty("MANAGER_HAS_DISPLAY_HOMEPAGE_SETTING");var o=this.byId("CampaignManagersFragment--CampaignManagersList").getBindingInfo("items");var e=this.byId("topCommentatorFragment--topCommentatorsList").getBindingInfo("items");if(H){o.sorter=[];var i=new F("DISPLAY_HOMEPAGE","EQ",1);o.filters=i;}this.byId("CampaignManagersFragment--CampaignManagersList").bindItems(o);this.byId("topCommentatorFragment--topCommentatorsList").bindItems(e);},_bindComments:function(){var o=this.byId("commentFragment--campaginCommentList");var e=o.getBindingInfo("items");o.bindItems(e);},_bindRegisterButton:function(){var r=this.byId("CampaignProfileFragment--registerButton");var o;var i=this.getView().getBindingContext("data").getProperty("ID");var p="/CampaignFull("+i+")";this.getModel("data").read(p,{urlParameters:{"$select":"REGISTER_STATUS"},success:function(){o=r.getBindingInfo("enabled");r.bindProperty("enabled",o);o=r.getBindingInfo("icon");r.bindProperty("icon",o);o=r.getBindingInfo("text");r.bindProperty("text",o);o=r.getBindingInfo("visible");r.bindProperty("visible",o);}});},_bindBannerList:function(){var o=this.byId("campaignBannerList");var e=o.getBindingInfo("pages");o.setActivePage(0);o.firePageChanged();o.bindAggregation("pages",e);},_bindTags:function(){if(!this._oTagTokenizer){this._oTagTokenizer=this.byId("campaignTagsFragment--campaignTags").getContent()[0];}this.byId("campaignTagsFragment--campaignTags").getContent()[0].setBusy(true);var t=this.byId("campaignTagsFragment--Tags");var o=t.getBindingInfo("tokens");t.bindAggregation("tokens",o);var e=this.getModel("data");var p=this.getView().getBindingContext("data").sPath+"/Tags";var i=this;e.read(p,{async:true,success:function(q){var r=i.byId("campaignTagsFragment--campaignTags");r.removeContent(r.getContent()[0]);if(q.results.length===0){var H=new sap.m.HBox().addStyleClass("sapInoCampaignTagsContainerNoTags");H.addItem(new sap.m.Text({text:i.getText("CAMPAIGN_LIST_FLD_NO_TAGS"),width:"100%"}).setTextAlign(c.Center));r.addContent(H);}else{r.addContent(i._oTagTokenizer);}i.byId("campaignTagsFragment--campaignTags").getContent()[0].setBusy(false);}});},_bindFeed:function(){var s=this;var p=a.getBackendRootURL()+"/sap/ino/xs/rest/common/feed.xsjs";var P=[];if(this.getCampaignId()){P.push("campaign="+this.getCampaignId());P.push("top=4");}if(P.length>0){p=p+"?"+P.join("&");}var o=new J(p);o.attachRequestCompleted(null,function(){if(o.oData.results){jQuery.each(o.oData.results,function(i,q){q.EVENT_AT=new Date(q.EVENT_AT);});}var e=s.byId("feedsFragment--feedList");e.setModel(o,"feed");},o);},onAfterRendering:function(){this._bindBannerList();},onOpenIdea:function(o){var i;if(o.getParameter("ideaId")){i=o.getParameter("ideaId");}else{try{if(o.getSource().getProperty("objectId")){i=o.getSource().getProperty("objectId");}}catch(e){i=o.getSource().getBindingContext("data").getProperty("ID");}}if(i){this.navigateTo("idea-display",{id:i});}},onOpenCampaign:function(){},onNavigateToIdeas:function(){this.navigateTo("campaign-idealist",{id:this.getCampaignId()});},onNavigateToBlogs:function(){this.navigateTo("campaign-bloglist",{id:this.getCampaignId()});},onIdeaCommentPress:function(o){var i;if(o.getParameter("ideaId")){i=o.getParameter("ideaId");}else{try{if(o.getSource().getProperty("objectId")){i=o.getSource().getProperty("objectId");}}catch(e){i=o.getSource().getBindingContext("data").getProperty("ID");}}if(i){this.navigateTo("idea-display",{id:i,query:{section:"sectionComments"}});}},onCardItemPress:function(e){var i=e.getSource();var o=i.getAggregation("content")[0];o.getFocusDomRef().focus();},onNavigateToComment:function(){this.navigateTo("campaign-comment",{id:this.getCampaignId()});},onNavigateToCampaignFeeds:function(){this.navigateTo("campaign-feeds",{id:this.getCampaignId()});},onOfficeToggle:function(){if(this._oParentView){var o=this._oParentView.getController();o.switchView();}},onOpenCampaignSettings:function(){if(this._oParentView){var o=this._oParentView.getController();if(o.openCampaignSettings){o.openCampaignSettings(this.getCampaignId());}}},showPopupTagCard:function(e){this._bIsTokenPressed=true;if(!this._oPopover){this._oPopover=sap.ui.xmlfragment("sap.ino.vc.tag.fragments.TagCardPopover",this);this.getView().addDependent(this._oPopover);}var t=e.getSource();var p="/SearchTagsAll(searchToken='',ID="+t.getKey()+")";var o=this.getModel("data");var i=this;o.read(p,{async:true,success:function(q){var r=new J();r.setData(q);i._oPopover.setModel(r,"Tag");jQuery.sap.delayedCall(0,i,function(){i._oPopover.openBy(t);});}});},onNavigateToManagers:function(){this.navigateTo("campaign-managerlist",{id:this.getCampaignId()});},onBlogItemPress:function(e){if(this._bIsTokenPressed){this._bIsTokenPressed=false;return;}var i=e.getSource();var o=i.getBindingContext("data");if(o){this.navigateTo("blog-display",{id:o.getProperty("ID")});}},onChangePage:function(e){var p=e.getParameters();var i=p.newActivePageId;$(".sapMCrslInner.sapMCrslBottomOffset").height($('#'+i).parents('.sapMCrslItem').height()+"px");$('#'+i).parents('.sapMCrslItem').fadeIn().siblings().hide().fadeIn();}}));});
