schema = "SAP_INO";
query = 
"
select distinct idea_id,campaign_id, identity_id, 'CAMPAIGN' as origin from(
select idea.id as idea_id, idea.campaign_id, role_camp.identity_id, 'CAMPAIGN' as origin
from \"sap.ino.db.idea::t_idea\" as idea 
left outer join \"sap.ino.db.subresponsibility::t_responsibility_value_stage\" as resp_value
    on resp_value.code = idea.resp_value_code
inner join \"sap.ino.db.iam::v_auth_application_user_role_transitive\" as role_camp
    on  (role_camp.object_id = idea.campaign_id and
        role_camp.object_type_code = 'CAMPAIGN')
        or (role_camp.object_id = resp_value.id and role_camp.object_type_code = 'RESPONSIBILITY')
inner join \"sap.ino.db.iam::t_role_privilege\" as role_privilege
    on  role_privilege.role_code = role_camp.role_code
inner join \"sap.ino.db.campaign::t_campaign_phase\" as campaign_phase
                on  campaign_phase.campaign_id = idea.campaign_id and
                    campaign_phase.phase_code = idea.phase_code
where role_privilege.privilege = 'CAMP_EVAL_CREATE' and campaign_phase.evaluation_model_code is not null

union all 

select idea.id as idea_id, idea.campaign_id, role_idea.identity_id, 'IDEA' as origin 
from \"sap.ino.db.idea::t_idea\" as idea 
inner join \"sap.ino.db.iam::v_auth_application_user_role_transitive\" as role_idea
    on  role_idea.object_id = idea.id and
        role_idea.object_type_code = 'IDEA'
inner join \"sap.ino.db.iam::t_role_privilege\" as role_privilege
    on  role_privilege.role_code = role_idea.role_code
inner join \"sap.ino.db.campaign::t_campaign_phase\" as campaign_phase
                on  campaign_phase.campaign_id = idea.campaign_id and
                    campaign_phase.phase_code = idea.phase_code
where role_privilege.privilege = 'IDEA_EVAL_CREATE' and campaign_phase.evaluation_model_code is not null

union all 

select idea.id as idea_id, idea.campaign_id, role_idea.identity_id, 'IDEA' as origin 
from \"sap.ino.db.idea::t_idea\" as idea 
inner join \"sap.ino.db.evaluation.ext::v_ext_evaluation_request_item_for_me\" as eval_req_item
    on eval_req_item.idea_id = idea.id 
        and eval_req_item.idea_phase_code = idea.phase_code
        and eval_req_item.status_code = 'sap.ino.config.EVAL_REQ_REQUESTED'
inner join \"sap.ino.db.iam::v_auth_application_user_role_transitive\" as role_idea
    on  role_idea.object_id = eval_req_item.id and
        role_idea.object_type_code = 'EVAL_REQUEST_ITEM'
inner join \"sap.ino.db.iam::t_role_privilege\" as role_privilege
    on  role_privilege.role_code = role_idea.role_code
inner join \"sap.ino.db.campaign::t_campaign_phase\" as campaign_phase
                on  campaign_phase.campaign_id = idea.campaign_id and
                    campaign_phase.phase_code = idea.phase_code
where role_privilege.privilege = 'IDEA_EVAL_CREATE' and campaign_phase.evaluation_model_code is not null

union all

select idea.id as idea_id, idea.campaign_id, role_idea.identity_id, 'SELF' as origin
from \"sap.ino.db.idea::t_idea\" as idea 
inner join \"sap.ino.db.iam::v_auth_application_user_role_transitive\" as role_idea
    on  role_idea.object_id = idea.id and
        role_idea.object_type_code = 'IDEA'
inner join \"sap.ino.db.campaign::t_campaign_phase\" as campaign_phase
	on  campaign_phase.campaign_id = idea.campaign_id and
    	campaign_phase.phase_code = idea.phase_code
where (role_idea.role_code = 'IDEA_SUBMITTER' or role_idea.role_code = 'IDEA_CONTRIBUTOR') and
	   campaign_phase.self_evaluation_active = 1 and campaign_phase.evaluation_model_code is not null)
 where idea_id not in (select distinct idea_id  from\"sap.ino.db.status::v_auth_campaign_authorization_underStatus\" as campaign_underStatus
                where campaign_underStatus.SETTING_CODE = 'OPEN_STATUS_AUTHORIZATION' and campaign_underStatus.VALUE = 1
                and campaign_underStatus.action_code = 'IDEA_EVALUATION' and campaign_underStatus.can_do_action = 0
                union all 
                select distinct idea_id  from\"sap.ino.db.status::v_auth_idea_authorization_underStatus\" as idea_underStatus
                where idea_underStatus.SETTING_CODE = 'OPEN_STATUS_AUTHORIZATION' and idea_underStatus.VALUE = 1
                and idea_underStatus.action_code = 'IDEA_EVALUATION' and idea_underStatus.can_do_action = 0)
union all 
    select campaign_underStatus.idea_id,campaign_underStatus.campaign_id,campaign_underStatus.identity_id, 'CAMPAIGN' as origin  from\"sap.ino.db.status::v_auth_campaign_authorization_underStatus\" as campaign_underStatus
                where campaign_underStatus.SETTING_CODE = 'OPEN_STATUS_AUTHORIZATION' and campaign_underStatus.VALUE = 1
                and campaign_underStatus.action_code = 'IDEA_EVALUATION' and campaign_underStatus.can_do_action = 1
union all 
     select idea_underStatus.idea_id,idea_underStatus.campaign_id,idea_underStatus.identity_id, 'CAMPAIGN' as origin  from\"sap.ino.db.status::v_auth_idea_authorization_underStatus\" as idea_underStatus
                where idea_underStatus.SETTING_CODE = 'OPEN_STATUS_AUTHORIZATION' and idea_underStatus.VALUE = 1
                and idea_underStatus.action_code = 'IDEA_EVALUATION' and idea_underStatus.can_do_action = 1
with read only";

depends_on_table = ["sap.ino.db.idea::t_idea",
                    "sap.ino.db.campaign::t_campaign_phase",
                    "sap.ino.db.iam::t_role_privilege",
                    "sap.ino.db.subresponsibility::t_responsibility_value_stage"];

depends_on_view = ["sap.ino.db.iam::v_auth_application_user_role_transitive",
                   "sap.ino.db.evaluation.ext::v_ext_evaluation_request_item_for_me",
                   "sap.ino.db.status::v_auth_idea_authorization_underStatus",
                   "sap.ino.db.status::v_auth_campaign_authorization_underStatus"];