schema = "SAP_INO";
query = "
    SELECT 	
        CRI.IDEA_ID,
    	CRI.CAMPAIGN_ID,
    	CRI.CAMPAIGN_PHASE_CODE,
    	CRI.MODEL_CODE,
    	CRI.EVALUATION_ID,
    	CRI.EVALUATION_CREATED_AT,
    	CRI.EVALUATION_CREATED_BY_ID,
    	CRI.EVALUATION_CHANGED_AT,
    	CRI.EVALUATION_CHANGED_BY_ID,
    	CRI.EVALUATION_STATUS_CODE,
    	CRI.EVALUATION_COMMENT,
    	CRI.CRITERION_CODE,
    	CRI.CRITERION_DATATYPE_CODE,
    	CRI.CRITERION_IS_OVERALL_RESULT,
    	CRI.CRITERION_TEXT_VALUE,
    	CRI.CRITERION_VALUE,
    	case WHEN CRI.VALUE_OPTION_LIST_CODE IS NULL THEN 
    	    CRI.criterion_all_value 
        ELSE	
            VAL.DEFAULT_TEXT END AS criterion_all_value
        FROM \"sap.ino.db.evaluation::v_criterion_all_value\" AS CRI
    LEFT JOIN \"sap.ino.db.evaluation::v_criterion_option_value\" AS VAL
    ON CRI.criterion_code = VAL.CODE 
        AND CRI.MODEL_CODE = VAL.MODEL_CODE 
        AND CRI.criterion_all_value = VAL.criterion_all_value
     
    UNION
    
    SELECT DISTINCT
        idea.id as idea_id,
        campaign.id as campaign_id,
        campaign_phase.phase_code as campaign_phase_code,
        model.code as model_code,
        evaluation.id as evaluation_id,
        evaluation.created_at as evaluation_created_at,
        evaluation.created_by_id as evaluation_created_by_id,
        evaluation.changed_at as evaluation_changed_at,
        evaluation.changed_by_id as evaluation_changed_by_id,
        evaluation.status_code as evaluation_status_code,
        evaluation.comment as evaluation_comment,
        'FORMULA_CODE' as criterion_code,
        'NUMERIC' as criterion_datatype_code,
        1 as criterion_is_overall_result,
        '' as criterion_text_value,
        evaluation.CAL_NUM_VALUE as criterion_value,
        CAST(evaluation.CAL_NUM_VALUE AS NVARCHAR(1024)) as criterion_all_value
    FROM \"sap.ino.db.idea::t_idea\" as idea
    INNER JOIN \"sap.ino.db.campaign::t_campaign\" as campaign
          ON idea.campaign_id = campaign.id
    INNER JOIN \"sap.ino.db.campaign::t_campaign_phase\" as campaign_phase 
          ON campaign.id = campaign_phase.campaign_id
    INNER JOIN \"sap.ino.db.evaluation::t_model\" as model
          ON campaign_phase.evaluation_model_code = model.code and model.ENABLE_FORMULA = 1
    INNER JOIN \"sap.ino.db.evaluation::t_criterion\" as criterion
          ON model.code = criterion.model_code
    LEFT OUTER JOIN \"sap.ino.db.evaluation::t_evaluation\" as evaluation
          ON idea.id = evaluation.idea_id AND
             campaign_phase.phase_code = evaluation.idea_phase_code AND 
             evaluation.status_code <> 'sap.ino.config.EVAL_DRAFT'
    with read only";

depends_on_table = ["sap.ino.db.evaluation::t_criterion_value", 
                    "sap.ino.db.evaluation::t_criterion",
                    "sap.ino.db.idea::t_idea",
                    "sap.ino.db.campaign::t_campaign",
                    "sap.ino.db.campaign::t_campaign_phase",
                    "sap.ino.db.evaluation::t_model",
                    "sap.ino.db.evaluation::t_evaluation"];