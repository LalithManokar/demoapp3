schema = "SAP_INO";
query  = "
select 
    eval_req.id,
    eval_req.idea_id,
    eval_req.idea_phase_code,
    phase.default_text as idea_phase_text,
    eval_req.description,
    eval_req.accept_date,
    eval_req.complete_date,
    eval_req.created_at,
    eval_req.created_by_id,
    eval_req.changed_at,
    eval_req.idea_name,
    eval_req.changed_by_id,
    eval_req.created_by, 
    eval_req.changed_by,
    null as status_code,
    null as status_text,
    eval_req.owner_id,
    eval_req.owner_name,
    eval_req_group_orders.group_order as group_order
  from \"sap.ino.db.evaluation::v_evaluation_request\" as eval_req
  inner join \"sap.ino.db.idea::t_idea\" as idea
    on  idea.id = eval_req.idea_id 
  inner join \"sap.ino.db.campaign::t_phase\"                  as phase
                on eval_req.idea_phase_code = phase.code
  left outer join \"sap.ino.db.iam::t_identity\" as owner 
             on owner.id = eval_req.owner_id
  left outer join (
                select idea_id, idea_phase_code, ROW_NUMBER() over (partition by idea_id order by last_date desc) as group_order from (
                select max(changed_at) last_date, idea_phase_code, idea_id from \"sap.ino.db.evaluation::v_evaluation_request_item\" group by idea_phase_code, idea_id
                )  ) as eval_req_group_orders
                    on eval_req.idea_id = eval_req_group_orders.idea_id and eval_req.idea_phase_code = eval_req_group_orders.idea_phase_code
with read only";

depends_on_view = [ "sap.ino.db.evaluation::v_evaluation_request",
                    "sap.ino.db.evaluation::v_evaluation_request_item"];
                    
depends_on_table = ["sap.ino.db.idea::t_idea",
                    "sap.ino.db.campaign::t_phase",
                    "sap.ino.db.iam::t_identity"];