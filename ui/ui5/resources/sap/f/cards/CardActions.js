/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/f/library","sap/ui/base/ManagedObject","sap/base/Log","sap/f/cards/BindingResolver","sap/ui/util/openWindow"],function(l,M,L,B,o){"use strict";function _(s){if(s&&typeof s==="object"){return s.name;}return s;}var A=l.cards.AreaType;var C=M.extend("sap.f.cards.CardActions",{metadata:{properties:{areaType:{type:"sap.f.cards.AreaType",defaultValue:A.None}}}});C.prototype.exit=function(){this._oAreaControl=null;};C.prototype.attach=function(i,a){this._oAreaControl=a;if(!i.actions){this._fireActionReady();return;}var b=i.actions[0];if(b&&b.type==="Navigation"){this._attachNavigationAction(i);}else{this._fireActionReady();}};C.prototype._setItemTemplateTypeFormatter=function(a){var t=this,b=t._oAreaControl,i=b._oItemTemplate;var c=M.bindingParser("{path:''}");c.formatter=function(v){var d=this.getBindingContext(),m=this.getModel(),p,P;if(d){p=d.getPath();}P=B.resolveValue(a.parameters,m,p);if(v.__resolved){if(v.__enabled){return"Navigation";}else{return"Inactive";}}if(!v.__promise){v.__promise=true;b._oServiceManager.getService(_(a.service)).then(function(n){if(n){n.enabled({parameters:P}).then(function(e){v.__resolved=true;v.__enabled=e;b.getModel().checkUpdate(true);}).catch(function(){v.__resolved=true;v.__enabled=false;});}else{v.__resolved=true;v.__enabled=false;}});}return"Inactive";};i.bindProperty("type",c);};C.prototype._setSingleActionEnabledState=function(i){var a=i.actions[0],b=this._oAreaControl,c=b.getBindingContext(),p=a.parameters,m=b.getModel(),P;if(c){P=c.getPath();}p=B.resolveValue(a.parameters,m,P);return new Promise(function(r){b._oServiceManager.getService(_(a.service)).then(function(n){if(n){n.enabled({parameters:p}).then(function(e){r(e);}).catch(function(){r(false);});}else{r(false);}}).catch(function(){r(false);});});};C.prototype._setItemTemplateEnabledState=function(a){var b,t,i=this._oAreaControl._oItemTemplate;if(typeof a.enabled==="string"){b=M.bindingParser(a.enabled);b.formatter=function(v){if(v&&(typeof v==="string")){return"Navigation";}else{return"Inactive";}};}if(b){i.bindProperty("type",b);}else{t=a.enabled!==false?"Navigation":"Inactive";i.setProperty("type",t);}};C.prototype._addClickableClass=function(){this._oAreaControl.addStyleClass("sapFCardClickable");};C.prototype._fireActionReady=function(){var h=this.getAreaType()===A.Header;var e=h?"_actionHeaderReady":"_actionContentReady";this._oAreaControl.fireEvent(e);};C.prototype._attachNavigationAction=function(i){var a=i.actions[0],b=this.getAreaType()===A.ContentItem?this._oAreaControl._oItemTemplate:this._oAreaControl,h,c=true,s=this.getAreaType(),S=s===A.Header||s===A.Content,d=s===A.ContentItem;var f=function(){b.attachPress(h.bind(this));if(S){this._addClickableClass();}}.bind(this);if(a.service){if(this.getAreaType()===A.ContentItem){this._setItemTemplateTypeFormatter(a);}h=function(E){var g=E.getSource(),j=g.getBindingContext(),m=g.getModel(),p;if(j){p=j.getPath();}this._oAreaControl._oServiceManager.getService(_(a.service)).then(function(n){if(n){n.navigate({parameters:B.resolveValue(a.parameters,m,p)});}}).catch(function(e){L.error("Navigation service unavailable",e);}).finally(function(){this._fireAction(E.getSource(),a.parameters,m,p);}.bind(this));}.bind(this);c=false;}else{if(d){this._setItemTemplateEnabledState(a);c=false;}if(a.url){h=function(e){var g=e.getSource(),j=g.getBindingContext(),m=g.getModel(),p,u;if(j){p=j.getPath();}u=B.resolveValue(a.url,m,p);this.openUrl(u,a);this._fireAction(e.getSource(),a.parameters,m,p);}.bind(this);}else{h=function(e){var g=e.getSource(),j=g.getBindingContext(),m=g.getModel(),p;if(j){p=j.getPath();}this._fireAction(e.getSource(),a.parameters,m,p);}.bind(this);}}if(S&&a.service){this._setSingleActionEnabledState(i).then(function(e){if(e){f();}this._fireActionReady();}.bind(this));}else{if(c){if(a.enabled!==false){f();}}else{f();}this._fireActionReady();}};C.prototype.openUrl=function(u,a){o(u,a.target||"_blank");};C.prototype._fireAction=function(s,a,m,p){this._oAreaControl.fireEvent("action",{type:"Navigation",actionSource:s,manifestParameters:B.resolveValue(a,m,p)});};return C;});
