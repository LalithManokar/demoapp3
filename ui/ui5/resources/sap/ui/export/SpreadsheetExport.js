/*!
 * SAPUI5

		(c) Copyright 2009-2019 SAP SE. All rights reserved
	
 */
sap.ui.define(['jquery.sap.global','sap/base/Log','sap/ui/Device'],function(q,L,D){'use strict';var a='sap/ui/export/js/libs/JSZip3',b='sap/ui/export/js/XLSXExportUtils',c='sap/ui/export/js/XLSXBuilder';function d(p,C){function f(m){return C&&C(m);}function o(v){f({progress:v});}function g(e){f({error:e.message||e});}function h(A){f({finish:true,data:A});}function i(){var S;var e;var t;function m(X,x){e=X.oData.getConverter(p);S=new x(p.workbook.columns,p.workbook.context,p.workbook.hierarchyLevel,p.customizing);o(0);t=window.setTimeout(r,0);}function r(){if(S){var x=p.dataSource.data||[];var R=e(x.slice());S.append(R);o(50);t=window.setTimeout(u,0);}}function u(){if(S){S.build().then(v);}}function v(x){h(x);S=null;}function w(){window.clearTimeout(t);v();}sap.ui.require([b,c,a],m);return{cancel:w};}function n(u){if(!u){return u;}try{return new URL(u,document.baseURI).toString();}catch(e){return window.URI(u).absoluteTo(document.baseURI).toString();}}function j(){var S,r;function e(X,v){S=new v(p.workbook.columns,p.workbook.context,p.workbook.hierarchyLevel,p.customizing);r=X.oData.fetch(p,m);o(0);}function m(M){if(M.rows){S.append(M.rows);}if(M.progress){o(M.progress);}if(M.error||typeof M.error==='string'){S=null;return g(M.error);}return M.finished&&S.build().then(t);}function t(v){h(v);S=null;}function u(){r.cancel();h();S=null;}sap.ui.require([b,c,a],e);return{cancel:u};}function k(){var m;var r=q.extend(true,{},p);var w=typeof r.worker==='object'?r.worker:{};var t=function(){m.postMessage({cancel:true});h();};function u(z){var A=new Worker(z);A.onmessage=function(e){if(e.data.status){o(e.data.status);}else if(e.data.error||typeof e.data.error==='string'){g(e.data.error);}else{h(e.data);}};A.postMessage(r);return A;}function v(){L.warning('Direct worker is not allowed. Load the worker via blob.');var e=window.URI(w.base).absoluteTo("").search("").hash("").toString();w.src=e+w.ref;var z='self.origin = "'+e+'"; '+'importScripts("'+w.src+'")';var A=new Blob([z]);var B=window.URL.createObjectURL(A);return u(B);}function x(){L.warning('Blob worker is not allowed. Use in-process export.');t=j(r).cancel;}function y(X){try{m=u(w.src);m.addEventListener('error',function(e){m=v();m.addEventListener('error',function(e){x();e.preventDefault();});e.preventDefault();});}catch(z){try{m=v();}catch(A){x();}}}r.dataSource.dataUrl=n(r.dataSource.dataUrl);r.dataSource.serviceUrl=n(r.dataSource.serviceUrl);w.base=w.base||sap.ui.require.toUrl('sap/ui/export/js/','');w.ref=w.ref||'SpreadsheetWorker.js';w.src=w.base+w.ref;sap.ui.require([b],y);return{cancel:function(){t();}};}var l=sap.ui.getCore().getConfiguration().getFormatSettings().getCustomCurrencies();if(l){var s;p.customizing=p.customizing||{};p.customizing.currency={};for(s in l){p.customizing.currency[s]={scale:l[s].digits};}}if(p.dataSource.type==='array'){return i();}else if(p.worker===false||sap.ui.disableExportWorkers===true||(D.browser.msie&&p.dataSource.dataUrl.indexOf('.')===0)){return j();}else{return k();}}return{execute:d};},true);
