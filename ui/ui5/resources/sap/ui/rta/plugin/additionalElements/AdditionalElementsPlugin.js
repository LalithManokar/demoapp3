/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/rta/plugin/Plugin","sap/ui/dt/ElementUtil","sap/ui/dt/OverlayRegistry","sap/ui/rta/Utils","sap/ui/fl/Utils","sap/ui/dt/Util","sap/ui/core/StashedControlSupport","sap/ui/dt/ElementDesignTimeMetadata","sap/base/Log","sap/ui/util/openWindow"],function(q,P,E,O,U,F,D,S,a,L,o){"use strict";function _(s,i){var p;var r=i.getRelevantContainer(!s);var R=O.getOverlay(r);if(s){p=i.getParentElementOverlay();}else{p=i;}return{relevantContainerOverlay:R,parentOverlay:p,relevantContainer:r,parent:p&&p.getElement()};}function b(p,C){return C.sParentAggregationName;}function c(p,s){var i=p.getElement();if(!i){return[];}var I=E.getAggregation(i,s).filter(function(C){var l=O.getOverlay(C);if(!this.hasStableId(l)){return false;}var r=p.getRelevantContainer(true);var R=O.getOverlay(r);var m=p;var n=false;do{n=!m.getElementVisibility();if(n){break;}if(m===R){break;}else{m=m.getParentElementOverlay();}}while(m);if(n){return true;}return l.getElementVisibility()===false;},this);var k=S.getStashedControls(i.getId());return I.concat(k);}var d=true;var e=false;function f(r,m,p,s,C){var n=[];var i;var k;if(m.addODataProperty||m.custom){var l=m.aggregation;var t=m[m.addODataProperty?"addODataProperty":"custom"].designTimeMetadata;i=t.getAggregationDescription(l,p);if(i){k=s?i.singular:i.plural;n.push(k);}}if(m.reveal){m.reveal.controlTypeNames.forEach(function(i){k=s?i.singular:i.plural;n.push(k);});}var N=n.reduce(function(u,v){if(u.indexOf(v)===-1){u.push(v);}return u;},[]);var T=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");if(N.length===1){k=N[0];}else if(C){k=C;}else{k=T.getText("MULTIPLE_CONTROL_NAME");}return T.getText(r,[k]);}function g(){return{designTimeMetadata:new a({data:{name:{singular:function(){return sap.ui.getCore().getLibraryResourceBundle("sap.uxap").getText("SECTION_CONTROL_NAME");},plural:function(){return sap.ui.getCore().getLibraryResourceBundle("sap.uxap").getText("SECTION_CONTROL_NAME_PLURAL");}},actions:{reveal:{changeType:"unstashControl",getAggregationName:b}}}}),action:{changeType:"unstashControl",getAggregationName:b}};}function h(m,r){var R;m.reveal.elements.some(function(i){if(i.element.getId()===r.getId()){R=i;return false;}});return R;}var A=P.extend("sap.ui.rta.plugin.additionalElements.AdditionalElementsPlugin",{metadata:{library:"sap.ui.rta",properties:{analyzer:"object",dialog:"object",commandFactory:"object"},associations:{},events:{}},getContextMenuTitle:function(i,k){var p=_(i,k);var m=this._getActionsOrUndef(i,k);return f("CTX_ADD_ELEMENTS",m,p.parent,d);},isAvailable:function(i,k){return k.every(function(l){return this._isEditableByPlugin(l,i);},this);},isEnabled:function(i,k){if(k.length>1){return false;}var l=k[0];var p;var I;if(i){p=l.getParentElementOverlay();if(p){I=true;}else{I=false;}}else{var m=this._getActionsOrUndef(i,l);if(m.reveal&&m.reveal.elements.length===0&&!m.addODataProperty){I=false;}else{I=true;}}var C=this.getCachedElements(i);var n=C&&C.length>0;I=I&&(n||this.getDialog().getCustomFieldEnabled());return I;},registerElementOverlay:function(i){var m=i.getElement().getModel();if(m){var M=m.getMetaModel();if(M&&M.loaded){M.loaded().then(function(){this.evaluateEditable([i],{onRegistration:true});}.bind(this));}}P.prototype.registerElementOverlay.apply(this,arguments);},_getRevealActions:function(s,i){var p=_(s,i);var k=[p.parentOverlay];if(p.relevantContainer!==p.parent){k=E.findAllSiblingsInContainer(p.parent,p.relevantContainer).map(function(n){return O.getOverlay(n);}).filter(function(i){return i;});}var l;if(s){var m=i.getParentAggregationOverlay();l=m?[i.getParentAggregationOverlay().getAggregationName()]:[];}else{l=p.parentOverlay.getAggregationOverlays().filter(function(n){return!n.getDesignTimeMetadata().isIgnored(p.parent);}).map(function(n){return n.getAggregationName();});}return l.reduce(function(n,r){return n.then(function(R){return this._getRevealActionFromAggregations(k,R,r);}.bind(this));}.bind(this),Promise.resolve({}));},_getRevealActionFromAggregations:function(p,i,s){var I=p.reduce(function(l,m){return m?l.concat(c.call(this,m,s)):l;}.bind(this),[]);var k={elements:[],controlTypeNames:[]};var r=I.reduce(function(l,m){return l.then(function(R){return this._invisibleToReveal(R,m);}.bind(this));}.bind(this),Promise.resolve(k));return r.then(function(R){if(R.elements.length>0){i[s]={reveal:R};}return i;});},_invisibleToReveal:function(r,i){return Promise.resolve().then(function(){var t=i.getMetadata().getName();var k;var R;var l=false;var H=Promise.resolve();if(t==="sap.ui.core._StashedControl"){var s=g();k=s.designTimeMetadata;R=s.action;l=true;}else{var m=O.getOverlay(i);if(m){k=m.getDesignTimeMetadata();R=k&&k.getAction("reveal",i);if(R&&R.changeType){var n=i;if(R.changeOnRelevantContainer){n=m.getRelevantContainer();}H=this.hasChangeHandler(R.changeType,n).then(function(p){if(p){if(R.changeOnRelevantContainer){var u=_(true,m);l=this.hasStableId(u.relevantContainerOverlay)&&this.hasStableId(u.parentOverlay);}else{l=true;}if(!R.getAggregationName){R.getAggregationName=b;}}}.bind(this));}}}return H.then(function(){if(l){r.elements.push({element:i,designTimeMetadata:k,action:R});var N=k.getName(i);if(N){r.controlTypeNames.push(N);}}return r;});}.bind(this));},_getAddODataPropertyActions:function(s,i){var p=_(s,i);var k=p.parentOverlay&&p.parentOverlay.getDesignTimeMetadata();var l=k&&k.getActionDataFromAggregations("addODataProperty",p.parent)||[];function m(n){return Promise.resolve().then(function(){if(n){var C=n.changeOnRelevantContainer?p.relevantContainer:p.parent;var r=O.getOverlay(C);if(n.changeType&&this.hasStableId(r)){return this.hasChangeHandler(n.changeType,C).then(function(H){if(H){return{aggregationName:n.aggregation,addODataProperty:{designTimeMetadata:k,action:n}};}});}}}.bind(this));}return l.reduce(function(n,r){return n.then(function(R){return m.call(this,r).then(function(t){if(t){R[t.aggregationName]={addODataProperty:t.addODataProperty};}return R;});}.bind(this));}.bind(this),Promise.resolve({}));},_getCustomAddActions:function(s,i){var p=_(s,i);var k=p.parentOverlay&&p.parentOverlay.getDesignTimeMetadata();var l=k&&k.getActionDataFromAggregations("add",p.parent,undefined,"custom")||[];function m(n){return Promise.resolve().then(function(){if(n){var C=p.parent;var r=O.getOverlay(C);if(typeof n.getItems==="function"&&this.hasStableId(r)){var I=n.getItems(C);if(Array.isArray(I)){var t=[];I.forEach(function(u){if(u.changeSpecificData.changeOnRelevantContainer){C=p.relevantContainer;}if(u.changeSpecificData.changeType){t.push(this.hasChangeHandler(u.changeSpecificData.changeType,C));}}.bind(this));return Promise.all(t).then(function(H){if(I.length===H.length&&H.indexOf(false)===-1){return{aggregationName:n.aggregation,custom:{designTimeMetadata:k,action:n,items:I}};}});}}}}.bind(this));}return l.reduce(function(n,r){return n.then(function(R){return m.call(this,r).then(function(t){if(t){R[t.aggregationName]={custom:t.custom};}return R;});}.bind(this));}.bind(this),Promise.resolve({}));},_getActions:function(s,i,I){return new Promise(function(r,k){var l=s?"asSibling":"asChild";if(!I&&i._mAddActions){return r(i._mAddActions[l]);}var R=this._getRevealActions(s,i);var m=this._getAddODataPropertyActions(s,i);var C=this._getCustomAddActions(s,i);return Promise.all([R,m,C]).then(function(n){var p=q.extend(true,n[0],n[1],n[2]);var t=Object.keys(p);if(t.length===0){p={};}else if(t.length>1){L.error("reveal or addODataProperty action defined for more than 1 aggregation, that is not yet possible");}if(t.length>0){var u=t[0];p[u].aggregation=u;p=p[u];}i._mAddActions=i._mAddActions||{asSibling:{},asChild:{}};i._mAddActions[l]=p;r(p);}).catch(function(v){k(v);});}.bind(this));},_getActionsOrUndef:function(s,i){var k=s?"asSibling":"asChild";return i._mAddActions&&i._mAddActions[k];},_checkIfCreateFunctionIsAvailable:function(C){return!C||(C&&C.content&&C.content.createFunction);},showAvailableElements:function(i,k,I,C){var l=k[0];var p=_(i,l);var s=i&&l.getElement();var m;return this._getActions(i,l).then(function(n){m=n;}).then(function(){return this.getAllElements(i,k,I,C);}.bind(this)).then(function(n){this.getDialog().setElements(n);return this.getDialog().open().then(function(){return this._createCommands(p,s,m,I);}.bind(this)).catch(function(r){if(r instanceof Error){throw r;}});}.bind(this)).catch(function(n){if(n instanceof Error){throw n;}else{L.info("Service not up to date, skipping add dialog","sap.ui.rta");}});},_setDialogTitle:function(m,p,C){var s=f("HEADER_ADDITIONAL_ELEMENTS",m,p,e,C);this.getDialog().setTitle(s);if(C){this.getDialog()._oList.setNoDataText(this.getDialog()._oTextResources.getText("MSG_NO_FIELDS",C.toLowerCase()));}},_onOpenCustomField:function(){var u=F.getUshellContainer();var C=u.getService("CrossApplicationNavigation");var H=(C&&C.hrefForExternal({target:{semanticObject:"CustomField",action:"develop"},params:{businessContexts:this._oCurrentFieldExtInfo.BusinessContexts.map(function(B){return B.BusinessContext;}),serviceName:this._oCurrentFieldExtInfo.ServiceName,serviceVersion:this._oCurrentFieldExtInfo.ServiceVersion,entityType:this._oCurrentFieldExtInfo.EntityType}}));o(H,"_blank");},_createCommands:function(p,s,m,i){var k=this.getDialog().getSelectedElements();k.sort(function(l,n){if(l.label>n.label){return-1;}if(l.label<n.label){return 1;}return 0;});if(k.length>0){return this.getCommandFactory().getCommandFor(p.parent,"composite").then(function(C){var l=Promise.resolve();k.forEach(function(n){switch(n.type){case"invisible":l=l.then(this._createCommandsForInvisibleElement.bind(this,C,n,p,s,m,i));break;case"odata":l=l.then(this._createCommandsForODataElement.bind(this,C,n,p,s,m,i));break;case"custom":l=l.then(this._createCommandsForCustomElement.bind(this,C,n,p,s,m,i));break;default:L.error("Can't create command for untreated element.type "+n.type);}},this);return l.then(function(){return C;});}.bind(this)).then(function(C){this.fireElementModified({command:C});}.bind(this)).catch(function(M){throw D.propagateError(M,"AdditionalElementsPlugin#_createCommands","Error occured during _createCommands execution","sap.ui.rta.plugin");});}return Promise.resolve();},_createCommandsForInvisibleElement:function(C,s,p,i,m,I){return this._createRevealCommandForInvisible(s,m,p).then(function(r){C.addCommand(r);return this._createMoveCommandForInvisible(s,m,p,i,I);}.bind(this)).then(function(M){if(M){C.addCommand(M);}else{L.warning("No move action configured for "+p.parent.getMetadata().getName()+", aggregation: "+m.aggregation,"sap.ui.rta");}return C;});},_waitForChangeHandlerSettings:function(m){if(m.changeHandlerSettings instanceof Promise){return m.changeHandlerSettings.then(function(s){m.changeHandlerSettings=s;return m.changeHandlerSettings;});}return Promise.resolve(m.changeHandlerSettings);},_createCommandsForODataElement:function(C,s,p,i,m,I){var k=p.parentOverlay.getAggregationOverlay(m.aggregation);var l=k.getDesignTimeMetadata();return this._waitForChangeHandlerSettings(m.addODataProperty.action).then(function(n){var r=n&&n.content&&n.content.requiredLibraries;if(r){return this._createCommandForAddLibrary(p,m,r,l).then(function(t){C.addCommand(t);});}}.bind(this)).then(this._createCommandForOData.bind(this,s,m,p,i,I)).then(function(n){C.addCommand(n);return C;});},_createCommandForOData:function(s,m,p,i,I){var k=p.parentOverlay.getAggregationOverlay(m.aggregation);var l=k.getDesignTimeMetadata();var n=m.addODataProperty.action;return this._waitForChangeHandlerSettings(n).then(function(C){var v;var r=C&&C.key&&C.key.oDataServiceVersion;var R=p.parent;if(n.changeOnRelevantContainer){R=p.relevantContainer;}var t=U.getIndex(p.parent,i,m.aggregation,l.getData().getIndex);return this._getChangeHandler(n.changeType,R).then(function(u){if(p.parentOverlay.getVariantManagement&&u&&u.revertChange){v=p.parentOverlay.getVariantManagement();}var M=F.getAppComponentForControl(p.parent).getManifest();var w=F.getODataServiceUriFromManifest(M);return this.getCommandFactory().getCommandFor(p.parent,"addODataProperty",{newControlId:U.createFieldLabelId(R,s.entityType,s.bindingPath),index:I!==undefined?I:t,bindingString:s.bindingPath,entityType:s.entityType,parentId:p.parent.getId(),oDataServiceVersion:r,oDataServiceUri:w,propertyName:s.name},l,v);}.bind(this));}.bind(this));},_createCommandForAddLibrary:function(p,m,r,i){var C=F.getAppComponentForControl(p.relevantContainer);var M=C.getManifest();var R=M["sap.app"].id;return this.getCommandFactory().getCommandFor(p.publicParent,"addLibrary",{reference:R,parameters:{libraries:r},appComponent:C},i);},_createRevealCommandForInvisible:function(s,m,p){var r=E.getElementInstance(s.elementId);var R=O.getOverlay(r);var i=h(m,r);var k=i.designTimeMetadata;var l=i.action;if(!R){var n=j(r,p,R);R=O.getOverlay(n);}var v;if(R){v=this.getVariantManagementReference(R);}if(l.changeOnRelevantContainer){return this.getCommandFactory().getCommandFor(r,"reveal",{revealedElementId:r.getId(),directParent:p.parent},k,v);}return this.getCommandFactory().getCommandFor(r,"reveal",{},k,v);},_createMoveCommandForInvisible:function(s,m,p,i,I){var r=E.getElementInstance(s.elementId);var R=O.getOverlay(r);var k;if(R){k=R.getParentAggregationOverlay().getAggregationName();}else{var l=h(m,r);k=l.action.getAggregationName(p.parent,r);}var n=j(r,p,R);var t=p.parent;var u=U.getIndex(p.parent,i,k);var v=U.getIndex(n,r,k)-1;u=I!==undefined?I:E.adjustIndexForMove(n,t,v,u);if(u!==v||p.parent!==r.getParent()){var w=O.getOverlay(r)?O.getOverlay(r).getParentAggregationOverlay():p.relevantContainerOverlay;var x=w.getDesignTimeMetadata();var M=x.getAction("move",r);var V;if(M){V=this.getVariantManagementReference(O.getOverlay(r));}return this.getCommandFactory().getCommandFor(p.relevantContainer,"move",{movedElements:[{element:r,sourceIndex:v,targetIndex:u}],source:{parent:n,aggregation:k},target:{parent:t,aggregation:k}},x,V);}return Promise.resolve();},_createCommandsForCustomElement:function(C,s,p,i,m,I){var k=p.parent;var l=p.parentOverlay.getAggregationOverlay(m.aggregation).getDesignTimeMetadata();var n=Object.assign({changeOnRelevantContainer:s.changeSpecificData.changeOnRelevantContainer,aggregationName:m.aggregation,changeType:s.changeSpecificData.changeType,addElementInfo:s.changeSpecificData.content,index:I||U.getIndex(p.parent,i,m.aggregation)},s.itemId&&{customItemId:s.itemId});var v;if(p.relevantContainerOverlay){v=this.getVariantManagementReference(p.relevantContainerOverlay);}return this.getCommandFactory().getCommandFor(k,"customAdd",n,l,v).then(function(r){if(r){C.addCommand(r);}return C;});},_isEditable:function(i){return Promise.all([this._isEditableCheck(i,true),this._isEditableCheck(i,false)]).then(function(p){return{asSibling:p[0],asChild:p[1]};}).catch(function(v){L.error(v);});},_isEditableCheck:function(i,k){return new Promise(function(r,l){var m=false;var p=_(k,i);if(!p.relevantContainerOverlay){return r(false);}this._getActions(k,i,true).then(function(n){return U.doIfAllControlsAreAvailable([i,p.parentOverlay],function(){if(n.addODataProperty){var s=n.addODataProperty.action;m=s&&s.aggregation===i.getParentAggregationOverlay().getAggregationName();}if(!m&&n.reveal){m=true;}if(!m&&n.custom){m=true;}return Promise.resolve(m).then(function(m){if(!m&&!k){return this.checkAggregationsOnSelf(p.parentOverlay,"addODataProperty");}return m;}.bind(this)).then(function(m){if(m){m=this.hasStableId(i)&&this.hasStableId(p.parentOverlay);}return m;}.bind(this));}.bind(this));}.bind(this)).then(function(m){r(m);}).catch(function(v){l(v);});}.bind(this));},getAllElements:function(i,k,I,C){var l=k[0];var p=_(i,l);var m;var n=[];var r=this.getCachedElements(i);if(r){return r;}return this._getActions(i,l).then(function(s){m=s;var t=Promise.resolve([]);if(m.addODataProperty){m.addODataProperty.relevantContainer=l.getRelevantContainer(!i);t=this._waitForChangeHandlerSettings(m.addODataProperty.action).then(function(u){return this._checkIfCreateFunctionIsAvailable(u)?this.getAnalyzer().getUnboundODataProperties(p.parent,m.addODataProperty):[];}.bind(this));}n.push(m.reveal?this.getAnalyzer().enhanceInvisibleElements(p.parent,m):Promise.resolve([]),t,m.custom?this.getAnalyzer().getCustomAddItems(p.parent,m.custom,m.aggregation):Promise.resolve([]));if(m.aggregation||C){this._setDialogTitle(m,p.parent,C);}}.bind(this)).then(function(){if(m.addODataProperty){return U.isServiceUpToDate(p.parent);}}).then(function(){if(m.addODataProperty){return U.isExtensibilityEnabledInSystem(p.parent);}this.getDialog()._oCustomFieldButton.setVisible(false);}.bind(this)).then(function(s){if(m.addODataProperty){this.getDialog()._oCustomFieldButton.setVisible(s);this.getDialog().setCustomFieldEnabled(false);return U.isCustomFieldAvailable(p.parent);}}.bind(this)).then(function(s){if(s){this._oCurrentFieldExtInfo=s;this.getDialog().setCustomFieldEnabled(true);this.getDialog().addBusinessContext(this._oCurrentFieldExtInfo.BusinessContexts);this.getDialog().detachEvent('openCustomField',this._onOpenCustomField,this);this.getDialog().attachEvent('openCustomField',null,this._onOpenCustomField,this);}}.bind(this)).then(this._combineAnalyzerResults.bind(this,n)).then(function(s){this.setCachedElements(s,i);return s;}.bind(this)).catch(function(s){throw s;});},getMenuItems:function(k){var l=true;var p="CTX_ADD_ELEMENTS_AS_SIBLING";var r=20;var I="sap-icon://add";var m=[];this.clearCachedElements();return Promise.all([this.getAllElements(true,k),this.getAllElements(false,k)]).then(function(){for(var i=0;i<2;i++){if(this.isAvailable(l,k)){var M=this.getContextMenuTitle.bind(this,l);m.push({id:p,text:M,handler:function(l,k){return this.showAvailableElements(l,k);}.bind(this,l),enabled:this.isEnabled.bind(this,l),rank:r,icon:I,group:"Add"});}l=false;p="CTX_ADD_ELEMENTS_AS_CHILD";r=30;}return m;}.bind(this));},_combineAnalyzerResults:function(p){return Promise.all(p).then(function(i){return this.getAnalyzer().getFilteredItemsList(i);}.bind(this));},clearCachedElements:function(){this._aCachedElements=undefined;},setCachedElements:function(i,k){this._aCachedElements=this._aCachedElements||{};this._aCachedElements[k?"asSibling":"asChild"]=i;},getCachedElements:function(i){if(!this._aCachedElements){return undefined;}return this._aCachedElements[i?"asSibling":"asChild"];}});function j(r,p,R){var i;if(R){i=R.getParentElementOverlay().getElement();}if(!i&&r.sParentId){i=sap.ui.getCore().byId(r.sParentId);}else if(!i){i=p.parent;}return i;}return A;});
