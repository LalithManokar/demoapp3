sap.ui.define(["sap/ui/core/mvc/Controller","sap/ovp/cards/ActionUtils","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/generic/app/navigation/service/PresentationVariant","sap/ovp/cards/CommonUtils","sap/ovp/cards/OVPCardAsAPIUtils","sap/ui/core/ResizeHandler","sap/ui/core/format/NumberFormat","sap/ovp/cards/AnnotationHelper","sap/ui/model/odata/AnnotationHelper","sap/m/MessageBox","sap/ui/generic/app/navigation/service/NavError","sap/ui/core/CustomData","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button","sap/m/MessageToast","sap/ui/core/TextDirection","sap/ui/generic/app/library","sap/ui/thirdparty/jquery","sap/ovp/app/resources","sap/ovp/app/OVPUtils","sap/base/Log","sap/ui/events/KeyCodes","sap/base/util/merge","sap/base/util/isPlainObject","sap/ui/util/openWindow"],function(C,A,S,P,a,O,R,N,b,c,M,d,e,F,J,D,B,f,T,G,q,g,h,L,K,m,k,o){"use strict";return C.extend("sap.ovp.cards.generic.Card",{initKeyboardNavigation:function(){var j=function(i){this.init(i);};j.prototype.layoutItemFocusHandler=function(){var l=q(document.activeElement);if(l){var n=l.find("[aria-label]");var i,s="";if(l.find('.valueStateText').length==1){var t=l.find('.valueStateText').find('.sapMObjectNumberText').text();var v=l.find('.valueStateText').find('.sapUiInvisibleText').text();l.find('.valueStateText').attr('aria-label',t+" "+v);l.find('.valueStateText').attr('aria-labelledby',"");}l.find("[role='listitem']").attr('aria-label',"");if(l.hasClass('sapOvpCardHeader')&&!l.hasClass('sapOvpStackCardContent')){var p="";var r=l.find('.cardHeaderType');if(r.length===0){var u=g.getText("CardHeaderType");p="cardHeaderType_"+new Date().getTime();var w='<div id="'+p+'" class="cardHeaderType" aria-label="'+u+'" hidden></div>';l.append(w);}else{p=r[0].id;}s+=p+" ";}for(i=0;i<n.length;i++){if(n[i].getAttribute("role")==="heading"){s+=n[i].id+" ";}}if(l.hasClass('sapOvpCardHeader')){var x=l.find('.cardHeaderText');if(x.length!==0){for(var i=0;i<x.length;i++){if(s.indexOf(x[i].id)===-1){s+=x[i].id+" ";}}}}if(s.length){l.attr("aria-labelledby",s);}if(l.prop('nodeName')==="LI"&&l.find('.linkListHasPopover').length!==0){if(l.find('#hasDetails').length===0){l.append("<div id='hasDetails' hidden>"+g.getText("HAS_DETAILS")+"</div>");l.attr('aria-describedby',"hasDetails");}}var y=l.attr("id");if((y&&y.indexOf("ovpTable")!=-1)&&l.find("[role='Link']")&&!l.hasClass('sapUiCompSmartLink')){var z=l.closest("td").attr("data-sap-ui-column"),E=l.closest("tbody").siblings().children().filter("tr").children();for(var i=0;i<E.length;i++){if(E[i].getAttribute("data-sap-ui")==z&&E[i].hasChildNodes("span")){var H=E[i].firstElementChild.getAttribute("id");l.attr("aria-labelledby",H);}}}}};j.prototype.init=function(i){this.cardLayout=i;this.keyCodes=K;this.jqElement=q(i.getView().$());this.jqElement=this.jqElement.parent().parent().parent();this.jqElement.on("focus.keyboardNavigation",this.layoutItemFocusHandler.bind(this));};this.keyboardNavigation=new j(this);},onInit:function(){this.oCardComponent=this.getOwnerComponent();this.oCardComponentData=this.oCardComponent&&this.oCardComponent.getComponentData();this.oMainComponent=this.oCardComponentData&&this.oCardComponentData.mainComponent;this.sCardId=this.oCardComponentData.cardId;var s=this.getView().mPreprocessors.xml[0].ovpCardProperties.oData.state;if(s!=="Error"){var H=this.getView().byId("ovpCardHeader");if(!!H){H.attachBrowserEvent("click",this.onHeaderClick.bind(this));H.addEventDelegate({onkeydown:function(E){if(!E.shiftKey&&E.keyCode==13){E.preventDefault();this.onHeaderClick(E);}else if(!E.shiftKey&&E.keyCode==32){E.preventDefault();}}.bind(this)});H.addEventDelegate({onkeyup:function(E){if(!E.shiftKey&&E.keyCode==32){E.preventDefault();this.onHeaderClick(E);}}.bind(this)});}}var n=this.getView().byId("kpiNumberValue");if(n){n.addEventDelegate({onAfterRendering:function(){var $=n.$();var i=$.find(".sapMNCValueScr");var j=$.find(".sapMNCScale");i.attr("aria-label",i.text());j.attr("aria-label",j.text());var l=this.getView().byId("ovpCardHeader").getDomRef();var p=this.getOwnerComponent().getComponentData();if(!!p&&!!p.appComponent){var r=p.appComponent;if(!!r.getModel("ui")){var u=r.getModel("ui");if(!!u.getProperty("/containerLayout")&&u.getProperty("/containerLayout")==="resizable"){var t=p.appComponent.getDashboardLayoutUtil();if(!!t){t.setKpiNumericContentWidth(l);}}}}}.bind(this)});}},exit:function(){if(this.resizeHandlerId){R.deregister(this.resizeHandlerId);}},onAfterRendering:function(){var i=this.getCardPropertiesModel();this.enableClick=true;var s=i.getProperty("/contentFragment");var j=this.getOwnerComponent().getComponentData();this._handleCountHeader();this._handleKPIHeader();var l=i.getProperty("/selectedKey");if(l&&i.getProperty("/state")!=='Loading'){var n=this.getView().byId("ovp_card_dropdown");if(n){n.setSelectedKey(l);}}try{var j=this.getOwnerComponent().getComponentData();if(j&&j.appComponent){var p=j.appComponent;if(p.getModel('ui')){var u=p.getModel('ui');if(u.getProperty('/containerLayout')==='resizable'){var r=p.getDashboardLayoutUtil();if(r){this.oDashboardLayoutUtil=r;this.cardId=j.cardId;if(r.isCardAutoSpan(j.cardId)){this.resizeHandlerId=R.register(this.getView(),function(Y){L.info('DashboardLayout autoSize:'+Y.target.id+' -> '+Y.size.height);r.setAutoCardSpanHeight(Y);});}}}}}}catch(t){L.error("DashboardLayout autoSpan check failed.");}if(this.oDashboardLayoutUtil&&this.oDashboardLayoutUtil.isCardAutoSpan(this.cardId)){var $=q("#"+this.oDashboardLayoutUtil.getCardDomId(this.cardId));if(this.oView.$().outerHeight()>$.innerHeight()){this.oDashboardLayoutUtil.setAutoCardSpanHeight(null,this.cardId,this.oView.$().height());}}var I=0;if(j&&j.mainComponent){var v=j.mainComponent;if(v.bGlobalFilterLoaded){I=this.checkNavigation();}}else if(O.checkIfAPIIsUsed(this)){I=this.checkAPINavigation();}var w=this.getCardPropertiesModel();var x=w.getProperty("/state");if(x!=="Loading"&&x!=="Error"){var y=w.getProperty("/template");if(y==="sap.ovp.cards.stack"){if(!I){var z=this.getView().byId('ViewAll');if(z){z=z.getDomRef();q(z).remove();}}}}if(I){if(s?s!=="sap.ovp.cards.quickview.Quickview":true){if(s==="sap.ovp.cards.stack.Stack"){var E=this.getView().getDomRef();var H=q(E).find('.sapOvpCardContentRightHeader');if(H.length!==0){H.addClass('sapOvpCardNavigable');}}else{this.getView().addStyleClass("sapOvpCardNavigable");}}if(s&&s==="sap.ovp.cards.quickview.Quickview"){var Q=this.byId("ovpCardHeader");if(Q){Q.addStyleClass("sapOvpCardNavigable");}}}else{if(s){this.getView().addStyleClass("ovpNonNavigableItem");var Q=this.byId("ovpCardHeader");if(Q){Q.$().removeAttr('role');Q.addStyleClass('ovpNonNavigableItem');}var U=this.checkLineItemNavigation();if(!U){switch(s){case"sap.ovp.cards.list.List":var V=this.getView().byId("listItem");if(V){V.setType("Inactive");}break;case"sap.ovp.cards.table.Table":var V=this.getView().byId("tableItem");if(V){V.setType("Inactive");}break;case"sap.ovp.cards.linklist.LinkList":if(!this.checkNavigationForLinkedList()){var V=this.getView().byId("ovpCLI");if(V){V.setType("Inactive");}}break;}}}}var W=this.getView().byId("ovp_card_dropdown");var X=this.getView().byId("ovp_card_dropdown_label");if(W){W.addAriaLabelledBy(X.getId());}if(O.checkIfAPIIsUsed(this)){this.initKeyboardNavigation();}},checkNavigation:function(){var i=this.getCardPropertiesModel();if(this.checkHeaderNavForChart()){return 0;}var E=this.getEntityType();if(E){if(i){var I=i.getProperty("/identificationAnnotationPath");var s=I;var j=i.getProperty("/contentFragment");if(j&&(j==="sap.ovp.cards.stack.Stack"||j==="sap.ovp.cards.quickview.Quickview")){var l=(I)?I.split(","):[];if(l&&l.length>1){if(j==="sap.ovp.cards.stack.Stack"){s=l[0];}else{s=l[1];}}}var r=E[s];if(this.isNavigationInAnnotation(r)){return 1;}if(i&&i.getProperty("/template")==="sap.ovp.cards.charts.analytical"){var n=i.getProperty("/kpiAnnotationPath");if(E&&n){var p=E[n];if(p&&p.Detail){var t=p.Detail.SemanticObject&&p.Detail.SemanticObject.String;var u=p.Detail.Action&&p.Detail.Action.String;if(t&&u){return 1;}}}}}}else if(i&&i.getProperty("/template")==="sap.ovp.cards.linklist"&&i.getProperty("/staticContent")&&i.getProperty("/targetUri")){return 1;}return 0;},checkNavigationForLinkedList:function(){if(this.getEntityType()){var E=this.getEntityType();var l=E['com.sap.vocabularies.UI.v1.LineItem'];if(l&&(l[0].RecordType==="com.sap.vocabularies.UI.v1.DataFieldForAction"||l[0].RecordType==="com.sap.vocabularies.UI.v1.DataFieldWithUrl")){return true;}}return false;},checkLineItemNavigation:function(){if(this.getEntityType()){var E=this.getEntityType();var i=this.getCardPropertiesModel();if(i){var s=i.getProperty("/annotationPath");var r=E[s];return this.isNavigationInAnnotation(r);}}},isNavigationInAnnotation:function(r){if(r&&r.length){for(var i=0;i<r.length;i++){var I=r[i];if(I.RecordType==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"||I.RecordType==="com.sap.vocabularies.UI.v1.DataFieldForAction"||I.RecordType==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"){return 1;}}}return 0;},checkAPINavigation:function(){var i=this.getOwnerComponent().getComponentData(),j=i.fnCheckNavigation&&typeof i.fnCheckNavigation==="function",l=j?i.fnCheckNavigation:null;if(l){if(l()){return true;}}else{if(this.checkNavigation()){return true;}}return false;},onHeaderClick:function(E){var n=E.ctrlKey||E.metaKey?h.constants.explace:h.constants.inplace;if(O.checkIfAPIIsUsed(this)){if(this.checkAPINavigation()){a.onHeaderClicked();}}else{var i=this.getCardPropertiesModel();var t=i.getProperty("/template");var s=i.getProperty("/targetUri");if(t=="sap.ovp.cards.linklist"&&i.getProperty("/staticContent")!==undefined&&s){window.location.href=s;}else if(i.getProperty("/staticContent")!==undefined&&s===""){return;}else if(this.checkHeaderNavForChart()){return;}else{this.doNavigation(this.getView().getBindingContext(),null,n);}}},checkHeaderNavForChart:function(){var i=this.getCardPropertiesModel();var t=i.getProperty("/template");var n=i.getProperty("/navigation");if(n=="noHeaderNav"&&(t=="sap.ovp.cards.charts.analytical"||"sap.ovp.cards.charts.smart.chart")){return true;}else{return false;}},resizeCard:function(i){L.info(i);if(this.resizeHandlerId){R.deregister(this.resizeHandlerId);this.resizeHandlerId=null;}},_handleCountHeader:function(){var i=this.getView().byId("ovpCountHeader");if(i){var I=this.getCardItemsBinding();if(I){if(I.isLengthFinal()&&I.getLength()>0){this.setHeaderCounter(I,i);}I.attachDataReceived(function(E){this.setHeaderCounter(I,i,E);}.bind(this));I.attachChange(function(E){this.setHeaderCounter(I,i,E);}.bind(this));}}},setHeaderCounter:function(i,j,E){var t;if(i.isLengthFinal()){t=i.getLength();}else{if(E&&E.getParameters().data&&E.getParameters().data.results){t=E.getParameters().data.results.length;}}var l=i.getCurrentContexts().length;var n,p="";var r=N.getIntegerInstance({minFractionDigits:0,maxFractionDigits:1,decimalSeparator:".",style:"short"});l=parseFloat(l,10);var s=this.getOwnerComponent().getComponentData();if(s&&s.appComponent){var u=s.appComponent;if(u.getModel('ui')){var U=u.getModel('ui');if(U.getProperty('/containerLayout')!=='resizable'){if(t!==0){t=r.format(Number(t));}if(l!==0){l=r.format(Number(l));}}else{n=u.getDashboardLayoutUtil().dashboardLayoutModel.getCardById(s.cardId);}}}if(l===0){p="";}else if(n&&n.dashboardLayout.showOnlyHeader){p=g.getText("Count_Header_Total",[t]);}else if(t!=l){p=g.getText("Count_Header",[l,t]);}j.setText(p);var v=j.$();v.attr("aria-label",p);},_handleKPIHeader:function(){var i,s;if(this.getView()&&this.getView().getDomRef()){i=this.getView().getDomRef().getElementsByClassName("numericContentHbox");s=this.getView().getDomRef().getElementsByClassName("noDataSubtitle");}else{return;}if(i||s){var j=this.getKPIBinding();if(j){j.attachDataReceived(function(E){var U=E.getParameter("data")&&E.getParameter("data").results&&E.getParameter("data").results[0];var t=j.getLength();if(i[0]){i[0].style.visibility=null;if(t===0){i[0].style.visibility='hidden';}else{this._setSubTitleWithUnitOfMeasure(U);i[0].style.visibility='visible';}}if(s.length!==0){s[0].style.display="none";if(t===0){s[0].style.display="flex";}}}.bind(this));}}},getKPIBinding:function(){var n=this.byId("kpiHBoxNumeric"),i=n&&n.getBindingInfo("items")&&n.getBindingInfo("items").binding;return i;},_setSubTitleWithUnitOfMeasure:function(U){var i=this.getCardPropertiesModel();if(!!i){var j=i.getData();var s=this.getView().byId("SubTitle-Text");if(!!s){s.setText(j.subTitle);if(!!j&&!!j.entityType&&!!j.dataPointAnnotationPath){var E=i.getData().entityType;var l=j.dataPointAnnotationPath.split("/");var n=l.length===1?E[j.dataPointAnnotationPath]:E[l[0]][l[1]];var p;if(n&&n.Value&&n.Value.Path){p=n.Value.Path;}else if(n&&n.Description&&n.Description.Value&&n.Description.Value.Path){p=n.Description.Value.Path;}if(!!p){var r=a.getUnitColumn(p,E);var u;if(!!r&&!!U){u=U[r];}else{u=a.getUnitColumn(p,E,true);}var t=g.getText("SubTitle_IN");if(!!j.subTitle&&!!t&&!!u){s.setText(j.subTitle+" "+t+" "+u);var v=s.getAggregation("customData");if(v){var w;for(w in v){var x=v[w];if(x.getKey()==="aria-label"){x.setValue(j.subTitle+" "+t+" "+u);break;}}}}}}}}},getCardItemsBinding:function(){},onActionPress:function(E){var s=E.getSource(),i=this._getActionObject(s),j=s.getBindingContext();if(i.type.indexOf("DataFieldForAction")!==-1){this.doAction(j,i);}else{this.doNavigation(j,i);}},_getActionObject:function(s){var j=s.getCustomData();var l={};for(var i=0;i<j.length;i++){l[j[i].getKey()]=j[i].getValue();}return l;},doNavigation:function(i,n,s){if(!s){s=h.constants.inplace;}if(!this.enableClick){return;}this.enableClick=false;setTimeout(function(){this.enableClick=true;}.bind(this),1000);if(!this.oMainComponent){return;}if(!n){n=this.getEntityNavigationEntries(i)[0];}var j=q.extend(true,{},i);var l=q.extend(true,{},n);var p=this.oMainComponent.doCustomNavigation&&this.oMainComponent.doCustomNavigation(this.sCardId,j,l);var E=this.oMainComponent.templateBaseExtension&&this.oMainComponent.templateBaseExtension.provideExtensionNavigation&&this.oMainComponent.templateBaseExtension.provideExtensionNavigation(this.sCardId,j,l);var r;if(p){r=p;}if(E){r=E;}if(r){var t=r.type;if(t&&typeof t==="string"&&t.length>0){t=t.split(".").pop().split("/").pop().toLowerCase();switch(t){case"datafieldwithurl":r.type="com.sap.vocabularies.UI.v1.DataFieldWithUrl";break;case"datafieldforintentbasednavigation":r.type="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation";break;}n=r;}}function u(s){if(!s){s=h.constants.inplace;}if(n){switch(n.type){case"com.sap.vocabularies.UI.v1.DataFieldWithUrl":this.doNavigationWithUrl(i,n,s);break;case"com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation":this.doIntentBasedNavigation(i,n,false,s);break;case"com.sap.vocabularies.UI.v1.KPIDetailType":this.doIntentBasedNavigation(i,n,false,s);break;}}}if(!this.oMainComponent.oAppStatePromise){u.call(this,s);}else{this.oMainComponent.oAppStatePromise.then(u.bind(this,s));}},doNavigationWithUrl:function(i,n,s){if(!s){s=h.constants.inplace;}if(!sap.ushell.Container){return;}var p=sap.ushell.Container.getService("URLParsing");if(!(p.isIntentUrl(n.url))){o(n.url,"newWindow");}else{var j=p.parseShellHash(n.url);var w=j.appSpecificRoute?true:false;this.doIntentBasedNavigation(i,j,w,s);}},fnHandleError:function(E){if(E instanceof d){if(E.getErrorCode()==="NavigationHandler.isIntentSupported.notSupported"){M.show(g.getText("OVP_NAV_ERROR_NOT_AUTHORIZED_DESC"),{title:g.getText("OVP_GENERIC_ERROR_TITLE")});}else{M.show(E.getErrorCode(),{title:g.getText("OVP_GENERIC_ERROR_TITLE")});}}},doCrossApplicationNavigation:function(I,n){var s="#"+I.semanticObject+'-'+I.action;if(I.params){var l=this.oCardComponent&&this.oCardComponent.getComponentData();var p=l&&l.appComponent;if(p){var r=p._formParamString(I.params);s=s+r;}}var t=this;if(!sap.ushell.Container){return;}sap.ushell.Container.getService("CrossApplicationNavigation").isIntentSupported([s]).done(function(u){if(u[s].supported===true){if(!!n.params){if(typeof n.params=='string'){try{n.params=JSON.parse(n.params);}catch(v){L.error("Could not parse the Navigation parameters");return;}}}var l=t.getOwnerComponent().getComponentData();var w=l?l.globalFilter:undefined;var U=w&&w.getUiState({allFilters:false});var x=U?JSON.stringify(U.getSelectionVariant()):"{}";w=q.parseJSON(x);var y=t._getFilterPreference();w=t._removeFilterFromGlobalFilters(y,w);if(!n.params){n.params={};}if(!!w&&!!w.SelectOptions){for(var i=0;i<w.SelectOptions.length;i++){var z=w.SelectOptions[i].Ranges;if(!!z){var E=[];for(var j=0;j<z.length;j++){if(z[j].Sign==="I"&&z[j].Option==="EQ"){E.push(z[j].Low);}}n.params[w.SelectOptions[i].PropertyName]=E;}}}sap.ushell.Container.getService("CrossApplicationNavigation").toExternal(n);}else{var H=new d("NavigationHandler.isIntentSupported.notSupported");t.fnHandleError(H);}}).fail(function(){L.error("Could not get authorization from isIntentSupported");});},doIntentBasedNavigation:function(i,I,u,n){if(!n){n=h.constants.inplace;}if(sap.ushell&&!sap.ushell.Container){return;}var p,j,l,E=i?i.getObject():null;var r=this.getCardPropertiesModel(),s=r.getProperty("/customParams");if(i&&typeof i.getAllData==="function"&&s){l=i.getAllData();}else if(r.getProperty("/staticContent")){l={iStaticLinkListIndex:I.iStaticLinkListIndex,bStaticLinkListIndex:true};}if(E&&E.__metadata){delete E.__metadata;}var t=a.getNavigationHandler();if(t){if(I){p=this._getEntityNavigationParameters(E,l,i);j={target:{semanticObject:I.semanticObject,action:I.action},appSpecificRoute:I.appSpecificRoute,params:p.sNavSelectionVariant};var v={};if(p.sNavPresentationVariant){v.presentationVariant=p.sNavPresentationVariant;}if(u){if(I&&I.semanticObject&&I.action){var w=this.getCardPropertiesModel().getProperty("/staticParameters");j.params=(!!w)?w:{};this.doCrossApplicationNavigation(I,j);}}else{t.navigate(j.target.semanticObject,j.target.action,j.params,null,this.fnHandleError,v,n);}}}},doAction:function(i,j){this.actionData=A.getActionInfo(i,j,this.getEntityType());if(this.actionData.allParameters.length>0){this._loadParametersForm();}else{this._callFunction();}},getEntityNavigationEntries:function(j,s){var n=[];var E=this.getEntityType();var l=this.getCardPropertiesModel();var p=l.getProperty("/template");if(!E){return n;}if(!s&&!j){if(!this.oCardComponentData.settings.identificationAnnotationPath){var r=l.getProperty("/kpiAnnotationPath");if(r&&p==="sap.ovp.cards.charts.analytical"){s=r;var t=E[s];var u=t&&t.Detail;var v=u.SemanticObject&&u.SemanticObject.String;var w=u.Action&&u.Action.String;if(u.RecordType==="com.sap.vocabularies.UI.v1.KPIDetailType"){if(v&&w){n.push({type:u.RecordType,semanticObject:v,action:w,label:""});}else{L.error("Invalid Semantic object and action configured for annotation "+u.RecordType);}}}}}if(!s){var I=l.getProperty("/identificationAnnotationPath");var x=(I)?I.split(","):[];if(x&&x.length>1){s=x[0];}else{s=I;}}var y=E[s];if(Array.isArray(y)){y=b.sortCollectionByImportance(y);for(var i=0;i<y.length;i++){if(y[i].RecordType==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"){n.push({type:y[i].RecordType,semanticObject:y[i].SemanticObject.String,action:y[i].Action.String,label:y[i].Label?y[i].Label.String:null});}if(y[i].RecordType==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"&&!y[i].Url.UrlRef){var z=this.getView().getModel();var H=z.oMetaModel;var Q=H.createBindingContext(E.$path);var U=c.format(Q,y[i].Url);var V=new e({key:"url",value:U});if(j&&p==="sap.ovp.cards.charts.analytical"){z=j.getModel();}V.setModel(z);V.setBindingContext(j);var W=V.getValue();n.push({type:y[i].RecordType,url:W,value:y[i].Value.String,label:y[i].Label?y[i].Label.String:null});}}}return n;},getModel:function(){return this.getView().getModel();},getMetaModel:function(){if(this.getModel()){return this.getModel().getMetaModel();}},getCardPropertiesModel:function(){if(!this.oCardPropertiesModel||q.isEmptyObject(this.oCardPropertiesModel)){this.oCardPropertiesModel=this.getView().getModel("ovpCardProperties");}return this.oCardPropertiesModel;},getEntitySet:function(){if(!this.entitySet){var E=this.getCardPropertiesModel().getProperty("/entitySet");this.entitySet=this.getMetaModel().getODataEntitySet(E);}return this.entitySet;},getEntityType:function(){if(!this.entityType){if(this.getMetaModel()&&this.getEntitySet()){this.entityType=this.getMetaModel().getODataEntityType(this.getEntitySet().entityType);}}return this.entityType;},getCardContentContainer:function(){if(!this.cardContentContainer){this.cardContentContainer=this.getView().byId("ovpCardContentContainer");}return this.cardContentContainer;},_processCustomParameters:function(j,s,l){var n=this.getCardPropertiesModel();if(!this.oMainComponent||!n){return;}var p;if(j&&j.bStaticLinkListIndex){var r=n.getProperty("/staticContent");p=r[j.iStaticLinkListIndex]["customParams"];j=null;}else{p=n.getProperty("/customParams");}if(!p||!this.oMainComponent.templateBaseExtension.provideCustomParameter||!this.oMainComponent.onCustomParams){return;}var t=this.oMainComponent.templateBaseExtension.provideCustomParameter(p)?this.oMainComponent.templateBaseExtension.provideCustomParameter(p):this.oMainComponent.onCustomParams(p);if(!t||!q.isFunction(t)){return;}var u=q.extend(true,{},j);var v=q.extend(true,{},s);var w=t(u,v);if(!w||(!Array.isArray(w)&&!k(w))){return;}var I=k(w);if(I&&q.isEmptyObject(w)){return;}var x=I&&(w.bIgnoreEmptyString||w.ignoreEmptyString);var y=I?(w.aSelectionVariant||w.selectionVariant):w;if(!Array.isArray(y)){return;}var i,z,E,H,V,Q;z=y.length;for(i=0;i<z;i++){E=y[i];if(!E){continue;}H=E.path;V=E.value1;Q=E.value2;if(!H||typeof H!=="string"||H===""){L.error("Custom Variant property path '"+H+"' should be valid string");continue;}if(!(V||V===0||(V===""&&x))){continue;}V=V.toString();Q=Q&&Q.toString();if(V===""&&x){s.removeSelectOption(H);}if(j){delete j[H];}if(l){delete l[H];}s.addSelectOption(H,E.sign,E.operator,V,Q);}if(x){this._removeEmptyStringsFromSelectionVariant(s);}return x;},_getEntityNavigationParameters:function(E,j,l){var n={};var s,p,r;var t=this.getOwnerComponent().getComponentData();var u=t?t.globalFilter:undefined;var v=this.getCardPropertiesModel();var w=v&&v.getProperty("/staticContent");if(!w){var x=b.getCardSelections(this.getCardPropertiesModel());var y=x.filters;var z=x.parameters;var H=this.getEntityType();y&&y.forEach(function(g1){g1.path=g1.path.replace("/",".");switch(g1.operator){case F.NE:g1.operator=F.EQ;g1.sign="E";break;case F.Contains:g1.operator="CP";var h1=g1.value1;g1.value1="*"+h1+"*";break;case F.EndsWith:g1.operator="CP";var h1=g1.value1;g1.value1="*"+h1;break;case F.StartsWith:g1.operator="CP";var h1=g1.value1;g1.value1=h1+"*";}});x.filters=y;if(l&&E&&E.hasOwnProperty("$isOthers")){var I=l.getOtherNavigationDimensions();for(var Q in I){var U=I[Q];for(var i=0;i<U.length;i++){x.filters.push({path:Q,operator:"EQ",value1:U[i],sign:"E"});}}}z&&z.forEach(function(g1){g1.path=g1.path.replace("/",".");});x.parameters=z;var V=b.getCardSorters(this.getCardPropertiesModel());if(E){var Q;for(var i=0;H.property&&i<H.property.length;i++){Q=H.property[i].name;var W=E[Q];if(E.hasOwnProperty(Q)){if(Array.isArray(E[Q])&&E[Q].length===1){n[Q]=E[Q][0];}else if(q.type(W)!=="object"){n[Q]=W;}}}}var X=v&&v.getProperty("/kpiAnnotationPath");var Y=v&&v.getProperty("/template");if(X&&Y==="sap.ovp.cards.charts.analytical"){var Z=H[X];var $=Z&&Z.Detail;if($&&$.RecordType==="com.sap.vocabularies.UI.v1.KPIDetailType"){n["kpiID"]=Z.ID.String;}}p=V&&new P(V);s=this._buildSelectionVariant(u,x);r=v&&v.getProperty("/staticParameters");}else{var _=u&&u.getUiState({allFilters:false});var a1=_?JSON.stringify(_.getSelectionVariant()):"{}";s=new S(a1);var b1=this._getFilterPreference();s=this._removeFilterFromGlobalFilters(b1,s);if(w[j.iStaticLinkListIndex].params){r=w[j.iStaticLinkListIndex].params;}else if(w[j.iStaticLinkListIndex].staticParameters){r=w[j.iStaticLinkListIndex].staticParameters;}}var c1;if(j&&!j.bStaticLinkListIndex){c1=this._processCustomParameters(j,s,n);}else if(j&&j.bStaticLinkListIndex){c1=this._processCustomParameters(j,s);}else{c1=this._processCustomParameters(n,s);}var d1=c1?G.navigation.service.SuppressionBehavior.ignoreEmptyString:undefined;if(r){for(var Q in r){if(!n.hasOwnProperty(Q)){n[Q]=r[Q];}}}var e1=a.getNavigationHandler();var f1=e1&&e1.mixAttributesAndSelectionVariant(n,s.toJSONString(),d1);if(!w){this._removeSensitiveAttributesFromNavSelectionVariant(H,f1);}return{sNavSelectionVariant:f1?f1.toJSONString():null,sNavPresentationVariant:p?p.toJSONString():null};},_removeSensitiveAttributesFromNavSelectionVariant:function(E,n){for(var i=0;i<E.property.length;i++){if(E.property[i]["com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"]&&E.property[i]["com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"].Bool){delete n._mSelectOptions[E.property[i].name];}}},_removeEmptyStringsFromSelectionVariant:function(s){var p=s.getParameterNames();for(var i=0;i<p.length;i++){if(s.getParameter(p[i])===""){s.removeParameter(p[i]);}}var l=s.getSelectOptionsPropertyNames();for(i=0;i<l.length;i++){var n=s.getSelectOption(l[i]);for(var j=0;j<n.length;j++){if(n[j].Low===""&&!n[j].High){n.splice(j,1);j--;}}if(n.length===0){s.removeSelectOption(l[i]);}}return s;},_checkIfCardFiltersAreValid:function(i,p){var j=true;if(i&&i.filterAll==="global"){j=false;}else if(i&&i.globalFilter){if(i.globalFilter.indexOf(p)>=0){j=false;}}return j;},_getFilterPreference:function(){var i=this.getOwnerComponent()?this.getOwnerComponent().getComponentData():null;var j;if(i&&i.mainComponent){j=i.mainComponent._getFilterPreference(i.cardId);}return j;},_removeFilterFromGlobalFilters:function(i,s){var j=[];if(i&&i.filterAll==="card"){j=s.getSelectOptionsPropertyNames();}else if(i&&i.cardFilter){j=i.cardFilter;}j.forEach(function(p){if(p!=="$.basicSearch"){s.removeSelectOption(p);}});return s;},_buildSelectionVariant:function(l,n){var u=l&&l.getUiState({allFilters:false});var s=u?JSON.stringify(u.getSelectionVariant()):"{}";var p=new S(s);var r,v,V,t;var w=this._getFilterPreference();p=this._removeFilterFromGlobalFilters(w,p);var x=n.filters;var y=n.parameters;for(var i=0;i<x.length;i++){r=x[i];if(r.path&&r.operator&&typeof r.value1!=="undefined"){v=r.value1.toString();V=(typeof r.value2!=="undefined")?r.value2.toString():undefined;if(this._checkIfCardFiltersAreValid(w,r.path)){p.addSelectOption(r.path,r.sign,r.operator,v,V);}}}var z,E,H;for(var j=0;j<y.length;j++){t=y[j];if(!t.path||!t.value){continue;}z=t.path.split("/").pop();z=z.split(".").pop();if(z.indexOf("P_")===0){E=z;H=z.substr(2);}else{E="P_"+z;H=z;}if(p.getParameter(E)){continue;}if(p.getParameter(H)){continue;}p.addParameter(z,t.value);}return p;},_loadParametersForm:function(){var p=new J();p.setData(this.actionData.parameterData);var t=this;var i=new D('ovpCardActionDialog',{title:this.actionData.sFunctionLabel,afterClose:function(){i.destroy();}}).addStyleClass("sapUiNoContentPadding");var j=new B({text:this.actionData.sFunctionLabel,press:function(E){var s=A.getParameters(E.getSource().getModel(),t.actionData.oFunctionImport);i.close();t._callFunction(s,t.actionData.sFunctionLabel);}});var l=new B({text:"Cancel",press:function(){i.close();}});i.setBeginButton(j);i.setEndButton(l);var n=function(E){var s=A.mandatoryParamsMissing(E.getSource().getModel(),t.actionData.oFunctionImport);j.setEnabled(!s);};var r=A.buildParametersForm(this.actionData,n);i.addContent(r);i.setModel(p);i.open();},_callFunction:function(u,i){var p={batchGroupId:"Changes",changeSetId:"Changes",urlParameters:u,forceSubmit:true,context:this.actionData.oContext,functionImport:this.actionData.oFunctionImport};var t=this;var j=new Promise(function(r,l){var n=t.actionData.oContext.getModel();var s;s="/"+p.functionImport.name;n.callFunction(s,{method:p.functionImport.httpMethod,urlParameters:p.urlParameters,batchGroupId:p.batchGroupId,changeSetId:p.changeSetId,headers:p.headers,success:function(v,w){r(w);},error:function(v){v.actionText=i;l(v);}});});j.then(function(r){return f.show(g.getText("Toast_Action_Success"),{duration:1000});},function(E){var l=a.showODataErrorMessages(E);if(l===""&&E.actionText){l=g.getText("Toast_Action_Error")+' "'+E.actionText+'"'+".";}return M.error(l,{title:g.getText("OVP_GENERIC_ERROR_TITLE"),onClose:null,styleClass:"",initialFocus:null,textDirection:T.Inherit});});},setErrorState:function(){var i=this.getOwnerComponent();if(!i||!i.oContainer){return;}var j=i.oContainer;var l=this.getCardPropertiesModel();var n={name:"sap.ovp.cards.loading",componentData:{model:this.getView().getModel(),settings:{category:l.getProperty("/category"),title:l.getProperty("/title"),description:l.getProperty("/description"),entitySet:l.getProperty("/entitySet"),state:h.loadingState.ERROR,template:l.getProperty("/template")}}};var p=sap.ui.component(n);j.setComponent(p);setTimeout(function(){i.destroy();},0);},changeSelection:function(s,i,j){if(!i){var l=this.getView().byId("ovp_card_dropdown");s=parseInt(l.getSelectedKey(),10);}var t={};if(!i){t=this.getCardPropertiesModel().getProperty("/tabs")[s-1];}else{t=j.tabs[s-1];}var u={cardId:this.getOwnerComponent().getComponentData().cardId,selectedKey:s};for(var p in t){u[p]=t[p];}if(O.checkIfAPIIsUsed(this)){O.recreateCard(u,this.getOwnerComponent().getComponentData());}else{this.getOwnerComponent().getComponentData().mainComponent.recreateCard(u);this.getOwnerComponent().getComponentData().mainComponent.setOrderedCardsSelectedKey(this.getOwnerComponent().getComponentData().cardId,s);}},getItemHeight:function(i,s,j){if(!!i){var l=i.getView().byId(s);var H=0;if(!!l){if(j){if(l.getItems()[0]&&l.getItems()[0].getDomRef()){H=q(l.getItems()[0].getDomRef()).outerHeight(true);}}else{if(l.getDomRef()){H=q(l.getDomRef()).outerHeight(true);}}}return H;}},getHeaderHeight:function(){var H=this.getItemHeight(this,'ovpCardHeader'),i=this.getOwnerComponent()?this.getOwnerComponent().getComponentData():null;if(i&&i.appComponent){var j=i.appComponent.getDashboardLayoutUtil(),l=j.getDashboardLayoutModel().getCardById(i.cardId);if(H!==0){l.dashboardLayout.headerHeight=H;}}return H;}});});
