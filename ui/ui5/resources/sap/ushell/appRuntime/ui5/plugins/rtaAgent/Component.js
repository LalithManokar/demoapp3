// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/Component","sap/ui/fl/write/api/FeaturesAPI","sap/ushell/appRuntime/ui5/plugins/baseRta/CheckConditions","sap/ushell/appRuntime/ui5/plugins/baseRta/AppLifeCycleUtils","sap/ushell/appRuntime/ui5/plugins/baseRta/Renderer","sap/ushell/appRuntime/ui5/plugins/baseRta/Trigger","sap/base/Log"],function(C,F,a,A,R,T,L){"use strict";var p;function g(){return{sComponentName:"sap.ushell.appRuntime.ui5.plugins.rtaAgent",layer:"CUSTOMER",developerMode:false};}function b(v){return new Promise(function(r,f){p.postMessageToFlp("user.postapi.rtaPlugin","switchToolbarVisibility",{visible:v}).done(r).fail(f);});}function c(){return new Promise(function(r,f){p.postMessageToFlp("user.postapi.rtaPlugin","activatePlugin").done(r).fail(f);});}function d(){if(a.checkUI5App()){p.postMessageToFlp("user.postapi.rtaPlugin","showAdaptUI").fail(function(E){throw new Error(E);});}}function e(f){var m=f&&f.config;if(m&&typeof m.validateAppVersion==="boolean"){return m.validateAppVersion;}return true;}function o(){this.oTrigger.triggerStopRta(true,true);}return C.extend("sap.ushell.appRuntime.ui5.plugins.rtaAgent.Component",{metadata:{manifest:"json"},init:function(){this.mConfig=g();p=this.getComponentData().oPostMessageInterface;return F.isKeyUser().then(function(i){if(i){return c();}return Promise.reject();}).then(function(){this.mConfig.i18n=this.getModel("i18n").getResourceBundle();this.mConfig.onStartHandler=this._onStartHandler.bind(this);this.mConfig.onErrorHandler=this._onErrorHandler.bind(this);this.mConfig.onStopHandler=this._onStopHandler.bind(this);this.oTrigger=new T(this.mConfig);var f=this.getComponentData();this.mConfig.bValidateAppVersion=e(f);this._registerPostMessages();this._restartRtaIfRequired();return A.getAppLifeCycleService();}.bind(this)).then(function(f){f.attachAppLoaded(this._onAppLoaded,this);return R.getRenderer(this);}.bind(this)).then(function(r){this.oRenderer=r;}.bind(this)).then(d).catch(function(E){if(E){L.error(E);}});},_registerPostMessages:function(){p.registerPostMessageAPIs({"user.postapi.rtaPlugin":{inCalls:{startUIAdaptation:{executeServiceCallFn:function(){sap.ui.getCore().getEventBus().subscribe("sap.ushell","appClosed",o.bind(this));this.oRenderer.addTopHeaderPlaceHolder();this.oTrigger.triggerStartRta(this);return p.createPostMessageResult();}.bind(this)}},outCalls:{activatePlugin:{},showAdaptUI:{}}}});},_restartRtaIfRequired:function(){if(a.checkUI5App()){if(a.checkRestartRTA(this.mConfig.layer)){return b(false).then(function(){this.oRenderer.addTopHeaderPlaceHolder();return this.oTrigger.triggerStartRta(this);}.bind(this));}}return Promise.resolve();},_onAppLoaded:function(){if(a.checkUI5App()){this._restartRtaIfRequired();d();}},_onStopHandler:function(){this._exitAdaptation();},_onStartHandler:function(){},_onErrorHandler:function(E){this.oTrigger.errorHandler(E);if(E!=="Reload triggered"){this._exitAdaptation();var s;var m;if(E instanceof Error){s=E.stack;m=this.mConfig.i18n.getText("TECHNICAL_ERROR");}else if(typeof E==="string"){s=m=E;}L.error("Cannot start UI Adaptation: ",s);sap.ui.require(["sap/ui/rta/Utils","sap/m/MessageBox"],function(U,M){M.error(m,{title:this.mConfig.i18n.getText("ERROR_TITLE"),onClose:null,styleClass:U.getRtaStyleClassName()});}.bind(this));}},_exitAdaptation:function(){sap.ui.getCore().getEventBus().unsubscribe("sap.ushell","appClosed",o.bind(this));b(true);this.oTrigger.exitRta();this.oRenderer.removeTopHeaderPlaceHolder();},exit:function(){sap.ui.getCore().getEventBus().unsubscribe("sap.ushell","appClosed",o.bind(this));b(true);var f=A.getAppLifeCycleService();f.detachAppLoaded(this._onAppLoaded,this);}});});
