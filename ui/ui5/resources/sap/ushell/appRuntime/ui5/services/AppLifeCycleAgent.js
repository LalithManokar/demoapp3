// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/appRuntime/ui5/AppRuntimePostMessageAPI","sap/ushell/appRuntime/ui5/AppRuntimeService","sap/base/util/UriParameters","sap/ui/thirdparty/URI","sap/ui/thirdparty/jquery","sap/ushell/appRuntime/ui5/services/TunnelsAgent","sap/ushell/appRuntime/ui5/services/AppDelegationBootstrap","sap/ui/Device","sap/ui/core/BusyIndicator","sap/base/Log"],function(A,a,U,b,q,t,d,D,B,L){"use strict";function c(C){var f=this,s,o,g={},h,i={},j={},r,R,k={},l={},S;this.init=function(m,e,n,p,u){s=m;h=e;R=n;if(p&&u){g[p]=JSON.parse(JSON.stringify(u));}A.registerCommHandlers({"sap.ushell.services.appLifeCycle":{"oServiceCalls":{"create":{executeServiceCallFn:function(M){var v=JSON.parse(M.oMessage.data),p=new U(v.body.sUrl).get("sap-ui-app-id");window.hasher.disableCFLPUpdate=true;window.hasher.replaceHash("");window.hasher.replaceHash(v.body.sHash);window.hasher.disableCFLPUpdate=false;f.create(p,v.body.sUrl);return new q.Deferred().resolve().promise();}},"destroy":{executeServiceCallFn:function(M){var v=JSON.parse(M.oMessage.data);f.destroy(v.body.sCacheId);return new q.Deferred().resolve().promise();}},"store":{executeServiceCallFn:function(M){var v=JSON.parse(M.oMessage.data);f.store(v.body.sCacheId);return new q.Deferred().resolve().promise();}},"restore":{executeServiceCallFn:function(M){var v=JSON.parse(M.oMessage.data);window.hasher.disableCFLPUpdate=true;window.hasher.replaceHash("");window.hasher.replaceHash(v.body.sHash);window.hasher.disableCFLPUpdate=false;f.restore(v.body.sCacheId);return new q.Deferred().resolve().promise();}}}},"sap.ushell.eventDelegation":{"oServiceCalls":{"registerEventHandler":{executeServiceCallFn:function(v){var E=JSON.parse(v.oMessageData.body.sEventObject),w=E.eventKey,x=E.eventData;if(k.hasOwnProperty(w)){var y=k[w];for(var z=0;z<y.length;z++){y[z](x);}}return new q.Deferred().resolve().promise();}}}}});this.initialSetup();};this.initialSetup=function(){d.bootstrap();a.sendMessageToOuterShell("sap.ushell.services.appLifeCycle.setup",{isStateful:true,isKeepAlive:true,isIframeValid:true,session:{bLogoutSupport:true}});};this.restore=function(e){var m=i[e],n=m.getComponentInstance();sap.ui.getCore().getEventBus().publish("launchpad","appOpening",{});m.setVisible(true);if(j[e]&&sap.ushell.Container){sap.ushell.Container.setAsyncDirtyStateProviders(j[e]);}if(S){S.setBackNavigation(l[e]);}if(n){if(n.restore){n.restore();}if(n.getRouter&&n.getRouter()&&n.getRouter().initialize){n.getRouter().initialize();}r=m;}sap.ui.getCore().getEventBus().publish("sap.ushell","appOpened",{});};this.store=function(e){var m=r,n;i[e]=m;if(S){l[e]=S._getBackNavigationCallback();}n=m.getComponentInstance();m.setVisible(false);if(sap.ushell.Container){j[e]=sap.ushell.Container.getAsyncDirtyStateProviders();sap.ushell.Container.cleanDirtyStateProviderArray();}if(n){if(n.suspend){n.suspend();}if(n.getRouter&&n.getRouter()){n.getRouter().stop();}}sap.ui.getCore().getEventBus().publish("sap.ushell","appClosed",{});};this.getURLParameters=function(u){return new Promise(function(e,m){if(u.hasOwnProperty("sap-intent-param")){var n=u["sap-intent-param"];a.sendMessageToOuterShell("sap.ushell.services.CrossApplicationNavigation.getAppStateData",{"sAppStateKey":n}).then(function(p){delete u["sap-intent-param"];var v=q.extend({},u,(new b("?"+p)).query(true),true);e(v);},function(E){e(u);});}else{e(u);}});};this.getAppInfo=function(e){return new Promise(function(m){function G(){o.getAppInfo(e).then(function(n){g[e]=(JSON.parse(JSON.stringify(n)));m(n);});}if(g[e]){m(JSON.parse(JSON.stringify(g[e])));}else if(o){G();}else{sap.ui.require([s.replace(/\./g,"/")],function(O){o=O;G();});}});};this.create=function(e,u){if(D.browser.chrome){B.show(0);}if(S){S._resetBackNavigationCallback();}sap.ui.getCore().getEventBus().publish("launchpad","appOpening",{});var m=new Promise(function(n){f.getAppInfo(e).then(function(p){n(p);});}).then(function(n){f.getURLParameters(new b(u).query(true)).then(function(p){h(e,p,n).then(function(v){R(v);sap.ui.getCore().getEventBus().publish("sap.ushell","appOpened",{});});});});return m;};this.setComponent=function(e){r=e;};this.destroy=function(m){function n(p){var u=p.sId||"<unkown>";try{p.destroy();}catch(e){L.error("exception when trying to close sapui5 application with id '"+u+"' when running inside the appruntim iframe '"+document.URL+"'. This error must be fixed in order for the iframe to operate properly.\n",e.stack,"sap.ushell.appRuntime.ui5.services.AppLifeCycleAgent::destroy");}}if(m&&i[m]){if(i[m]===r){r=undefined;}n(i[m]);delete i[m];}else if(r){n(r);r=undefined;}sap.ushell.Container.cleanDirtyStateProviderArray();if(S){S._resetBackNavigationCallback();}sap.ui.getCore().getEventBus().publish("sap.ushell","appClosed",{});};this.jsonStringifyFn=function(J){var e=JSON.stringify(J,function(m,v){return(typeof v==="function")?v.toString():v;});return e;};this.setShellUIService=function(e){S=e;};}return new c();},true);
