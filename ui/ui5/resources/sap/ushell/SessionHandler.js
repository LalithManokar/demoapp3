// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/resources","sap/m/Dialog","sap/m/Button","sap/m/Text","sap/ui/model/json/JSONModel","sap/m/VBox","sap/ui/core/library","sap/ushell/ui/launchpad/LoadingDialog","sap/ui/thirdparty/jquery","sap/ui/util/Storage","sap/base/Log"],function(r,D,B,T,J,V,c,L,q,S,a){"use strict";var b=c.ValueState;var d=function(A){var t=this;this.init=function(C){a.debug("SessionHandler.config.sessionTimeoutIntervalInMinutes: "+C.sessionTimeoutIntervalInMinutes,"","SessionHandler");a.debug("SessionHandler.config.sessionTimeoutReminderInMinutes: "+C.sessionTimeoutReminderInMinutes,"","SessionHandler");a.debug("SessionHandler.config.enableAutomaticSignout: "+C.enableAutomaticSignout,"","SessionHandler");this.config=C;this.oModel=new J();this.putTimestampInStorage(this._getCurrentDate());sap.ushell.Container.registerLogout(this.logout);this.registerCommHandlers();this.attachUserEvents();if(C.sessionTimeoutIntervalInMinutes>0){this.initSessionTimeout();}if(C.sessionTimeoutTileStopRefreshIntervalInMinutes>0){this.initTileRequestTimeout();}};this.initSessionTimeout=function(){q.sap.measure.start("SessionTimeoutInit","Inititialize Session Timeout","FLP_SHELL");if(this.config.enableAutomaticSignout===undefined){this.config.enableAutomaticSignout=false;}if(this.config.sessionTimeoutReminderInMinutes===undefined){this.config.sessionTimeoutReminderInMinutes=0;}this.oModel.setProperty("/SessionRemainingTimeInSeconds",this.config.sessionTimeoutReminderInMinutes*60);this.counter=0;this.oKeepAliveDialog=undefined;this.notifyServer();this.monitorUserIsInactive();q.sap.measure.end("SessionTimeoutInit");};this.registerCommHandlers=function(){A.registerShellCommunicationHandler({"sap.ushell.sessionHandler":{oRequestCalls:{"logout":{isActiveOnly:false,distributionType:["URL"]},"extendSessionEvent":{isActiveOnly:false,distributionType:["all"]}},oServiceCalls:{"notifyUserActive":{executeServiceCallFn:function(){t.userActivityHandler();return new q.Deferred().resolve().promise();}}}}});};this.monitorUserIsInactive=function(){a.debug("SessionHandler.monitorInactiveUser : Check started","*****","SessionHandler");var i=this.timeLastInteraction(),e=this.timePopup(),f=this.timeNow(),g=this.timeOver(),R=e-f,h=f-i;a.debug("SessionHandler.monitorUserIsInactive :: time since last interaction : "+h,"","SessionHandler");a.debug("SessionHandler.monitorUserIsInactive :: remaining time until dialog : "+R,"","SessionHandler");if(f<e){setTimeout(this.monitorUserIsInactive.bind(this),R*1000);return;}if(f>=e&&f<g&&this.config.sessionTimeoutReminderInMinutes>0){this.detachUserEvents();this.oContinueWorkingDialog=this.createContinueWorkingDialog();this.oContinueWorkingDialog.open();a.debug("SessionHandler.monitorUserIsInactive :: Dialog opened","","SessionHandler");this.monitorCountdown(true);}if(f>=g){a.debug("SessionHandler.monitorUserIsInactive :: Session over detected","","SessionHandler");this.handleSessionOver();return;}a.debug("SessionHandler.monitorInactiveUser :: Check done","*****","SessionHandler");};this.handleSessionOver=function(){clearTimeout(this.notifyServerTimer);sap.ui.getCore().getEventBus().publish("launchpad","sessionTimeout");if(this.config.enableAutomaticSignout===true){a.debug("SessionHandler.handleSessionOver :: Automatic signout gets initiated","","SessionHandler");this.logout();}else{a.debug("SessionHandler.handleSessionOver :: Session expired dialog gets opened","","SessionHandler");this.createSessionExpiredDialog().open();}};this.notifyServer=function(){var e=this._getCurrentDate()-new Date(this.getTimestampFromStorage()),f=e/(1000*60);if(f<=this.config.sessionTimeoutIntervalInMinutes){sap.ushell.Container.sessionKeepAlive();A.postMessageToIframeApp("sap.ushell.sessionHandler","extendSessionEvent",{});}else{}this.notifyServerTimer=setTimeout(this.notifyServer.bind(this),this.config.sessionTimeoutIntervalInMinutes*60*1000);};this.monitorCountdown=function(i){if(i){a.debug("SessionHandler.monitorCountdown :: Initiated from outside","*****","SessionHandler");}else{a.debug("SessionHandler.monitorCountdown :: Initiated from internal call","**","SessionHandler");}var e=this.timeLastInteraction(),f=this.timePopup(),g=this.timeNow(),h=this.timeOver(),j=g-e;a.debug("SessionHandler.monitorCountdown :: timeNow : "+g,"","SessionHandler");a.debug("SessionHandler.monitorCountdown :: iTimeLastInteraction : "+e,"","SessionHandler");a.debug("SessionHandler.monitorCountdown :: timeSinceLastInteraction : "+j,"","SessionHandler");a.debug("SessionHandler.monitorCountdown :: iTimeOver : "+h,"","SessionHandler");if(g<f){a.debug("SessionHandler.monitorCountdown :: Auto-click","<=","SessionHandler");this.continueWorkingButtonPressHandler(true);return;}var R=h-g;if(R>0){a.debug("SessionHandler.monitorCountdown :: Remaining seconds : "+R+" - iTimeOver : "+h,"","SessionHandler");this.oModel.setProperty("/SessionRemainingTimeInSeconds",R);this.remainingTimer=setTimeout(this.monitorCountdown.bind(this,false),500);return;}if(R<=0){if(this.oSessionKeepAliveDialog){this.oSessionKeepAliveDialog.close();}this.handleSessionOver();}};this.initTileRequestTimeout=function(){q.sap.measure.start("SessionTileStopRequestInit","Initialize tile request timeout","FLP_SHELL");this.checkStopBackendRequestRemainingTime();this.bBackendRequestsActive=true;q.sap.measure.end("SessionTileStopRequestInit");};this.checkStopBackendRequestRemainingTime=function(){var s=this._getCurrentDate()-new Date(this.getTimestampFromStorage()),e=s/(1000*60),R=this.config.sessionTimeoutTileStopRefreshIntervalInMinutes,f=(R-e)*60*1000;if(e<R){setTimeout(this.checkStopBackendRequestRemainingTime.bind(this),f);}else if(R>0){this._setConnectionActive(false);}};this._setConnectionActive=function(e){this.bBackendRequestsActive=e;var n=sap.ushell.Container.getService("Notifications");if(e){setTimeout(this.checkStopBackendRequestRemainingTime.bind(this),0);this._setTilesVisibleOnHomepage();if(n.isEnabled()){n._resumeConnection();}}else{this._setTilesInvisibleOnHomepage();if(n.isEnabled()){n._closeConnection();}}};this._setTilesVisibleOnHomepage=function(){sap.ui.require(["sap/ushell/utils"],function(u){u.handleTilesVisibility();});};this._setTilesInvisibleOnHomepage=function(){return new Promise(function(e,f){sap.ushell.Container.getServiceAsync("LaunchPage").then(function(g){g.getGroups().then(function(G){var E=sap.ui.getCore().getEventBus();G.forEach(function(o){g.getGroupTiles(o).forEach(function(h){g.setTileVisible(h,false);});});E.publish("launchpad","visibleTilesChanged",[]);e();});});});};this.getLocalStorage=function(){if(this.oLocalStorage===undefined){var s=new S(this.config&&this.config.sessionType||S.Type.local);if(this._isLocalStorageSupported(s)){this.oLocalStorage=s;}else{this.oLocalStorage=false;}}return this.oLocalStorage;};this._isLocalStorageSupported=function(s){var i;try{i=s.isSupported();}catch(e){i=false;}if(!i){a.warning("SessionHandler._isLocalStorageSupported :: Failed to instantiate local storage handler: "+"Might be disabled by the browser!","","SessionHandler");}return i;};this.createContinueWorkingDialog=function(){a.debug("SessionHandler.createContinueWorkingDialog :: Continue working dialog beeing created","","SessionHandler");this.oMessageVBox=new V();this.oSessionKeepAliveLabel=new T({text:{parts:["/SessionRemainingTimeInSeconds"],formatter:function(s){var i=s>60,e,f,m;e=i?r.i18n.getText("sessionTimeoutMessage_units_minutes"):r.i18n.getText("sessionTimeoutMessage_units_seconds");f=i?Math.ceil(s/60):s;if(t.config.enableAutomaticSignout){m=r.i18n.getText("sessionTimeoutMessage_kioskMode_main",[f,e]);}else{m=r.i18n.getText("sessionTimeoutMessage_main",[f,e]);}return m;}}});this.oMessageVBox.addItem(this.oSessionKeepAliveLabel);if(this.config.enableAutomaticSignout===false){this.oLostDataReminder=new T({text:r.i18n.getText("sessionTimeoutMessage_unsavedData")});this.oMessageVBox.addItem(this.oLostDataReminder);}this.oSessionKeepAliveLabel.setModel(this.oModel);this.oSessionKeepAliveDialog=new D("sapUshellKeepAliveDialog",{title:r.i18n.getText("sessionTimeoutMessage_title"),type:"Message",state:b.Warning,content:this.oMessageVBox,beginButton:this.getContinueWorkingButton(),afterClose:function(){this.oSessionKeepAliveDialog.destroy();}.bind(this)});if(this.config.enableAutomaticSignout===true){this.oSignOutButton=new B({text:r.i18n.getText("logoutBtn_title"),tooltip:r.i18n.getText("logoutBtn_tooltip"),press:this.logout.bind(this)});this.oSessionKeepAliveDialog.setEndButton(this.oSignOutButton);}return this.oSessionKeepAliveDialog;};this.getContinueWorkingButton=function(){return new B({text:r.i18n.getText("sessionTimeoutMessage_continue_button_title"),press:t.continueWorkingButtonPressHandler.bind(t,false)});};this.continueWorkingButtonPressHandler=function(i){a.debug("SessionHandler.continueWorkingButtonPressHandler :: Session was extended"+i?"automatically":"by user","","SessionHandler");if(this.oSessionKeepAliveDialog){this.oSessionKeepAliveDialog.close();}clearTimeout(this.remainingTimer);if(!i){this.putTimestampInStorage(this._getCurrentDate());}this.monitorUserIsInactive();this.attachUserEvents();A.postMessageToIframeApp("sap.ushell.sessionHandler","extendSessionEvent",{});};this.createSessionExpiredDialog=function(){this.oSessionExpiredDialog=new D("sapUshellSessioTimedOutDialog",{title:r.i18n.getText("sessionExpiredMessage_title"),type:"Message",state:b.Warning,content:new T({text:r.i18n.getText("sessionExpiredMessage_main")}),beginButton:this.getReloadButton(),afterClose:function(){this.oSessionExpiredDialog.destroy();}.bind(this)});return this.oSessionExpiredDialog;};this.getReloadButton=function(){return new B({text:r.i18n.getText("sessionExpiredMessage_reloadPage_button_title"),press:function(){t.oSessionExpiredDialog.close();location.reload();}});};this.attachUserEvents=function(){q(document).on("mousedown.sessionTimeout mousemove.sessionTimeout",this.userActivityHandler.bind(this));q(document).on("keyup.sessionTimeout",this.userActivityHandler.bind(this));q(document).on("touchstart.sessionTimeout",this.userActivityHandler.bind(this));sap.ushell.Container.getService("AppLifeCycle").attachAppLoaded({},this.userActivityHandler,this);};this.detachUserEvents=function(){q(document).off("mousedown.sessionTimeout mousemove.sessionTimeout");q(document).off("keydown.sessionTimeout");q(document).off("touchstart.sessionTimeout");sap.ushell.Container.getService("AppLifeCycle").detachAppLoaded(this.userActivityHandler,this);};this.putTimestampInStorage=function(e){a.debug("SessionHandler.putTimestampInStorage :: Timestamp is "+e,"","SessionHandler");q.sap.measure.average("SessionTimeoutPutLocalStorage","Put timestamp in local storage Average","FLP_SHELL");var l=this.getLocalStorage();if(l){l.put("lastActivityTime",e);if(this.bBackendRequestsActive===false){this._setConnectionActive(true);}}q.sap.measure.end("SessionTimeoutPutLocalStorage");};this.getTimestampFromStorage=function(){var l=this.getLocalStorage();if(l){return l.get("lastActivityTime");}return null;};this.timeNow=function(){return Math.floor(Date.now()/1000);};this.timeLastInteraction=function(){return Math.floor(new Date(this.getTimestampFromStorage()).getTime()/1000);};this.timeOver=function(){return Math.floor(this.timeLastInteraction()+this.config.sessionTimeoutIntervalInMinutes*60);};this.timePopup=function(){return Math.floor(this.timeLastInteraction()+this.config.sessionTimeoutIntervalInMinutes*60-this.config.sessionTimeoutReminderInMinutes*60);};this.userActivityHandler=function(){if(this.oUserActivityTimer!==undefined){return;}this.oUserActivityTimer=setTimeout(function(){a.debug("SessionHandler.userActivityHandler :: Timed time stamp update","","SessionHandler");t.putTimestampInStorage(t._getCurrentDate());t.oUserActivityTimer=undefined;},1000);};this._getCurrentDate=function(){return new Date();};this.logout=function(){a.debug("SessionHandler.logout :: Logout initiated","","SessionHandler");var l=new L({text:""});A.postMessageToIframeApp("sap.ushell.sessionHandler","logout",{},true).then(function(){t.detachUserEvents();clearTimeout(t.oUserActivityTimer);clearTimeout(t.remainingTimer);clearTimeout(t.notifyServerTimer);l.openLoadingScreen();l.showAppInfo(r.i18n.getText("beforeLogoutMsg"),null);sap.ushell.Container.setDirtyFlag(false);sap.ushell.Container.defaultLogout();});};};return d;},true);
