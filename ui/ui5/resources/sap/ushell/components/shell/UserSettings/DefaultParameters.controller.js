// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/comp/smartform/SmartForm","sap/ui/model/odata/ODataModel","sap/ui/comp/smartfield/SmartField","sap/ui/comp/valuehelpdialog/ValueHelpDialog","sap/ui/thirdparty/jquery","sap/base/Log","sap/ui/Device","sap/ui/model/json/JSONModel","sap/ui/comp/smartform/GroupElement","sap/ui/comp/smartform/Group","sap/ui/layout/GridData","sap/m/Button","sap/ushell/resources","sap/m/library","sap/ui/comp/smartfield/SmartLabel","sap/m/Input","sap/m/FlexItemData","sap/m/FlexBox","sap/ui/comp/library","sap/m/Token"],function(S,O,a,V,q,L,D,J,G,b,c,B,r,m,d,I,F,e,f,T){"use strict";var g=f.valuehelpdialog.ValueHelpRangeOperation;var h=m.ButtonType;var j=m.FlexAlignItems;var k=m.FlexDirection;var l=m.FlexWrap;sap.ui.controller("sap.ushell.components.shell.UserSettings.DefaultParameters",{onInit:function(){this.oModelRecords={};this.oChangedParameters={};this.oBlockedParameters={};this.aDisplayedUserDefaults=[];this.DefaultParametersService=sap.ushell.Container.getService("UserDefaultParameters");},applyFocus:function(){var t=this;setTimeout(function(){if(!D.phone){var i=t.getView().$().firstFocusableDomRef();if(i){i.focus();}}},1);},overrideOdataModelValue:function(E){var u=E.getParameter("url"),M=E.getSource(),s,i,t=this;this.aDisplayedUserDefaults.forEach(function(R){if(R.editorMetadata&&R.editorMetadata.editorInfo){i=R.editorMetadata.editorInfo.odataURL+R.editorMetadata.editorInfo.bindingPath;if(i===u){s=R.editorMetadata.editorInfo.bindingPath+"/"+R.editorMetadata.editorInfo.propertyName;if(M.getProperty(s)!==R.valueObject.value){M.setProperty(s,R.valueObject.value);}t.oBlockedParameters[R.parameterName]=false;}}});},getOrCreateModelForODataService:function(u){if(!this.oModelRecords[u]){var p={metadataUrlParams:{"sap-documentation":"heading,quickinfo","sap-value-list":"none","sap-language":sap.ui.getCore().getConfiguration().getLanguageTag()},json:true};var M=new O(u,p);M.setDefaultCountMode("None");M.setDefaultBindingMode("TwoWay");M.attachRequestCompleted(this.overrideOdataModelValue.bind(this));this.oModelRecords[u]=M;}return this.oModelRecords[u];},constructControlSet:function(p){var u=[];for(var P in p){for(var n=0;n<u.length;n++){if(u[n].parameterName===P){u.splice(n,1);}}p[P].parameterName=P;u.push(p[P]);}this.sortParametersByGroupIdParameterIndex(u);this.aDisplayedUserDefaults=u;this.sForm=new S({editable:true}).addStyleClass("sapUshellShellDefaultValuesForm");this.getView().addContent(this.sForm);},getValue:function(){var i=q.Deferred();var H=sap.ushell.Container.getService("UserDefaultParameters").hasRelevantMaintainableParameters();H.done(function(n){i.resolve({value:n?1:0,displayText:" "});});H.fail(function(E){i.reject(E);});return i.promise();},createPlainModel:function(i,R){R.modelBind.model=this.oMdlParameter;R.modelBind.extendedModel=this.oMdlParameter;i.setModel(R.modelBind.model);var M="/sUserDef_"+R.nr+"_";R.modelBind.sFullPropertyPath=M;R.modelBind.sPropertyName="{"+M+"}";R.modelBind.model.setProperty(R.modelBind.sFullPropertyPath,R.valueObject.value);},revertToPlainModelControls:function(i,R){L.error("Metadata loading for parameter "+R.parameterName+" failed"+JSON.stringify(R.editorMetadata));R.modelBind.isOdata=false;this.createPlainModel(i,R);this.createAppropriateControl(i,R);},getContent:function(){var t=this;var n=new q.Deferred();this.DefaultParametersService.editorGetParameters().done(function(p){t.oMdlParameter=new J(p);t.oMdlParameter.setDefaultBindingMode("TwoWay");t.getView().setModel(t.oMdlParameter,"MdlParameter");t.oOriginalParameters=q.extend(true,{},p);t.oCurrentParameters=q.extend(true,{},p);t.constructControlSet(p);var o="nevermore";var s;t.aChangedParameters=[];t.oBindingContexts={};t.setPropValue=function(R){R.modelBind.model.setProperty(R.modelBind.sFullPropertyPath,R.valueObject.value);t.oBlockedParameters[R.parameterName]=false;};t.oMdlParameter.setProperty("/sUser");for(var i=0;i<t.aDisplayedUserDefaults.length;++i){var R=t.aDisplayedUserDefaults[i];R.nr=i;R.editorMetadata=R.editorMetadata||{};R.valueObject=R.valueObject||{value:""};var u=new G({});if(o!==R.editorMetadata.groupId){var v=R.editorMetadata.groupTitle||undefined;s=new b({label:v,"editable":true,layoutData:new c({linebreak:false})});o=R.editorMetadata.groupId;t.sForm.addGroup(s);}s.addGroupElement(u);R.modelBind={model:undefined,sModelPath:undefined,sPropertyName:undefined,sFullPropertyPath:undefined};R.valueObject.value=R.valueObject.value||"";if(R.editorMetadata.editorInfo&&R.editorMetadata.editorInfo.propertyName){R.modelBind.isOdata=true;var U=R.editorMetadata.editorInfo.odataURL;R.modelBind.model=t.getOrCreateModelForODataService(U);u.setModel(R.modelBind.model);if(!t.oBindingContexts[U]){u.bindElement(R.editorMetadata.editorInfo.bindingPath);t.oBindingContexts[U]=R.modelBind.model.getContext(R.editorMetadata.editorInfo.bindingPath);}else{u.setBindingContext(t.oBindingContexts[U]);}R.modelBind.sPropertyName="{"+R.editorMetadata.editorInfo.propertyName+"}";R.modelBind.sFullPropertyPath=R.editorMetadata.editorInfo.bindingPath+"/"+R.editorMetadata.editorInfo.propertyName;R.modelBind.extendedModel=t.oMdlParameter;}else{t.createPlainModel(u,R);}R.valueObject.value=R.valueObject.value||"";R.modelBind.model.setProperty(R.modelBind.sFullPropertyPath,R.valueObject.value);if(R.modelBind.isOdata){t.oBlockedParameters[R.parameterName]=true;R.modelBind.model.attachMetadataLoaded(t.createAppropriateControl.bind(t,u,R));R.modelBind.model.attachMetadataFailed(t.revertToPlainModelControls.bind(t,u,R));}else{t.createAppropriateControl(u,R);}R.modelBind.model.bindTree(R.modelBind.sFullPropertyPath).attachChange(t.storeChangedData.bind(t));}t.oMdlParameter.bindTree("/").attachChange(t.storeChangedData.bind(t));n.resolve(t.getView());});return n.promise();},createAppropriateControl:function(i,R){var s,n,o;if(R.editorMetadata.extendedUsage){var t=this;o=new B({text:r.i18n.getText("userDefaultsExtendedParametersTitle"),tooltip:r.i18n.getText("userDefaultsExtendedParametersTooltip"),type:{parts:["MdlParameter>/"+R.parameterName+"/valueObject/extendedValue/Ranges"],formatter:function(u){return u&&u.length?h.Emphasized:h.Transparent;}},press:function(u){t.openExtendedValueDialog(u,R);}}).addStyleClass("sapUshellExtendedDefaultParamsButton");}L.debug("Creating controls for parameter"+R.parameterName+" type "+R.modelBind.isOdata);var E=i.getElements().slice();E.forEach(function(u){i.removeElement(u);});var p=i.getFields().slice();p.forEach(function(u){i.removeField(u);});n=new d({width:D.system.phone?"auto":"12rem",textAlign:D.system.phone?"Left":"Right"});if(R.modelBind.isOdata&&R.editorMetadata.editorInfo){s=new a({value:R.modelBind.sPropertyName,name:R.parameterName});s.attachInnerControlsCreated({},this.applyFocus,this);n.setLabelFor(s);}else{s=new I({name:R.parameterName,value:R.modelBind.sPropertyName,type:"Text"});s.addAriaLabelledBy(n);this.setPropValue(R);n.setText((R.editorMetadata.displayText||R.parameterName)+":");n.setTooltip(R.editorMetadata.description||R.parameterName);}s.attachChange(this.storeChangedData.bind(this));s.addStyleClass("sapUshellDefaultValuesSmartField");s.setLayoutData(new F({shrinkFactor:0}));n.setLayoutData(new F({shrinkFactor:0}));i.addElement(new e({width:D.system.phone?"100%":"auto",alignItems:D.system.phone?j.Start:j.Center,direction:(D.system.phone&&!o)?k.Column:k.Row,items:[n,s,o],wrap:l.Wrap}));},openExtendedValueDialog:function(E,o){var t=this,p="/"+o.parameterName+"/valueObject/extendedValue/Ranges",M=o.modelBind.extendedModel,R=M.getProperty(p)||[],i,n;if(o.modelBind.isOdata){n=this._getMetadataNameSpace(o.editorMetadata.editorInfo.odataURL);var s=o.modelBind.model.getMetaModel().getODataEntityType(n+"."+o.editorMetadata.editorInfo.entityName);if(s){i=o.modelBind.model.getMetaModel().getODataProperty(s,o.editorMetadata.editorInfo.propertyName)["sap:label"];}}var v=new V({basicSearchText:o.editorMetadata.displayText||i||o.parameterName,title:o.editorMetadata.displayText||i||o.parameterName,supportRanges:true,supportRangesOnly:true,key:o.modelBind.sPropertyName,displayFormat:"UpperCase",descriptionKey:o.editorMetadata.displayText||i||o.parameterName,filterMode:true,stretch:D.system.phone,ok:function(C){t.saveExtendedValue(C,o,M,v);},cancel:function(){v.close();},afterClose:function(){v.destroy();}});v.setIncludeRangeOperations(this.getListOfSupportedRangeOperations());this.addTokensToValueHelpDialog(v,R,o.parameterName);var u=[];u.push({label:v.getTitle(),key:o.parameterName});v.setRangeKeyFields(u);v.open();},saveExtendedValue:function(C,o,M,v){this.aTokens=C.getParameters().tokens;var t=[],p="/"+o.parameterName+"/valueObject/extendedValue/Ranges",i,n={extendedValue:{"Ranges":[]}};q.extend(this.oCurrentParameters[o.parameterName].valueObject,n);for(var s in this.aTokens){if(this.aTokens.hasOwnProperty(s)){t.push(this.aTokens[s].data("range"));}}i=t.map(function(s){return{Sign:s.exclude?"E":"I",Option:s.operation!=="Contains"?s.operation:"CP",Low:s.value1,High:s.value2||null};});if(!M.getProperty("/"+o.parameterName+"/valueObject/extendedValue")){M.setProperty("/"+o.parameterName+"/valueObject/extendedValue",{});}M.setProperty(p,i);this.oChangedParameters[o.parameterName]=true;v.close();},getListOfSupportedRangeOperations:function(){var s=Object.keys(g);return s.filter(function(o){return o!=="StartsWith"&&o!=="EndsWith"&&o!=="Initial";});},_getMetadataNameSpace:function(s){var i=s.split("/"),n;n=i[i.length-1];return n;},addTokensToValueHelpDialog:function(o,R,p){var t=[],i;R.forEach(function(n){if(n){i={};i.exclude=n.Sign==="E";i.keyField=p;i.operation=n.Option!=="CP"?n.Option:"Contains";i.value1=n.Low;i.value2=n.High;t.push(new T({}).data("range",i));}});o.setTokens(t);},sortParametersByGroupIdParameterIndex:function(u){function i(o,p){if(!(p.editorMetadata&&p.editorMetadata.groupId)){return-1;}if(!(o.editorMetadata&&o.editorMetadata.groupId)){return 1;}if(o.editorMetadata.groupId<p.editorMetadata.groupId){return-1;}if(o.editorMetadata.groupId>p.editorMetadata.groupId){return 1;}return 0;}function n(o,p){if(!(p.editorMetadata&&p.editorMetadata.parameterIndex)){return-1;}if(!(o.editorMetadata&&o.editorMetadata.parameterIndex)){return 1;}return o.editorMetadata.parameterIndex-p.editorMetadata.parameterIndex;}u.sort(function(o,p){var s=i(o,p);if(s===0){return n(o,p);}return s;});},storeChangedData:function(){var i=0,t=this,n=t.aDisplayedUserDefaults;for(i=0;i<n.length;++i){var p=n[i].parameterName;if(!t.oBlockedParameters[p]){var o={value:t.oCurrentParameters[p].valueObject&&t.oCurrentParameters[p].valueObject.value,extendedValue:t.oCurrentParameters[p].valueObject&&t.oCurrentParameters[p].valueObject.extendedValue&&t.oCurrentParameters[p].valueObject.extendedValue};if(n[i].modelBind&&n[i].modelBind.model){var M=n[i].modelBind.model;var s=n[i].modelBind.extendedModel;var P=n[i].modelBind.sFullPropertyPath;var A=M.getProperty(P);var N={value:M.getProperty(P),extendedValue:s.getProperty("/"+p+"/valueObject/extendedValue")};if(this.isValueDifferent(N,o)){t.oCurrentParameters[p].valueObject.value=A;if(N.extendedValue){q.extend(t.oCurrentParameters[p].valueObject.extendedValue,N.extendedValue);}t.oChangedParameters[p]=true;}}}}},onCancel:function(){if(sap.ui.getCore().byId("saveButton")){sap.ui.getCore().byId("saveButton").setEnabled(true);}var C=Object.keys(this.oChangedParameters),n=this.aDisplayedUserDefaults,p,o,s;if(C.length>0){for(var i=0;i<n.length&&C.length>0;i++){p=n[i].parameterName;if(C.indexOf(p)>-1){s=this.oOriginalParameters[p];o=n[i].modelBind;o.model.setProperty(o.sFullPropertyPath,s.valueObject.value||"");if(s.editorMetadata&&s.editorMetadata.extendedUsage){o.extendedModel.setProperty("/"+p+"/valueObject/extendedValue",s.valueObject.extendedValue||{});}}}this.oCurrentParameters=q.extend(true,{},this.oOriginalParameters);this.oChangedParameters={};}},isValueDifferent:function(v,o){var i=false,s=v?JSON.stringify(v):v,n=o?JSON.stringify(o):o,E,p;if(s===n){return false;}if(v===undefined){return false;}if(o===undefined){return false;}E=v.extendedValue?JSON.stringify(v.extendedValue):v.extendedValue;p=o.extendedValue?JSON.stringify(o.extendedValue):o.extendedValue;if((v.value===""&&o.value===undefined)||(o.value===""&&v.value===undefined)){i=true;}if(i&&(E===p)){return false;}return(!i&&(v.value!==o.value))||(E!==p);},onSave:function(){var t=this,n=new q.Deferred(),i,C=Object.keys(this.oChangedParameters).sort(),s,p,o=false;if(C.length===0){n.resolve();}for(i=0;i<C.length;i++){p=C[i];if(this.isValueDifferent(this.oOriginalParameters[p].valueObject,this.oCurrentParameters[p].valueObject)){if((this.oCurrentParameters[p].valueObject&&this.oCurrentParameters[p].valueObject.value===null)||(this.oCurrentParameters[p].valueObject&&this.oCurrentParameters[p].valueObject.value==="")){this.oCurrentParameters[p].valueObject.value=undefined;}if(this.oCurrentParameters[p].valueObject&&this.oCurrentParameters[p].valueObject.extendedValue&&Array.isArray(this.oCurrentParameters[p].valueObject.extendedValue.Ranges)&&(this.oCurrentParameters[p].valueObject.extendedValue.Ranges.length===0)){this.oCurrentParameters[p].valueObject.extendedValue=undefined;}s=sap.ushell.Container.getService("UserDefaultParameters").editorSetValue(p,this.oCurrentParameters[p].valueObject);s.done(function(P){t.oChangedParameters={};t.oOriginalParameters[P].valueObject.value=t.oCurrentParameters[P].valueObject.value;n.resolve();});s.fail(n.reject);o=true;}}if(!o){n.resolve();}return n.promise();}});});
