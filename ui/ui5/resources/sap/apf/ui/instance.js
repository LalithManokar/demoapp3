/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2019 SAP AG. All rights reserved
 */
sap.ui.define(['sap/apf/ui/utils/constants','sap/apf/core/constants','sap/apf/ui/reuse/view/analysisPath.view','sap/apf/ui/reuse/view/carousel.view','sap/apf/utils/trace',"sap/ui/dom/includeStylesheet","sap/ui/thirdparty/jquery"],function(u,c,A,C,t,i,q){'use strict';function s(o,f,S){var l=o.getLayoutView();var a=l.byId("subHeader");var b=l.byId("idSplitterLayoutData");a.addContent(f);if(!(f instanceof sap.ui.comp.smartfilterbar.SmartFilterBar)){b.setSize("65px");}f.addEventDelegate({onAfterRendering:function(){a.setBusy(false);if(f instanceof sap.ui.comp.smartfilterbar.SmartFilterBar){a.setHeight("");a.addStyleClass(S);}}});}function r(o){o.getLayoutView().byId("subHeader").setBusy(false);}function I(o){o.uiApi=this;var a=o.oCoreApi;var S=o.oStartFilterHandler;var b;var m;var d;var e;var f;var g;var p;var h;var j;var F,k;var l=a.getUriGenerator().getApfLocation();this.oEventCallbacks={};var n;i(l+"resources/css/apfUi.css","apfCss");i(l+"resources/css/apfPrint.css","printCss");q("#printCss").attr("media","print");this.getAddAnalysisStepButton=function(){return this.getAnalysisPath().getCarouselView().getAddStepButton();};this.getAnalysisPath=function(){if(b===undefined){b=sap.ui.view({viewName:"sap.apf.ui.reuse.view.analysisPath",type:sap.ui.core.mvc.ViewType.JS,viewData:o,async:true});}return b;};this.getNotificationBar=function(){if(m===undefined){m=sap.ui.view({viewName:"sap.apf.ui.reuse.view.messageHandler",type:sap.ui.core.mvc.ViewType.JS,viewData:o,async:true});}return m;};this.getStepContainer=function(){if(d===undefined){d=sap.ui.view({viewName:"sap.apf.ui.reuse.view.stepContainer",type:sap.ui.core.mvc.ViewType.JS,viewData:o,async:true});}return d;};this.getToolbar=function(){if(e===undefined){e=sap.ui.view({viewName:"sap.apf.ui.reuse.view.toolbar",type:sap.ui.core.mvc.ViewType.JS,viewData:o,async:true});}return e;};this.createCarouselSingleton=function(){if(o&&o.functions&&o.functions.createCarouselSingleton){f=o.functions.createCarouselSingleton();}if(f===undefined){f=sap.ui.view({viewName:"sap.apf.ui.reuse.view.carousel",type:sap.ui.core.mvc.ViewType.JS,viewData:{oInject:o},async:true});}return f;};this.getStepGallery=function(){if(g===undefined){g=sap.ui.view({type:sap.ui.core.mvc.ViewType.JS,viewName:"sap.apf.ui.reuse.view.stepGallery",viewData:o,async:true});}return g;};this.getPathGallery=function(){if(p===undefined){p=sap.ui.view({viewName:"sap.apf.ui.reuse.view.pathGallery",type:sap.ui.core.mvc.ViewType.JS,viewData:{oInject:o},async:true});}return p;};this.getDeleteAnalysisPath=function(){if(h===undefined){h=sap.ui.view({viewName:"sap.apf.ui.reuse.view.deleteAnalysisPath",type:sap.ui.core.mvc.ViewType.JS,viewData:{oInject:o},async:true});}return h;};this.getLayoutView=function(){if(j===undefined){j=sap.ui.view({viewName:"sap.apf.ui.reuse.view.layout",type:sap.ui.core.mvc.ViewType.XML,viewData:o,async:true});}return j;};this.selectionChanged=function(R){t.logCall("ui/Instance.selectionChanged",", bRefreshAllSteps: ",R,"--------");var y;var z=this;function B(){if(j){j.getController().enableDisableOpenIn();}}y=a.getSteps().indexOf(a.getActiveStep());var D=0;y=a.getSteps().indexOf(a.getActiveStep());if(!R){D=y+1;}t.logCall("...",", nActiveStepIndex: ",y,", indexOfRefresh",D);z.getAnalysisPath().getController().refresh(D);z.getAnalysisPath().getController().getView().getCarouselView().getController().setBusyFromIndex(D);a.updatePath(z.getAnalysisPath().getController().callBackForUpdatePath.bind(z.getAnalysisPath().getController()),function(){B();});t.logReturn("ui/Instance.selectionChanged");};var v=false;this.createApplicationLayout=function(y){var z=this;return new Promise(function(B){if(!v){var D=z.getStepGallery().loaded();var E=z.getToolbar().loaded();var G=z.getPathGallery().loaded();var H=z.getDeleteAnalysisPath().loaded();var J=z.getStepContainer().loaded();var K=Promise.all([D]).then(function(){return z.createCarouselSingleton().loaded();});var L=Promise.all([E,K,G,H]).then(function(){return z.getAnalysisPath().loaded();});var M=Promise.all([J,L]).then(function(){return z.getLayoutView().loaded();});M.then(function(){y.addPage(j);v=true;n=y;B(y);});}else{B(n);}});};this.addDetailFooterContent=function(y){this.getLayoutView().getController().addDetailFooterContentLeft(y);};this.addMasterFooterContentRight=function(y){this.getLayoutView().getController().addMasterFooterContentRight(y);};this.setEventCallback=function(E,y){this.oEventCallbacks[E]=y;};this.getEventCallback=function(E){return this.oEventCallbacks[E];};this.getCustomFormatExit=function(){return o.exits;};this.setCustomFormatExit=function(y){var z=this.getCustomFormatExit();z.customFormat=y;};this.drawSmartFilterBar=function(y){var z=this;function B(D){a.getSmartFilterbarDefaultFilterValues().done(function(E){k=sap.ui.view({viewName:"sap.apf.ui.reuse.view.smartFilterBar",type:sap.ui.core.mvc.ViewType.JS,viewData:{oCoreApi:a,oUiApi:z,oSmartFilterBarConfiguration:D,controlConfiguration:E,parent:z.getLayoutView()},async:true});k.loaded().then(function(V){s(z,V.byId("idAPFSmartFilterBar"),"smartFilterBarContainer");});});}if(y){if(y.entitySet){B(y);}else{a.getMetadata(y.service).done(function(D){y.entitySet=D.getEntitySetByEntityType(y.entityType);delete y.entityType;B(y);});}}else{r(z);}};this.drawFacetFilter=function(y){if(y.length>0){var z=this;F=sap.ui.view({viewName:"sap.apf.ui.reuse.view.facetFilter",type:sap.ui.core.mvc.ViewType.JS,viewData:{oCoreApi:a,oUiApi:this,aConfiguredFilters:y,oStartFilterHandler:S},async:true});F.loaded().then(function(V){s(z,V.byId("idAPFFacetFilter"));});}else{r(this);}};this.contextChanged=function(R){var y=this.getEventCallback(c.eventTypes.contextChanged);if(typeof y==="function"){y();}};this.getFacetFilterForPrint=function(){if(F){return F.byId("idAPFFacetFilter");}};this.getSmartFilterForPrint=function(){if(k){return k.byId("idAPFSmartFilterBar");}};this.handleStartup=function(y){var z=this;var B=q.Deferred();a.getSmartFilterBarConfigurationAsPromise().done(function(D){if(D){z.drawSmartFilterBar(D);}y.done(function(E){var G=S.getStartFilters();G.done(function(H){z.contextChanged();if(!D){z.drawFacetFilter(H);}if(E.navigationMode==="backward"){z.getAnalysisPath().getController().isBackNavigation=true;a.updatePath(z.getAnalysisPath().getController().callBackForUpdatePath.bind(z.getAnalysisPath().getController()));z.getLayoutView().getController().setPathTitle();}if(E.navigationMode==="forward"){if(a.getStartParameterFacade().getSteps()){var J=a.getStartParameterFacade().getSteps()[0].stepId;var K=a.getStartParameterFacade().getSteps()[0].representationId;var L=z.getAnalysisPath().getController().callBackForUpdatePathAndSetLastStepAsActive.bind(z.getAnalysisPath().getController());a.createFirstStep(J,K,L);}if(sap.ui.core.BusyIndicator){sap.ui.core.BusyIndicator.hide();}}z.getNotificationBar().loaded().then(function(M){z.getLayoutView().byId("applicationPage").addContent(M);var N=M.getController().showMessage;a.setCallbackForMessageHandling(N.bind(M.getController()));B.resolve();});});});});return B.promise();};this.destroy=function(){F=undefined;k=undefined;if(b){var y=this.getAnalysisPath().getToolbar().getController();w(y.saveDialog);w(y.newOpenDialog);w(y.newDialog);w(y.confirmDialog);w(y.errorMsgDialog);w(y.noPathAddedDialog);if(y.deleteAnalysisPath!==undefined){w(y.deleteAnalysisPath.getController().oDialog);}if(y.pathGallery!==undefined){w(y.pathGallery.getController().oDialog);}var z=this.getAnalysisPath().getCarouselView().getStepGallery().getController();w(z.oHierchicalSelectDialog);}if(d){var B=this.getStepContainer().getController();w(B.selectionDisplayDialog);x(this);}};function w(y){if(y!==undefined){if(y instanceof sap.m.ViewSettingsDialog){y.destroy();}else if(y.isOpen()){y.close();}}}function x(y){var z=false;var B=false;var D;if(y.getStepContainer().getViewData().oCoreApi.getActiveStep()!==undefined){z=true;}if(z){D=y.getStepContainer().getViewData().oCoreApi.getActiveStep().getSelectedRepresentation();if(D!==undefined){B=true;}}if(B){if(D.type!==u.representationTypes.TABLE_REPRESENTATION){if(D.toggleInstance!==undefined){w(D.toggleInstance.viewSettingsDialog);}}else{w(D.viewSettingsDialog);}}}}sap.apf.ui.Instance=I;return I;},true);
