/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/core/utils/filterSimplify","sap/apf/utils/utils","sap/apf/utils/executeFilterMapping","sap/ui/core/routing/HashChanger","sap/ui/thirdparty/jquery","sap/base/util/uid"],function(f,u,e,H,q,a){'use strict';var N=function(I){var c;var b;var l;var m=I.instances.messageHandler;var n=this;var F=I.constructors&&I.constructors.FilterReduction||f.FilterReduction;var d;var g=false;this.getNavigationTargets=function(){var i,s;var t=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");if(!t){if(!g){s=m.createMessageObject({code:5074});m.putMessage(s);g=true;}b={global:[],stepSpecific:[]};return u.createPromise(b);}i=q.Deferred();I.functions.getCumulativeFilterUpToActiveStep().done(function(C){if(b&&C.isEqual(l)){i.resolve(o(b));return i.promise();}l=C;if(!c){h();}b=q.extend(true,[],c);b.forEach(function(w){w.text="";});v(C).done(function(w){b=w;i.resolve(o(b));});});return i.promise();function v(w){var i=q.Deferred();var x=[];var D=[];var y;b.forEach(function(z){var A;if(z.useDynamicParameters){y=y||p(w);z.parameters=r(z.parameters,y);}A=q.Deferred();D.push(A);t.getLinks({semanticObject:z.semanticObject,action:z.action,params:k(z.parameters),ignoreFormFactor:false,ui5Component:I.instances.component}).then(function(B){B.forEach(function(C){var E=C.intent.split("-");var G=E[1].split("?");G=G[0].split("~");if(C.text!==""&&G[0]===z.action){z.text=C.text;x.push(z);}});A.resolve();},function(){A.resolve();});});q.when.apply(q,D).done(function(){i.resolve(x);});return i.promise();}};this.navigateToApp=function(i){if(!c){h();}var s=j(i);if(!s){return;}var t=H&&H.getInstance();I.functions.getCumulativeFilterUpToActiveStep().done(function(C){if(I.functions.isFilterReductionActive&&I.functions.isFilterReductionActive()){d=d||new F();var v=d.reduceFilter(m,C);if(v===null){m.putMessage(m.createMessageObject({code:5235}));}else{C=v;}}if(!s.filterMapping||!s.filterMapping.requestForMappedFilter){w(null,null);}else{var M=I.functions.createRequest(s.filterMapping.requestForMappedFilter);e(C,M,s.filterMapping.target,w,m);}function w(x,y){var z;if(y){return;}if(x){C=C.addAnd(x);}var A=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");if(A){I.instances.serializationMediator.serialize(true).done(function(B){n.generateSelectionVariant(C).done(function(D){var E;var G={};if(s.useDynamicParameters){E=p(C);}G.sapApfState=B;G.sapApfCumulativeFilter=C.mapToSapUI5FilterExpression();G.selectionVariant=D;z=A.createEmptyAppState(I.instances.component);z.setData(G);z.save();if(t){t.replaceHash("sap-iapp-state="+z.getKey());}var J=s.parameters;if(s.useDynamicParameters){J=r(J,E);}A.toExternal({target:{semanticObject:s.semanticObject,action:s.action},appStateKey:z.getKey(),params:k(J)},I.instances.component);});});}}});};this.checkMode=function(){var i=q.Deferred();var s=H&&H.getInstance&&H.getInstance();var t=/(?:sap-iapp-state=)([^&=]+)/;var v,w,x,y;if(s){x=t.exec(s.getHash());if(x){v=x[1];}}w=I.functions.getXappStateId();if(v){sap.ushell.Container.getService("CrossApplicationNavigation").getAppState(I.instances.component,v).done(function(z){y=z.getData();if(y.sapApfState){I.instances.serializationMediator.deserialize(y.sapApfState).done(function(){i.resolve({navigationMode:"backward"});});}});}else if(w){sap.ushell.Container.getService("CrossApplicationNavigation").getAppState(I.instances.component,w).done(function(z){y=z.getData();if(y&&y.sapApfCumulativeFilter){i.resolve({navigationMode:"forward",sapApfCumulativeFilter:y.sapApfCumulativeFilter});}else{i.resolve({navigationMode:"forward"});}});}else{i.resolve({navigationMode:"forward"});}if(s){s.replaceHash("");}return i.promise();};this.generateSelectionVariant=function(i){var s=q.Deferred();if(!I.functions.isFilterReductionActive||!I.functions.isFilterReductionActive()){d=d||new F();i=d.reduceFilter(m,i);}if(!d||!d.isContradicted()){var t=i.mapToSelectOptions(I.functions.getAllParameterEntitySetKeyProperties);t.done(function(v){v.SelectionVariantID=a();s.resolve(v);});}else{var v={};v={SelectionVariantID:a(),Text:'Filter could not be converted to a selectionVariant'};s.resolve(v);}return s.promise();};function h(){c=I.functions.getNavigationTargets();}function j(s){for(var i=0,t=c.length;i<t;i++){if(c[i].id===s){return c[i];}}}function k(i){var s;if(i&&i.length>0){s={};i.forEach(function(t){s[t.key]=t.value;});}return s;}function o(t){var i=q.extend(true,[],t);var s={global:[],stepSpecific:[]};i.forEach(function(w){if(w.isStepSpecific&&v(w.id)){delete w.isStepSpecific;s.stepSpecific.push(w);}else if(!w.isStepSpecific){delete w.isStepSpecific;s.global.push(w);}});return s;function v(w){var x=false;var y;var z=I.functions.getActiveStep();if(z&&z.getAssignedNavigationTargets){y=z.getAssignedNavigationTargets();if(y&&Array.isArray(y)){y.forEach(function(A){if(w===A.id){x=true;}});}}return x;}}function p(i){d=d||new F();var s=d.reduceFilter(m,i)||i;return s.getSingleValueTerms();}function r(i,t){t.forEach(function(s){i=i||[];i.push({'key':s.property,'value':s.value});});return i;}};sap.apf.utils.NavigationHandler=N;return N;},true);
